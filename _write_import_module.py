# -*- coding: utf-8 -*-
import pathlib

bsl_code = r'''#Область ПрограммныйИнтерфейс

// Загружает данные из Excel-файла и возвращает таблицу значений для предпросмотра.
//
// Параметры:
//  АдресХранилища - Строка - адрес файла во временном хранилище.
//
// Возвращаемое значение:
//  ТаблицаЗначений - таблица с загруженными данными.
//
Функция ЗагрузитьДанныеИзФайла(АдресХранилища) Экспорт
	
	ТабДок = ПрочитатьExcelФайл(АдресХранилища);
	Если ТабДок = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Читаем заголовки (первая строка)
	Заголовки = Новый Массив;
	Для НомерКолонки = 1 По ТабДок.ШиринаТаблицы Цикл
		ЗначениеЯчейки = СокрЛП(ТабДок.Область(1, НомерКолонки).Текст);
		Заголовки.Добавить(ЗначениеЯчейки);
	КонецЦикла;
	
	// Создаём таблицу с универсальными колонками
	ТаблицаДанных = Новый ТаблицаЗначений;
	ТаблицаДанных.Колонки.Добавить("ЭтоГруппа", Новый ОписаниеТипов("Булево"));
	ТаблицаДанных.Колонки.Добавить("Код", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(50)));
	ТаблицаДанных.Колонки.Добавить("Наименование", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(150)));
	ТаблицаДанных.Колонки.Добавить("НазваниеНаЭтикетке", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(100)));
	ТаблицаДанных.Колонки.Добавить("ЕдиницаИзмерения", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(20)));
	ТаблицаДанных.Колонки.Добавить("КодРодителя", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(50)));
	ТаблицаДанных.Колонки.Добавить("НаименованиеРодителя", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(150)));
	
	// Определяем тип импорта и маппинг колонок
	МаппингКолонок = ОпределитьМаппингКолонок(Заголовки);
	
	// Заполняем таблицу данными
	Для НомерСтроки = 2 По ТабДок.ВысотаТаблицы Цикл
		НоваяСтрока = ТаблицаДанных.Добавить();
		
		Для Каждого Элемент Из МаппингКолонок Цикл
			ИмяКолонки = Элемент.Ключ;
			НомерКолонки = Элемент.Значение;
			
			Если НомерКолонки > 0 И НомерКолонки <= ТабДок.ШиринаТаблицы Тогда
				Значение = СокрЛП(ТабДок.Область(НомерСтроки, НомерКолонки).Текст);
				
				Если ИмяКолонки = "ЭтоГруппа" Тогда
					НоваяСтрока.ЭтоГруппа = (ВРег(Значение) = "ДА" ИЛИ ВРег(Значение) = "YES" ИЛИ ВРег(Значение) = "ИСТИНА" ИЛИ ВРег(Значение) = "TRUE");
				ИначеЕсли ТаблицаДанных.Колонки.Найти(ИмяКолонки) <> Неопределено Тогда
					НоваяСтрока[ИмяКолонки] = Значение;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	Возврат ТаблицаДанных;
	
КонецФункции

// Выполняет импорт данных из Excel-файла.
//
// Параметры:
//  АдресХранилища - Строка - адрес файла во временном хранилище.
//
// Возвращаемое значение:
//  Структура - результат импорта:
//    * Успешно - Булево
//    * КоличествоЗагружено - Число
//    * СообщениеОбОшибке - Строка
//
Функция ВыполнитьИмпорт(АдресХранилища) Экспорт
	
	Результат = Новый Структура("Успешно, КоличествоЗагружено, СообщениеОбОшибке", Ложь, 0, "");
	
	ТабДок = ПрочитатьExcelФайл(АдресХранилища);
	Если ТабДок = Неопределено Тогда
		Результат.СообщениеОбОшибке = "Не удалось прочитать файл Excel";
		Возврат Результат;
	КонецЕсли;
	
	// Определяем тип импорта по заголовкам
	Заголовки = Новый Массив;
	Для НомерКолонки = 1 По ТабДок.ШиринаТаблицы Цикл
		Заголовки.Добавить(НРег(СокрЛП(ТабДок.Область(1, НомерКолонки).Текст)));
	КонецЦикла;
	
	ТипИмпорта = ОпределитьТипИмпорта(Заголовки);
	
	Попытка
		Если ТипИмпорта = "Номенклатура" Тогда
			Результат.КоличествоЗагружено = ИмпортироватьНоменклатуру(ТабДок);
		ИначеЕсли ТипИмпорта = "Цены" Тогда
			Результат.КоличествоЗагружено = ИмпортироватьЦены(ТабДок);
		ИначеЕсли ТипИмпорта = "Остатки" Тогда
			Результат.КоличествоЗагружено = ИмпортироватьОстатки(ТабДок);
		ИначеЕсли ТипИмпорта = "Штрихкоды" Тогда
			Результат.КоличествоЗагружено = ИмпортироватьШтрихкоды(ТабДок);
		Иначе
			Результат.СообщениеОбОшибке = "Не удалось определить тип данных в файле. Проверьте заголовки.";
			Возврат Результат;
		КонецЕсли;
		
		Результат.Успешно = Истина;
	Исключение
		Результат.СообщениеОбОшибке = ОписаниеОшибки();
		ЗаписьЖурналаРегистрации("ИмпортНоменклатуры.Ошибка",
			УровеньЖурналаРегистрации.Ошибка, , ,
			"Тип: " + ТипИмпорта + "; Ошибка: " + ОписаниеОшибки());
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Читает Excel-файл из временного хранилища.
Функция ПрочитатьExcelФайл(АдресХранилища)
	
	Попытка
		ДвоичныеДанные = ПолучитьИзВременногоХранилища(АдресХранилища);
		ИмяВременногоФайла = ПолучитьИмяВременногоФайла("xlsx");
		ДвоичныеДанные.Записать(ИмяВременногоФайла);
		
		ТабДок = Новый ТабличныйДокумент;
		ТабДок.Прочитать(ИмяВременногоФайла, ТипФайлаТабличногоДокумента.XLSX);
		
		УдалитьФайлы(ИмяВременногоФайла);
		
		Возврат ТабДок;
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

// Определяет тип импорта по заголовкам.
Функция ОпределитьТипИмпорта(Заголовки)
	
	ЗаголовокСтрока = "";
	Для Каждого Заг Из Заголовки Цикл
		ЗаголовокСтрока = ЗаголовокСтрока + НРег(Заг) + ";";
	КонецЦикла;
	
	Если СтрНайти(ЗаголовокСтрока, "это группа") > 0 ИЛИ СтрНайти(ЗаголовокСтрока, "единица изм") > 0 Тогда
		Возврат "Номенклатура";
	ИначеЕсли СтрНайти(ЗаголовокСтрока, "штрих") > 0 Тогда
		Возврат "Штрихкоды";
	ИначеЕсли СтрНайти(ЗаголовокСтрока, "количество") > 0 ИЛИ СтрНайти(ЗаголовокСтрока, "остаток") > 0 Тогда
		Возврат "Остатки";
	ИначеЕсли СтрНайти(ЗаголовокСтрока, "цена") > 0 Тогда
		Возврат "Цены";
	КонецЕсли;
	
	Возврат "";
	
КонецФункции

// Определяет маппинг колонок файла в поля таблицы.
Функция ОпределитьМаппингКолонок(Заголовки)
	
	Маппинг = Новый Соответствие;
	
	Для Индекс = 0 По Заголовки.ВГраница() Цикл
		ЗагНРег = НРег(Заголовки[Индекс]);
		НомерКолонки = Индекс + 1;
		
		Если СтрНайти(ЗагНРег, "это группа") > 0 Тогда
			Маппинг.Вставить("ЭтоГруппа", НомерКолонки);
		ИначеЕсли ЗагНРег = "код" ИЛИ ЗагНРег = "номенклатура.код" Тогда
			Маппинг.Вставить("Код", НомерКолонки);
		ИначеЕсли ЗагНРег = "наименование" ИЛИ ЗагНРег = "номенклатура.наименование" Тогда
			Маппинг.Вставить("Наименование", НомерКолонки);
		ИначеЕсли СтрНайти(ЗагНРег, "этикетк") > 0 Тогда
			Маппинг.Вставить("НазваниеНаЭтикетке", НомерКолонки);
		ИначеЕсли СтрНайти(ЗагНРег, "единица") > 0 Тогда
			Маппинг.Вставить("ЕдиницаИзмерения", НомерКолонки);
		ИначеЕсли СтрНайти(ЗагНРег, "родитель.код") > 0 Тогда
			Маппинг.Вставить("КодРодителя", НомерКолонки);
		ИначеЕсли СтрНайти(ЗагНРег, "родитель.наименование") > 0 Тогда
			Маппинг.Вставить("НаименованиеРодителя", НомерКолонки);
		КонецЕсли;
	КонецЦикла;
	
	Возврат Маппинг;
	
КонецФункции

// ============================================================
// ИМПОРТ НОМЕНКЛАТУРЫ
// ============================================================

Функция ИмпортироватьНоменклатуру(ТабДок)
	
	Счетчик = 0;
	
	// Шаг 1: Собираем все строки
	МассивГрупп = Новый Массив;
	МассивЭлементов = Новый Массив;
	
	Для НомерСтроки = 2 По ТабДок.ВысотаТаблицы Цикл
		Код = СокрЛП(ТабДок.Область(НомерСтроки, 1).Текст);
		Наименование = СокрЛП(ТабДок.Область(НомерСтроки, 2).Текст);
		НазваниеНаЭтикетке = СокрЛП(ТабДок.Область(НомерСтроки, 3).Текст);
		ЕдИзм = СокрЛП(ТабДок.Область(НомерСтроки, 4).Текст);
		ЭтоГруппаТекст = ВРег(СокрЛП(ТабДок.Область(НомерСтроки, 5).Текст));
		КодРодителя = СокрЛП(ТабДок.Область(НомерСтроки, 6).Текст);
		
		Если ПустаяСтрока(Код) Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаДанных = Новый Структура;
		СтрокаДанных.Вставить("Код", Код);
		СтрокаДанных.Вставить("Наименование", Наименование);
		СтрокаДанных.Вставить("НазваниеНаЭтикетке", НазваниеНаЭтикетке);
		СтрокаДанных.Вставить("ЕдиницаИзмерения", ЕдИзм);
		СтрокаДанных.Вставить("КодРодителя", КодРодителя);
		
		ЭтоГруппа = (ЭтоГруппаТекст = "ДА" ИЛИ ЭтоГруппаТекст = "YES" ИЛИ ЭтоГруппаТекст = "ИСТИНА");
		СтрокаДанных.Вставить("ЭтоГруппа", ЭтоГруппа);
		
		Если ЭтоГруппа Тогда
			МассивГрупп.Добавить(СтрокаДанных);
		Иначе
			МассивЭлементов.Добавить(СтрокаДанных);
		КонецЕсли;
	КонецЦикла;
	
	// Шаг 2: Создаём группы
	КэшГрупп = Новый Соответствие; // Код -> СсылкаГруппы
	
	Для Каждого ДанныеГруппы Из МассивГрупп Цикл
		СсылкаГруппы = НайтиИлиСоздатьГруппу(ДанныеГруппы.Код, ДанныеГруппы.Наименование, ДанныеГруппы.КодРодителя, КэшГрупп);
		Если СсылкаГруппы <> Неопределено Тогда
			КэшГрупп.Вставить(ДанныеГруппы.Код, СсылкаГруппы);
			Счетчик = Счетчик + 1;
		КонецЕсли;
	КонецЦикла;
	
	// Шаг 3: Создаём элементы
	Для Каждого ДанныеЭлемента Из МассивЭлементов Цикл
		
		// Определяем родителя
		Родитель = КэшГрупп[ДанныеЭлемента.КодРодителя];
		Если Родитель = Неопределено И НЕ ПустаяСтрока(ДанныеЭлемента.КодРодителя) Тогда
			// Группа могла быть создана ранее — ищем по коду
			Родитель = Справочники.Номенклатура.НайтиПоКоду(ДанныеЭлемента.КодРодителя);
			Если Родитель.Пустая() Тогда
				// Создаём группу автоматически
				Родитель = НайтиИлиСоздатьГруппу(ДанныеЭлемента.КодРодителя, ДанныеЭлемента.КодРодителя, "", КэшГрупп);
				КэшГрупп.Вставить(ДанныеЭлемента.КодРодителя, Родитель);
			КонецЕсли;
		КонецЕсли;
		
		// Ищем или создаём элемент
		ЭлементСправочника = Справочники.Номенклатура.НайтиПоКоду(ДанныеЭлемента.Код);
		
		Если ЭлементСправочника.Пустая() Тогда
			НовыйОбъект = Справочники.Номенклатура.СоздатьЭлемент();
			НовыйОбъект.Код = ДанныеЭлемента.Код;
		Иначе
			НовыйОбъект = ЭлементСправочника.ПолучитьОбъект();
		КонецЕсли;
		
		НовыйОбъект.Наименование = ДанныеЭлемента.Наименование;
		
		Если Родитель <> Неопределено И НЕ Родитель.Пустая() Тогда
			НовыйОбъект.Родитель = Родитель;
		КонецЕсли;
		
		НовыйОбъект.ЕдиницаИзмерения = ОпределитьЕдиницуИзмерения(ДанныеЭлемента.ЕдиницаИзмерения);
		
		НовыйОбъект.Записать();
		Счетчик = Счетчик + 1;
	КонецЦикла;
	
	Возврат Счетчик;
	
КонецФункции

Функция НайтиИлиСоздатьГруппу(Код, Наименование, КодРодителя, КэшГрупп)
	
	СсылкаГруппы = Справочники.Номенклатура.НайтиПоКоду(Код);
	
	Если НЕ СсылкаГруппы.Пустая() Тогда
		Возврат СсылкаГруппы;
	КонецЕсли;
	
	НоваяГруппа = Справочники.Номенклатура.СоздатьГруппу();
	НоваяГруппа.Код = Код;
	НоваяГруппа.Наименование = Наименование;
	
	// Родитель группы (если указан)
	Если НЕ ПустаяСтрока(КодРодителя) Тогда
		Родитель = КэшГрупп[КодРодителя];
		Если Родитель = Неопределено Тогда
			Родитель = Справочники.Номенклатура.НайтиПоКоду(КодРодителя);
		КонецЕсли;
		Если Родитель <> Неопределено И НЕ Родитель.Пустая() Тогда
			НоваяГруппа.Родитель = Родитель;
		КонецЕсли;
	КонецЕсли;
	
	НоваяГруппа.Записать();
	
	Возврат НоваяГруппа.Ссылка;
	
КонецФункции

Функция ОпределитьЕдиницуИзмерения(Значение)
	
	ЗначениеНРег = НРег(СокрЛП(Значение));
	
	Если ЗначениеНРег = "шт" ИЛИ ЗначениеНРег = "шт." Тогда
		Возврат Перечисления.ЕдиницыИзмерения.шт;
	ИначеЕсли ЗначениеНРег = "кг" ИЛИ ЗначениеНРег = "кг." Тогда
		Возврат Перечисления.ЕдиницыИзмерения.кг;
	ИначеЕсли ЗначениеНРег = "л" ИЛИ ЗначениеНРег = "л." Тогда
		Возврат Перечисления.ЕдиницыИзмерения.л;
	ИначеЕсли ЗначениеНРег = "м" ИЛИ ЗначениеНРег = "м." Тогда
		Возврат Перечисления.ЕдиницыИзмерения.м;
	Иначе
		Возврат Перечисления.ЕдиницыИзмерения.шт;
	КонецЕсли;
	
КонецФункции

// ============================================================
// ИМПОРТ ЦЕН (через документ Переоценка)
// ============================================================

Функция ИмпортироватьЦены(ТабДок)
	
	// Колонки: Номенклатура.Код, Номенклатура.Наименование, Цена
	Счетчик = 0;
	
	ТипЦен = НастройкиПоУмолчанию.ПолучитьОсновнойТипЦен();
	
	ДокументПереоценка = Документы.Переоценка.СоздатьДокумент();
	ДокументПереоценка.Дата = ТекущаяДатаСеанса();
	ДокументПереоценка.ТипЦен = ТипЦен;
	
	Для НомерСтроки = 2 По ТабДок.ВысотаТаблицы Цикл
		КодНоменклатуры = СокрЛП(ТабДок.Область(НомерСтроки, 1).Текст);
		ЦенаТекст = СокрЛП(ТабДок.Область(НомерСтроки, 3).Текст);
		
		Если ПустаяСтрока(КодНоменклатуры) ИЛИ ПустаяСтрока(ЦенаТекст) Тогда
			Продолжить;
		КонецЕсли;
		
		Номенклатура = Справочники.Номенклатура.НайтиПоКоду(КодНоменклатуры);
		Если Номенклатура.Пустая() Тогда
			Продолжить;
		КонецЕсли;
		
		Цена = Число(СтрЗаменить(ЦенаТекст, " ", ""));
		Если Цена <= 0 Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаТовара = ДокументПереоценка.Товары.Добавить();
		СтрокаТовара.Номенклатура = Номенклатура;
		СтрокаТовара.Цена = Цена;
		
		Счетчик = Счетчик + 1;
	КонецЦикла;
	
	Если Счетчик > 0 Тогда
		ДокументПереоценка.Записать(РежимЗаписиДокумента.Проведение);
	КонецЕсли;
	
	Возврат Счетчик;
	
КонецФункции

// ============================================================
// ИМПОРТ ОСТАТКОВ (через документ ИнвентаризацияТоваров)
// ============================================================

Функция ИмпортироватьОстатки(ТабДок)
	
	// Колонки: Номенклатура.Код, Номенклатура.Наименование, Количество Остаток
	Счетчик = 0;
	
	Склад = НастройкиПоУмолчанию.ПолучитьОсновнойСклад();
	
	ДокументИнвентаризация = Документы.ИнвентаризацияТоваров.СоздатьДокумент();
	ДокументИнвентаризация.Дата = ТекущаяДатаСеанса();
	ДокументИнвентаризация.Склад = Склад;
	
	Для НомерСтроки = 2 По ТабДок.ВысотаТаблицы Цикл
		КодНоменклатуры = СокрЛП(ТабДок.Область(НомерСтроки, 1).Текст);
		КоличествоТекст = СокрЛП(ТабДок.Область(НомерСтроки, 3).Текст);
		
		Если ПустаяСтрока(КодНоменклатуры) ИЛИ ПустаяСтрока(КоличествоТекст) Тогда
			Продолжить;
		КонецЕсли;
		
		Номенклатура = Справочники.Номенклатура.НайтиПоКоду(КодНоменклатуры);
		Если Номенклатура.Пустая() Тогда
			Продолжить;
		КонецЕсли;
		
		Количество = Число(СтрЗаменить(КоличествоТекст, " ", ""));
		Если Количество <= 0 Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаТовара = ДокументИнвентаризация.Товары.Добавить();
		СтрокаТовара.Номенклатура = Номенклатура;
		СтрокаТовара.ФактическоеКоличество = Количество;
		СтрокаТовара.УчетноеКоличество = 0; // Начальный ввод остатков
		СтрокаТовара.Отклонение = Количество;
		
		Счетчик = Счетчик + 1;
	КонецЦикла;
	
	Если Счетчик > 0 Тогда
		ДокументИнвентаризация.Записать(РежимЗаписиДокумента.Проведение);
	КонецЕсли;
	
	Возврат Счетчик;
	
КонецФункции

// ============================================================
// ИМПОРТ ШТРИХКОДОВ (в регистр сведений + ТЧ справочника)
// ============================================================

Функция ИмпортироватьШтрихкоды(ТабДок)
	
	// Колонки: Код, Наименование, Штрих код
	Счетчик = 0;
	
	Для НомерСтроки = 2 По ТабДок.ВысотаТаблицы Цикл
		КодНоменклатуры = СокрЛП(ТабДок.Область(НомерСтроки, 1).Текст);
		ШтрихкодТекст = СокрЛП(ТабДок.Область(НомерСтроки, 3).Текст);
		
		Если ПустаяСтрока(КодНоменклатуры) ИЛИ ПустаяСтрока(ШтрихкодТекст) Тогда
			Продолжить;
		КонецЕсли;
		
		Номенклатура = Справочники.Номенклатура.НайтиПоКоду(КодНоменклатуры);
		Если Номенклатура.Пустая() Тогда
			Продолжить;
		КонецЕсли;
		
		// Убираем пробелы из штрихкода
		Штрихкод = СтрЗаменить(ШтрихкодТекст, " ", "");
		
		Если ПустаяСтрока(Штрихкод) Тогда
			Продолжить;
		КонецЕсли;
		
		// Записываем в регистр сведений Штрихкоды
		МенеджерЗаписи = РегистрыСведений.Штрихкоды.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Штрихкод = Штрихкод;
		МенеджерЗаписи.Номенклатура = Номенклатура;
		МенеджерЗаписи.Записать(Истина);
		
		// Добавляем в ТЧ Штрихкоды справочника Номенклатура
		ОбъектНоменклатуры = Номенклатура.ПолучитьОбъект();
		
		// Проверяем дубликат
		ЕстьШтрихкод = Ложь;
		Для Каждого СтрокаШК Из ОбъектНоменклатуры.Штрихкоды Цикл
			Если СтрокаШК.Штрихкод = Штрихкод Тогда
				ЕстьШтрихкод = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если НЕ ЕстьШтрихкод Тогда
			НоваяСтрока = ОбъектНоменклатуры.Штрихкоды.Добавить();
			НоваяСтрока.Штрихкод = Штрихкод;
			ОбъектНоменклатуры.Записать();
		КонецЕсли;
		
		Счетчик = Счетчик + 1;
	КонецЦикла;
	
	Возврат Счетчик;
	
КонецФункции

#КонецОбласти
'''

paths = [
    pathlib.Path(r"D:\Git\Public_Trade_Module\Конфигурация\DataProcessors\ИмпортНоменклатуры\Ext\ObjectModule.bsl"),
    pathlib.Path(r"D:\Git\Public_Trade_Module\Конфигурация\Проверка\DataProcessors\ИмпортНоменклатуры\Ext\ObjectModule.bsl"),
]

for p in paths:
    p.parent.mkdir(parents=True, exist_ok=True)
    p.write_text(bsl_code, encoding='utf-8-sig')
    print(f"  OK: {p.parent.parent.name}/{p.parent.name}/{p.name}")

print("\nDone!")
