Функция ПолучитьНастройкиСканера() Экспорт
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |    КО.Ссылка,
        |    КО.ДрайверID,
        |    КО.Порт,
        |    КО.ПараметрыПодключения
        |ИЗ
        |    Справочник.КассовоеОборудование КАК КО
        |ГДЕ
        |    КО.ТипОборудования = ЗНАЧЕНИЕ(Перечисление.ТипыОборудования.СканерШтрихкода)
        |    И НЕ КО.ПометкаУдаления"; 
        
    Выборка = Запрос.Выполнить().Выбрать();
    
    Если Выборка.Следующий() Тогда
        Рез = Новый Структура;
        Рез.Вставить("ДрайверID", Выборка.ДрайверID);
        
        // Читаем порт прямо из реквизита!
        // Если не заполнен - ставим дефолтный (например, 1)
        НомерПорта = ?(Выборка.Порт = 0, 1, Выборка.Порт);
        
        // Формируем структуру параметров
        // Остальные параметры (скорость, битность) пока оставляем хардкодом или берем дефолтные,
        // так как порт - самое меняющееся значение.
        Рез.Вставить("Параметры", Новый Структура("Port, Speed, DataBits, StopBits", НомерПорта, 9600, 8, 1));
        
        Возврат Рез;
    КонецЕсли;
    
    Возврат Неопределено;

КонецФункции// Функция поиска товаров.
// Возвращает Массив Структур:
// 1. Номенклатура (СправочникСсылка)
// 2. Цена (Число)
// 3. Представление (Строка) - для списка выбора
Функция НайтиТоварыПоШтрихкоду(Знач Штрихкод, Знач ДатаАктуальности) Экспорт
	
	Результат = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Штрихкоды.Номенклатура КАК Номенклатура,
		|	Штрихкоды.Номенклатура.Наименование КАК Наименование
		|ИЗ
		|	РегистрСведений.Штрихкоды КАК Штрихкоды
		|ГДЕ
		|	Штрихкоды.Штрихкод = &Штрихкод";
	
	Запрос.УстановитьПараметр("Штрихкод", СокрЛП(Штрихкод));
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ЦенаТовара = ПолучитьРозничнуюЦену(ДатаАктуальности, Выборка.Номенклатура);
		
		СтруктураТовара = Новый Структура;
		СтруктураТовара.Вставить("Номенклатура", Выборка.Номенклатура);
		СтруктураТовара.Вставить("Цена", ЦенаТовара);
		
		// Формируем красивое название для списка: "Молоко (120 руб.)"
		СтруктураТовара.Вставить("Представление", 
			Строка(Выборка.Наименование) + " [" + ЦенаТовара + " руб.]");
		
		Результат.Добавить(СтруктураТовара);
		
	КонецЦикла;
	
	Возврат Результат;

КонецФункции// Эту функцию мы писали ранее, она тоже должна быть здесь
Функция ПолучитьРозничнуюЦену(АктуальнаяДата, Номенклатура) Экспорт
	
	ТипЦенСсылка = Справочники.ТипыЦен.НайтиПоНаименованию("Розничная");
	
	Если ТипЦенСсылка.Пустая() Тогда
		Возврат 0; 
	КонецЕсли;
	
	Отбор = Новый Структура("Номенклатура, ТипЦен", Номенклатура, ТипЦенСсылка);
	ЗначенияРесурсов = РегистрыСведений.ЦеныНоменклатуры.ПолучитьПоследнее(АктуальнаяДата, Отбор);
	
	Если ЗначенияРесурсов.Цена <> Неопределено Тогда
		Возврат ЗначенияРесурсов.Цена;
	Иначе
		Возврат 0;
	КонецЕсли;

КонецФункции

// =============================================================================
// ГЛОБАЛЬНЫЙ ПОИСК ТОВАРОВ
// =============================================================================

// Функция: НайтиТовар
// Назначение: Универсальный поиск товара по Штрихкоду, Коду или Артикулу.
// Параметры:
//  СтрокаПоиска - Строка - Данные со сканера или ручной ввод.
// Возвращает:
//  СправочникСсылка.Номенклатура - если найден уникальный товар.
//  Массив - если найдено несколько товаров (дубли штрихкодов или совпадение артикулов).
//  Неопределено - если ничего не найдено.
//
Функция НайтиТовар(Знач СтрокаПоиска) Экспорт
	
	Если ПустаяСтрока(СтрокаПоиска) Тогда Возврат Неопределено; КонецЕсли;
	
	СтрокаПоиска = СокрЛП(СтрокаПоиска);
	
	// --- ЭТАП 1: ПОИСК ПО ШТРИХКОДУ (Приоритет) ---
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Штрихкоды.Номенклатура КАК Номенклатура
		|ИЗ
		|	РегистрСведений.Штрихкоды КАК Штрихкоды
		|ГДЕ
		|	Штрихкоды.Штрихкод = &СтрокаПоиска";
		
	Запрос.УстановитьПараметр("СтрокаПоиска", СтрокаПоиска);
	Результат = Запрос.Выполнить();
	
	Если Не Результат.Пустой() Тогда
		
		Выборка = Результат.Выбрать();
		
		// Если найден ровно 1 товар
		Если Результат.Выгрузить().Количество() = 1 Тогда
			Выборка.Следующий();
			Возврат Выборка.Номенклатура;
		Иначе
			// Если найдено несколько (коллизия штрихкодов), возвращаем массив для выбора
			СписокТоваров = Новый Массив;
			Пока Выборка.Следующий() Цикл
				СписокТоваров.Добавить(Выборка.Номенклатура);
			КонецЦикла;
			Возврат СписокТоваров;
		КонецЕсли;
		
	КонецЕсли;
	
	// --- ЭТАП 2: ПОИСК ПО КОДУ ИЛИ АРТИКУЛУ (Fallback) ---
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	(Номенклатура.Код = &СтрокаПоиска
		|	ИЛИ Номенклатура.Артикул = &СтрокаПоиска)";
		
	Запрос.УстановитьПараметр("СтрокаПоиска", СтрокаПоиска);
	Результат = Запрос.Выполнить();
	
	Если Не Результат.Пустой() Тогда
		
		Выборка = Результат.Выбрать();
		
		Если Результат.Выгрузить().Количество() = 1 Тогда
			Выборка.Следующий();
			Возврат Выборка.Ссылка;
		Иначе
			СписокТоваров = Новый Массив;
			Пока Выборка.Следующий() Цикл
				СписокТоваров.Добавить(Выборка.Ссылка);
			КонецЦикла;
			Возврат СписокТоваров;
		КонецЕсли;
		
	КонецЕсли;
	
	// Ничего не найдено
	Возврат Неопределено;

КонецФункции