// Получает актуальную розничную цену на дату
Функция ПолучитьРозничнуюЦену(АктуальнаяДата, Номенклатура) Экспорт
	
	// 1. Находим тип цен "Розничная"
	// В идеале - кэшировать это значение в параметрах сеанса, но для старта ищем по коду/наименованию
	// Важно: Убедитесь, что в Предприятии создали ТипЦен с именем "Розничная"
	ТипЦенСсылка = Справочники.ТипыЦен.НайтиПоНаименованию("Розничная");
	
	Если ТипЦенСсылка.Пустая() Тогда
		Возврат 0; // Тип цен не найден
	КонецЕсли;
	
	// 2. Получаем срез последних
	Отбор = Новый Структура("Номенклатура, ТипЦен", Номенклатура, ТипЦенСсылка);
	ЗначенияРесурсов = РегистрыСведений.ЦеныНоменклатуры.ПолучитьПоследнее(АктуальнаяДата, Отбор);
	
	Если ЗначенияРесурсов.Цена <> Неопределено Тогда
		Возврат ЗначенияРесурсов.Цена;
	Иначе
		Возврат 0;
	КонецЕсли;

КонецФункции 

// Ищет товары по штрихкоду. Возвращает Массив Структур (Номенклатура, Цена).
Функция НайтиТоварыПоШтрихкоду(Знач Штрихкод, Знач ДатаАктуальности) Экспорт
	
	Результат = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Штрихкоды.Номенклатура КАК Номенклатура
		|ИЗ
		|	РегистрСведений.Штрихкоды КАК Штрихкоды
		|ГДЕ
		|	Штрихкоды.Штрихкод = &Штрихкод";
	
	Запрос.УстановитьПараметр("Штрихкод", СокрЛП(Штрихкод));
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ДанныеТовара = Новый Структура;
		ДанныеТовара.Вставить("Номенклатура", Выборка.Номенклатура);
		// Сразу получаем цену, чтобы не делать лишний вызов
		ДанныеТовара.Вставить("Цена", ПолучитьРозничнуюЦену(ДатаАктуальности, Выборка.Номенклатура));
		
		Результат.Добавить(ДанныеТовара);
	КонецЦикла;
	
	Возврат Результат;

КонецФункции