// ОбщийМодуль.МенеджерОборудования
// Свойства модуля: [x] Клиент (упр. прил), [x] Сервер

// ---------------------------------------------------------
// ВЕСЬ код работы с оборудованием оборачиваем в условие,
// чтобы сервер его "не видел" и не ругался на ОписаниеОповещения.
// ---------------------------------------------------------
#Если Клиент Тогда

Процедура ПодключитьСканер() Экспорт
	
	ДанныеСканера = ОбщегоНазначения.ПолучитьНастройкиСканера();
	
	Если ДанныеСканера = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// COM-драйвер работает синхронно и просто
	Попытка
		// Старый ProgID для ScanOPOS.dll
		ДрайверОбъект = Новый COMОбъект("Scanner.ScanOPOS");
		
		ДрайверОбъект.Open(); // В старом драйвере метод открытия обязателен
		
		// Настройка
		Параметры = ДанныеСканера.Параметры;
		ДрайверОбъект.Port = Параметры.Port;
		ДрайверОбъект.Speed = Параметры.Speed;
		ДрайверОбъект.DataBits = Параметры.DataBits;
		ДрайверОбъект.StopBits = Параметры.StopBits;
		
		// Подписка на событие (у старого драйвера имя события "Scan")
		ДобавитьОбработчик ДрайверОбъект.Scan, ОбработчикСобытияСканирования;
		
		// Включение
		ДрайверОбъект.DeviceEnabled = Истина;
		
		глДрайверСканера = ДрайверОбъект;
		Сообщить("Старый COM-сканер подключен (COM" + Параметры.Port + ")!");
		
	Исключение
		Сообщить("Не удалось создать объект Scanner.ScanOPOS! Выполните regsvr32 ScanOPOS.dll. Ошибка: " + ОписаниеОшибки());
	КонецПопытки;

КонецПроцедуры

// Обработчик события для COM-драйвера (специфичный для старой DLL)
Процедура ОбработчикСобытияСканирования(Данные) Экспорт
	
	// Эмулируем стандартное ВнешнееСобытие для нашей формы
	// Так как COM-драйвер не кидает ExternalEvent, а вызывает процедуру
	// Нам нужно "пробросить" штрихкод в активную форму.
	
	// Вариант 1: Оповестить форму через Оповестить()
	Оповестить("ВнешнееСобытие", Новый Структура("Event, Data", "BarCode", Данные), "Scanner");
	
КонецПроцедуры

// Обработчик завершения подключения
Процедура ПослеПодключенияКомпоненты(Подключено, ДопПараметры) Экспорт
	
	Если Не Подключено Тогда
        // Если все равно не работает - значит драйвер не установлен или имеет другое имя
        Сообщить("Не удалось подключить компоненту сканера (Async)! Проверьте установку драйвера.");
        Возврат;
	КонецЕсли;	   
	
	Попытка
		// 4. Создаем объект драйвера
		ДрайверОбъект = Новый("AddIn.Scanner.CScanner");
		
		// 5. Настраиваем (берем настройки, которые мы протащили через ДопПараметры)
		Параметры = ДопПараметры.Настройки;
		
		ДрайверОбъект.Port = Параметры.Port;       // Наш новый реквизит "Порт"
		ДрайверОбъект.Speed = Параметры.Speed;
		ДрайверОбъект.DataBits = Параметры.DataBits;
		ДрайверОбъект.StopBits = Параметры.StopBits;
		
		ДрайверОбъект.DeviceEnabled = Истина;
		ДрайверОбъект.DataEventEnabled = Истина;
		
		// 6. Сохраняем в глобальную переменную (в модуле приложения)
		глДрайверСканера = ДрайверОбъект;
		
		Сообщить("Сканер успешно подключен (COM" + Параметры.Port + ")!");
		
	Исключение
		Сообщить("Ошибка инициализации объекта сканера: " + ОписаниеОшибки());
	КонецПопытки;

КонецПроцедуры

// --- БЛОК ККТ (ПЕЧАТЬ) ---
// Его тоже нужно оставить внутри #Если Клиент

Процедура НапечататьЧек(Знач ОборудованиеСсылка, Знач ДанныеЧека) Экспорт
	
	// Используем глобальный кэш
	КэшДрайверов = глКэшДрайверовККТ; 
	Драйвер = ПолучитьДрайверККТ(ОборудованиеСсылка, КэшДрайверов);
	
	Если Драйвер = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// ... (Сюда вставьте ваш код печати чека: OpenCheck, Register и т.д.) ...
    
КонецПроцедуры

Функция ПолучитьДрайверККТ(ОборудованиеСсылка, КэшДрайверов)
    // ... (код получения/создания драйвера ККТ) ...
    Возврат Неопределено; // Заглушка, замените на реальный код
КонецФункции

#КонецЕсли