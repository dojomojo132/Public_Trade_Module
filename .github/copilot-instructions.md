# 1C:Enterprise 8.3.27 Development Agent

> **Роль:** Senior 1C Developer | **Платформа:** 8.3.27 | **Режим:** Strict

---

## 1. ПРИОРИТЕТ ДОКУМЕНТАЦИИ

| # | Документ | Путь |
|---|----------|------|
| 1 | Техническая спецификация (Единственный источник истины) | `Документация/Спецификации/ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ КОНФИГУРАЦИИ PTM (Public Trade Module).xml` |
| 2 | Алгоритм разработки | `Документация/Спецификации/Алгоритм разработки.xml` |
| 3 | Стандарты 1С (синтаксис, именование, запросы, транзакции) | `Документация/Технические_стандарты/1c-standards-8.3.27.md` |
| 4 | XML-структура конфигурации | `Документация/Технические_стандарты/xml-structure-8.3.27.md` |
| 5 | Элементы форм | `Документация/Технические_стандарты/form-elements.md` |
| 6 | XML-шаблоны (копировать и заполнять!) | `Документация/Шаблоны/*.xml` |
| 7 | Скрипт валидации (запускать перед загрузкой!) | `Документация/Валидация/validate-config.ps1` |
| 8 | Скрипт деплоя (загрузка → проверка → запуск) | `Документация/Валидация/deploy-config.ps1` |
| 9 | Мониторинг ошибок (ТЖ + ЖР, авто-отлов runtime) | `Документация/Валидация/monitor-errors.ps1` |

---

## 2. MCP-ИНСТРУМЕНТЫ

### 2.1 Обязательные проверки ПЕРЕД написанием кода

| Что проверить | Инструмент |
|---------------|------------|
| Существование объекта метаданных | `mcp_mcp_1c_torgov_list_metadata_objects` |
| Структура объекта (реквизиты, ТЧ, измерения) | `mcp_mcp_1c_torgov_get_metadata_structure` |
| Точное имя формы | `file_search` по `**/Forms/**/` |

### 2.2 Обязательные проверки ПОСЛЕ написания кода

| Что проверить | Инструмент |
|---------------|------------|
| Синтаксические ошибки BSL | `get_errors` на файл .bsl |
| Диагностики BSL Language Server | `get_errors` на файл .bsl |
| Валидность XML | `get_errors` на файл .xml |
| Целостность конфигурации | `run_in_terminal` → `validate-config.ps1` |

**КРИТИЧНО:** После генерации любого .bsl файла — ВСЕГДА вызвать `get_errors` и исправить все найденные проблемы до выдачи результата.

### 2.3 Правила

```
❌ ЗАПРЕЩЕНО: угадывать имена полей/объектов/форм
❌ ЗАПРЕЩЕНО: выдавать код без проверки через get_errors
❌ ЗАПРЕЩЕНО: создавать объект метаданных без обновления Configuration.xml И ConfigDumpInfo.xml
✅ ОБЯЗАТЕЛЬНО: сначала запросить через MCP, потом писать код
✅ ОБЯЗАТЕЛЬНО: после написания — проверить через get_errors
✅ ОБЯЗАТЕЛЬНО: для XML — брать шаблон из Документация/Шаблоны/
✅ ОБЯЗАТЕЛЬНО: запустить validate-config.ps1 перед деплоем
✅ ОБЯЗАТЕЛЬНО: запустить deploy-config.ps1 -Action Full в рамках запроса
✅ ОБЯЗАТЕЛЬНО: при успехе — открыть конфигуратор (deploy-config.ps1 -Action Designer)
⚠️ ВАЖНО: MCP-сервер возвращает объекты расширения с префиксом `mcp_` — их ИГНОРИРОВАТЬ, НЕ создавать файлы на диске
```

---

## 3. АЛГОРИТМ РАБОТЫ (ВСЕГДА В РАМКАХ ОДНОГО ЗАПРОСА)

**КРИТИЧНО:** Каждый запрос пользователя = полный цикл от реализации до подтверждения пользователем. НИКОГДА не останавливаться на этапе "Файлы созданы".

```
ФАЗА 0: ЗАЩИТА ДАННЫХ (АВТОМАТИЧЕСКИ!)
  ЭТАП 0: БЭКАП     → deploy-config.ps1 -Action Backup ИЛИ автоматически в -Action Full
                      Создаёт .dt копию ИБ: данные, пользователи, MCP-настройки
      ↓
ФАЗА 0.5: НАЧАЛО СЕССИИ (при запросе "начать сессию")
  ЭТАП 0.5: ДИАЛОГ 3  → ask_questions:
                       1. "Мониторинг ошибок"   → Сразу к ФАЗЕ 4 (ЭТАП 9)
                       2. "Новый запрос" + поле ввода → ФАЗА 1 с указанным запросом
      ↓
ФАЗА 1: РЕАЛИЗАЦИЯ
  ЭТАП 1: АНАЛИЗ       → Изучить запрос → Проверить спецификацию → Уточнить неясности
  ЭТАП 2: ВЕРИФИКАЦИЯ  → MCP → Проверить метаданные → Сверить с DataModel
  ЭТАП 3: НАПИСАНИЕ     → BSL-код + XML из шаблонов + get_errors
  ЭТАП 4: MULTI-FILE    → Configuration.xml + ConfigDumpInfo.xml + Подсистемы
      ↓
ФАЗА 2: ДЕПЛОЙ И ОТЛАДКА (АВТОМАТИЧЕСКИ!)
  ЭТАП 5: ДЕПЛОЙ       → deploy-config.ps1 -Action Full (бэкап включён!)
  ЭТАП 6: ОТЛАДКА      → Разобрать ошибки → Исправить → Повторить деплой
                        ↻ ЦИКЛ пока не будет 0 ошибок
  ЭТАП 6а: ОТКАТ     → Если ошибки критичны и не решаются:
                        deploy-config.ps1 -Action Rollback → восстановить ИБ
                        Исправить XML/BSL → Повторить деплой заново
      ↓
ФАЗА 3: ЗАВЕРШЕНИЕ
  ЭТАП 7: КОНФИГУРАТОР → Конфигуратор открыт (автоматически в Full)
  ЭТАП 8: ДОКУМЕНТАЦИЯ → Обновить спецификацию → Добавить Record в History
      ↓
ФАЗА 4: НЕПРЕРЫВНЫЙ МОНИТОРИНГ (НЕ ЗАКРЫВАТЬ ЗАПРОС!)
  ЭТАП 9: МОНИТОРИНГ → monitor-errors.ps1 -Action Check [-LastMinutes 5]
                       Автоматически читает ошибки из ТЖ и Журнала регистрации
      ↓
  ЭТАП 10: РЕШЕНИЕ   → Если монитор нашёл ошибки:
                       Исправить BSL/XML → Деплой → НАЗАД К ЭТАПУ 9
                       ↻ ЦИКЛ: фикс → деплой → мониторинг → фикс...
      ↓
  ЭТАП 11: ДИАЛОГ    → Если ошибок нет — ДИАЛОГ 1 (ask_questions):
                       1. "Всё работает корректно"  → ЭТАП 11а (ДИАЛОГ 2)
                       2. "Есть ошибка, проверь журналы" → ЭТАП 12
                       3. "Нужно больше времени"    → СТОП мониторинга
      ↓
  ЭТАП 11а: ДИАЛОГ 2 → После подтверждения "Всё работает" — ДИАЛОГ 2:
                       1. "Остановить работу"        → ЗАВЕРШЕНИЕ ✔
                       2. "Новый запрос" + поле ввода → ОЧИСТКА КОНТЕКСТА:
                          a) Сбросить todo-лист (manage_todo_list с пустым массивом)
                          b) Забыть предыдущий запрос — новый запрос = новая задача
                          c) Начать полный цикл Фаза 1-4 с чистого листа
      ↓
  ЭТАП 12: ФИКСЫ     → Если пользователь выбрал "Есть ошибка, проверь журналы":
                       Агент читает monitor-errors.ps1 → Находит ошибку
                       → Исправить → Деплой → НАЗАД К ЭТАПУ 9
```

> **Агент ОБЯЗАН** выполнить все 4 фазы в рамках одного запроса.
> Мониторинг останавливается ТОЛЬКО при выборе "Нужно больше времени" или "Остановить работу".

### 3.0 Защита данных (КРИТИЧНО!)

**Проблема:** Ошибки в XML/BSL могут сломать конфигурацию. Ранее это приводило к потере данных:
- Пользователи ИБ
- Настройки MCP-сервера
- Содержимое базы (справочники, документы, регистры)

**Решение:** Бэкап .dt ПЕРЕД каждым деплоем. Откат при ошибках.

```
БЭКАП (.dt) → ДЕПЛОЙ → УСПЕХ? → Маркер стабильности ✔
                     ↓ НЕТ
               ОТКАТ (.dt) → Исправить → ДЕПЛОЙ заново
```

**Правила отката:**
1. Если деплой провалился и ошибки не решаются за 2 попытки — ОТКАТИТЬ
2. Если EXIT_CODE = -2 (таймаут) — ОТКАТИТЬ немедленно
3. После отката — исправить XML/BSL и попробовать деплой заново
4. НИКОГДА не пересоздавать ИБ с нуля (CREATEINFOBASE) без явного разрешения пользователя

### 3.1 Команды деплоя

```powershell
# Полный цикл: БЭКАП → валидация XML → загрузка → синтакс-контроль → обновление БД → конфигуратор
deploy-config.ps1 -Action Full

# Только создать бэкап текущей ИБ
deploy-config.ps1 -Action Backup

# Откат к последнему стабильному бэкапу
deploy-config.ps1 -Action Rollback

# Только открыть конфигуратор
deploy-config.ps1 -Action Designer

# Показать информацию о среде
deploy-config.ps1 -Action Info
```

### 3.2 Порядок запуска деплоя (КРИТИЧНО!)

```powershell
# Из-за проблем с кириллицей в PowerShell — использовать Get-ChildItem для поиска:
$script = Get-ChildItem -Path "D:\Git\Public_Trade_Module" -Recurse -Filter "deploy-config.ps1" | Select-Object -First 1
powershell -ExecutionPolicy Bypass -File $script.FullName -Action Full
```

**КРИТИЧНО:** При ошибках загрузки — скрипт выводит структурированный блок ошибок. Агент ОБЯЗАН:
1. Найти блок `=== ОШИБКИ (для Copilot Agent) ===` в выводе
2. Прочитать ВСЕ секции: `--- ОШИБКИ ---`, `--- ПОЛНЫЙ ЛОГ 1С ---`, `--- STDOUT ---`, `--- STDERR ---`
3. Разобрать КАЖДУЮ конкретную ошибку (номерованный список `[1]`, `[2]`...)
4. Исправить XML/BSL файлы
5. Запустить деплой повторно
6. Повторять цикл пока Deploy не завершится УСПЕШНО (exit code 0)
7. НЕ останавливаться если ошибки непонятны — анализировать ПОЛНЫЙ ЛОГ 1С
8. **Если ошибки не решаются за 2 попытки — ОТКАТИТЬ:** `deploy-config.ps1 -Action Rollback`
9. После отката — исправить XML/BSL и попробовать деплой заново

### 3.3 Расшифровка типичных ошибок деплоя

| Ошибка в логе | Причина | Что исправить |
|--------------|---------|---------------|
| `[ДИАЛОГ ЗАБЛОКИРОВАН] Запрещено использование окон` | 1С пыталась показать диалог-ошибку, но он заблокирован | Критическая ошибка XML-структуры. Запустить validate-config.ps1, исправить ВСЕ [ОШИБКА] |
| `[ПУСТОЙ ЛОГ]` | Лог-файл пуст после неудачной операции | Проверить путь к ИБ, права доступа, наличие 1cv8.exe |
| `[НЕ РАСПОЗНАНО]` | Парсер не нашёл конкретных ошибок | Читать секцию `--- ПОЛНЫЙ ЛОГ 1С ---` целиком |
| `[ТАЙМАУТ]` | Процесс 1С завис (вероятно на диалоге) | XML-структура содержит критическую ошибку |
| `{Модуль(строка, колонка)}: текст` | Ошибка BSL-кода | Исправить BSL в указанном модуле на указанной строке |
| `EXIT_CODE: 1` | Общая ошибка загрузки | Смотреть детали в ПОЛНОМ ЛОГЕ |
| `EXIT_CODE: -2` | Таймаут (процесс убит) | XML критически повреждён → ОТКАТИТЬ немедленно |
| `EXIT_CODE: 10` | Бэкап не удался | Деплой отменён. Проверить доступ к ИБ |

### 3.4 Мониторинг ошибок (Фаза 4)

```powershell
# Однократная настройка ТЖ (нужны права администратора):
$script = Get-ChildItem -Path "D:\Git\Public_Trade_Module" -Recurse -Filter "monitor-errors.ps1" | Select-Object -First 1
powershell -ExecutionPolicy Bypass -File $script.FullName -Action Setup

# Проверка ошибок за последние N минут (ТЖ + Журнал регистрации):
$script = Get-ChildItem -Path "D:\Git\Public_Trade_Module" -Recurse -Filter "monitor-errors.ps1" | Select-Object -First 1
powershell -ExecutionPolicy Bypass -File $script.FullName -Action Check -LastMinutes 30

# Показать состояние мониторинга:
powershell -ExecutionPolicy Bypass -File $script.FullName -Action Status

# Выключить ТЖ (после завершения отладки):
powershell -ExecutionPolicy Bypass -File $script.FullName -Action Stop
```

**Два источника ошибок:**
1. **Технологический журнал (ТЖ)** — ловит EXCP (runtime-исключения). Нужна однократная настройка (Setup).
2. **Журнал регистрации (ЖР)** — читает ошибки из .lgp файлов базы. Работает без настройки.

**Workflow мониторинга (ЭТАП 9-12) — НЕПРЕРЫВНЫЙ ЦИКЛ:**
```
СТАРТОВЫЙ ДИАЛОГ 3 ("начать сессию"):
│   ├── "Мониторинг ошибок" → ↓ (ЭТАП 9)
│   └── "Новый запрос" [текст] → ФАЗА 1-4 → ↓ (ЭТАП 9)
│
┌─→ ЭТАП 9: monitor-errors.ps1 -Action Check -LastMinutes 5
│       ├── Ошибки найдены? → ЭТАП 10: Исправить → Деплой → ↑ (назад к 9)
│       └── Ошибок нет?    → ЭТАП 11: ДИАЛОГ 1
│                               ├── "Всё работает"      → ЭТАП 11а: ДИАЛОГ 2
│                               │       ├── "Остановить работу"  → ЗАВЕРШЕНИЕ ✔
│                               │       └── "Новый запрос" [текст] → ОЧИСТКА → Фаза 1-4 → ↑
│                               ├── "Есть ошибка, проверь" → ЭТАП 12: check → фикс → деплой → ↑
│                               └── "Нужно больше времени" → СТОП мониторинга
└───────────────────────────────────────────────────────────────────────────────┘
```

**КРИТИЧНО:** Агент ОБЯЗАН использовать инструмент `ask_questions` для ВСЕХ диалогов.

**ДИАЛОГ 3** (стартовый — при запросе "начать сессию" / "запускай" / "старт"):
- **"Мониторинг ошибок"** — сразу переход к ФАЗЕ 4 (ЭТАП 9: мониторинг → ДИАЛОГ 1)
- **"Новый запрос"** — поле ввода (allowFreeformInput: true). Текст запроса → ФАЗА 1 (полный цикл)

**ДИАЛОГ 1** (после мониторинга без ошибок):
- **"Всё работает корректно"** — переход к ДИАЛОГУ 2 (выбор следующего действия)
- **"Есть ошибка, проверь журналы"** — агент сам читает журналы, находит и фиксит ошибку
- **"Нужно больше времени"** — мониторинг останавливается, пользователь продолжит позже

**ДИАЛОГ 2** (после подтверждения "Всё работает"):
- **"Остановить работу"** — полное завершение сессии
- **"Новый запрос"** — поле ввода (allowFreeformInput: true). **ОЧИСТКА КОНТЕКСТА:**
  1. Сбросить todo-лист (`manage_todo_list` с пустым массивом `[]`)
  2. Не ссылаться на предыдущий запрос — новый запрос = новая изолированная задача
  3. Заново анализировать метаданные через MCP (не полагаться на кэш предыдущего запроса)
  4. Начать полный цикл Фаза 1-4 с чистого листа

После ЛЮБОГО фикса (монитор или пользователь) → деплой → ОБЯЗАТЕЛЬНО снова мониторинг (ЭТАП 9).

---

## 4. НЕГАТИВНЫЙ СЛОВАРЬ (частые ошибки агента)

### 4.1 BSL — несуществующие функции и конструкции

| ❌ ОШИБКА (не существует) | ✅ ПРАВИЛЬНО | Комментарий |
|---------------------------|-------------|-------------|
| `ЗначениеВСтроку()` | `ЗначениеВСтрокуВнутр()` | Полное имя с "Внутр" |
| `СтрокаВЗначение()` | `ЗначениеИзСтрокиВнутр()` | Полное имя с "Внутр" |
| `Новая Структура` | `Новый Структура` | В BSL всегда `Новый` |
| `Новая Массив` | `Новый Массив` | В BSL всегда `Новый` |
| `Новая Запрос` | `Новый Запрос` | В BSL всегда `Новый` |
| `Новая Соответствие` | `Новый Соответствие` | В BSL всегда `Новый` |
| `ТекущаяДата()` | `ТекущаяДатаСеанса()` | Устаревший метод |
| `Найти()` | `СтрНайти()` | Устаревший метод строк |
| `Сообщить()` | `СообщениеПользователю` с привязкой к полям | Не рекомендуется |
| `ЭтаФорма` | `ЭтотОбъект` | Устаревшее свойство |
| `Вопрос()` | `ВопросАсинх()` / `ПоказатьВопрос()` | Модальный вызов |
| `Предупреждение()` | `ПредупреждениеАсинх()` | Модальный вызов |
| `ОткрытьФормуМодально()` | `ОткрытьФормуАсинх()` | Модальный вызов |
| `ВвестиЧисло()` | `ВвестиЧислоАсинх()` | Модальный вызов |
| `ВвестиСтроку()` | `ВвестиСтрокуАсинх()` | Модальный вызов |

### 4.2 BSL — конструкция `Новый`

> **Правило:** В BSL ключевое слово `Новый` — **ЕДИНСТВЕННАЯ** допустимая форма. `Новая` и `Новое` — **синтаксические ошибки**.

| ❌ НЕ существует | ✅ ПРАВИЛЬНО |
|-----------------|-------------|
| `Новая БлокировкаДанных` | `Новый БлокировкаДанных` |
| `Новое Соответствие` | `Новый Соответствие` |
| `Новое ОписаниеОповещения` | `Новый ОписаниеОповещения` |

Примеры: `Новый Массив`, `Новый Запрос`, `Новый Структура`, `Новый Соответствие`, `Новый ТаблицаЗначений`, `Новый БлокировкаДанных`.

### 4.3 XML — частые ошибки

| ❌ ОШИБКА | ✅ ПРАВИЛЬНО |
|-----------|-------------|
| Неполный набор xmlns | Копировать ВЕСЬ заголовок из шаблона `Документация/Шаблоны/` |
| `version="2.0"` | `version="2.20"` |
| Отсутствие InternalInfo/GeneratedType | Обязательно для справочников, документов, регистров |
| UUID не в формате | `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` (lowercase hex) |
| Пропущенные дочерние элементы | ContextMenu, ExtendedTooltip для каждого элемента формы |
| Не обновлён Configuration.xml | Добавить `<ТипОбъекта>Имя</ТипОбъекта>` в `<ChildObjects>` |
| Не обновлён ConfigDumpInfo.xml | Добавить `<Metadata name="Тип.Имя" id="UUID">` |
| Дублирующиеся id элементов формы | Каждый id уникален внутри Form.xml |
| `FillFromFillingValue`/`FillValue` у обработки | Эти свойства НЕ существуют для DataProcessor.Attribute! Только для Document/Catalog |

---

## 5. ПРАВИЛА ГЕНЕРАЦИИ XML

### 5.1 Обязательный порядок

1. **Взять шаблон** из `Документация/Шаблоны/` (template-catalog.xml, template-document.xml, template-form.xml и т.д.)
2. **Скопировать заголовок целиком** (все xmlns)
3. **Заменить плейсхолдеры** `{{...}}` реальными значениями
4. **Для UUID** — генерировать уникальные в формате `xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`
5. **Для id элементов формы** — использовать последовательную нумерацию начиная с 1, AutoCommandBar формы = -1
6. **Проверить** через `get_errors`

### 5.2 Эталонный заголовок MetaDataObject (из реальных файлов проекта)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<MetaDataObject xmlns="http://v8.1c.ru/8.3/MDClasses"
    xmlns:app="http://v8.1c.ru/8.2/managed-application/core"
    xmlns:cfg="http://v8.1c.ru/8.1/data/enterprise/current-config"
    xmlns:cmi="http://v8.1c.ru/8.2/managed-application/cmi"
    xmlns:ent="http://v8.1c.ru/8.1/data/enterprise"
    xmlns:lf="http://v8.1c.ru/8.2/managed-application/logform"
    xmlns:style="http://v8.1c.ru/8.1/data/ui/style"
    xmlns:sys="http://v8.1c.ru/8.1/data/ui/fonts/system"
    xmlns:v8="http://v8.1c.ru/8.1/data/core"
    xmlns:v8ui="http://v8.1c.ru/8.1/data/ui"
    xmlns:web="http://v8.1c.ru/8.1/data/ui/colors/web"
    xmlns:win="http://v8.1c.ru/8.1/data/ui/colors/windows"
    xmlns:xen="http://v8.1c.ru/8.3/xcf/enums"
    xmlns:xpr="http://v8.1c.ru/8.3/xcf/predef"
    xmlns:xr="http://v8.1c.ru/8.3/xcf/readable"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    version="2.20">
```

---

## 6. ПРАВИЛА BSL-КОДА (краткая сводка)

Полные стандарты: `Документация/Технические_стандарты/1c-standards-8.3.27.md`

- **Асинхронность:** ТОЛЬКО `Асинх`/`Ждать` на клиенте. Никаких модальных вызовов.
- **Директивы:** Каждый метод имеет `&НаКлиенте` / `&НаСервере` / `&НаСервереБезКонтекста`.
- **Области:** Весь код внутри `#Область ... #КонецОбласти`.
- **Именование:** Русский CamelCase. Глагол+Существительное для методов.
- **Запросы:** Псевдонимы, `ЕСТЬNULL`, параметры, НИКОГДА в циклах.
- **Транзакции:** `НачатьТранзакцию() → Попытка → ЗафиксироватьТранзакцию() / ОтменитьТранзакцию()`.
- **Сериализация:** `ЗначениеВСтрокуВнутр()` / `ЗначениеИзСтрокиВнутр()` — НЕ `ЗначениеВСтроку`.

---

## 7. ОБНОВЛЕНИЕ СПЕЦИФИКАЦИИ

При любом изменении — обновить затронутые блоки + добавить:
```xml
<Record date="YYYY-MM-DD">Описание изменения</Record>
```

Шаблон нового объекта:
```xml
<Object name="Имя" type="Тип">
    <Purpose><Content>Описание.</Content></Purpose>
    <DataModel><Fields><Field name="Имя" type="Тип">Описание</Field></Fields></DataModel>
    <Logic><Items><Item>Алгоритм</Item></Items></Logic>
    <History><Record date="YYYY-MM-DD">Создание.</Record></History>
</Object>
```

---

## 8. ФАЙЛОВАЯ СТРУКТУРА КОНФИГУРАЦИИ

Рабочая папка: `Конфигурация/`

### 8.1 Маппинг типов → папок

| Тип в Configuration.xml | Папка на диске | Примечание |
|------------------------|----------------|------------|
| `<Catalog>Имя</Catalog>` | `Catalogs/Имя.xml` + `Catalogs/Имя/` | Папка если есть формы/модули |
| `<Document>Имя</Document>` | `Documents/Имя.xml` + `Documents/Имя/` | Всегда папка |
| `<Enum>Имя</Enum>` | `Enums/Имя.xml` | Папка если есть предопределённые |
| `<Report>Имя</Report>` | `Reports/Имя.xml` + `Reports/Имя/` | |
| `<DataProcessor>Имя</DataProcessor>` | `DataProcessors/Имя.xml` + `DataProcessors/Имя/` | |
| `<CommonModule>Имя</CommonModule>` | `CommonModules/Имя.xml` + `CommonModules/Имя/Ext/Module.bsl` | |
| `<AccumulationRegister>Имя</AccumulationRegister>` | `AccumulationRegisters/Имя.xml` | Папка если есть модуль |
| `<InformationRegister>Имя</InformationRegister>` | `InformationRegisters/Имя.xml` | |
| `<Constant>Имя</Constant>` | `Constants/Имя.xml` | |
| `<Subsystem>Имя</Subsystem>` | `Subsystems/Имя.xml` | |

### 8.2 Структура объекта с формой

```
Documents/                              (или Catalogs/, DataProcessors/)
  НовыйДокумент.xml                    ← XML описание объекта
  НовыйДокумент/
    Ext/
      ObjectModule.bsl                  ← Модуль объекта
      ManagerModule.bsl                 ← Модуль менеджера (опционально)
    Forms/
      ФормаДокумента.xml               ← XML описатель формы (ссылка)
      ФормаДокумента/
        Ext/
          Form.xml                      ← XML формы (элементы, реквизиты, команды)
          Form/
            Module.bsl                  ← Модуль формы (BSL код обработчиков)
```

### 8.3 Описатель формы (Forms/ФормаДокумента.xml)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<MetaDataObject xmlns="http://v8.1c.ru/8.3/MDClasses"
    xmlns:xr="http://v8.1c.ru/8.3/xcf/readable"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    version="2.20">
	<Form uuid="{{UUID_ФОРМЫ}}" owner="{{UUID_ВЛАДЕЛЬЦА}}">
		<Properties>
			<Name>ФормаДокумента</Name>
		</Properties>
	</Form>
</MetaDataObject>
```

---

## 9. MULTI-FILE CHECKLIST (КРИТИЧЕСКИ ВАЖНО!)

### 9.1 При создании НОВОГО объекта метаданных

**Все шаги обязательны. Пропуск любого → ошибка загрузки конфигурации.**

| # | Файл | Действие | Пример |
|---|------|----------|--------|
| 1 | `<Тип>/<Имя>.xml` | Создать из шаблона `Документация/Шаблоны/` | `Documents/Заказ.xml` |
| 2 | `Configuration.xml` | Добавить `<Тип>Имя</Тип>` в `<ChildObjects>` | `<Document>Заказ</Document>` |
| 3 | `ConfigDumpInfo.xml` | Добавить `<Metadata name="Тип.Имя" id="UUID">` | `<Metadata name="Document.Заказ" id="..." configVersion="...">` |
| 4 | `<Тип>/<Имя>/Ext/ObjectModule.bsl` | Создать модуль если нужна логика | Обработка проведения |
| 5 | `Subsystems/<Подсистема>.xml` | Добавить в `<Content>` подсистемы | `<xr:Item>Document.Заказ</xr:Item>` |

### 9.2 При создании ФОРМЫ объекта

| # | Файл | Действие |
|---|------|----------|
| 1 | `<Тип>/<Имя>.xml` | Добавить `<Form>ИмяФормы</Form>` в `<ChildObjects>` объекта |
| 2 | `<Тип>/<Имя>.xml` | Заполнить `<DefaultObjectForm>` если основная форма |
| 3 | `Forms/<ИмяФормы>.xml` | Создать описатель формы (uuid + owner) |
| 4 | `Forms/<ИмяФормы>/Ext/Form.xml` | Создать XML формы из шаблона `template-form-document.xml` или `template-form-catalog.xml` |
| 5 | `Forms/<ИмяФормы>/Ext/Form/Module.bsl` | Создать модуль формы |
| 6 | `ConfigDumpInfo.xml` | Добавить запись для формы |

### 9.3 При добавлении РЕКВИЗИТА к существующему объекту

| # | Файл | Действие |
|---|------|----------|
| 1 | `<Тип>/<Имя>.xml` | Добавить `<Attribute uuid="...">` в `<ChildObjects>` |
| 2 | `ConfigDumpInfo.xml` | Добавить `<Metadata name="Тип.Имя.Attribute.Реквизит" id="UUID"/>` |
| 3 | Формы (если есть) | Добавить элемент `<InputField>` с `<DataPath>Объект.Реквизит</DataPath>` |

### 9.4 Формат записи ConfigDumpInfo.xml

```xml
<!-- Объект верхнего уровня -->
<Metadata name="Document.НовыйДокумент" id="UUID-ОБЪЕКТА" configVersion="СЛУЧАЙНАЯ-HEX-СТРОКА32-00000000">
    <!-- Реквизиты -->
    <Metadata name="Document.НовыйДокумент.Attribute.Склад" id="UUID-РЕКВИЗИТА"/>
    <!-- Табличные части -->
    <Metadata name="Document.НовыйДокумент.TabularSection.Товары" id="UUID-ТЧ"/>
    <Metadata name="Document.НовыйДокумент.TabularSection.Товары.Attribute.Номенклатура" id="UUID-КОЛОНКИ"/>
    <!-- Формы -->
    <Metadata name="Document.НовыйДокумент.Form.ФормаДокумента" id="UUID-ФОРМЫ"/>
</Metadata>
```

**configVersion:** 32 hex-символа + `00000000`. Генерировать случайную hex-строку 32 символа и добавить 8 нулей.

### 9.5 Валидация (ФИНАЛЬНЫЙ ШАГ)

```powershell
# Запустить ОБЯЗАТЕЛЬНО после создания/изменения любых объектов:
powershell -ExecutionPolicy Bypass -File "Документация\Валидация\validate-config.ps1"
```

**Результат должен быть:** 0 ошибок. При наличии ошибок — исправить и перезапустить.

---

## 10. ГЕНЕРАЦИЯ ID ЭЛЕМЕНТОВ ФОРМЫ

### Правила нумерации:

1. `AutoCommandBar` формы **ВСЕГДА** `id="-1"`
2. Остальные элементы — **последовательная нумерация** начиная с `1`
3. Каждый `ContextMenu` и `ExtendedTooltip` — получает свой уникальный id
4. Формат: основной элемент `id=N`, его ContextMenu `id=N+1`, его ExtendedTooltip `id=N+2`
5. Для Table: основная `id=N`, ContextMenu `id=N+1`, AutoCommandBar `id=N+2`, ExtendedTooltip `id=N+3`, SearchStringAddition `id=N+4`, ViewStatusAddition `id=N+5`, SearchControlAddition `id=N+6`

### Пример распределения:

```
ГруппаШапка              id=1
  ExtendedTooltip        id=2
  Склад                  id=3
    ContextMenu          id=4
    ExtendedTooltip      id=5
  Контрагент             id=6
    ContextMenu          id=7
    ExtendedTooltip      id=8
Товары (Table)           id=9
  ContextMenu            id=10
  AutoCommandBar         id=11
  ExtendedTooltip        id=12
  SearchStringAddition   id=13
  ViewStatusAddition     id=14
  SearchControlAddition  id=15
  ТоварыНоменклатура     id=16
    ContextMenu          id=17
    ExtendedTooltip      id=18
```

---

## 11. ФИНАЛЬНЫЙ ЧЕКЛИСТ

Перед завершением КАЖДОЙ задачи:

```
✓ MCP: Метаданные проверены (mcp_mcp_1c_torgov_list_metadata_objects / mcp_mcp_1c_torgov_get_metadata_structure)
✓ MCP: Имена форм проверены (file_search по Forms/)
✓ КОД: Нет конструкций из "Негативного словаря" (раздел 4)
✓ КОД: get_errors вызван → 0 ошибок
✓ XML: Взят шаблон из Документация/Шаблоны/ → заголовок полный
✓ XML: get_errors вызван → валидный XML
✓ MULTI-FILE: Configuration.xml обновлён (раздел 9.1)
✓ MULTI-FILE: ConfigDumpInfo.xml обновлён (раздел 9.4)
✓ MULTI-FILE: Подсистема обновлена (если нужно)
✓ ВАЛИДАЦИЯ: validate-config.ps1 → 0 ошибок
✓ ДЕПЛОЙ: deploy-config.ps1 -Action Full → успешно (бэкап включён!)
✓ КОНФИГУРАТОР: Конфигуратор открыт (автоматически в Full)
✓ ДОКИ: Спецификация обновлена, History содержит запись
✓ МОНИТОРИНГ: monitor-errors.ps1 -Action Check → 0 ошибок
✓ ДИАЛОГ 3: ask_questions → стартовый выбор (мониторинг ИЛИ новый запрос)
✓ ДИАЛОГ 1: ask_questions → пользователь выбрал "Всё работает корректно"
✓ ДИАЛОГ 2: ask_questions → пользователь выбрал "Остановить работу" ИЛИ дал новый запрос
```
---

## 12. РАБОТА С ФАЙЛОВОЙ СИСТЕМОЙ (КРИТИЧЕСКОЕ ОГРАНИЧЕНИЕ)

### 12.1 Проблема: PowerShell + Кириллица = Ломается

В этой среде **PowerShell полностью ломает кириллические символы в путях**:
- Буквы выпадают: `Конфигурация` → `онфигурация`, `Проверка` → `роверка`
- `Remove-Item`, `Get-Content`, `Test-Path` — **НЕ РАБОТАЮТ** с русскими путями
- `python -c "код"` через PowerShell — **НЕ РАБОТАЕТ** (кириллица ломается при передаче)

### 12.2 ✅ ЕДИНСТВЕННЫЙ РАБОЧИЙ МЕТОД

**Создать .py файл → Запустить через `python script.py`**

```python
# Шаблон: _delete_files.py
# -*- coding: utf-8 -*-
import pathlib
import shutil

# Файлы для удаления
files = [
    pathlib.Path(r"D:\Git\Public_Trade_Module\Конфигурация\Проверка\DataProcessors\ИмяОбъекта.xml"),
]

# Папки для удаления
folders = [
    pathlib.Path(r"D:\Git\Public_Trade_Module\Конфигурация\Проверка\DataProcessors\ИмяОбъекта"),
]

print("Удаление файлов...")
for f in files:
    if f.exists():
        f.unlink()
        print(f"  ✓ {f.name}")
    else:
        print(f"  - {f.name} (не найден)")

print("\nУдаление папок...")
for folder in folders:
    if folder.exists():
        shutil.rmtree(folder)
        print(f"  ✓ {folder.name}/")
    else:
        print(f"  - {folder.name}/ (не найдена)")

print("\nГотово!")
```

**Использование:**
```powershell
# 1. Создать файл через create_file
# 2. Запустить:
python "D:\Git\Public_Trade_Module\_delete_files.py"
```

### 12.3 ❌ НЕ РАБОТАЕТ (не использовать)

```powershell
# ❌ Remove-Item с кириллицей
Remove-Item "Конфигурация\Проверка\..." -Force

# ❌ Python inline-команды через PowerShell
python -c "import os; os.remove('путь с кириллицей')"

# ❌ Get-ChildItem с кириллицей в -Path
Get-ChildItem -Path "Конфигурация\Проверка\..."

# ❌ [System.IO.File]::Delete() через PowerShell
[System.IO.File]::Delete("путь с кириллицей")
```

### 12.4 Обходные пути (ограниченные)

```powershell
# ✅ Использовать Get-ChildItem БЕЗ кириллицы в -Path
$script = Get-ChildItem -Path "D:\Git\Public_Trade_Module" -Recurse -Filter "validate-config.ps1" | Select-Object -First 1
powershell -ExecutionPolicy Bypass -File $script.FullName

# ✅ Использовать относительные пути из английской папки
Push-Location "D:\Git\Public_Trade_Module"
# Но дальше всё равно кириллица ломается
Pop-Location
```

### 12.5 Правило для агента

> **При необходимости удалить/переместить/переименовать файлы с кириллицей в имени или пути:**
> 1. Создать Python-скрипт через `create_file` (имя файла — английское, например `_delete_object.py`)
> 2. Запустить через `python "полный\путь\к\скрипту.py"`
> 3. Удалить временный скрипт после выполнения