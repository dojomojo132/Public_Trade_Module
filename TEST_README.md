# 🧪 Тестирование отчета по ценам номенклатуры

## Описание

Демонстрация работы PowerShell обёрток для 1С через практический пример - получение текущих цен товаров.

## Что демонстрируется

✅ Подключение к 1С через COM без открытия клиента  
✅ Выполнение запросов к регистрам сведений  
✅ Обработка результатов запросов  
✅ Работа с константами конфигурации  
✅ Создание тестовых данных  
✅ Форматированный вывод отчетов  
✅ Статистический анализ данных  

---

## 🚀 Быстрый запуск

### 1. Проверка системы (обязательно)

```bash
node quick-start.js verify
```

Убедитесь что все ✅ зелёные галочки.

### 2. Быстрый тест (30 секунд)

```bash
node test-quick.js
```

**Что делает:**
- Подключается к базе PTM_Test
- Получает текущую дату
- Считает количество товаров
- Выводит топ-5 товаров с ценами
- Проверяет константы
- Показывает системную информацию

**Ожидаемый результат:**
```
╔════════════════════════════════════════════════════════════════╗
║    БЫСТРЫЙ ТЕСТ: Получение цен товаров через COM             ║
╚════════════════════════════════════════════════════════════════╝

1️⃣  Подключение к базе...
✅ Подключено

2️⃣  Проверка связи с сервером...
✅ Дата на сервере: 20.01.2026 15:30:45

3️⃣  Получение количества товаров...
✅ Найдено товаров: 15

4️⃣  Получение топ-5 товаров с ценами...
✅ Товары с ценами:

┌─────────────────────────────────────────┬──────────────┐
│ Наименование                            │ Цена         │
├─────────────────────────────────────────┼──────────────┤
│ Ноутбук Lenovo                          │      450.00  │
│ Клавиатура USB                          │       25.50  │
│ Мышь беспроводная                       │       15.00  │
└─────────────────────────────────────────┴──────────────┘

✅ ТЕСТ ЗАВЕРШЕН
```

### 3. Полный отчет (1 минута)

```bash
node test-report-prices.js
```

**Что делает:**
- Подключается к базе
- Проверяет наличие данных
- Создаёт тестовые данные (если нужно)
- Формирует полный отчёт по ценам
- Выводит статистику (мин/макс/средняя цена)
- Показывает распределение по типам цен

**Ожидаемый результат:**
```
╔════════════════════════════════════════════════════════════════════════════╗
║                        ОТЧЕТ: ЦЕНЫ НОМЕНКЛАТУРЫ                           ║
╚════════════════════════════════════════════════════════════════════════════╝

Всего записей: 15

┌────┬──────────────────────────────────┬──────────────────┬────────────┬──────────────────┐
│ № │ Наименование                     │ Тип цен          │ Цена       │ Дата установки   │
├────┼──────────────────────────────────┼──────────────────┼────────────┼──────────────────┤
│  1 │ Ноутбук Lenovo                   │ Розничная        │     450.00 │ 20.01.2026 15:30 │
│  2 │ Клавиатура USB                   │ Розничная        │      25.50 │ 20.01.2026 15:30 │
│  3 │ Мышь беспроводная                │ Розничная        │      15.00 │ 20.01.2026 15:30 │
...
└────┴──────────────────────────────────┴──────────────────┴────────────┴──────────────────┘

╔════════════════════════════════════════════════════════════════════════════╗
║                              СТАТИСТИКА                                    ║
╚════════════════════════════════════════════════════════════════════════════╝

💰 Минимальная цена: 15.00 руб.
💰 Максимальная цена: 1250.00 руб.
💰 Средняя цена: 287.50 руб.

📊 Распределение по типам цен:
   • Розничная: 12 шт.
   • Оптовая: 3 шт.

⏱️  Время выполнения: 1250 мс
```

---

## 📋 Что тестируется

### Компоненты системы

| Компонент | Метод | Что проверяется |
|-----------|-------|-----------------|
| PowerShellHelper | `connect1C()` | Подключение к COM |
| COM1CWrapper | `init()` | Инициализация соединения |
| COM1CWrapper | `eval()` | Выполнение запросов |
| COM1CWrapper | `getCurrentDate()` | Получение даты сервера |
| COM1CWrapper | `getConstant()` | Чтение констант |
| COM1CWrapper | `getSystemInfo()` | Системная информация |
| Запросы 1С | Query | Работа с регистрами |
| Обработка данных | String parsing | Парсинг результатов |

### Метаданные 1С

- ✅ Справочник.Номенклатура
- ✅ Справочник.ТипыЦен
- ✅ РегистрСведений.ЦеныНоменклатуры
- ✅ Константы конфигурации

---

## 🔧 Настройка

### Изменить базу данных

Отредактируйте файлы `test-quick.js` или `test-report-prices.js`:

```javascript
const config = {
  infobase: 'D:\\1C_Bases\\PTM_Development',  // Ваш путь
  user: 'Admin',                               // Ваш пользователь
  password: ''                                  // Пароль (если есть)
};
```

### Требования к базе

- ✅ 1С:Предприятие 8.3.24 установлена
- ✅ Информационная база создана
- ✅ Конфигурация PTM загружена
- ✅ Пользователь имеет полные права
- ✅ COM объект V83.COMConnector зарегистрирован

---

## 🐛 Troubleshooting

### Ошибка: "Не удалось подключиться к базе"

**Причина:** База не существует или неверный путь

**Решение:**
```bash
# Проверить путь к базе
dir D:\1C_Bases\PTM_Test\1Cv8.1CD

# Создать базу
"C:\Program Files\1cv8\8.3.24\bin\1cv8.exe" CREATEINFOBASE File="D:\1C_Bases\PTM_Test"
```

### Ошибка: "COM объект не доступен"

**Причина:** V83.COMConnector не зарегистрирован

**Решение:**
```powershell
cd "C:\Program Files\1cv8\8.3.24\bin"
regsvr32.exe comcntr.dll
```

### Ошибка: "Регистр ЦеныНоменклатуры пустой"

**Причина:** Нет данных для отчета

**Решение:** Скрипт автоматически создаст тестовые данные. Или заполните вручную:
```javascript
// Запустите в 1С
Набор = РегистрыСведений.ЦеныНоменклатуры.СоздатьНаборЗаписей();
Запись = Набор.Добавить();
Запись.Номенклатура = Справочники.Номенклатура.НайтиПоКоду("000001");
Запись.ТипЦен = Справочники.ТипыЦен.НайтиПоНаименованию("Розничная");
Запись.Цена = 100;
Запись.Период = ТекущаяДата();
Набор.Записать();
```

### Ошибка выполнения запроса

**Причина:** Неверный синтаксис или отсутствуют объекты

**Решение:**
```bash
# Проверить метаданные
node mcp-config/examples.js

# Проверить конфигурацию загружена
"C:\Program Files\1cv8\8.3.24\bin\1cv8.exe" DESIGNER /F"D:\1C_Bases\PTM_Test" /DumpCfg Configuration.xml
```

---

## 📊 Архитектура теста

```
test-report-prices.js
        ↓
  COM1CWrapper
        ↓
  PowerShellHelper
        ↓
    PowerShell
        ↓
 V83.COMConnector
        ↓
   1С:Предприятие
        ↓
РегистрСведений.ЦеныНоменклатуры
```

---

## 💡 Расширение примера

### Добавить фильтры

```javascript
// В методе получитьЦеныТоваров() добавить параметры
const запрос = `
  Запрос.Текст = "...
  |ГДЕ
  |    ЦеныНоменклатуры.Цена > &МинимальнаяЦена
  |    И ЦеныНоменклатуры.ТипЦен = &ТипЦен
  |";
  
  Запрос.УстановитьПараметр("МинимальнаяЦена", 100);
  Запрос.УстановитьПараметр("ТипЦен", Справочники.ТипыЦен.НайтиПоНаименованию("Розничная"));
`;
```

### Экспорт в CSV

```javascript
экспортироватьВCSV(данные) {
  const fs = require('fs');
  const csv = данные.строки.map(s => 
    `"${s.наименование}","${s.типЦен}",${s.цена},"${s.период}"`
  ).join('\n');
  
  fs.writeFileSync('prices-export.csv', 
    'Наименование,Тип цен,Цена,Дата\n' + csv
  );
  console.log('✅ Экспорт в prices-export.csv завершен');
}
```

### Добавить графики

```javascript
// Использовать библиотеку asciichart
const asciichart = require('asciichart');
const цены = данные.строки.map(s => s.цена);
console.log(asciichart.plot(цены));
```

---

## ✅ Критерии успеха

Тест считается успешным если:

- [x] Подключение к базе установлено
- [x] Запрос выполнен без ошибок
- [x] Получены данные из регистра
- [x] Данные корректно распарсены
- [x] Отчет выведен в читаемом формате
- [x] Статистика рассчитана правильно
- [x] Время выполнения < 5 секунд

---

## 📚 Дополнительная документация

- [PowerShell обёртки](mcp-config/README.md) - Полная документация API
- [Быстрый старт](POWERSHIFT_QUICKSTART.md) - Примеры использования
- [Статус реализации](СТАТУС_РЕАЛИЗАЦИИ.md) - Что уже работает

---

**🎉 Готово к запуску!**

Начни с: `node test-quick.js`
