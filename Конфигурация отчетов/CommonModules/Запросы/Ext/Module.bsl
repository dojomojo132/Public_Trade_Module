// Формирует структуру параметров для HTTP-запроса
// Параметры:
//   Метод - Строка - HTTP-метод (GET, POST, PUT, DELETE и т.д.) (по умолчанию GET)
//   Ресурс - Строка - путь ресурса (например, /api/auth/signin)
//   Порт - Число - порт сервера (по умолчанию 8080)
//   ЗащищенноеСоединение - Булево - использовать HTTPS (по умолчанию Ложь)
//   Таймаут - Число - таймаут соединения в секундах (по умолчанию 30)
//   Заголовки - Соответствие - HTTP-заголовки (по умолчанию пустое соответствие)
//   ПараметрыURL - Соответствие - параметры строки запроса (query parameters) (по умолчанию пустое соответствие)
//   hostname - Строка - имя хоста для параметра URL (по умолчанию "")
//   ТелоЗапроса - Строка - тело запроса (по умолчанию "")
//   Кодировка - Строка - кодировка текста (по умолчанию UTF-8)
//   ДопустимыеКодыСостояния - Массив - список допустимых кодов HTTP (по умолчанию [200])
// Возвращаемое значение:
//   Структура - параметры запроса
Функция СформироватьПараметрыЗапроса(Метод = "GET", Ресурс = "", Порт = 8080, ЗащищенноеСоединение = Ложь, Таймаут = 30,
								Заголовки = Неопределено, ПараметрыURL = Неопределено, hostname = "", ТелоЗапроса = "",
								Кодировка = "UTF-8", ДопустимыеКодыСостояния = Неопределено) Экспорт
	
	ПараметрыЗапроса = Новый Структура;
	ПараметрыЗапроса.Вставить("Метод", Метод);
	ПараметрыЗапроса.Вставить("Ресурс", Ресурс);
	ПараметрыЗапроса.Вставить("Порт", Порт);
	ПараметрыЗапроса.Вставить("ЗащищенноеСоединение", ЗащищенноеСоединение);
	ПараметрыЗапроса.Вставить("Таймаут", Таймаут);
	
	// Обработка заголовков
	ПараметрыЗапроса.Вставить("Заголовки", ?(ТипЗнч(Заголовки) = Тип("Соответствие"), Заголовки, Новый Соответствие));
	
	// Обработка параметров URL
	РезультатПараметрыURL = ?(ТипЗнч(ПараметрыURL) = Тип("Соответствие"), ПараметрыURL, Новый Соответствие);
		
	Если Не ПустаяСтрока(hostname) Тогда
		РезультатПараметрыURL.Вставить("hostname", hostname);
	КонецЕсли;
	ПараметрыЗапроса.Вставить("ПараметрыURL", РезультатПараметрыURL);
	
	// Тело запроса
	ПараметрыЗапроса.Вставить("ТелоЗапроса", ТелоЗапроса);
	
	// Кодировка
	Попытка
		ПараметрыЗапроса.Вставить("Кодировка", КодировкаТекста[Кодировка]);
	Исключение
		ПараметрыЗапроса.Вставить("Кодировка", КодировкаТекста.UTF8);
	КонецПопытки;
	
	// Допустимые коды состояния
	Если ТипЗнч(ДопустимыеКодыСостояния) = Тип("Массив") И ДопустимыеКодыСостояния.Количество() > 0 Тогда
		ПараметрыЗапроса.Вставить("ДопустимыеКодыСостояния", ДопустимыеКодыСостояния);
	Иначе
		ДопустимыеКодыСостояния = Новый Массив;
		ДопустимыеКодыСостояния.Добавить(200);
		ПараметрыЗапроса.Вставить("ДопустимыеКодыСостояния", ДопустимыеКодыСостояния);
	КонецЕсли;
	
	Возврат ПараметрыЗапроса;
	
КонецФункции

// Универсальная функция для выполнения HTTP-запросов
// Параметры:
//   ИмяХоста - Строка - адрес сервера
//   ПараметрыЗапроса - Структура  - параметры запроса:
//     * Метод - Строка - HTTP-метод (GET, POST, PUT, DELETE и т.д.) (по умолчанию POST)
//     * Ресурс - Строка - путь ресурса (например, /api/auth/signin) (по умолчанию пустая строка)
//     * Порт - Число - порт сервера (по умолчанию 80)
//     * ЗащищенноеСоединение - Булево - использовать HTTPS (по умолчанию Ложь)
//     * Таймаут - Число - таймаут соединения в секундах (по умолчанию 30)
//     * Заголовки - Соответствие - HTTP-заголовки (по умолчанию Content-Type: application/json)
//     * ПараметрыURL - Соответствие - параметры строки запроса (query parameters)
//     * ТелоЗапроса - Строка - тело запроса (по умолчанию пустая строка)
//     * Кодировка - Строка - кодировка текста (по умолчанию UTF-8)
//     * ДопустимыеКодыСостояния - Массив - список допустимых кодов HTTP (по умолчанию [200])
// Возвращаемое значение:
//   Структура - результат запроса:
//     * Успех - Булево - признак успешного выполнения
//     * КодСостояния - Число - код состояния HTTP
//     * ТелоОтвета - Строка - тело ответа
//     * Заголовки - Соответствие - заголовки ответа
//     * ОписаниеОшибки - Строка - описание ошибки, если Успех = Ложь

Функция ВыполнитьHTTPЗапрос(ИмяХоста, ПараметрыЗапроса) Экспорт
	
	// Инициализация результата
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("КодСостояния", 0);
	Результат.Вставить("ТелоОтвета", "");
	Результат.Вставить("Заголовки", Новый Соответствие);
	Результат.Вставить("ОписаниеОшибки", "");
	
	// Значения по умолчанию
	Метод = ?(ПараметрыЗапроса.Свойство("Метод"), ПараметрыЗапроса.Метод, "POST");
	Ресурс = ?(ПараметрыЗапроса.Свойство("Ресурс"), ПараметрыЗапроса.Ресурс, "");
	Порт = ?(ПараметрыЗапроса.Свойство("Порт"), ПараметрыЗапроса.Порт, 80);
	ЗащищенноеСоединение = ?(ПараметрыЗапроса.Свойство("ЗащищенноеСоединение"), ПараметрыЗапроса.ЗащищенноеСоединение, Ложь);
	Таймаут = ?(ПараметрыЗапроса.Свойство("Таймаут"), ПараметрыЗапроса.Таймаут, 30);
	Заголовки = ?(ПараметрыЗапроса.Свойство("Заголовки"), ПараметрыЗапроса.Заголовки, Новый Соответствие);
	ПараметрыURL = ?(ПараметрыЗапроса.Свойство("ПараметрыURL"), ПараметрыЗапроса.ПараметрыURL, Новый Соответствие);
	ТелоЗапроса = ?(ПараметрыЗапроса.Свойство("ТелоЗапроса"), ПараметрыЗапроса.ТелоЗапроса, "");
	Кодировка = ?(ПараметрыЗапроса.Свойство("Кодировка"), ПараметрыЗапроса.Кодировка, КодировкаТекста.UTF8);
	ДопустимыеКодыСостояния = ?(ПараметрыЗапроса.Свойство("ДопустимыеКодыСостояния"), ПараметрыЗапроса.ДопустимыеКодыСостояния, Новый Массив);
	Если ДопустимыеКодыСостояния.Количество() = 0 Тогда
		ДопустимыеКодыСостояния.Добавить(200);
	КонецЕсли;
	
	// Добавление заголовка Content-Type, если не указан
	Если Заголовки.Получить("Content-Type") = Неопределено И Метод = "POST" Тогда
		Заголовки.Вставить("Content-Type", "application/json");
	КонецЕсли;
	
	Попытка
		// Настройка соединения
		Если ЗащищенноеСоединение Тогда
			HTTPСоединение = Новый HTTPСоединение(ИмяХоста, Порт,,,, Таймаут, Новый ЗащищенноеСоединениеOpenSSL());
		Иначе
			HTTPСоединение = Новый HTTPСоединение(ИмяХоста, Порт,,,, Таймаут);
		КонецЕсли;
		
		// Формирование строки параметров URL
		СтрокаПараметров = "";
		Для Каждого Параметр Из ПараметрыURL Цикл
			СтрокаПараметров = СтрокаПараметров + ?(СтрокаПараметров = "", "?", "&") 
				+ Параметр.Ключ + "=" + КодироватьСтроку(Строка(Параметр.Значение), СпособКодированияСтроки.КодировкаURL);
		КонецЦикла;
		
		// Формирование запроса
		Запрос = Новый HTTPЗапрос;
		Запрос.АдресРесурса = Ресурс + СтрокаПараметров;
		
		// Установка заголовков
		Для Каждого Заголовок Из Заголовки Цикл
			Запрос.Заголовки.Вставить(Заголовок.Ключ, Заголовок.Значение);
		КонецЦикла;
		
		// Установка тела запроса, если есть
		Если Не ПустаяСтрока(ТелоЗапроса) Тогда
			Запрос.УстановитьТелоИзСтроки(ТелоЗапроса, Кодировка);
		КонецЕсли;
		
		// Выполнение запроса
		Ответ = HTTPСоединение.ВызватьHTTPМетод(Метод, Запрос);
		
		// Сохранение результата
		Результат.КодСостояния = Ответ.КодСостояния;
		Результат.ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
		Результат.Заголовки = Ответ.Заголовки;
		
		// Проверка кода состояния
		Если ДопустимыеКодыСостояния.Найти(Ответ.КодСостояния) = Неопределено Тогда
			Результат.ОписаниеОшибки = "Ошибка HTTP: Код " + Ответ.КодСостояния + ". " + Результат.ТелоОтвета;
			Сообщить(Результат.ОписаниеОшибки);
			Возврат Результат;
		КонецЕсли;
		
		Результат.Успех = Истина;
		
	Исключение
		Результат.ОписаниеОшибки = "Ошибка при выполнении запроса: " + ОписаниеОшибки();
		Сообщить(Результат.ОписаниеОшибки);
		Возврат Результат;
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

