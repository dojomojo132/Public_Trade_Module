// Функция для выполнения пинга указанного адреса с 4 попытками
// Параметры:
//   Адрес - строка, IP-адрес или доменное имя для пинга
// Возвращаемое значение:
//   Структура:
//     - Успех - Булево, Истина если хотя бы одна попытка успешна
//     - КоличествоУдачныхПопыток - Число, количество успешных попыток (0-4)
Функция Пинг(Адрес) Экспорт
    // Инициализация структуры результата
    Результат = Новый Структура("Успех, КоличествоУдачныхПопыток", Ложь, 0);
    
    Попытка
        // Создаем объект WScript.Shell для выполнения системных команд
        ОбъектShell = Новый COMОбъект("WScript.Shell");
        
        // Счетчик удачных попыток
        КоличествоУдачных = 0;
        
        // Выполняем 4 попытки пинга
        Для НомерПопытки = 1 По 4 Цикл
            // Формируем команду для пинга (Windows)
            Команда = "ping -n 1 " + Адрес; // -n 1 означает один запрос
            
            // Выполняем команду и скрываем окно (0 - скрытое окно, Истина - ожидать завершения)
            КодВозврата = ОбъектShell.Run(Команда, 0, Истина);
            
            // Проверяем код возврата (0 - успех)
            Если КодВозврата = 0 Тогда
                КоличествоУдачных = КоличествоУдачных + 1;
            КонецЕсли;
        КонецЦикла;
        
        // Заполняем структуру результатов
        Результат.Успех = (КоличествоУдачных > 0);
        Результат.КоличествоУдачныхПопыток = КоличествоУдачных;
        
        Возврат Результат;
        
    Исключение
        // Обработка ошибок
        Сообщить("Ошибка при выполнении пинга: " + ОписаниеОшибки());
        Возврат Результат;
    КонецПопытки;
КонецФункции


Процедура ЗаписьАктивностьОбрудования_В_Регистр(Оборудование, Статус, УдачныеПопытки) Экспорт 

	Запись = РегистрыСведений.СостояниеАктивностиПринтеров.СоздатьМенеджерЗаписи();
    Запись.Период = ТекущаяДата();
    Запись.Оборудование = Оборудование;
    Запись.Статус = Статус;
    Запись.КоличествоУдачныхПопыток = УдачныеПопытки;

    Попытка
        Запись.Записать(Истина);
		//Сообщить("Родитель задачи успешно обновлен!");
    Исключение
        Сообщить("Ошибка при записи в родителя Задачи: " + ОписаниеОшибки());
    КонецПопытки;

КонецПроцедуры
