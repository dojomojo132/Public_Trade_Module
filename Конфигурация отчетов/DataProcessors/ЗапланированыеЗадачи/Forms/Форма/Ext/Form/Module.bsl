
&НаСервере
Процедура ЗаполнитьДеревоЗначений()
    // Создаем дерево значений
    ДеревоСЗадачами = Новый ДеревоЗначений;
    ДеревоСЗадачами.Колонки.Добавить("Задача");
    ДеревоСЗадачами.Колонки.Добавить("Статус");
    
    // Запрос для получения задач и их статусов
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |	АтрибутыЗадачиСрезПоследних.Задача КАК Задача,
    |	АтрибутыЗадачиСрезПоследних.Значение КАК Статус,
    |	АтрибутыЗадачиСрезПоследних1.Период КАК Период,
    |	АтрибутыЗадачиСрезПоследних1.Задача КАК Задача1,
    |	АтрибутыЗадачиСрезПоследних1.Атрибут КАК Атрибут,
    |	АтрибутыЗадачиСрезПоследних1.Значение КАК Значение,
    |	АтрибутыЗадачиСрезПоследних1.Автор КАК Автор
    |ИЗ
    |	РегистрСведений.АтрибутыЗадачи.СрезПоследних(, Атрибут = &Запланировано) КАК АтрибутыЗадачиСрезПоследних1
    |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АтрибутыЗадачи.СрезПоследних(, Атрибут = &Атрибут) КАК АтрибутыЗадачиСрезПоследних
    |		ПО (АтрибутыЗадачиСрезПоследних.Задача = АтрибутыЗадачиСрезПоследних1.Задача)
    |ГДЕ
    |	НЕ АтрибутыЗадачиСрезПоследних.Задача В
    |				(ВЫБРАТЬ
    |					РодительЗадачи.Задача
    |				ИЗ
    |					РегистрСведений.РодительЗадачи КАК РодительЗадачи)
    |ИТОГИ ПО
    |	Задача";
    
    Запрос.УстановитьПараметр("Атрибут", Перечисления.АтрибутыЗадачи.СтатусВыполнения);
    Запрос.УстановитьПараметр("Атрибут", Перечисления.АтрибутыЗадачи.Запланировано);
	Запрос.УстановитьПараметр("Запланировано", ТекущаяДата());

    РезультатЗапроса = Запрос.Выполнить();
    
    // Обходим результат запроса
    Выборка = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
    Пока Выборка.Следующий() Цикл
        // Добавляем задачу первого уровня
        ЗадачаПервогоУровня = ДеревоСЗадачами.Строки.Добавить();
        ЗадачаПервогоУровня.Задача = Выборка.Задача;
        ЗадачаПервогоУровня.Статус = Выборка.Статус;
        
        // Рекурсивно добавляем подчиненные задачи
        ДобавитьПодчиненныеЗадачи(ЗадачаПервогоУровня, Выборка.Задача, ДеревоСЗадачами);
    КонецЦикла;
    
    // Помещаем дерево в реквизит формы
    ЗначениеВРеквизитФормы(ДеревоСЗадачами, "ДеревоЗадач");
КонецПроцедуры

&НаСервере
Процедура НастроитьУсловноеОформление()
    // Очищаем существующее оформление (опционально)
    Элементы.ДеревоЗадач.УсловноеОформление.Элементы.Очистить();
    
    // Создаем элемент условного оформления
    ЭлементОформления = Элементы.ДеревоЗадач.УсловноеОформление.Элементы.Добавить();
    
    // Условие: Статус = "Выполнено"
    ЭлементУсловия = ЭлементОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
    ЭлементУсловия.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("ДеревоЗадач.Статус");
    ЭлементУсловия.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
    ЭлементУсловия.ПравоеЗначение = "Выполнено"; // Замените на ваше значение статуса
    
    // Оформление: зеленый цвет текста
    ЭлементОформления.Оформление.УстановитьЗначениеПараметра("ЦветТекста", WebЦвета.Зеленый);
    
    // Поля, к которым применяется оформление
    ОформляемоеПоле = ЭлементОформления.Поля.Элементы.Добавить();
    ОформляемоеПоле.Поле = Новый ПолеКомпоновкиДанных("ДеревоЗадачЗадача");
    ОформляемоеПоле = ЭлементОформления.Поля.Элементы.Добавить();
    ОформляемоеПоле.Поле = Новый ПолеКомпоновкиДанных("ДеревоЗадачСтатус");
    
    // Пример для другого статуса, например, "В работе"
    ЭлементОформления = Элементы.ДеревоЗадач.УсловноеОформление.Элементы.Добавить();
    ЭлементУсловия = ЭлементОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
    ЭлементУсловия.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("ДеревоЗадач.Статус");
    ЭлементУсловия.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
    ЭлементУсловия.ПравоеЗначение = Перечисления.СтатусВыполнения.Завершено;
    ЭлементОформления.Оформление.УстановитьЗначениеПараметра("ЦветТекста", WebЦвета.ЗеленаяЛужайка);
    
    ОформляемоеПоле = ЭлементОформления.Поля.Элементы.Добавить();
    ОформляемоеПоле.Поле = Новый ПолеКомпоновкиДанных("ДеревоЗадачЗадача");
    ОформляемоеПоле = ЭлементОформления.Поля.Элементы.Добавить();
    ОформляемоеПоле.Поле = Новый ПолеКомпоновкиДанных("ДеревоЗадачСтатус");
КонецПроцедуры

// Рекурсивная процедура для добавления подчиненных задач
&НаСервере
Процедура ДобавитьПодчиненныеЗадачи(СтрокаДерева, РодительскаяЗадача, ДеревоСЗадачами)
    // Запрос для получения подчиненных задач
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |    РодительЗадачи.Задача КАК Задача,
    |    АтрибутыЗадачиСрезПоследних.Значение КАК Статус
    |ИЗ
    |    РегистрСведений.РодительЗадачи КАК РодительЗадачи
    |        ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АтрибутыЗадачи.СрезПоследних(, Атрибут = &Атрибут) КАК АтрибутыЗадачиСрезПоследних
    |        ПО РодительЗадачи.Задача = АтрибутыЗадачиСрезПоследних.Задача
    |ГДЕ
    |    РодительЗадачи.Родитель = &Родитель";
    
    Запрос.УстановитьПараметр("Родитель", РодительскаяЗадача);
    Запрос.УстановитьПараметр("Атрибут", Перечисления.АтрибутыЗадачи.СтатусВыполнения);
    
    РезультатЗапроса = Запрос.Выполнить();
    Выборка = РезультатЗапроса.Выбрать();
    
    // Обходим подчиненные задачи
    Пока Выборка.Следующий() Цикл
        // Добавляем подчиненную задачу
        ПодчиненнаяЗадача = СтрокаДерева.Строки.Добавить();
        ПодчиненнаяЗадача.Задача = Выборка.Задача;
        ПодчиненнаяЗадача.Статус = Выборка.Статус;
        
        // Рекурсивно добавляем вложенные задачи
        ДобавитьПодчиненныеЗадачи(ПодчиненнаяЗадача, Выборка.Задача, ДеревоСЗадачами);
    КонецЦикла;
КонецПроцедуры


&НаКлиенте
Процедура ДатаЗадачПриИзменении(Элемент)
	ЗаполнитьДеревоЗначений();
КонецПроцедуры
