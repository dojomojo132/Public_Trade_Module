
// Функция отправляет POST-запрос для авторизации и возвращает тело ответа
// Параметры:
//   ИмяХоста - строка, имя хоста для параметра hostname
//   Пароль - строка, пароль для авторизации (по умолчанию "150147")
// Возвращаемое значение:
//   Строка - тело ответа сервера, или пустая строка в случае ошибки
&НаСервере
Функция ОтправитьЗапросАвторизации(ИмяХоста, Пароль) Экспорт
	
	// Инициализация результата
	ТелоОтвета = "";
	
	// Путь к файлу лога
	ФайлЛога = СокрЛП(Константы.ПутьКЛогированию.Получить())+"auth_log.txt";
	
	// Открытие файла лога
	Попытка
		ЗаписьЛога = Новый ЗаписьТекста(ФайлЛога, КодировкаТекста.UTF8,, Истина);
		ЗаписьЛога.ЗаписатьСтроку("[" + ТекущаяДата() + "] Начало запроса авторизации");
		ЗаписьЛога.ЗаписатьСтроку("Имя хоста: " + ИмяХоста);
		ЗаписьЛога.ЗаписатьСтроку("Пароль: " + Пароль);
	Исключение
		Сообщить("Ошибка при открытии файла лога: " + ОписаниеОшибки());
		//Возврат "";
	КонецПопытки;
	
	Попытка
		// Настройка соединения
		Сервер = ИмяХоста;
		Порт = 8080;

		Ресурс = "/api/auth/signin";
		
		HTTPСоединение = Новый HTTPСоединение(Сервер, ,,,, 30);
		
		// Формирование URL с параметром hostname
		Запрос = Новый HTTPЗапрос;
		Запрос.АдресРесурса = Ресурс + "?hostname=" + КодироватьСтроку("", СпособКодированияСтроки.КодировкаURL);
		
		// Формирование тела запроса
		ТелоЗапроса = "{""password"":""" + Пароль + """}";
		Запрос.Заголовки.Вставить("Content-Type", "application/json");
		Запрос.УстановитьТелоИзСтроки(ТелоЗапроса, КодировкаТекста.UTF8);
		
		// Логирование запроса
		ЗаписьЛога.ЗаписатьСтроку("URL: http://" + Сервер + ":" + Формат(Порт, "ЧГ=0") + Запрос.АдресРесурса);
		ЗаписьЛога.ЗаписатьСтроку("Тело запроса: " + ТелоЗапроса);
		
		// Выполнение запроса
		Ответ = HTTPСоединение.ВызватьHTTPМетод("POST", Запрос);
		
		// Логирование ответа
		ЗаписьЛога.ЗаписатьСтроку("Код состояния: " + Ответ.КодСостояния);
		ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
		ЗаписьЛога.ЗаписатьСтроку("Тело ответа: " + ТелоОтвета);
		
		// Проверка статуса ответа
		Если Ответ.КодСостояния <> 200 Тогда
			ЗаписьЛога.ЗаписатьСтроку("Ошибка HTTP: Код " + Ответ.КодСостояния);
			Сообщить("Ошибка HTTP: Код " + Ответ.КодСостояния + ". " + ТелоОтвета);
			ЗаписьЛога.Закрыть();
			Возврат "";
		КонецЕсли;
		
		ЗаписьЛога.ЗаписатьСтроку("Запрос успешно выполнен");
		ЗаписьЛога.Закрыть();
		
	Исключение
		ЗаписьЛога.ЗаписатьСтроку("Ошибка при выполнении запроса: " + ОписаниеОшибки());
		ЗаписьЛога.Закрыть();
		Сообщить("Ошибка при выполнении запроса: " + ОписаниеОшибки());
		Возврат "";
	КонецПопытки;
	
	Возврат ТелоОтвета;
	
КонецФункции

// Функция извлекает токен из JSON-ответа
// Параметры:
//   ТелоОтвета - строка, тело ответа сервера в формате JSON
// Возвращаемое значение:
//   Строка - токен из ответа, или пустая строка в случае ошибки
&НаСервере
Функция ИзвлечьТокенИзОтвета(ТелоОтвета) Экспорт
	ПутьКЛогированию=СокрЛП(Константы.ПутьКЛогированию.Получить());
	// Путь к файлу лога
	ФайлЛога = ПутьКЛогированию+"auth_log.txt";
	
	// Открытие файла лога
	Попытка
		ЗаписьЛога = Новый ЗаписьТекста(ФайлЛога, КодировкаТекста.UTF8,, Истина);
		ЗаписьЛога.ЗаписатьСтроку("[" + ТекущаяДата() + "] Начало извлечения токена");
	Исключение
		Сообщить("Ошибка при открытии файла лога: " + ОписаниеОшибки());
		Возврат "";
	КонецПопытки;
	
	// Проверка на пустой ответ
	Если ПустаяСтрока(ТелоОтвета) Тогда
		ЗаписьЛога.ЗаписатьСтроку("Ошибка: Тело ответа пустое");
		ЗаписьЛога.Закрыть();
		Сообщить("Ошибка: Тело ответа пустое");
		Возврат "";
	КонецЕсли;
	
	Попытка
		// Чтение JSON-ответа
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
		ДанныеОтвета = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
		// Извлечение токена
		Если ДанныеОтвета.Свойство("token") Тогда
			Токен = ДанныеОтвета.token;
			ЗаписьЛога.ЗаписатьСтроку("Токен успешно извлечен: " + Токен);
			ЗаписьЛога.Закрыть();
			Возврат Токен;
		Иначе
			ЗаписьЛога.ЗаписатьСтроку("Ошибка: Поле 'token' не найдено в ответе");
			ЗаписьЛога.Закрыть();
			Сообщить("Ошибка: Поле 'token' не найдено в ответе");
			Возврат "";
		КонецЕсли;
		
	Исключение
		ЗаписьЛога.ЗаписатьСтроку("Ошибка при парсинге ответа: " + ОписаниеОшибки());
		ЗаписьЛога.Закрыть();
		Сообщить("Ошибка при парсинге ответа: " + ОписаниеОшибки());
		Возврат "";
	КонецПопытки;
	
КонецФункции


&НаСервере
Процедура ПолучитьТокенНаСервере()
	ИмяХоста=Справочники.Заведения.ПолучитьИмяХоста(Объект.Заведение);
	Пароль = Константы.ПарольАдминистратора.Получить();
	Ответ=ОтправитьЗапросАвторизации(ИмяХоста, Пароль);
	Токен=ИзвлечьТокенИзОтвета(Ответ);
	Если ЗначениеЗаполнено(Токен) = Истина Тогда
		Константы.ТокенВВП.Установить(СокрЛП(Токен));	
		//Сообщить(СокрЛП(Токен));
		Сообщить("Токен успешно записан!");
	Иначе
		Сообщить("Токен не был получен!");
	КонецЕсли;
КонецПроцедуры


&НаКлиенте
Процедура ПолучитьТокен(Команда)
	ПолучитьТокенНаСервере();
КонецПроцедуры



// Функция отправляет POST-запрос для удаления заказа
// Параметры:
//   OrderId - строка или число, идентификатор заказа
//   Токен - строка, токен авторизации
// Возвращаемое значение:
//   Булево - Истина, если запрос успешен (код 200 или 204), Ложь в случае ошибки
&НаСервере
Функция УдалитьЗаказ(OrderId, Токен, Адрес)
	ПутьКЛогированию=СокрЛП(Константы.ПутьКЛогированию.Получить());

	// Путь к файлу лога
	ФайлЛога = ПутьКЛогированию+"remove_order_log.txt";
	
	// Открытие файла лога
	Попытка
		ЗаписьЛога = Новый ЗаписьТекста(ФайлЛога, КодировкаТекста.UTF8,, Истина);
		ЗаписьЛога.ЗаписатьСтроку("[" + ТекущаяДата() + "] Начало запроса на удаление заказа");
		ЗаписьЛога.ЗаписатьСтроку("OrderId: " + Формат(OrderId, "ЧГ=0"));
		ЗаписьЛога.ЗаписатьСтроку("Токен: " + ?(СтрДлина(Токен) > 20, Лев(Токен, 20) + "...", Токен));
	Исключение
		Сообщить("Ошибка при открытии файла лога: " + ОписаниеОшибки());
		Возврат Ложь;
	КонецПопытки;
	
	Попытка
		// Настройка соединения
		Сервер = Адрес;
		Порт = 8080;
		Ресурс = "/api/v1/orders/" + Формат(OrderId, "ЧГ=0") + "/remove";
		
		HTTPСоединение = Новый HTTPСоединение(Сервер, ,,,, 30);
		
		// Формирование запроса
		Запрос = Новый HTTPЗапрос;
		Запрос.АдресРесурса = Ресурс;
		
		// Установка заголовка авторизации
		Запрос.Заголовки.Вставить("Authorization", "Bearer " + Токен);
		
		// Логирование запроса
		ЗаписьЛога.ЗаписатьСтроку("URL: http://" + Сервер + ":" + Формат(Порт, "ЧГ=0") + Ресурс);
		ЗаписьЛога.ЗаписатьСтроку("Заголовок Authorization: Bearer " + ?(СтрДлина(Токен) > 20, Лев(Токен, 20) + "...", Токен));
		
		// Выполнение запроса
		Ответ = HTTPСоединение.ВызватьHTTPМетод("POST", Запрос);
		
		// Логирование ответа
		ЗаписьЛога.ЗаписатьСтроку("Код состояния: " + Ответ.КодСостояния);
		ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
		ЗаписьЛога.ЗаписатьСтроку("Тело ответа: " + ТелоОтвета);
		
		// Проверка статуса ответа
		Если Ответ.КодСостояния = 200 Или Ответ.КодСостояния = 204 Тогда
			ЗаписьЛога.ЗаписатьСтроку("Запрос успешно выполнен");
			ЗаписьЛога.Закрыть();
			Сообщить("Запрос успешно выполнен");
			Возврат Истина;
		Иначе
			ЗаписьЛога.ЗаписатьСтроку("Ошибка HTTP: Код " + Ответ.КодСостояния);
			Сообщить("Ошибка HTTP: Код " + Ответ.КодСостояния + ". " + ТелоОтвета);
			ЗаписьЛога.Закрыть();
			Возврат Ложь;
		КонецЕсли;
		
	Исключение
		ЗаписьЛога.ЗаписатьСтроку("Ошибка при выполнении запроса: " + ОписаниеОшибки());
		ЗаписьЛога.Закрыть();
		Сообщить("Ошибка при выполнении запроса: " + ОписаниеОшибки());
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

&НаСервере
Процедура УдалитьНаСервере()
	НомерСчета=Объект.НомерСчета;
	Токен=СокрЛП(Константы.ТокенВВП.Получить());
	ИмяХоста=Справочники.Заведения.ПолучитьИмяХоста(Объект.Заведение);
	УдалитьЗаказ(НомерСчета, Токен, ИмяХоста);
КонецПроцедуры

&НаКлиенте
Процедура Удалить(Команда)
	ПолучитьТокенНаСервере();
	УдалитьНаСервере();
КонецПроцедуры
