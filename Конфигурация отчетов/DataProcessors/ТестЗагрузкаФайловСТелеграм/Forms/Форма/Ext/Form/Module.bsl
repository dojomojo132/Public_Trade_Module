
&НаКлиенте
Процедура ПолучитьСообщение(Команда)
	Telegram.ПроверкаНовыхФайловВ_ТГ();
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    // Инициализация по умолчанию
    Если ПустаяСтрока(Токен) Тогда
        Токен = "6713646445:AAHUf_rZFTeumMEjLA0hl-VqkTpd983U8Pg"; // Введите токен
    КонецЕсли;
    Если ПустаяСтрока(ChatId) Тогда
        ChatId = "-1002745535324"; // Введите chat_id группы
    КонецЕсли;
    Если ПустаяСтрока(КаталогСохранения) Тогда
        КаталогСохранения = "D:\Test folder\";
    КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура НачатьМониторинг(Команда)
    ПодключитьОбработчикОжидания("МониторингФайловКлиент", 10); // Опрос каждые 5 сек
    Сообщить("Мониторинг запущен...");
КонецПроцедуры

&НаКлиенте
Процедура МониторингФайловКлиент()
    МониторингФайлов();
КонецПроцедуры      

Процедура МониторингФайлов() Экспорт
	
	
	Если ПустаяСтрока(Токен) Или ПустаяСтрока(ChatId) Тогда
        ЗаписьЖурналаРегистрации("TelegramDownloader.Ошибка", УровеньЖурналаРегистрации.Ошибка, , , "Не заполнены Токен или ChatId");
        Возврат;
    КонецЕсли;
    
    // HTTP-соединение с Telegram API
    Соединение = Новый HTTPСоединение("api.telegram.org", 443, , , , , Новый ЗащищенноеСоединениеOpenSSL());
    
    // Получаем обновления (long polling)
    ПараметрыGET = Новый Структура;
    ПараметрыGET.Вставить("offset", Константы.ПоследнееПровереноеСообщение.Получить()); // Будем обновлять offset для новых сообщений
    ПараметрыGET.Вставить("limit", 1); // По одному сообщению за раз
    ПараметрыGET.Вставить("timeout", 10);
    ПараметрыGET.Вставить("allowed_updates", "message"); // Только сообщения
    
    URL = "/bot" + Токен + "/getUpdates?" + ПараметрыURL(ПараметрыGET);
    
    Запрос = Новый HTTPЗапрос(URL);
    Ответ = Соединение.Получить(Запрос);
    
    Если Ответ.КодСостояния <> 200 Тогда
        ЗаписьЖурналаРегистрации("TelegramDownloader.Ошибка", УровеньЖурналаРегистрации.Ошибка, , , "Ошибка API: " + Ответ.ПолучитьТелоКакСтроку());
        Возврат;
    КонецЕсли;
    
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(Ответ.ПолучитьТелоКакСтроку());
    Данные = ПрочитатьJSON(ЧтениеJSON);                                                 
	
    Если Данные.result.Количество() = 0 Тогда
        Возврат; // Нет новых сообщений
    КонецЕсли;
    
    Для Каждого Update Из Данные.result Цикл
        Message = Update.channel_post;
        Если Message.chat.id <> Число(ChatId) Тогда
            Продолжить; // Не наша группа
        КонецЕсли;
		
		//Если Update.channel_post.message_id<=Константы.ПоследнееПровереноеСообщение.Получить() Тогда   
		//	Продолжить;
		//КонецЕсли;
			
        // Проверяем наличие файла в сообщении
        Если ТипЗнч(ЕстьФайлВСообщении(Message))=Тип("Структура") Тогда
            ОбработатьФайлИзСообщения(Message);
        КонецЕсли;
        Константы.ПоследнееПровереноеСообщение.Установить(Update.update_id + 1);
        // Обновляем offset для long polling
        //ПараметрыGET.offset = Update.update_id + 1;
    КонецЦикла;
    
КонецПроцедуры

Функция ЕстьФайлВСообщении(Message)
    // Проверяем document, photo (последний элемент — оригинал), video, audio, voice, video_note
    Возврат Message["document"];
КонецФункции

Процедура ОбработатьФайлИзСообщения(Message)
    FileData = ПолучитьДанныеФайлаИзСообщения(Message);
    Если FileData = Неопределено Тогда
        Возврат;
    КонецЕсли;
    
    // Проверяем уникальность по file_id
    Запрос = Новый Запрос;
    Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 1 ИЗ РегистрСведений.СкачанныеФайлыTelegram ГДЕ FileId = &FileId";
    Запрос.УстановитьПараметр("FileId", FileData.file_id);
    
    Если НЕ Запрос.Выполнить().Пустой() Тогда
        ЗаписьЖурналаРегистрации("TelegramDownloader", УровеньЖурналаРегистрации.Информация, , FileData.file_id, "Файл уже скачан ранее");
        Возврат;
    КонецЕсли;
    
    // Скачиваем и сохраняем
    СкачатьИСохранитьФайл(FileData, Message);
    
    // Записываем в регистр для уникальности
    МенеджерЗаписи = РегистрыСведений.СкачанныеФайлыTelegram.СоздатьМенеджерЗаписи();
    МенеджерЗаписи.FileId = FileData.file_id;
    МенеджерЗаписи.Записать();
    
КонецПроцедуры

Функция ПолучитьДанныеФайлаИзСообщения(Message)
    // Логика извлечения file_id и file_unique_id
    Если Message.Свойство("document") Тогда
        Возврат Message.document;
    ИначеЕсли Message.Свойство("photo") И Message.photo.Количество() > 0 Тогда
        // Берем последний (оригинальный) фото
        FileData = Message.photo[Message.photo.ВГраница()];
        FileData.Вставить("file_name", "photo.jpg"); // По умолчанию
        FileData.Вставить("mime_type", "image/jpeg");
        Возврат FileData;
    ИначеЕсли Message.Свойство("video") Тогда
        FileData = Message.video;
        FileData.Вставить("file_name", "video.mp4");
        FileData.Вставить("mime_type", "video/mp4");
        Возврат FileData;
    ИначеЕсли Message.Свойство("audio") Тогда
        FileData = Message.audio;
        FileData.Вставить("file_name", FileData.file_name);
        Возврат FileData;
    ИначеЕсли Message.Свойство("voice") Тогда
        FileData = Message.voice;
        FileData.Вставить("file_name", "voice.ogg");
        FileData.Вставить("mime_type", "audio/ogg");
        Возврат FileData;
    ИначеЕсли Message.Свойство("video_note") Тогда
        FileData = Message.video_note;
        FileData.Вставить("file_name", "video_note.mp4");
        FileData.Вставить("mime_type", "video/mp4");
        Возврат FileData;
    КонецЕсли;
    
    Возврат Неопределено;
КонецФункции

Процедура СкачатьИСохранитьФайл(FileData, Message)
    // Получаем путь файла через getFile
    Соединение = Новый HTTPСоединение("api.telegram.org", 443, , , , , Новый ЗащищенноеСоединениеOpenSSL());
    URLGetFile = "/bot" + Токен + "/getFile?file_id=" + FileData.file_id;
    Запрос = Новый HTTPЗапрос(URLGetFile);
    Ответ = Соединение.Получить(Запрос);
    
    Если Ответ.КодСостояния <> 200 Тогда
        ЗаписьЖурналаРегистрации("TelegramDownloader.Ошибка", УровеньЖурналаРегистрации.Ошибка, , , "Ошибка getFile: " + Ответ.ПолучитьТелоКакСтроку());
        Возврат;
    КонецЕсли;
    
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(Ответ.ПолучитьТелоКакСтроку());
    FileInfo = ПрочитатьJSON(ЧтениеJSON);
    ЧтениеJSON.Закрыть();
    
    Если НЕ FileInfo.ok Тогда
        Возврат;
    КонецЕсли;
    
    FilePath = FileInfo.result.file_path;
    DownloadURL = "https://api.telegram.org/file/bot" + Токен + "/" + FilePath;
    
    // Скачиваем файл
    HTTPСоединениеФайл = Новый HTTPСоединение("api.telegram.org", 443, , , , , Новый ЗащищенноеСоединениеOpenSSL());
    ЗапросФайл = Новый HTTPЗапрос("/file/bot" + Токен + "/" + FilePath);
    ОтветФайл = HTTPСоединениеФайл.Получить(ЗапросФайл);
    
    Если ОтветФайл.КодСостояния = 200 Тогда
        ИмяФайла = FileData.file_name;
        Если ПустаяСтрока(ИмяФайла) Тогда
            // Генерируем имя по MIME
            MIME = ?(FileData.Свойство("mime_type"), FileData.mime_type, "application/octet-stream");
            Расширение = ПолучитьРасширениеПоMIME(MIME);
            ИмяФайла = "file_" + Формат(ТекущаяДата(), "ДФ=yyyyMMddHHmmss") + "." + Расширение;
        КонецЕсли;
        
        ПолныйПуть = КаталогСохранения + ИмяФайла;
        ОтветФайл.ПолучитьТелоКакДвоичныеДанные().Записать(ПолныйПуть);
        
        // Логируем с текстом сообщения
        ТекстСообщения = ?(Message.Свойство("text"), Message.text, "Без текста");
        ЗаписьЖурналаРегистрации("TelegramDownloader", УровеньЖурналаРегистрации.Информация, , FileData.file_id, 
            "Скачан файл: " + ИмяФайла + ". Текст: " + ТекстСообщения);
    Иначе
        ЗаписьЖурналаРегистрации("TelegramDownloader.Ошибка", УровеньЖурналаРегистрации.Ошибка, , , "Ошибка скачивания: " + ОтветФайл.КодСостояния);
    КонецЕсли;
    
КонецПроцедуры

Функция ПолучитьРасширениеПоMIME(MIME)
    Соответствие = Новый Соответствие;
    Соответствие.Вставить("image/jpeg", "jpg");
    Соответствие.Вставить("image/png", "png");
    Соответствие.Вставить("video/mp4", "mp4");
    Соответствие.Вставить("audio/mpeg", "mp3");
    // Добавьте другие MIME по необходимости
    Возврат Соответствие.Получить(MIME, "bin");
КонецФункции

// Вспомогательная функция для URL-параметров (если нет в БСП)
Функция ПараметрыURL(Параметры)
    Массив = Новый Массив;
    Для Каждого КлючЗначение Из Параметры Цикл
        Массив.Добавить(КодироватьСтроку(Строка(КлючЗначение.Ключ), СпособКодированияСтроки.КодировкаURL) + 
                        "=" + КодироватьСтроку(Строка(КлючЗначение.Значение), СпособКодированияСтроки.КодировкаURL));
    КонецЦикла;
    Возврат СтрСоединить(Массив, "&");
КонецФункции

&НаКлиенте
Процедура ЗаполнитьДанные(Команда)
	    // Инициализация по умолчанию
    Если ПустаяСтрока(Токен) Тогда
        Токен = "6713646445:AAHUf_rZFTeumMEjLA0hl-VqkTpd983U8Pg"; // Введите токен
    КонецЕсли;
    Если ПустаяСтрока(ChatId) Тогда
        ChatId = "-1002745535324"; // Введите chat_id группы
    КонецЕсли;
    Если ПустаяСтрока(КаталогСохранения) Тогда
        КаталогСохранения = "D:\Test folder";
    КонецЕсли;
КонецПроцедуры
