# -*- coding: utf-8 -*-
import pathlib

paths = [
    pathlib.Path(r"D:\Git\Public_Trade_Module\Конфигурация\DataProcessors\ИмпортНоменклатуры\Ext\ObjectModule.bsl"),
    pathlib.Path(r"D:\Git\Public_Trade_Module\Конфигурация\Проверка\DataProcessors\ИмпортНоменклатуры\Ext\ObjectModule.bsl"),
]

old = '''	Для НомерСтроки = 2 По ТабДок.ВысотаТаблицы Цикл
		КодНоменклатуры = СокрЛП(ТабДок.Область(НомерСтроки, 1).Текст);
		КоличествоТекст = СокрЛП(ТабДок.Область(НомерСтроки, 3).Текст);
		
		Если ПустаяСтрока(КодНоменклатуры) ИЛИ ПустаяСтрока(КоличествоТекст) Тогда
			Продолжить;
		КонецЕсли;
		
		Номенклатура = Справочники.Номенклатура.НайтиПоКоду(КодНоменклатуры);
		Если Номенклатура.Пустая() Тогда
			Продолжить;
		КонецЕсли;
		
		Количество = Число(СтрЗаменить(КоличествоТекст, " ", ""));
		Если Количество <= 0 Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаТовара = ДокументИнвентаризация.Товары.Добавить();
		СтрокаТовара.Номенклатура = Номенклатура;
		СтрокаТовара.ФактическоеКоличество = Количество;
		СтрокаТовара.УчетноеКоличество = 0; // Начальный ввод остатков
		СтрокаТовара.Отклонение = Количество;
		
		Счетчик = Счетчик + 1;
	КонецЦикла;'''

new = '''	// Дедупликация номенклатуры (суммирование количества при дубликатах)
	УжеДобавлены = Новый Соответствие; // Номенклатура -> НомерСтрокиТЧ
	
	Для НомерСтроки = 2 По ТабДок.ВысотаТаблицы Цикл
		КодНоменклатуры = СокрЛП(ТабДок.Область(НомерСтроки, 1).Текст);
		КоличествоТекст = СокрЛП(ТабДок.Область(НомерСтроки, 3).Текст);
		
		Если ПустаяСтрока(КодНоменклатуры) ИЛИ ПустаяСтрока(КоличествоТекст) Тогда
			Продолжить;
		КонецЕсли;
		
		Номенклатура = Справочники.Номенклатура.НайтиПоКоду(КодНоменклатуры);
		Если Номенклатура.Пустая() Тогда
			Продолжить;
		КонецЕсли;
		
		Количество = Число(СтрЗаменить(КоличествоТекст, " ", ""));
		Если Количество <= 0 Тогда
			Продолжить;
		КонецЕсли;
		
		// Проверяем дубликат — суммируем количество
		СуществующийИндекс = УжеДобавлены[Номенклатура];
		Если СуществующийИндекс <> Неопределено Тогда
			СтрокаСущ = ДокументИнвентаризация.Товары[СуществующийИндекс];
			СтрокаСущ.ФактическоеКоличество = СтрокаСущ.ФактическоеКоличество + Количество;
			СтрокаСущ.Отклонение = СтрокаСущ.ФактическоеКоличество;
		Иначе
			СтрокаТовара = ДокументИнвентаризация.Товары.Добавить();
			СтрокаТовара.Номенклатура = Номенклатура;
			СтрокаТовара.ФактическоеКоличество = Количество;
			СтрокаТовара.УчетноеКоличество = 0; // Начальный ввод остатков
			СтрокаТовара.Отклонение = Количество;
			УжеДобавлены.Вставить(Номенклатура, ДокументИнвентаризация.Товары.Количество() - 1);
			Счетчик = Счетчик + 1;
		КонецЕсли;
	КонецЦикла;'''

for p in paths:
    content = p.read_text(encoding='utf-8-sig')
    if old in content:
        content = content.replace(old, new)
        p.write_text(content, encoding='utf-8-sig')
        print(f"  OK: {p}")
    else:
        print(f"  SKIP: {p} (not found)")

print("\nDone!")
