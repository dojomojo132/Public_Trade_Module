Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	// 1. Инициализация движений
	Движения.ОстаткиТоваров.Записывать = Истина;
	
	// 3. Контроль остатков
	// Выполняем только если включена соответствующая константа
	Если Константы.КонтролироватьОстаткиПриСписании.Получить() = Истина Тогда
		ВыполнитьКонтрольОстатков(Отказ);
	КонецЕсли;
	
	// Если контроля не было или он прошел успешно (Отказ = Ложь) — формируем движения
	Если Не Отказ Тогда
		
		Для Каждого ТекСтрока Из Товары Цикл
			
			Движение = Движения.ОстаткиТоваров.Добавить();
			Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
			Движение.Период = Дата;
			Движение.Склад = Склад;
			Движение.Номенклатура = ТекСтрока.Номенклатура;
			Движение.Количество = ТекСтрока.Количество;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ВыполнитьКонтрольОстатков(Отказ)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ТоварыДокумента.Номенклатура КАК Номенклатура,
		|	ТоварыДокумента.Количество КАК Количество,
		|	ТоварыДокумента.ПредставлениеНоменклатуры КАК ПредставлениеНоменклатуры
		|ПОМЕСТИТЬ ВТ_Товары
		|ИЗ
		|	&ТЧ_Товары КАК ТоварыДокумента
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Товары.ПредставлениеНоменклатуры КАК Товар,
		|	ВТ_Товары.Количество КАК Требуется,
		|	ЕСТЬNULL(ОстаткиТоваровОстатки.КоличествоОстаток, 0) КАК Остаток,
		|	ЕСТЬNULL(ОстаткиТоваровОстатки.КоличествоОстаток, 0) - ВТ_Товары.Количество КАК Дефицит
		|ИЗ
		|	ВТ_Товары КАК ВТ_Товары
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиТоваров.Остатки(&МоментВремени, Склад = &Склад) КАК ОстаткиТоваровОстатки
		|		ПО ВТ_Товары.Номенклатура = ОстаткиТоваровОстатки.Номенклатура
		|
		|ГДЕ
		|	ЕСТЬNULL(ОстаткиТоваровОстатки.КоличествоОстаток, 0) < ВТ_Товары.Количество";
	
	// Подготовка данных
	ТЧ_Свернутая = Товары.Выгрузить();
	ТЧ_Свернутая.Свернуть("Номенклатура", "Количество");
	
	// ИСПРАВЛЕНИЕ: Явное указание типа данных для колонки (Строка, 150 символов)
	ТипСтрока = Новый ОписаниеТипов("Строка", Новый КвалификаторыСтроки(150));
	ТЧ_Свернутая.Колонки.Добавить("ПредставлениеНоменклатуры", ТипСтрока);
	
	Для Каждого Стр Из ТЧ_Свернутая Цикл
		Стр.ПредставлениеНоменклатуры = Строка(Стр.Номенклатура);
	КонецЦикла;
	
	Запрос.УстановитьПараметр("ТЧ_Товары", ТЧ_Свернутая);
	Запрос.УстановитьПараметр("Склад", Склад);
	Запрос.УстановитьПараметр("МоментВремени", МоментВремени());
	
	Результат = Запрос.Выполнить();
	
	Если Не Результат.Пустой() Тогда
		
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = СтрШаблон("Не хватает товара ""%1"" на складе ""%2"". Требуется: %3, В наличии: %4. Не хватает: %5",
				Выборка.Товар,
				Склад,
				Выборка.Требуется,
				Выборка.Остаток,
				-Выборка.Дефицит);
			Сообщение.УстановитьДанные(ЭтотОбъект);
			Сообщение.Сообщить();
			
		КонецЦикла;
		
		Отказ = Истина;
		
	КонецЕсли;

КонецПроцедуры