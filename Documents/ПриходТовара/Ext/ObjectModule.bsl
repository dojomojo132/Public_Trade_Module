Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	// 1. Инициализация записи регистров
	Движения.ОстаткиТоваров.Записывать = Истина;
	Движения.Взаиморасчеты.Записывать = Истина;
	
	// 2. Движения по ТОВАРАМ и ЦЕНАМ
	Для Каждого ТекСтрокаТовары Из Товары Цикл
		
		// А) Остатки товаров (Приход)
		Движение = Движения.ОстаткиТоваров.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период = Дата;
		Движение.Склад = Склад;
		Движение.Номенклатура = ТекСтрокаТовары.Номенклатура;
		Движение.Количество = ТекСтрокаТовары.Количество;
		
		// Б) Фиксация закупочных цен (Регистр сведений)
		// Пишем каждую строку, так как цены могут отличаться. 
		// Используем МенеджерЗаписи для независимого регистра.
		ЗаписьЦены = РегистрыСведений.ЦеныЗакупки.СоздатьМенеджерЗаписи();
		ЗаписьЦены.Период = Дата;
		ЗаписьЦены.Номенклатура = ТекСтрокаТовары.Номенклатура;
		ЗаписьЦены.Цена = ТекСтрокаТовары.Цена;
		ЗаписьЦены.Записать(Истина);
		
	КонецЦикла;
	
	// 3. Движения по ВЗАИМОРАСЧЕТАМ (Общая сумма)
	// Долг поставщику увеличивается (Расход по регистру Взаиморасчеты, т.к. это "Наш долг")
	Движение = Движения.Взаиморасчеты.Добавить();
	Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
	Движение.Период = Дата;
	Движение.Контрагент = Контрагент;
	Движение.Сумма = СуммаДокумента; 

КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	// Если создается новый документ (не копия, не ввод на основании другого документа)
	Если ЭтоНовый() И ТипЗнч(ДанныеЗаполнения) = Тип("Неопределено") Тогда
		
		// 1. Заполняем Склад из константы, если он еще не заполнен
		Если Склад.Пустая() Тогда
			Склад = НастройкиПоУмолчанию.ПолучитьОсновнойСклад();
		КонецЕсли;
		
		// 2. Заполняем Контрагента из константы
		Если Контрагент.Пустая() Тогда
			Контрагент = НастройкиПоУмолчанию.ПолучитьОсновногоПоставщика();
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	// 3. Автоматический пересчет суммы документа по табличной части
	СуммаДокумента = Товары.Итог("Сумма");
	
КонецПроцедуры