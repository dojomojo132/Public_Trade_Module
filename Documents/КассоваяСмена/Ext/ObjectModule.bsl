
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработчикиСобытий

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	
	// Обязательные поля
	МассивНепроверяемых = Новый Массив;
	
	Если НЕ ЗначениеЗаполнено(Касса) Тогда
		ТекстСообщения = "Поле ""Касса"" должно быть заполнено.";
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,, "Касса",, Отказ);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ДатаНачала) Тогда
		ТекстСообщения = "Поле ""Дата начала"" должно быть заполнено.";
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,, "ДатаНачала",, Отказ);
	КонецЕсли;
	
	// Если смена закрыта, дата окончания обязательна
	Если Статус = Перечисления.СтатусыКассовойСмены.Закрыта И НЕ ЗначениеЗаполнено(ДатаОкончания) Тогда
		ТекстСообщения = "Для закрытой смены поле ""Дата окончания"" должно быть заполнено.";
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,, "ДатаОкончания",, Отказ);
	КонецЕсли;
	
	// Дата окончания не может быть раньше даты начала
	Если ЗначениеЗаполнено(ДатаНачала) И ЗначениеЗаполнено(ДатаОкончания) Тогда
		Если ДатаОкончания < ДатаНачала Тогда
			ТекстСообщения = "Дата окончания смены не может быть раньше даты начала.";
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,, "ДатаОкончания",, Отказ);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	// Контроль уникальности: не более одной открытой смены на кассу
	Если Статус = Перечисления.СтатусыКассовойСмены.Открыта Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	КассоваяСмена.Ссылка КАК Ссылка,
			|	КассоваяСмена.Номер КАК Номер
			|ИЗ
			|	Документ.КассоваяСмена КАК КассоваяСмена
			|ГДЕ
			|	КассоваяСмена.Касса = &Касса
			|	И КассоваяСмена.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыКассовойСмены.Открыта)
			|	И КассоваяСмена.Ссылка <> &ТекущаяСсылка
			|	И НЕ КассоваяСмена.ПометкаУдаления";
		
		Запрос.УстановитьПараметр("Касса", Касса);
		Запрос.УстановитьПараметр("ТекущаяСсылка", Ссылка);
		
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Выборка.Следующий();
			ТекстСообщения = СтрШаблон(
				"По кассе ""%1"" уже существует открытая смена № %2. Закройте её перед открытием новой.",
				Касса, Выборка.Номер);
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,, "Касса",, Отказ);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Закрывает кассовую смену
//
// Параметры:
//  ДатаЗакрытия - Дата - Дата и время закрытия смены
//
Процедура ЗакрытьСмену(ДатаЗакрытия = Неопределено) Экспорт
	
	Если Статус = Перечисления.СтатусыКассовойСмены.Закрыта Тогда
		ВызватьИсключение "Смена уже закрыта!";
	КонецЕсли;
	
	Если ДатаЗакрытия = Неопределено Тогда
		ДатаЗакрытия = ТекущаяДата();
	КонецЕсли;
	
	ЭтотОбъект.ДатаОкончания = ДатаЗакрытия;
	ЭтотОбъект.Статус = Перечисления.СтатусыКассовойСмены.Закрыта;
	
	Попытка
		ЭтотОбъект.Записать(РежимЗаписиДокумента.Проведение);
	Исключение
		ВызватьИсключение СтрШаблон("Ошибка при закрытии смены: %1", ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли
