// --- АВТОМАТИЧЕСКИЙ РАСЧЕТ ПЕРЕД ЗАПИСЬЮ ---
Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Для Каждого ТекСтрока Из Товары Цикл
		// Отклонение = Факт - Учет
		ТекСтрока.Отклонение = ТекСтрока.ФактическоеКоличество - ТекСтрока.УчетноеКоличество;
	КонецЦикла;
	
КонецПроцедуры

// --- ЗАПОЛНЕНИЕ ПО ОСТАТКАМ ---
Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	// Заполнение склада при вводе на основании (если будет) или интерактивно
	Если ТипЗнч(ДанныеЗаполнения) = Тип("СправочникСсылка.Склады") Тогда
		Склад = ДанныеЗаполнения;
	КонецЕсли;
	
	// Если склад выбран, а таблица пуста — заполняем автоматически
	Если ЗначениеЗаполнено(Склад) И Товары.Количество() = 0 Тогда
		ЗаполнитьПоОстаткам();
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьПоОстаткам() Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ОстаткиТоваровОстатки.Номенклатура КАК Номенклатура,
		|	ЕСТЬNULL(ОстаткиТоваровОстатки.КоличествоОстаток, 0) КАК УчетноеКоличество
		|ИЗ
		|	РегистрНакопления.ОстаткиТоваров.Остатки(&Период, Склад = &Склад) КАК ОстаткиТоваровОстатки
		|ГДЕ
		|	ОстаткиТоваровОстатки.КоличествоОстаток <> 0";
	
	// Если документ новый (Ссылка пустая) — берем текущую дату, иначе дату документа
	Запрос.УстановитьПараметр("Период", ?(ЗначениеЗаполнено(Ссылка), Дата, ТекущаяДата()));
	Запрос.УстановитьПараметр("Склад", Склад);
	
	Результат = Запрос.Выполнить();
	Товары.Загрузить(Результат.Выгрузить());
	
	// По умолчанию Факт = Учет (инвентаризация "по умолчанию" сходится)
	Для Каждого Стр Из Товары Цикл
		Стр.ФактическоеКоличество = Стр.УчетноеКоличество;
	КонецЦикла;
	
КонецПроцедуры

// --- ПРОВЕДЕНИЕ ---
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	// Инициализация
	Движения.ОстаткиТоваров.Записывать = Истина;
	
	// Формируем движения на разницу
	Для Каждого ТекСтрока Из Товары Цикл
		
		Если ТекСтрока.Отклонение = 0 Тогда
			Продолжить; // Расхождений нет
		КонецЕсли;
		
		Движение = Движения.ОстаткиТоваров.Добавить();
		Движение.Период = Дата;
		Движение.Склад = Склад;
		Движение.Номенклатура = ТекСтрока.Номенклатура;
		
		Если ТекСтрока.Отклонение > 0 Тогда
			// ИЗЛИШКИ (Нашли больше, чем было) -> Приход
			Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
			Движение.Количество = ТекСтрока.Отклонение;
			
		Иначе // Отклонение < 0
			// НЕДОСТАЧА (Не хватает) -> Расход
			Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
			Движение.Количество = -ТекСтрока.Отклонение; // Минус на минус дает плюс (нам нужно положительное число в поле Количество)
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры