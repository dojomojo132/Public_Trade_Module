Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	// --- 1. ИНИЦИАЛИЗАЦИЯ ДВИЖЕНИЙ ---
	Движения.ОстаткиТоваров.Записывать = Истина;
	Движения.Продажи.Записывать = Истина;
	Движения.ДенежныеСредства.Записывать = Истина;
	// Если используете дисконтные карты, раскомментируйте:
	// Движения.ПродажиПоДисконтнымКартам.Записывать = Истина;
	
	// --- 3. ФОРМИРОВАНИЕ ДВИЖЕНИЙ ПО ТОВАРАМ ---
	Для Каждого ТекСтрока Из Товары Цикл
		
		// А) Списание остатков (Расход)
		Движение = Движения.ОстаткиТоваров.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		Движение.Период = Дата;
		Движение.Склад = Склад;
		Движение.Номенклатура = ТекСтрока.Номенклатура;
		Движение.Количество = ТекСтрока.Количество;
		
		// Б) Фиксация продаж (Оборот)
		ДвижениеПродажи = Движения.Продажи.Добавить();
		ДвижениеПродажи.Период = Дата;
		ДвижениеПродажи.Номенклатура = ТекСтрока.Номенклатура;
		ДвижениеПродажи.Касса = Касса;
		ДвижениеПродажи.КассоваяСмена = КассоваяСмена;
		// Пытаемся определить текущего пользователя как сотрудника
		ДвижениеПродажи.Сотрудник = Справочники.Пользователи.НайтиПоНаименованию(ИмяПользователя());
		ДвижениеПродажи.Количество = ТекСтрока.Количество;
		ДвижениеПродажи.Сумма = ТекСтрока.Сумма;
		
	КонецЦикла;
	
	// --- 4. ФОРМИРОВАНИЕ ДВИЖЕНИЙ ПО ДЕНЬГАМ ---
	Для Каждого ТекОплата Из Оплата Цикл
		ДвижениеДеньги = Движения.ДенежныеСредства.Добавить();
		ДвижениеДеньги.ВидДвижения = ВидДвиженияНакопления.Приход;
		ДвижениеДеньги.Период = Дата;
		ДвижениеДеньги.Касса = Касса;
		ДвижениеДеньги.Сумма = ТекОплата.Сумма;
	КонецЦикла;
	
	// --- 5. ЗАПУСК СПЛИТ-СИСТЕМЫ (ФИСКАЛИЗАЦИЯ) ---
	// Если движений складских ошибок нет, пробуем пробить фискальные чеки
	Если Не Отказ Тогда
		Попытка
			ВыполнитьФискализацию();
		Исключение
			// Если ошибка фискализации - отменяем проведение всего чека
			Отказ = Истина;
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = "Ошибка фискализации: " + ОписаниеОшибки();
			Сообщение.Сообщить();
		КонецПопытки;
	КонецЕсли;

КонецПроцедуры

// --- ПРОЦЕДУРА РАЗБИЕНИЯ ЧЕКА (SPLIT) ---
Процедура ВыполнитьФискализацию()
	
	// 1. Получаем список уникальных налоговых групп в чеке
	ТаблицаГрупп = Товары.Выгрузить();
	ТаблицаГрупп.Свернуть("НалоговаяГруппа"); 
	
	Для Каждого СтрГруппа Из ТаблицаГрупп Цикл
		
		НалогГруппа = СтрГруппа.НалоговаяГруппа;
		
		// 2. Определяем, на какое оборудование печатать эту группу
		Оборудование = ПолучитьОборудованиеДляГруппы(НалогГруппа);
		
		// Если для группы не найдено оборудование в регистре - это ошибка настройки
		Если Оборудование.Пустая() Тогда
			ВызватьИсключение "Не настроено распределение для группы: " + НалогГруппа + " на кассе: " + Касса;
		КонецЕсли;

		// 3. Создаем технический документ "ФискальныйЧек"
		НовыйЧек = Документы.ФискальныйЧек.СоздатьДокумент();
		НовыйЧек.Дата = Дата;
		НовыйЧек.ДокументОснование = Ссылка; // Связь с родительским чеком
		НовыйЧек.Оборудование = Оборудование;
		
		// Эмуляция ответа от драйвера (Номер чека и ФПД)
		УИД = Строка(Новый УникальныйИдентификатор);
		НовыйЧек.НомерЧекаККМ = "K-" + Сред(УИД, 1, 8); 
		НовыйЧек.ФискальныйПризнак = "ФП-" + Сред(УИД, 25, 12);
		
		// 4. Заполняем товары, относящиеся только к текущей группе
		Отбор = Новый Структура("НалоговаяГруппа", НалогГруппа);
		СтрокиГруппы = Товары.НайтиСтроки(Отбор);
		
		СуммаЧека = 0;
		Для Каждого СтрокаТЧ Из СтрокиГруппы Цикл
			НоваяСтрока = НовыйЧек.Товары.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТЧ);
			СуммаЧека = СуммаЧека + НоваяСтрока.Сумма;
		КонецЦикла;
		
		НовыйЧек.Сумма = СуммаЧека;
		
		// 5. Проводим технический чек
		НовыйЧек.Записать(РежимЗаписиДокумента.Проведение);
		
	КонецЦикла;

КонецПроцедуры

// --- ПОИСК ОБОРУДОВАНИЯ В РЕГИСТРЕ ---
Функция ПолучитьОборудованиеДляГруппы(НалоговаяГруппа)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Настройки.Оборудование
		|ИЗ
		|	РегистрСведений.НастройкиРаспределенияПродаж КАК Настройки
		|ГДЕ
		|	Настройки.Касса = &Касса
		|	И Настройки.НалоговаяГруппа = &НалоговаяГруппа";
		
	Запрос.УстановитьПараметр("Касса", Касса);
	Запрос.УстановитьПараметр("НалоговаяГруппа", НалоговаяГруппа);
	
	Результат = Запрос.Выполнить();
	Если Не Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Оборудование;
	КонецЕсли;
	
	Возврат Справочники.КассовоеОборудование.ПустаяСсылка();
	
КонецФункции