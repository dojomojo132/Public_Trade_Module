// --- 1. ОБРАБОТЧИКИ СОБЫТИЙ ШАПКИ И ТАБЛИЦ ---

&НаКлиенте
Процедура ТоварыНоменклатураПриИзменении(Элемент)
	
	ТекСтрока = Элементы.Товары.ТекущиеДанные;
	
	Если ТекСтрока <> Неопределено И ЗначениеЗаполнено(ТекСтрока.Номенклатура) Тогда
		
		// 1. Получаем данные товара
		ДанныеТовара = ПолучитьДанныеНоменклатурыНаСервере(ТекСтрока.Номенклатура, Объект.Склад, Объект.Дата);
		
		ТекСтрока.Цена = ДанныеТовара.Цена;
		ТекСтрока.НалоговаяГруппа = ДанныеТовара.НалоговаяГруппа;
		ТекСтрока.Количество = 1;
		
		// 2. Логика Маркировки (АСИНХРОННО)
		Если ДанныеТовара.ТребуетМарку Тогда
			
			Подсказка = "Товар """ + ТекСтрока.Номенклатура + """ требует акцизную марку! Отсканируйте DataMatrix:";
			
			// Передаем текущую строку в параметры, чтобы обработчик знал, куда писать марку
			ПараметрыОповещения = Новый Структура("СтрокаТаблицы", ТекСтрока);
			Оповещение = Новый ОписаниеОповещения("ВводМаркиЗавершение", ЭтотОбъект, ПараметрыОповещения);
			
			// Вызываем неблокирующее окно ввода
			ПоказатьВводСтроки(Оповещение, "", Подсказка, 0, Истина);
			
		Иначе
			// Если марка не нужна, сразу считаем
			РассчитатьСтроку(ТекСтрока);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВводМаркиЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	ТекСтрока = ДополнительныеПараметры.СтрокаТаблицы;
	
	// Результат = Неопределено, если нажали Отмена
	Если Результат <> Неопределено Тогда
		
		ТекСтрока.АкцизнаяМарка = Результат;
		РассчитатьСтроку(ТекСтрока);
		
	Иначе
		
		// Если отказались вводить марку - очищаем строку
		ТекСтрока.Номенклатура = ПредопределенноеЗначение("Справочник.Номенклатура.ПустаяСсылка");
		ТекСтрока.Количество = 0;
		ТекСтрока.Цена = 0;
		ТекСтрока.Сумма = 0;
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Ввод марки отменен. Товар удален из строки.";
		Сообщение.Сообщить();
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	РассчитатьСтроку(Элементы.Товары.ТекущиеДанные);
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	РассчитатьСтроку(Элементы.Товары.ТекущиеДанные);
КонецПроцедуры

// --- 2. РАСЧЕТНЫЕ ФУНКЦИИ ---

&НаКлиенте
Процедура РассчитатьСтроку(СтрокаТЧ)
	
	// Сумма = Цена * Кол-во - Скидка
	СтрокаТЧ.Сумма = (СтрокаТЧ.Цена * СтрокаТЧ.Количество) - СтрокаТЧ.СуммаСкидки;
	
	РассчитатьИтогиДокумента();
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьИтогиДокумента()
	
	Объект.СуммаДокумента = 0;
	
	Для Каждого Стр Из Объект.Товары Цикл
		Объект.СуммаДокумента = Объект.СуммаДокумента + Стр.Сумма;
	КонецЦикла;
	
КонецПроцедуры

// --- 3. ПОМОЩНИКИ ОПЛАТЫ ---

&НаКлиенте
Процедура ОплатитьНаличными(Команда)
	ДобавитьОплату(ПредопределенноеЗначение("Перечисление.ВидыОплаты.Наличные"));
КонецПроцедуры

&НаКлиенте
Процедура ОплатитьКартой(Команда)
	ДобавитьОплату(ПредопределенноеЗначение("Перечисление.ВидыОплаты.Безналичные"));
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьОплату(ВидОплаты)
	
	// Считаем сколько еще осталось оплатить
	УжеОплачено = 0;
	Для Каждого Стр Из Объект.Оплата Цикл
		УжеОплачено = УжеОплачено + Стр.Сумма;
	КонецЦикла;
	
	ОстатокКДоплате = Объект.СуммаДокумента - УжеОплачено;
	
	Если ОстатокКДоплате <= 0 Тогда
		Сообщить("Вся сумма уже распределена!");
		Возврат;
	КонецЕсли;
	
	НоваяОплата = Объект.Оплата.Добавить();
	НоваяОплата.ВидОплаты = ВидОплаты;
	НоваяОплата.Сумма = ОстатокКДоплате;
	
КонецПроцедуры

// --- 4. ПРОВЕРКА ПЕРЕД ЗАПИСЬЮ (ВАЛИДАЦИЯ) ---

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи, РежимЗаписи)
	
	// Если просто записываем (не проводим), проверки не нужны
	Если РежимЗаписи = РежимЗаписиДокумента.Запись Тогда
		Возврат;
	КонецЕсли;
	
	// 1. Проверка сумм
	СуммаОплат = 0;
	Для Каждого Стр Из Объект.Оплата Цикл
		СуммаОплат = СуммаОплат + Стр.Сумма;
	КонецЦикла;
	
	Если СуммаОплат < Объект.СуммаДокумента Тогда
		Отказ = Истина;
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Недостаточно средств оплаты! Внесено: " + СуммаОплат + ", Требуется: " + Объект.СуммаДокумента;
		Сообщение.Сообщить();
	КонецЕсли;
	
	// 2. Статус
	Если Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусыЧекаККМ.Аннулирован") Тогда
		Отказ = Истина;
		Сообщить("Нельзя провести аннулированный чек!");
	КонецЕсли;
	
	// При проведении статус автоматически становится "Пробит"
	Если Не Отказ Тогда
		Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусыЧекаККМ.Пробит");
	КонецЕсли;
	
КонецПроцедуры

// --- 5. СЕРВЕРНЫЕ ЗАПРОСЫ ---

&НаСервереБезКонтекста
Функция ПолучитьДанныеНоменклатурыНаСервере(Номенклатура, Склад, ДатаДок)
	
	Результат = Новый Структура("Цена, ТребуетМарку, НалоговаяГруппа", 0, Ложь, Неопределено);
	
	Если Не ЗначениеЗаполнено(Номенклатура) Тогда
		Возврат Результат;
	КонецЕсли;
	
	// 1. Читаем реквизиты самого товара
	Результат.ТребуетМарку = Номенклатура.ТребуетАкцизнуюМарку;
	Результат.НалоговаяГруппа = Номенклатура.НалоговаяГруппа;
	
	// 2. Получаем цену (Срез последних)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) КАК Цена
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&Период, Номенклатура = &Номенклатура) КАК ЦеныНоменклатурыСрезПоследних";
		
	Запрос.УстановитьПараметр("Период", ?(ЗначениеЗаполнено(ДатаДок), ДатаДок, ТекущаяДата()));
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат.Цена = Выборка.Цена;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции