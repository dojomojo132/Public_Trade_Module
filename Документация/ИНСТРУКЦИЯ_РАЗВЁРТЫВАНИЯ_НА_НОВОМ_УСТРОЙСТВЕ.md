# Инструкция для AI-агента: Развёртывание проекта PTM на новом устройстве

> **Назначение:** Полная пошаговая инструкция для AI-агента (GitHub Copilot) по настройке рабочей среды проекта **PTM (Public Trade Module)** на чистом устройстве. После выполнения всех шагов среда должна быть полностью идентична эталонной.
>
> **Целевой результат:** Агент, запущенный по этой инструкции, полностью настроит VS Code, 1С, MCP-сервер, скрипты деплоя и сможет вести разработку конфигурации.

---

## ОГЛАВЛЕНИЕ

1. [Предварительные требования](#1-предварительные-требования)
2. [Установка ПО](#2-установка-по)
3. [Клонирование репозитория](#3-клонирование-репозитория)
4. [Настройка VS Code](#4-настройка-vs-code)
5. [Настройка 1С:Предприятие](#5-настройка-1спредприятие)
6. [Настройка MCP-сервера 1С](#6-настройка-mcp-сервера-1с)
7. [Финальная проверка](#7-финальная-проверка)
8. [Справочник путей и переменных](#8-справочник-путей-и-переменных)

---

## 1. ПРЕДВАРИТЕЛЬНЫЕ ТРЕБОВАНИЯ

### 1.1 Операционная система
- **Windows 10/11** (x64)

### 1.2 Необходимое ПО (установить до начала)

| Компонент | Минимальная версия | Где взять |
|-----------|-------------------|-----------|
| 1С:Предприятие | 8.3.27.x | Установщик от 1С (нужна лицензия) |
| Git | 2.40+ | https://git-scm.com |
| Node.js | 18+ (LTS рекомендуется) | https://nodejs.org |
| Python | 3.10+ | https://python.org |
| VS Code | Последняя стабильная | https://code.visualstudio.com |
| PowerShell | 5.1 (встроен в Windows) | Уже есть |

### 1.3 Лицензия 1С
На устройстве должна быть активирована лицензия 1С:Предприятие 8.3. Без лицензии невозможна работа конфигуратора и загрузка конфигурации.

---

## 2. УСТАНОВКА ПО

### 2.1 Установить 1С:Предприятие 8.3.27

```
Установить с компонентами:
- Тонкий клиент
- Толстый клиент
- Конфигуратор
- Сервер администрирования (опционально)
- Модули расширения веб-сервера (ОБЯЗАТЕЛЬНО — для MCP!)

Путь установки по умолчанию: C:\Program Files\1cv8\8.3.27.XXXX\
```

**КРИТИЧНО:** Запомнить точную версию (например `8.3.27.1719`), она понадобится ниже.

### 2.2 Проверить установку

```powershell
# Найти установленные версии 1С
Get-ChildItem "C:\Program Files\1cv8\" -Directory

# Проверить наличие 1cv8.exe
$v8 = Get-ChildItem "C:\Program Files\1cv8\" -Recurse -Filter "1cv8.exe" | Select-Object -First 1
$v8.FullName

# Node.js
node --version

# Python  
python --version

# Git
git --version
```

---

## 3. КЛОНИРОВАНИЕ РЕПОЗИТОРИЯ

### 3.1 Клонировать

```powershell
cd D:\Git
git clone <URL_РЕПОЗИТОРИЯ> Public_Trade_Module
cd Public_Trade_Module
```

> **Путь проекта:** `D:\Git\Public_Trade_Module`  
> Если путь другой — необходимо адаптировать все пути в конфигурационных файлах (см. раздел 8).

### 3.2 Установить npm-зависимости

```powershell
cd D:\Git\Public_Trade_Module
npm install

cd mcp-config
npm install
cd ..
```

---

## 4. НАСТРОЙКА VS CODE

### 4.1 Расширения (обязательные)

Установить следующие расширения VS Code. Агент может выполнить команды:

```powershell
# === 1С / BSL ===
code --install-extension 1c-syntax.language-1c-bsl
code --install-extension yellow-hammer.1c-platform-tools
code --install-extension skywow.1c-filebase-manager
code --install-extension skywow.init-dev-base-1c
code --install-extension zerobig.vscode-1c-metadata-viewer
code --install-extension akpaevj.onec-debug
code --install-extension artemyakovlev.vsc-1c-local-check
code --install-extension astrizhachuk.1c-extension-pack
code --install-extension bsl-analyzer-team.bsl-type-safety-analyzer

# === Общие разработческие ===
code --install-extension github.copilot-chat
code --install-extension ms-python.python
code --install-extension ms-python.vscode-pylance
code --install-extension ms-python.debugpy
code --install-extension ms-python.vscode-python-envs
code --install-extension ms-vscode.powershell
code --install-extension dotjoshjohnson.xml
code --install-extension davidanson.vscode-markdownlint

# === Docker/Containers (опционально) ===
code --install-extension ms-azuretools.vscode-docker
code --install-extension ms-azuretools.vscode-containers

# === Локализация ===
code --install-extension ms-ceintl.vscode-language-pack-ru

# === Другие (по желанию) ===
code --install-extension codezombiech.gitignore
code --install-extension evilbeaver.oscript-debug
code --install-extension reshitko.tester
```

### 4.2 Настройки воркспейса (.vscode/settings.json)

Файл уже в репозитории: `.vscode/settings.json`. После клонирования проверить содержимое:

```json
{
    "editor.formatOnSave": false,
    "files.encoding": "utf8bom",
    "files.autoSave": "onFocusChange",
    "files.associations": {
        "*.bsl": "bsl",
        "*.os": "bsl"
    },
    "[bsl]": {
        "editor.tabSize": 4,
        "editor.insertSpaces": false,
        "editor.wordWrap": "on"
    },
    "search.exclude": {
        "**/node_modules": true,
        "**/DerivedData": true
    },
    "github.copilot.chat.codeGeneration.useReferencedFiles": true
}
```

### 4.3 Пользовательские настройки VS Code (глобальные)

Открыть `%APPDATA%\Code\User\settings.json` и добавить/обновить:

```json
{
    "github.copilot.enable": {
        "*": true,
        "plaintext": false,
        "scminput": false
    },
    "github.copilot.nextEditSuggestions.enabled": true,
    "chat.agent.maxRequests": 100,

    "chat.mcp.serverSampling": {
        "Global in Code: mcp_1c_torgovly": {
            "allowedModels": ["copilot/claude-haiku-4.5"]
        },
        "Глобальный в Code: mcp_1c_torgovly": {
            "allowedModels": ["copilot/claude-sonnet-4.5"]
        }
    },

    "chat.commandCenter.enabled": true,
    "chat.agent.autoApprove.terminals": [
        "Get-ChildItem",
        "Select-String",
        "Test-Path",
        "Get-Content",
        "git status",
        "git log",
        "git diff",
        "git branch",
        "npm ls",
        "npm list",
        "node --version",
        "python --version",
        "cat ",
        "type ",
        "dir ",
        "ls ",
        "find ",
        "grep "
    ]
}
```

> **Адаптировать:** Если используется BSL Analyzer — обновить путь `bslAnalyzer.path` на актуальный путь к ИБ.

### 4.4 Задачи (.vscode/tasks.json)

Файл уже в репозитории. Содержит задачу "Открыть спецификацию".

### 4.5 Конфигурации запуска (.vscode/launch.json)

Файл уже в репозитории. Содержит:
- OneScript отладка (oscript.exe)
- Attach к 1С через DBG (порт 1550)

### 4.6 Рекомендации расширений (.vscode/extensions.json)

```json
{
    "recommendations": [
        "yellow-hammer.1c-platform-tools"
    ]
}
```

---

## 5. НАСТРОЙКА 1С:ПРЕДПРИЯТИЕ

### 5.1 Создать файловую информационную базу

**Вариант А: Из файла .dt (рекомендуется)**

1. Запустить 1С:Предприятие
2. «Добавить» → «Создание новой информационной базы»
3. «Создание информационной базы без конфигурации»
4. Указать путь: `D:\Confiq\Public Trade Module` (создать папку если не существует)
5. Готово — база создана
6. Открыть конфигуратор
7. «Администрирование» → «Загрузить информационную базу» → выбрать `.dt` файл из папки `CF/` репозитория (выбрать последний по дате)

**Вариант Б: Из XML-выгрузки**

```powershell
# Создать пустую базу
$v8exe = (Get-ChildItem "C:\Program Files\1cv8\" -Recurse -Filter "1cv8.exe" | Sort-Object { [version]$_.Directory.Parent.Name } -Descending | Select-Object -First 1).FullName
& $v8exe CREATEINFOBASE "File=""D:\Confiq\Public Trade Module"""

# Загрузить конфигурацию из XML
$scriptPath = Get-ChildItem -Path "D:\Git\Public_Trade_Module" -Recurse -Filter "deploy-config.ps1" | Select-Object -First 1
powershell -ExecutionPolicy Bypass -File $scriptPath.FullName -Action Full
```

### 5.2 Создать пользователя

В конфигураторе:
1. «Администрирование» → «Пользователи»
2. Создать пользователя **Admin** (без пароля, или с паролем — тогда обновить скрипты)
3. Назначить роль **ПолныеПрава**

### 5.3 Настроить пути в скриптах деплоя

Файл `Документация/Валидация/deploy-config.ps1` — параметр по умолчанию:

```powershell
[string]$BasePath = "D:\Confiq\Public Trade Module"
```

**Если база размещена по другому пути** — либо изменить значение по умолчанию, либо всегда передавать параметр `-BasePath`.

### 5.4 Настройка веб-публикации 1С (для MCP-сервера)

**КРИТИЧНО:** MCP-сервер метаданных — это HTTP-сервис внутри конфигурации 1С, опубликованный через веб-сервер. Без веб-публикации MCP-инструменты работать не будут.

#### 5.4.1 Установить Apache (из поставки 1С)

1С поставляется с Apache. Путь обычно: `C:\Program Files\1cv8\8.3.27.XXXX\httpd\`

Альтернативно можно использовать IIS, но Apache проще настроить.

#### 5.4.2 Публикация базы на веб-сервере

В конфигураторе:
1. «Администрирование» → «Публикация на веб-сервере...»
2. Заполнить:
   - **Имя публикации:** `PTM`
   - **Веб-сервер:** Apache (или IIS)
   - **Каталог:** Выбрать каталог для публикации
   - **Отметить:** «Публиковать HTTP-сервисы»
3. «Опубликовать»

#### 5.4.3 Проверить веб-публикацию

```powershell
# MCP-сервер должен отвечать
Invoke-RestMethod -Uri "http://localhost/PTM/hs/mcp/mcp" -Method POST -Body '{"jsonrpc":"2.0","method":"tools/list","id":1}' -ContentType "application/json"
```

> **Если HTTP-сервис `mcp` отсутствует в конфигурации** — его нужно создать. Он реализован как HTTPСервис внутри конфигурации 1С и предоставляет два метода: `list_metadata_objects` и `get_metadata_structure`.

---

## 6. НАСТРОЙКА MCP-СЕРВЕРА 1С

### 6.1 Глобальная конфигурация MCP для VS Code

Создать/обновить файл `%APPDATA%\Code\User\mcp.json`:

```json
{
    "servers": {
        "mcp_1c_torgovly": {
            "url": "http://localhost/PTM/hs/mcp/mcp",
            "type": "http"
        }
    },
    "inputs": []
}
```

> **Адаптация пути:** Если имя публикации отличается от `PTM`, заменить в URL.

### 6.2 Проверить работу MCP

1. Перезапустить VS Code
2. Открыть GitHub Copilot Chat (Ctrl+Shift+I)
3. В режиме Agent написать: "Вызови mcp_mcp_1c_torgov_list_metadata_objects для типа Catalogs"
4. Агент должен получить список справочников из информационной базы

### 6.3 Copilot Instructions

Файл `.github/copilot-instructions.md` уже в репозитории. Он автоматически подхватывается GitHub Copilot Chat при работе в этом воркспейсе. **Не трогать — это ядро поведения агента.**

---

## 7. ФИНАЛЬНАЯ ПРОВЕРКА

### 7.1 Чеклист (выполнить все пункты)

```powershell
# 1. Проверить структуру репозитория
Test-Path "D:\Git\Public_Trade_Module\Конфигурация\Configuration.xml"  # True
Test-Path "D:\Git\Public_Trade_Module\Конфигурация\ConfigDumpInfo.xml"  # True
Test-Path "D:\Git\Public_Trade_Module\.github\copilot-instructions.md"  # True

# 2. Проверить 1cv8.exe
$v8 = Get-ChildItem "C:\Program Files\1cv8\" -Recurse -Filter "1cv8.exe" | Select-Object -First 1
$v8.FullName  # Должен вернуть путь

# 3. Проверить базу 1С
Test-Path "D:\Confiq\Public Trade Module\1Cv8.1CD"  # True

# 4. Проверить npm-зависимости
Test-Path "D:\Git\Public_Trade_Module\node_modules"  # True

# 5. Проверить Python
python --version  # 3.x

# 6. Запустить валидацию конфигурации
$script = Get-ChildItem -Path "D:\Git\Public_Trade_Module" -Recurse -Filter "validate-config.ps1" | Select-Object -First 1
powershell -ExecutionPolicy Bypass -File $script.FullName
# Результат: 0 ошибок (или только предупреждения)

# 7. Запустить полный деплой (загрузка + проверка + обновление)
$deploy = Get-ChildItem -Path "D:\Git\Public_Trade_Module" -Recurse -Filter "deploy-config.ps1" | Select-Object -First 1
powershell -ExecutionPolicy Bypass -File $deploy.FullName -Action Full
# Результат: exit code 0

# 8. Открыть конфигуратор
powershell -ExecutionPolicy Bypass -File $deploy.FullName -Action Designer
```

### 7.2 Проверить MCP

В GitHub Copilot Chat (Agent mode):
```
Вызови mcp_mcp_1c_torgov_list_metadata_objects с metaType="Catalogs"
```

Должен вернуть список справочников конфигурации.

### 7.3 Проверить BSL Language Server

1. Открыть любой `.bsl` файл из `Конфигурация/`
2. Должна работать подсветка синтаксиса, линтинг
3. `get_errors` на файл должен работать

---

## 8. СПРАВОЧНИК ПУТЕЙ И ПЕРЕМЕННЫХ

### 8.1 Ключевые пути (по умолчанию)

| Компонент | Путь | Где настраивается |
|-----------|------|-------------------|
| Репозиторий | `D:\Git\Public_Trade_Module` | git clone |
| Информационная база (основная) | `D:\Confiq\Public Trade Module` | deploy-config.ps1 `-BasePath` |
| XML-конфигурация (рабочая копия) | `Конфигурация\Проверка` | deploy-config.ps1 `-ConfigPath` |
| XML-конфигурация (эталон) | `Конфигурация\` | Файлы выгрузки |
| 1cv8.exe | `C:\Program Files\1cv8\8.3.27.XXXX\bin\1cv8.exe` | Автопоиск в deploy-config.ps1 |
| Логи деплоя | `Документация\Валидация\logs\` | deploy-config.ps1 `-LogDir` |
| Copilot instructions | `.github\copilot-instructions.md` | Автоматически |
| MCP конфигурация | `%APPDATA%\Code\User\mcp.json` | Глобальная настройка VS Code |

### 8.2 Что адаптировать при другом расположении

Если пути отличаются от эталонных, изменить:

| Файл | Что менять |
|------|-----------|
| `Документация/Валидация/deploy-config.ps1` | Параметр `$BasePath` (путь к ИБ) |
| `mcp-config/config.json` | `connections.development.path` |
| `%APPDATA%\Code\User\mcp.json` | URL MCP-сервера (имя публикации `PTM`) |
| `%APPDATA%\Code\User\settings.json` | `bslAnalyzer.path`, `1c-filebase-manager` настройки |

### 8.3 Версии ПО (эталонная среда)

| Компонент | Версия |
|-----------|--------|
| 1С:Предприятие | 8.3.27.1719 |
| Node.js | 24.13.0 |
| Python | 3.14.0 |
| Git | 2.52.0 |
| PowerShell | 5.1 |
| VS Code | Последняя стабильная |

---

## 9. СТРУКТУРА КАТАЛОГОВ (для контроля)

После полной настройки должна быть следующая структура:

```
D:\Git\Public_Trade_Module\                ← Репозиторий
├── .github\
│   └── copilot-instructions.md            ← Инструкции для AI-агента
├── .vscode\
│   ├── settings.json                      ← Настройки воркспейса
│   ├── tasks.json                         ← Задачи
│   ├── launch.json                        ← Конфигурации запуска
│   ├── extensions.json                    ← Рекомендации расширений
│   └── mcp-tools\                         ← MCP-инструменты отладки
├── Конфигурация\                          ← XML-выгрузка конфигурации
│   ├── Configuration.xml                  ← Главный файл конфигурации
│   ├── ConfigDumpInfo.xml                 ← Реестр UUID объектов
│   ├── Проверка\                          ← Рабочая копия для деплоя
│   ├── Catalogs\                          ← Справочники
│   ├── Documents\                         ← Документы
│   ├── Enums\                             ← Перечисления
│   ├── CommonModules\                     ← Общие модули
│   ├── AccumulationRegisters\             ← Регистры накопления
│   ├── InformationRegisters\              ← Регистры сведений
│   ├── Reports\                           ← Отчёты
│   ├── DataProcessors\                    ← Обработки
│   ├── Constants\                         ← Константы
│   ├── Subsystems\                        ← Подсистемы
│   └── ...                                ← Прочие папки объектов
├── Документация\
│   ├── Спецификации\                      ← Техническая спецификация, алгоритм
│   ├── Технические_стандарты\             ← Стандарты BSL, XML, форм
│   ├── Шаблоны\                           ← XML-шаблоны объектов
│   └── Валидация\                         ← deploy-config.ps1, validate-config.ps1
├── mcp-config\                            ← MCP-сервер (debug-bridge)
├── CF\                                    ← .dt файлы резервных копий
└── PTM\                                   ← Копия ИБ (для локальной работы)

D:\Confiq\Public Trade Module\             ← Информационная база 1С
└── 1Cv8.1CD                               ← Файл базы данных
```

---

## 10. МЕХАНИЗМ РАБОТЫ КОНФИГУРАЦИЯ → ДЕПЛОЙ

### Понимание рабочего процесса

```
Конфигурация/              ← Эталонные XML-файлы (git-tracked)
       │
       ├─ sync ─→ Конфигурация/Проверка/   ← Рабочая копия (деплоится в 1С)
       │
       └─ deploy-config.ps1 -Action Full:
              1. validate-config.ps1        ← Проверка XML-файлов
              2. LoadConfigFromFiles        ← Загрузка XML → ИБ
              3. CheckConfig                ← Синтакс-контроль BSL
              4. UpdateDBCfg               ← Обновление БД
              5. Designer                  ← Открытие конфигуратора
```

### Порядок при разработке

1. Агент вносит изменения в XML/BSL файлы в `Конфигурация/`
2. `_sync_full_config.py` копирует в `Конфигурация/Проверка/`
3. `deploy-config.ps1 -Action Full` загружает в ИБ
4. При ошибках — цикл исправления + повторный деплой

---

## 11. TROUBLESHOOTING

### 11.1 1cv8.exe не найден

```powershell
# Проверить наличие
Get-ChildItem "C:\Program Files\1cv8\" -Directory
# Если пусто — 1С не установлена
```

### 11.2 MCP не отвечает

```powershell
# Проверить веб-публикацию
Invoke-WebRequest -Uri "http://localhost/PTM/" -UseBasicParsing
# Если ошибка — база не опубликована на веб-сервере
```

### 11.3 Кириллица ломается в PowerShell

Это ИЗВЕСТНАЯ ПРОБЛЕМА среды. Решение:
- Для файловых операций с кириллическими путями — использовать Python-скрипты
- Шаблон: `Документация/Шаблоны/template-delete-object.py`
- Для запуска PS1-скриптов — использовать Get-ChildItem для поиска файла

### 11.4 База заблокирована

```powershell
# Закрыть все процессы 1С
Get-Process -Name "1cv8*" | Stop-Process -Force
```

### 11.5 Ошибка при LoadConfigFromFiles

Обычно вызвана невалидным XML. Запустить:
```powershell
$script = Get-ChildItem -Path "D:\Git\Public_Trade_Module" -Recurse -Filter "validate-config.ps1" | Select-Object -First 1
powershell -ExecutionPolicy Bypass -File $script.FullName
```
Исправить все `[ОШИБКА]` и повторить загрузку.
