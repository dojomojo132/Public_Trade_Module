# Инструкция для AI-агента: Создание рабочей документации для новой конфигурации 1С

> **Назначение:** Пошаговая инструкция для AI-агента по созданию полного набора рабочей документации, шаблонов, скриптов валидации/деплоя и copilot-instructions для **произвольной** конфигурации 1С:Предприятие 8.3.
>
> **Предусловия:** В репозитории УЖЕ есть:
> - Папка с XML-выгрузкой конфигурации (аналог `Конфигурация/`)
> - MCP-сервер для работы с метаданными (HTTP-сервис в ИБ, аналог `mcp_1c_torgov`)
>
> **Результат:** Полностью настроенная рабочая среда для AI-разработки, идентичная по качеству проекту PTM.

---

## ОГЛАВЛЕНИЕ

1. [Входные данные от пользователя](#1-входные-данные-от-пользователя)
2. [Анализ конфигурации](#2-анализ-конфигурации)
3. [Создание структуры документации](#3-создание-структуры-документации)
4. [Техническая спецификация](#4-техническая-спецификация)
5. [XML-шаблоны объектов](#5-xml-шаблоны-объектов)
6. [Технические стандарты](#6-технические-стандарты)
7. [Скрипты валидации и деплоя](#7-скрипты-валидации-и-деплоя)
8. [Copilot Instructions](#8-copilot-instructions)
9. [Настройки VS Code](#9-настройки-vs-code)
10. [Регламенты и процессы](#10-регламенты-и-процессы)
11. [Финальная проверка](#11-финальная-проверка)

---

## 1. ВХОДНЫЕ ДАННЫЕ ОТ ПОЛЬЗОВАТЕЛЯ

Перед началом работы **запросить** у пользователя:

| # | Параметр | Пример | Обязательно |
|---|----------|--------|-------------|
| 1 | **Имя конфигурации** (краткое) | `PTM`, `ERP`, `RetailPro` | Да |
| 2 | **Полное название** конфигурации | `Торговля розница` | Да |
| 3 | **Версия платформы** 1С | `8.3.27` | Да |
| 4 | **Путь к репозиторию** | `D:\Git\MyProject` | Да |
| 5 | **Путь к папке XML-выгрузки** внутри репозитория | `Конфигурация/` | Да |
| 6 | **Путь к файловой ИБ** | `D:\Confiq\My Base` | Да |
| 7 | **Имя пользователя ИБ** | `Admin` | Да (по умолчанию `Admin`) |
| 8 | **Имя MCP-сервера** в VS Code | `mcp_1c_myproject` | Да |
| 9 | **URL MCP-сервера** | `http://localhost/MyProject/hs/mcp/mcp` | Да |
| 10 | **Имя публикации** базы на веб-сервере | `MyProject` | Да |
| 11 | **Описание/назначение** конфигурации | `Розничная торговля, склад, касса` | Да |
| 12 | **Подсистемы верхнего уровня** | `Торговля, Склад, Финансы, Настройки` | Желательно |

**Переменные-плейсхолдеры** для шаблонов ниже:

```
{{PROJECT_SHORT}}      — краткое имя (PTM, ERP...)
{{PROJECT_FULL}}       — полное название
{{PLATFORM_VERSION}}   — версия платформы (8.3.27)
{{REPO_PATH}}          — путь к репозиторию
{{CONFIG_PATH}}        — путь к XML-выгрузке
{{BASE_PATH}}          — путь к файловой ИБ
{{DB_USER}}            — пользователь ИБ
{{MCP_SERVER_NAME}}    — имя MCP-сервера
{{MCP_URL}}            — URL MCP-сервера
{{WEB_PUBLICATION}}    — имя публикации
{{DESCRIPTION}}        — описание конфигурации
```

---

## 2. АНАЛИЗ КОНФИГУРАЦИИ

### 2.1 Исследовать существующую конфигурацию

Через MCP-инструменты получить полную картину конфигурации:

```
// Шаг 1: Получить ВСЕ типы объектов
mcp_{{MCP_SERVER_NAME}}_list_metadata_objects(metaType="Catalogs")
mcp_{{MCP_SERVER_NAME}}_list_metadata_objects(metaType="Documents")
mcp_{{MCP_SERVER_NAME}}_list_metadata_objects(metaType="Enums")
mcp_{{MCP_SERVER_NAME}}_list_metadata_objects(metaType="AccumulationRegisters")
mcp_{{MCP_SERVER_NAME}}_list_metadata_objects(metaType="InformationRegisters")
mcp_{{MCP_SERVER_NAME}}_list_metadata_objects(metaType="Reports")
mcp_{{MCP_SERVER_NAME}}_list_metadata_objects(metaType="DataProcessors")
mcp_{{MCP_SERVER_NAME}}_list_metadata_objects(metaType="CommonModules")
mcp_{{MCP_SERVER_NAME}}_list_metadata_objects(metaType="Constants")
mcp_{{MCP_SERVER_NAME}}_list_metadata_objects(metaType="Subsystems")

// Шаг 2: Для КАЖДОГО объекта — получить структуру
mcp_{{MCP_SERVER_NAME}}_get_metadata_structure(metaType="Catalogs", name="ИмяСправочника")
// ... повторить для каждого объекта
```

### 2.2 Проанализировать XML-файлы

```
// Прочитать Configuration.xml — определить:
//   - Имя конфигурации, синоним
//   - Версию (version="2.20")
//   - Настройки модальности (ModalityUseMode)
//   - Режим запуска (DefaultRunMode)
//   - ScriptVariant (Russian/English)
//   - Список всех объектов в <ChildObjects>

// Прочитать ConfigDumpInfo.xml — определить формат записей
```

### 2.3 Составить реестр объектов

Создать таблицу:

```markdown
| Тип | Имя | Синоним | Реквизиты | Табличные части | Формы | Подсистема |
|-----|-----|---------|-----------|-----------------|-------|------------|
| Справочник | Номенклатура | Номенклатура | Код, Наименование, Ед | — | ФормаЭлемента | Торговля |
| ... | ... | ... | ... | ... | ... | ... |
```

---

## 3. СОЗДАНИЕ СТРУКТУРЫ ДОКУМЕНТАЦИИ

### 3.1 Создать дерево папок

```
{{REPO_PATH}}/
├── .github/
│   └── copilot-instructions.md          ← СОЗДАТЬ (раздел 8)
├── .vscode/
│   ├── settings.json                    ← СОЗДАТЬ (раздел 9)
│   ├── tasks.json                       ← СОЗДАТЬ (раздел 9)
│   ├── launch.json                      ← СОЗДАТЬ (раздел 9)
│   └── extensions.json                  ← СОЗДАТЬ (раздел 9)
├── Документация/
│   ├── README.md                        ← СОЗДАТЬ (навигатор)
│   ├── Спецификации/
│   │   ├── ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ КОНФИГУРАЦИИ {{PROJECT_SHORT}}.xml  ← СОЗДАТЬ (раздел 4)
│   │   ├── Алгоритм разработки.xml      ← СОЗДАТЬ (раздел 10)
│   │   └── Регламент актуализации документации.xml  ← СОЗДАТЬ (раздел 10)
│   ├── Технические_стандарты/
│   │   ├── 1c-standards-{{PLATFORM_VERSION}}.md   ← СОЗДАТЬ (раздел 6)
│   │   ├── xml-structure-{{PLATFORM_VERSION}}.md  ← СОЗДАТЬ (раздел 6)
│   │   └── form-elements.md              ← СОЗДАТЬ (раздел 6)
│   ├── Шаблоны/
│   │   ├── README.md                     ← СОЗДАТЬ (раздел 5)
│   │   ├── template-catalog.xml          ← СОЗДАТЬ (раздел 5)
│   │   ├── template-document.xml         ← СОЗДАТЬ
│   │   ├── template-form.xml             ← СОЗДАТЬ
│   │   ├── template-form-document.xml    ← СОЗДАТЬ
│   │   ├── template-form-catalog.xml     ← СОЗДАТЬ
│   │   ├── template-enum.xml             ← СОЗДАТЬ
│   │   ├── template-common-module.xml    ← СОЗДАТЬ
│   │   ├── template-accumulation-register.xml  ← СОЗДАТЬ
│   │   ├── template-information-register.xml   ← СОЗДАТЬ
│   │   └── template-delete-object.py     ← СОЗДАТЬ
│   └── Валидация/
│       ├── deploy-config.ps1             ← СОЗДАТЬ (раздел 7)
│       ├── validate-config.ps1           ← СОЗДАТЬ (раздел 7)
│       └── logs/                         ← Создать пустую папку
└── {{CONFIG_PATH}}/                     ← Уже существует (XML-выгрузка)
    ├── Configuration.xml
    ├── ConfigDumpInfo.xml
    └── Проверка/                        ← СОЗДАТЬ (рабочая копия)
```

### 3.2 Создать README навигатор

Файл: `Документация/README.md`

```markdown
# Документация проекта {{PROJECT_FULL}} ({{PROJECT_SHORT}})

## Структура

### Спецификации
| Документ | Назначение |
|----------|-----------|
| [Техническая спецификация](Спецификации/ТЕХНИЧЕСКАЯ%20СПЕЦИФИКАЦИЯ%20КОНФИГУРАЦИИ%20{{PROJECT_SHORT}}.xml) | Единственный источник истины. Описание всех объектов. |
| [Алгоритм разработки](Спецификации/Алгоритм%20разработки.xml) | 6-этапный процесс разработки |
| [Регламент документации](Спецификации/Регламент%20актуализации%20документации.xml) | Правила ведения документации |

### Технические стандарты
| Документ | Назначение |
|----------|-----------|
| [Стандарты 1С](Технические_стандарты/1c-standards-{{PLATFORM_VERSION}}.md) | BSL-код: именование, области, директивы, запросы |
| [Структура XML](Технические_стандарты/xml-structure-{{PLATFORM_VERSION}}.md) | Формат XML-файлов конфигурации |
| [Элементы форм](Технические_стандарты/form-elements.md) | Справочник элементов управляемых форм |

### Шаблоны
| Шаблон | Тип объекта |
|--------|-------------|
| [template-catalog.xml](Шаблоны/template-catalog.xml) | Справочник |
| [template-document.xml](Шаблоны/template-document.xml) | Документ |
| [template-form.xml](Шаблоны/template-form.xml) | Форма (универсальная) |
| [template-enum.xml](Шаблоны/template-enum.xml) | Перечисление |
| [template-common-module.xml](Шаблоны/template-common-module.xml) | Общий модуль |
| [template-accumulation-register.xml](Шаблоны/template-accumulation-register.xml) | Регистр накопления |
| [template-information-register.xml](Шаблоны/template-information-register.xml) | Регистр сведений |

### Валидация и деплой
| Скрипт | Назначение |
|--------|-----------|
| [deploy-config.ps1](Валидация/deploy-config.ps1) | Полный цикл загрузки конфигурации |
| [validate-config.ps1](Валидация/validate-config.ps1) | 7-этапная валидация XML |

## Гайды

### Для нового разработчика
1. Прочитать техническую спецификацию
2. Изучить стандарты кодирования
3. Посмотреть шаблоны XML
4. Сделать пробный деплой

### При создании нового объекта
1. Описать в спецификации (Spec-First!)
2. Взять шаблон из `Шаблоны/`
3. Обновить Configuration.xml + ConfigDumpInfo.xml
4. Запустить validate-config.ps1
5. Запустить deploy-config.ps1 -Action Full
```

---

## 4. ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ

### 4.1 Структура XML

Создать файл: `Документация/Спецификации/ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ КОНФИГУРАЦИИ {{PROJECT_SHORT}}.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!--
    ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ КОНФИГУРАЦИИ {{PROJECT_SHORT}} ({{PROJECT_FULL}})
    Единственный источник истины (Single Source of Truth).
    
    Сгенерировано: {{ТЕКУЩАЯ_ДАТА}}
    Платформа: 1С:Предприятие {{PLATFORM_VERSION}}
-->
<Configuration name="{{PROJECT_SHORT}} - {{PROJECT_FULL}}" version="1.0.0" platform="{{PLATFORM_VERSION}}">

    <Description>
        <Content>{{DESCRIPTION}}</Content>
    </Description>

    <!-- ============================================================ -->
    <!-- ПАРАМЕТРЫ СЕАНСА -->
    <!-- ============================================================ -->
    <SessionParameters>
        <!-- Заполняется по результатам анализа конфигурации -->
        <!-- Формат:
        <Parameter name="ИмяПараметра" type="Тип">Назначение</Parameter>
        -->
    </SessionParameters>

    <!-- ============================================================ -->
    <!-- КОНСТАНТЫ -->
    <!-- ============================================================ -->
    <Constants>
        <!-- Формат:
        <Constant name="ИмяКонстанты" type="Тип" defaultValue="Значение">
            Назначение константы.
        </Constant>
        -->
    </Constants>

    <!-- ============================================================ -->
    <!-- ОБЩИЕ МОДУЛИ -->
    <!-- ============================================================ -->
    <CommonModules>
        <!-- Формат:
        <Object name="ИмяМодуля" context="Сервер|Клиент|СерверВызов">
            <Block name="Purpose"><Content>Назначение модуля.</Content></Block>
            <Block name="PublicAPI">
                <Methods>
                    <Method name="ИмяМетода(Параметры)">Описание</Method>
                </Methods>
            </Block>
            <Block name="History">
                <Record date="YYYY-MM-DD">Создание.</Record>
            </Block>
        </Object>
        -->
    </CommonModules>

    <!-- ============================================================ -->
    <!-- ПОДСИСТЕМЫ -->
    <!-- ============================================================ -->
    <Subsystems>
        <!-- Формат:
        <Subsystem name="Имя" synonym="Синоним">
            <Content>Описание подсистемы.</Content>
            <Objects>
                <Object>Тип.ИмяОбъекта</Object>
            </Objects>
        </Subsystem>
        -->
    </Subsystems>

    <!-- ============================================================ -->
    <!-- СПРАВОЧНИКИ -->
    <!-- ============================================================ -->
    <Catalogs>
        <!-- Формат:
        <Object name="ИмяСправочника" synonym="Синоним">
            <Block name="Purpose"><Content>Назначение.</Content></Block>
            <Block name="DataModel">
                <Fields>
                    <Field name="ИмяРеквизита" type="Тип">Описание</Field>
                </Fields>
            </Block>
            <Block name="Logic">
                <Items>
                    <Item>Описание бизнес-логики</Item>
                </Items>
            </Block>
            <Block name="History">
                <Record date="YYYY-MM-DD">Создание.</Record>
            </Block>
        </Object>
        -->
    </Catalogs>

    <!-- ============================================================ -->
    <!-- ДОКУМЕНТЫ -->
    <!-- ============================================================ -->
    <Documents>
        <!-- Формат:
        <Object name="ИмяДокумента" synonym="Синоним">
            <Block name="Purpose"><Content>Назначение.</Content></Block>
            <Block name="DataModel">
                <Fields>
                    <Field name="Реквизит" type="Тип">Описание</Field>
                </Fields>
                <TabularSections>
                    <TabularSection name="Товары">
                        <Field name="Номенклатура" type="СправочникСсылка.Номенклатура">Товар</Field>
                        <Field name="Количество" type="Число(15,3)">Кол-во</Field>
                    </TabularSection>
                </TabularSections>
            </Block>
            <Block name="Logic">
                <Items>
                    <Item>Проведение: формирует движения по регистрам...</Item>
                </Items>
            </Block>
            <Block name="RegisterRecords">
                <Register>ИмяРегистра</Register>
            </Block>
            <Block name="History">
                <Record date="YYYY-MM-DD">Создание.</Record>
            </Block>
        </Object>
        -->
    </Documents>

    <!-- ============================================================ -->
    <!-- ПЕРЕЧИСЛЕНИЯ -->
    <!-- ============================================================ -->
    <Enums>
        <!-- Формат:
        <Object name="ИмяПеречисления" synonym="Синоним">
            <Block name="Purpose"><Content>Назначение.</Content></Block>
            <Values>
                <Value name="Значение1" synonym="Синоним1"/>
                <Value name="Значение2" synonym="Синоним2"/>
            </Values>
            <Block name="History">
                <Record date="YYYY-MM-DD">Создание.</Record>
            </Block>
        </Object>
        -->
    </Enums>

    <!-- ============================================================ -->
    <!-- РЕГИСТРЫ НАКОПЛЕНИЯ -->
    <!-- ============================================================ -->
    <AccumulationRegisters>
        <!-- Формат:
        <Object name="ИмяРегистра" synonym="Синоним" registerType="Остатки|Обороты">
            <Block name="Purpose"><Content>Назначение.</Content></Block>
            <Block name="DataModel">
                <Dimensions>
                    <Field name="Измерение" type="Тип">Описание</Field>
                </Dimensions>
                <Resources>
                    <Field name="Ресурс" type="Число(15,2)">Описание</Field>
                </Resources>
            </Block>
            <Block name="History">
                <Record date="YYYY-MM-DD">Создание.</Record>
            </Block>
        </Object>
        -->
    </AccumulationRegisters>

    <!-- ============================================================ -->
    <!-- РЕГИСТРЫ СВЕДЕНИЙ -->
    <!-- ============================================================ -->
    <InformationRegisters>
        <!-- Формат аналогичен регистрам накопления -->
    </InformationRegisters>

    <!-- ============================================================ -->
    <!-- ОТЧЁТЫ -->
    <!-- ============================================================ -->
    <Reports>
        <!-- Формат:
        <Object name="ИмяОтчёта" synonym="Синоним">
            <Block name="Purpose"><Content>Назначение.</Content></Block>
            <Block name="DataSources">
                <Source>Описание источника данных</Source>
            </Block>
            <Block name="History">
                <Record date="YYYY-MM-DD">Создание.</Record>
            </Block>
        </Object>
        -->
    </Reports>

    <!-- ============================================================ -->
    <!-- ОБРАБОТКИ -->
    <!-- ============================================================ -->
    <DataProcessors>
        <!-- Формат:
        <Object name="ИмяОбработки" synonym="Синоним">
            <Block name="Purpose"><Content>Назначение.</Content></Block>
            <Block name="DataModel">
                <Fields>
                    <Field name="Реквизит" type="Тип">Описание</Field>
                </Fields>
            </Block>
            <Block name="Logic">
                <Items>
                    <Item>Алгоритм работы</Item>
                </Items>
            </Block>
            <Block name="History">
                <Record date="YYYY-MM-DD">Создание.</Record>
            </Block>
        </Object>
        -->
    </DataProcessors>

    <!-- ============================================================ -->
    <!-- ПЛАНЫ НА БУДУЩЕЕ -->
    <!-- ============================================================ -->
    <FutureWorkItems>
        <!-- Формат:
        <Item priority="high|medium|low" target="Q1 2026">Описание задачи</Item>
        -->
    </FutureWorkItems>

</Configuration>
```

### 4.2 Заполнение спецификации

**КРИТИЧНО:** Агент ОБЯЗАН заполнить спецификацию реальными данными из анализа (раздел 2).

Порядок заполнения:

1. **Подсистемы** — из `list_metadata_objects(metaType="Subsystems")`
2. **Константы** — из `list_metadata_objects(metaType="Constants")`
3. **Общие модули** — из `list_metadata_objects(metaType="CommonModules")`, для каждого `get_metadata_structure`
4. **Перечисления** — из `list_metadata_objects(metaType="Enums")`, для каждого `get_metadata_structure`
5. **Справочники** — из `list_metadata_objects(metaType="Catalogs")`, для каждого `get_metadata_structure`
6. **Документы** — из `list_metadata_objects(metaType="Documents")`, для каждого `get_metadata_structure`
7. **Регистры** — оба типа
8. **Отчёты** — из `list_metadata_objects(metaType="Reports")`
9. **Обработки** — из `list_metadata_objects(metaType="DataProcessors")`

Для каждого объекта:
- **Purpose:** Вывести из имени/синонима + контекста подсистемы
- **DataModel:** Из `get_metadata_structure` — реквизиты, табличные части, измерения, ресурсы
- **Logic:** Кратко описать на основе типа объекта (для документов — что проводит, для обработок — что делает)
- **History:** `<Record date="ТЕКУЩАЯ_ДАТА">Начальное описание при создании документации.</Record>`

---

## 5. XML-ШАБЛОНЫ ОБЪЕКТОВ

### 5.1 Общий принцип

Шаблоны создаются на основе **реальных XML-файлов конфигурации** — берём эталонный заголовок с xmlns, формат version, структуру InternalInfo из существующих файлов.

### 5.2 Эталонный заголовок MetaDataObject

Взять из **любого реального XML-файла** конфигурации (Configuration.xml или файл объекта). Должен содержать **ВСЕ** пространства имён:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<MetaDataObject xmlns="http://v8.1c.ru/8.3/MDClasses"
    xmlns:app="http://v8.1c.ru/8.2/managed-application/core"
    xmlns:cfg="http://v8.1c.ru/8.1/data/enterprise/current-config"
    xmlns:cmi="http://v8.1c.ru/8.2/managed-application/cmi"
    xmlns:ent="http://v8.1c.ru/8.1/data/enterprise"
    xmlns:lf="http://v8.1c.ru/8.2/managed-application/logform"
    xmlns:style="http://v8.1c.ru/8.1/data/ui/style"
    xmlns:sys="http://v8.1c.ru/8.1/data/ui/fonts/system"
    xmlns:v8="http://v8.1c.ru/8.1/data/core"
    xmlns:v8ui="http://v8.1c.ru/8.1/data/ui"
    xmlns:web="http://v8.1c.ru/8.1/data/ui/colors/web"
    xmlns:win="http://v8.1c.ru/8.1/data/ui/colors/windows"
    xmlns:xen="http://v8.1c.ru/8.3/xcf/enums"
    xmlns:xpr="http://v8.1c.ru/8.3/xcf/predef"
    xmlns:xr="http://v8.1c.ru/8.3/xcf/readable"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    version="2.20">
```

> **ВАЖНО:** Заголовок копировать из существующего XML проекта, не собирать вручную!

### 5.3 Список шаблонов для создания

Создать каждый файл в `Документация/Шаблоны/`:

#### template-catalog.xml
Скопировать из эталона PTM (`Документация/Шаблоны/template-catalog.xml`), адаптировать:
- 5 обязательных GeneratedType: Object, Ref, Selection, List, Manager
- Свойства: Hierarchical, CodeLength, DescriptionLength, EditType
- Шаблон реквизита с FillFromFillingValue/FillValue (для Item)
- Плейсхолдеры `{{UUID_...}}`, `{{ИМЯ}}`

#### template-document.xml
- 5 GeneratedType: Object, Ref, Selection, List, Manager
- NumberType, NumberLength, Posting=Allow
- RegisterRecords (закомментированы)
- Шаблон реквизита (без FillFromFillingValue!)
- Шаблон табличной части с GeneratedType для TabularSection/TabularSectionRow

#### template-form.xml
- Корневой `<Form>` (НЕ `<MetaDataObject>`)
- AutoCommandBar id="-1"
- Events: OnCreateAtServer, OnOpen
- Шаблоны InputField, Table с полным набором дочерних элементов
- Attributes с MainAttribute=true

#### template-form-document.xml
- Специализированный для документа: Номер, Дата, таблица Товары
- AutoTime, UsePostingMode

#### template-form-catalog.xml
- Специализированный для справочника: Код, Наименование
- WindowOpeningMode, UseForFoldersAndItems

#### template-enum.xml
- 3 GeneratedType: Ref, List, Manager (без Object и Selection!)
- QuickChoice=true
- Шаблоны EnumValue

#### template-common-module.xml
- Все флаги контекста
- Комментарий с типичными комбинациями

#### template-accumulation-register.xml
- 6 GeneratedType: Record, Manager, Selection, List, RecordSet, RecordKey
- RegisterType (Balance/Turnovers)
- Dimension, Resource

#### template-information-register.xml
- 6 GeneratedType: аналогично
- Periodicity, WriteMode
- Dimension, Resource

#### template-delete-object.py
- Python-скрипт для удаления объектов (обход проблемы PowerShell + кириллица)
- Удаляет XML + папку из основной конфигурации и из Проверка/
- Напоминание обновить Configuration.xml и ConfigDumpInfo.xml

### 5.4 README шаблонов

Создать `Документация/Шаблоны/README.md` с:
- Таблицей всех шаблонов и их назначений
- Порядком использования (5 шагов)
- Критическими правилами (заголовок, version, InternalInfo, UUID, формы)
- Описанием проблемы PowerShell + кириллица и решением через Python

---

## 6. ТЕХНИЧЕСКИЕ СТАНДАРТЫ

### 6.1 Стандарты кодирования BSL

Файл: `Документация/Технические_стандарты/1c-standards-{{PLATFORM_VERSION}}.md`

Включить следующие разделы:

```markdown
# Стандарты кодирования 1С:Предприятие {{PLATFORM_VERSION}}

## 1. Асинхронность
- С {{PLATFORM_VERSION}} — ТОЛЬКО `Асинх/Ждать` на клиенте
- Таблица замен модальных вызовов:
  | Устаревшее | Замена |
  |------------|--------|
  | Вопрос() | ВопросАсинх() |
  | Предупреждение() | ПредупреждениеАсинх() |
  | ОткрытьФормуМодально() | ОткрытьФормуАсинх() |
  | ВвестиЧисло() | ВвестиЧислоАсинх() |
  | ВвестиСтроку() | ВвестиСтрокуАсинх() |

## 2. Директивы компиляции
- &НаКлиенте
- &НаСервере
- &НаСервереБезКонтекста
- &НаКлиентеНаСервереБезКонтекста

## 3. Именование
- Русский CamelCase
- Методы: Глагол+Существительное (ПолучитьСписокТоваров)
- Переменные: Существительное (СписокТоваров)
- Максимум 80 символов

## 4. Области (#Область)
- Весь код внутри #Область ... #КонецОбласти
- СлужебныйПрограммныйИнтерфейс
- СлужебныеПроцедурыИФункции
- ОбработчикиСобытий
- ОбработчикиКомандФормы

## 5. Запросы
- ВСЕГДА псевдонимы
- ВСЕГДА ЕСТЬNULL()
- ВСЕГДА параметры (не конкатенация!)
- НИКОГДА в циклах
- Все поля — явное перечисление (не *)

## 6. Транзакции
НачатьТранзакцию();
Попытка
    // работа
    ЗафиксироватьТранзакцию();
Исключение
    ОтменитьТранзакцию();
    // обработка
КонецПопытки;

## 7. Негативный словарь (запрещённые конструкции)
| ❌ Ошибка | ✅ Правильно |
|-----------|-------------|
| Новая Структура | Новый Структура |
| ЗначениеВСтроку() | ЗначениеВСтрокуВнутр() |
| СтрокаВЗначение() | ЗначениеИзСтрокиВнутр() |
| ТекущаяДата() | ТекущаяДатаСеанса() |
| Найти() | СтрНайти() |
| ЭтаФорма | ЭтотОбъект |
```

### 6.2 Структура XML

Файл: `Документация/Технические_стандарты/xml-structure-{{PLATFORM_VERSION}}.md`

Включить:
- Общая структура XML со всеми xmlns
- Формат для каждого типа объекта (Catalog, Document, Enum, Register, etc.)
- Обязательные GeneratedType по типам
- Правила InternalInfo
- Формат ConfigDumpInfo.xml
- Маппинг типов → папок

### 6.3 Элементы форм

Файл: `Документация/Технические_стандарты/form-elements.md`

Включить:
- Все типы элементов (InputField, LabelField, CheckBoxField, Table, etc.)
- Обязательные дочерние элементы (ContextMenu, ExtendedTooltip)
- Правила нумерации id
- Обязательные дочерние для Table (7 элементов)
- Events формы

---

## 7. СКРИПТЫ ВАЛИДАЦИИ И ДЕПЛОЯ

### 7.1 validate-config.ps1

Файл: `Документация/Валидация/validate-config.ps1`

Скопировать из эталона PTM и адаптировать:

**Обязательные параметры для замены:**
```powershell
# Путь к проекту — автоматически определяется относительно скрипта
$projectRoot = Split-Path -Parent (Split-Path -Parent $scriptDir)

# Путь к конфигурации — относительный
$configPath = Join-Path $projectRoot "{{CONFIG_PATH}}\Проверка"
```

**7 этапов проверки (все обязательны):**
1. Чтение Configuration.xml (version=2.20, ModalityUseMode)
2. Соответствие файлов на диске ↔ Configuration.xml
3. ConfigDumpInfo.xml (наличие записей, уникальность UUID)
4. Структура XML объектов (UUID, version, InternalInfo)
5. Проверка форм (id уникальность, ContextMenu/ExtendedTooltip)
6. Файловая структура (описатели форм, модули)
7. Перекрёстные ссылки (DefaultObjectForm, RegisterRecords)

**Маппинг типов → папок:**
```powershell
$typeMap = @{
    "Catalog"               = "Catalogs"
    "Document"              = "Documents"
    "Enum"                  = "Enums"
    "Report"                = "Reports"
    "DataProcessor"         = "DataProcessors"
    "CommonModule"          = "CommonModules"
    "AccumulationRegister"  = "AccumulationRegisters"
    "InformationRegister"   = "InformationRegisters"
    "Constant"              = "Constants"
    "Subsystem"             = "Subsystems"
}
```

### 7.2 deploy-config.ps1

Файл: `Документация/Валидация/deploy-config.ps1`

Скопировать из эталона PTM и адаптировать:

**Параметры для замены:**
```powershell
param(
    [string]$BasePath = "{{BASE_PATH}}",        # ← ЗАМЕНИТЬ
    [string]$User = "{{DB_USER}}",              # ← ЗАМЕНИТЬ
    # остальные параметры оставить
)
```

**Обязательные функции:**
- `Write-Step` — логирование с цветами
- `Read-LogWithEncoding` — чтение логов 1С (UTF-8, Windows-1251)
- `Invoke-1C` — запуск 1cv8.exe с таймаутом и асинхронным чтением stdout/stderr
- `Parse-1CErrors` — парсинг ошибок из лога
- `Format-ErrorBlockForAgent` — структурированный блок `=== ОШИБКИ (для Copilot Agent) ===`

**Действия (Actions):**
- `Load` — LoadConfigFromFiles
- `Check` — CheckConfig  
- `Update` — UpdateDBCfg
- `Run` — Запуск предприятия
- `Designer` — Открыть конфигуратор
- `Full` — Validate → Load → Check → Update → Designer
- `Info` — Информация о среде

### 7.3 Папка логов

Создать пустую папку `Документация/Валидация/logs/` — туда будут складываться логи деплоя.

---

## 8. COPILOT INSTRUCTIONS

### 8.1 Структура файла

Файл: `.github/copilot-instructions.md`

Это **ядро поведения AI-агента**. Создать на основе эталона PTM, но с параметрами ДАННОЙ конфигурации.

### 8.2 Обязательные разделы

```markdown
# 1C:Enterprise {{PLATFORM_VERSION}} Development Agent

> **Роль:** Senior 1C Developer | **Платформа:** {{PLATFORM_VERSION}} | **Режим:** Strict

## 1. ПРИОРИТЕТ ДОКУМЕНТАЦИИ
(таблица путей к документам — адаптировать под структуру проекта)

## 2. MCP-ИНСТРУМЕНТЫ
### 2.1 Обязательные проверки ПЕРЕД написанием кода
(mcp_{{MCP_SERVER_NAME}}_list_metadata_objects, mcp_{{MCP_SERVER_NAME}}_get_metadata_structure)
### 2.2 Обязательные проверки ПОСЛЕ написания кода
(get_errors, validate-config.ps1)
### 2.3 Правила
(❌ ЗАПРЕЩЕНО / ✅ ОБЯЗАТЕЛЬНО)

## 3. АЛГОРИТМ РАБОТЫ
(3 фазы: Реализация → Деплой → Завершение)
### 3.1 Команды деплоя
(deploy-config.ps1 -Action Full/Designer/Info)
### 3.2 Порядок запуска
(Get-ChildItem для поиска скрипта)
### 3.3 Расшифровка ошибок
(таблица типичных ошибок)

## 4. НЕГАТИВНЫЙ СЛОВАРЬ
### 4.1 BSL — несуществующие функции
### 4.2 BSL — конструкция `Новый`
### 4.3 XML — частые ошибки

## 5. ПРАВИЛА ГЕНЕРАЦИИ XML
### 5.1 Обязательный порядок
### 5.2 Эталонный заголовок MetaDataObject

## 6. ПРАВИЛА BSL-КОДА

## 7. ОБНОВЛЕНИЕ СПЕЦИФИКАЦИИ

## 8. ФАЙЛОВАЯ СТРУКТУРА КОНФИГУРАЦИИ
### 8.1 Маппинг типов → папок
### 8.2 Структура объекта с формой
### 8.3 Описатель формы

## 9. MULTI-FILE CHECKLIST
### 9.1 При создании НОВОГО объекта
### 9.2 При создании ФОРМЫ объекта
### 9.3 При добавлении РЕКВИЗИТА
### 9.4 Формат ConfigDumpInfo.xml
### 9.5 Валидация

## 10. ГЕНЕРАЦИЯ ID ЭЛЕМЕНТОВ ФОРМЫ

## 11. ФИНАЛЬНЫЙ ЧЕКЛИСТ

## 12. РАБОТА С ФАЙЛОВОЙ СИСТЕМОЙ
(Проблема PowerShell + кириллица, Python-обходной путь)
```

### 8.3 Ключевые адаптации

При создании copilot-instructions заменить:
- Все пути (`D:\Git\Public_Trade_Module` → `{{REPO_PATH}}`)
- Путь к ИБ (`D:\Confiq\Public Trade Module` → `{{BASE_PATH}}`)
- Имена MCP-инструментов (`mcp_mcp_1c_torgov_*` → `mcp_{{MCP_SERVER_NAME}}_*`)
- Имя конфигурации (`ТорговляРозница` → имя из Configuration.xml)
- Версию платформы (если отличается)

---

## 9. НАСТРОЙКИ VS CODE

### 9.1 .vscode/settings.json

```json
{
    "editor.formatOnSave": false,
    "files.encoding": "utf8bom",
    "files.autoSave": "onFocusChange",
    "files.associations": {
        "*.bsl": "bsl",
        "*.os": "bsl"
    },
    "[bsl]": {
        "editor.tabSize": 4,
        "editor.insertSpaces": false,
        "editor.wordWrap": "on"
    },
    "search.exclude": {
        "**/node_modules": true,
        "**/DerivedData": true
    },
    "github.copilot.chat.codeGeneration.useReferencedFiles": true
}
```

### 9.2 .vscode/tasks.json

```json
{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "Открыть спецификацию",
            "type": "shell",
            "command": "code",
            "args": [
                "${workspaceFolder}/Документация/Спецификации/ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ КОНФИГУРАЦИИ {{PROJECT_SHORT}}.xml"
            ]
        }
    ]
}
```

### 9.3 .vscode/launch.json

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "OneScript отладка",
            "type": "oscript",
            "request": "launch",
            "program": "${file}",
            "cwd": "${workspaceFolder}",
            "runtimeExecutable": "oscript.exe"
        },
        {
            "name": "Attach к 1С через DBG",
            "type": "node",
            "request": "attach",
            "port": 1550,
            "restart": true,
            "timeout": 10000
        }
    ]
}
```

### 9.4 .vscode/extensions.json

```json
{
    "recommendations": [
        "1c-syntax.language-1c-bsl",
        "yellow-hammer.1c-platform-tools",
        "dotjoshjohnson.xml",
        "github.copilot-chat"
    ]
}
```

### 9.5 Глобальная конфигурация MCP

Файл `%APPDATA%\Code\User\mcp.json`:

```json
{
    "servers": {
        "{{MCP_SERVER_NAME}}": {
            "url": "{{MCP_URL}}",
            "type": "http"
        }
    },
    "inputs": []
}
```

---

## 10. РЕГЛАМЕНТЫ И ПРОЦЕССЫ

### 10.1 Алгоритм разработки

Файл: `Документация/Спецификации/Алгоритм разработки.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<DevelopmentAlgorithm project="{{PROJECT_SHORT}}">
    <Stage number="1" name="Анализ требований">
        <Steps>
            <Step>Изучить запрос пользователя</Step>
            <Step>Проверить техническую спецификацию на конфликты</Step>
            <Step>Выявить затронутые объекты метаданных</Step>
            <Step>При неясности — уточнить у пользователя</Step>
        </Steps>
    </Stage>
    <Stage number="2" name="Техническое задание">
        <Steps>
            <Step>Сформулировать список изменений (новые/изменённые объекты)</Step>
            <Step>Оценить влияние на существующую логику</Step>
            <Step>Согласовать с пользователем перед реализацией</Step>
        </Steps>
    </Stage>
    <Stage number="3" name="Документирование">
        <Principle>Код не пишется, пока не обновлена Спецификация</Principle>
        <Steps>
            <Step>Обновить/создать блоки объектов в спецификации</Step>
            <Step>Заполнить Purpose, DataModel, Logic</Step>
            <Step>Добавить Record в History</Step>
        </Steps>
    </Stage>
    <Stage number="4" name="Кодирование">
        <Steps>
            <Step>Создать/изменить XML метаданных из шаблонов</Step>
            <Step>Написать BSL-код согласно стандартам</Step>
            <Step>Обновить Configuration.xml + ConfigDumpInfo.xml</Step>
            <Step>Проверить через get_errors</Step>
        </Steps>
    </Stage>
    <Stage number="5" name="Тестирование">
        <Steps>
            <Step>Запустить validate-config.ps1</Step>
            <Step>Запустить deploy-config.ps1 -Action Full</Step>
            <Step>При ошибках — разбор + исправление + повтор</Step>
            <Step>Цикл до 0 ошибок</Step>
        </Steps>
    </Stage>
    <Stage number="6" name="Подтверждение">
        <Steps>
            <Step>Обновить History в спецификации</Step>
            <Step>Открыть конфигуратор (deploy-config.ps1 -Action Designer)</Step>
            <Step>Доложить пользователю</Step>
        </Steps>
    </Stage>
</DevelopmentAlgorithm>
```

### 10.2 Регламент актуализации документации

Файл: `Документация/Спецификации/Регламент актуализации документации.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<DocumentationRegulation project="{{PROJECT_SHORT}}">
    <Principles>
        <Principle name="Spec-First">
            Любое изменение начинается с обновления документации.
            Кодирование — только после фиксации изменений в спецификации.
        </Principle>
        <Principle name="SingleSourceOfTruth">
            Единственный файл спецификации — источник истины.
            Все остальные документы — производные.
        </Principle>
        <Principle name="MandatoryBlocks">
            Каждый объект ОБЯЗАН содержать блоки:
            Purpose, DataModel, Logic, History.
            UI-блок — опционально.
        </Principle>
        <Principle name="ChangelogPolicy">
            История ведётся НЕ отдельным файлом, а внутри блока History
            каждого объекта спецификации.
        </Principle>
    </Principles>
</DocumentationRegulation>
```

---

## 11. ФИНАЛЬНАЯ ПРОВЕРКА

### 11.1 Чеклист созданных файлов

После выполнения всех шагов проверить наличие:

```
✓ .github/copilot-instructions.md
✓ .vscode/settings.json
✓ .vscode/tasks.json
✓ .vscode/launch.json
✓ .vscode/extensions.json
✓ Документация/README.md
✓ Документация/Спецификации/ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ КОНФИГУРАЦИИ {{PROJECT_SHORT}}.xml
✓ Документация/Спецификации/Алгоритм разработки.xml
✓ Документация/Спецификации/Регламент актуализации документации.xml
✓ Документация/Технические_стандарты/1c-standards-{{PLATFORM_VERSION}}.md
✓ Документация/Технические_стандарты/xml-structure-{{PLATFORM_VERSION}}.md
✓ Документация/Технические_стандарты/form-elements.md
✓ Документация/Шаблоны/README.md
✓ Документация/Шаблоны/template-catalog.xml
✓ Документация/Шаблоны/template-document.xml
✓ Документация/Шаблоны/template-form.xml
✓ Документация/Шаблоны/template-form-document.xml
✓ Документация/Шаблоны/template-form-catalog.xml
✓ Документация/Шаблоны/template-enum.xml
✓ Документация/Шаблоны/template-common-module.xml
✓ Документация/Шаблоны/template-accumulation-register.xml
✓ Документация/Шаблоны/template-information-register.xml
✓ Документация/Шаблоны/template-delete-object.py
✓ Документация/Валидация/deploy-config.ps1
✓ Документация/Валидация/validate-config.ps1
✓ Документация/Валидация/logs/ (пустая папка)
✓ {{CONFIG_PATH}}/Проверка/ (рабочая копия)
```

### 11.2 Чеклист качества

```
✓ Спецификация содержит ВСЕ объекты из Configuration.xml
✓ Для каждого объекта заполнены Purpose, DataModel, History
✓ copilot-instructions.md содержит правильные пути и имена MCP-инструментов
✓ deploy-config.ps1 содержит правильный BasePath
✓ validate-config.ps1 запускается без ошибок
✓ Шаблоны содержат правильный заголовок xmlns из реальных XML проекта
✓ MCP-сервер отвечает по указанному URL
```

### 11.3 Тестовый прогон

Финальное подтверждение — выполнить простую операцию через Copilot:

1. Открыть Copilot Chat в Agent mode
2. Попросить: "Покажи структуру справочника [ИмяЛюбого] через MCP"
3. Убедиться что MCP-инструменты работают
4. Попросить: "Запусти validate-config.ps1"
5. Убедиться что валидация проходит

---

## ПРИЛОЖЕНИЕ A: ИСТОЧНИКИ ДЛЯ КОПИРОВАНИЯ

При создании документации для новой конфигурации можно **копировать** из проекта PTM:

| Файл PTM | Что копировать | Что адаптировать |
|----------|---------------|------------------|
| `.github/copilot-instructions.md` | Всю структуру, разделы 4-12 | Раздел 1 (пути), имена MCP, пути к ИБ |
| `Документация/Валидация/validate-config.ps1` | Весь скрипт | Пути ($configPath) |
| `Документация/Валидация/deploy-config.ps1` | Весь скрипт | $BasePath, $User |
| `Документация/Шаблоны/*.xml` | Все шаблоны целиком | Ничего (универсальные) |
| `Документация/Шаблоны/template-delete-object.py` | Весь скрипт | Путь к проекту |
| `Документация/Технические_стандарты/*.md` | Все файлы | Версию платформы (если отличается) |
| `.vscode/settings.json` | Всю структуру | Ничего (универсальные) |
| `.vscode/extensions.json` | Весь файл | Ничего |

> Шаблоны XML, технические стандарты BSL и элементы форм — **универсальны** для всех конфигураций 1С:Предприятие 8.3.27. Их можно копировать без изменений.

---

## ПРИЛОЖЕНИЕ B: ПРИМЕРНЫЙ ТАЙМИНГ

| Шаг | Примерное время агента |
|-----|----------------------|
| Анализ конфигурации через MCP | 5-15 минут (зависит от кол-ва объектов) |
| Создание структуры папок | 1 минута |
| Генерация спецификации | 10-30 минут (зависит от кол-ва объектов) |
| Копирование/адаптация шаблонов | 5 минут |
| Копирование/адаптация скриптов | 5 минут |
| Создание copilot-instructions | 10 минут |
| Настройка VS Code | 2 минуты |
| Финальная проверка | 5 минут |
| **ИТОГО** | **~40-70 минут** |

---

## ПРИЛОЖЕНИЕ C: МИНИМАЛЬНАЯ КОМПЛЕКТАЦИЯ

Если нужна **быстрая** настройка (MVP), создать только эти файлы:

1. `.github/copilot-instructions.md` — **обязательно** (без него агент бесполезен)
2. `Документация/Валидация/deploy-config.ps1` — **обязательно** (деплой)
3. `Документация/Валидация/validate-config.ps1` — **обязательно** (валидация)
4. `Документация/Шаблоны/*.xml` — **обязательно** (шаблоны объектов)
5. `.vscode/settings.json` — **обязательно** (настройки BSL)

Остальное (спецификация, стандарты, регламенты) можно добавить позже.
