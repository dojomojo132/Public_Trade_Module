// --- 1. КОМАНДА "ЗАПОЛНИТЬ ПО ОСТАТКАМ" ---

&НаКлиенте
Процедура Заполнить(Команда)
	
	Режим = РежимДиалогаВопрос.ДаНет;
	
	// Создаем "обещание" (описание оповещения), какую процедуру запустить после ответа пользователя
	Оповещение = Новый ОписаниеОповещения("ЗаполнитьЗавершение", ЭтотОбъект);
	
	// Асинхронный вызов диалога
	ПоказатьВопрос(Оповещение, "Табличная часть будет очищена и заполнена текущими остатками. Продолжить?", Режим, 0);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	// Эта процедура запустится сама, когда пользователь нажмет кнопку в диалоге
	Если Результат = КодВозвратаДиалога.Да Тогда
		ЗаполнитьНаСервере();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНаСервере()
	
	// 1. Конвертируем данные формы в реальный объект Документ
	ДокументОбъект = РеквизитФормыВЗначение("Объект");
	
	// 2. Вызываем процедуру из модуля объекта
	ДокументОбъект.Товары.Очистить();
	ДокументОбъект.ЗаполнитьПоОстаткам();
	
	// 3. Возвращаем данные обратно на форму
	ЗначениеВРеквизитФормы(ДокументОбъект, "Объект");
	
КонецПроцедуры

// --- 2. ОБРАБОТКА ВЫБОРА ТОВАРА (При выборе товара остаток тоже заполняется) ---

&НаКлиенте
Процедура ТоварыНоменклатураПриИзменении(Элемент)
	
	ТекСтрока = Элементы.Товары.ТекущиеДанные;
	
	Если ТекСтрока <> Неопределено Тогда
		
		// Получаем остаток с сервера для выбранной номенклатуры
		СтруктураДанных = ПолучитьДанныеНоменклатурыНаСервере(ТекСтрока.Номенклатура, Объект.Склад);
		
		ТекСтрока.УчетноеКоличество = СтруктураДанных.Остаток;
		
		// По умолчанию ставим Факт = Учет (чтобы не вбивать руками, если всё сходится)
		ТекСтрока.ФактическоеКоличество = СтруктураДанных.Остаток;
		
		РассчитатьОтклонение(ТекСтрока);
		
	КонецЕсли;
	
КонецПроцедуры

// --- 3. АВТО-РАСЧЕТ ОТКЛОНЕНИЯ (При изменении количеств руками) ---

&НаКлиенте
Процедура ТоварыФактическоеКоличествоПриИзменении(Элемент)
	ТекСтрока = Элементы.Товары.ТекущиеДанные;
	РассчитатьОтклонение(ТекСтрока);
КонецПроцедуры

&НаКлиенте
Процедура ТоварыУчетноеКоличествоПриИзменении(Элемент)
	ТекСтрока = Элементы.Товары.ТекущиеДанные;
	РассчитатьОтклонение(ТекСтрока);
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьОтклонение(ТекСтрока)
	If ТекСтрока <> Неопределено Тогда
		ТекСтрока.Отклонение = ТекСтрока.ФактическоеКоличество - ТекСтрока.УчетноеКоличество;
	КонецЕсли;
КонецПроцедуры

// --- СЛУЖЕБНЫЕ ФУНКЦИИ ---

&НаСервереБезКонтекста
Функция ПолучитьДанныеНоменклатурыНаСервере(Номенклатура, Склад)
	
	Результат = Новый Структура("Остаток", 0);
	
	Если Не ЗначениеЗаполнено(Номенклатура) ИЛИ Не ЗначениеЗаполнено(Склад) Тогда
		Возврат Результат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЕСТЬNULL(ОстаткиТоваровОстатки.КоличествоОстаток, 0) КАК Остаток
		|ИЗ
		|	РегистрНакопления.ОстаткиТоваров.Остатки(
		|			&Период,
		|			Склад = &Склад
		|				И Номенклатура = &Номенклатура) КАК ОстаткиТоваровОстатки";
	
	Запрос.УстановитьПараметр("Период", ТекущаяДата());
	Запрос.УстановитьПараметр("Склад", Склад);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Результат.Остаток = Выборка.Остаток;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции