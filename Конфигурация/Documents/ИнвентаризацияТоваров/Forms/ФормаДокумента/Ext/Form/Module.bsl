// --- 1. КОМАНДА "ЗАПОЛНИТЬ ПО ОСТАТКАМ" ---

&НаКлиенте
Процедура Заполнить(Команда)
	
	Режим = РежимДиалогаВопрос.ДаНет;
	
	// Создаем "обещание" (описание оповещения), какую процедуру запустить после ответа пользователя
	Оповещение = Новый ОписаниеОповещения("ЗаполнитьЗавершение", ЭтотОбъект);
	
	// Асинхронный вызов диалога
	ПоказатьВопрос(Оповещение, "Табличная часть будет очищена и заполнена текущими остатками. Продолжить?", Режим, 0);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	// Эта процедура запустится сама, когда пользователь нажмет кнопку в диалоге
	Если Результат = КодВозвратаДиалога.Да Тогда
		ЗаполнитьНаСервере();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНаСервере()
	
	// 1. Конвертируем данные формы в реальный объект Документ
	ДокументОбъект = РеквизитФормыВЗначение("Объект");
	
	// 2. Вызываем процедуру из модуля объекта (очистка теперь внутри)
	ДокументОбъект.ЗаполнитьПоОстаткам();
	
	// 3. Возвращаем данные обратно на форму
	ЗначениеВРеквизитФормы(ДокументОбъект, "Объект");
	
	
КонецПроцедуры

// --- 2. ОБРАБОТКА ВЫБОРА ТОВАРА (При выборе товара остаток тоже заполняется) ---

&НаКлиенте
Процедура ТоварыНоменклатураПриИзменении(Элемент)
	
	ТекСтрока = Элементы.Товары.ТекущиеДанные;
	
	Если ТекСтрока <> Неопределено Тогда
		
		// Получаем остаток и цену с сервера
		СтруктураДанных = ПолучитьДанныеНоменклатурыНаСервере(ТекСтрока.Номенклатура, Объект.Склад);
		
		ТекСтрока.УчетноеКоличество = СтруктураДанных.Остаток;
		ТекСтрока.Цена = СтруктураДанных.Цена;
		
		// По умолчанию ставим Факт = 0 (нужно пересчитать)
		ТекСтрока.ФактическоеКоличество = 0;
		ТекСтрока.Сумма = 0;
		
		РассчитатьОтклонение(ТекСтрока);
		РассчитатьСуммуНедостачиИзлишков(ТекСтрока);
		
	КонецЕсли;
	
КонецПроцедуры

// --- 2.1 ОБРАБОТКА ШТРИХКОДА (Поиск номенклатуры по штрихкоду) ---

&НаКлиенте
Асинх Процедура ТоварыШтрихкодПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Проверка на пустой штрихкод
	Если ПустаяСтрока(ТекущиеДанные.Штрихкод) Тогда
		Возврат;
	КонецЕсли;
	
	// Поиск номенклатуры по штрихкоду
	НайденнаяНоменклатура = НайтиНоменклатуруПоШтрихкоду(ТекущиеДанные.Штрихкод);
	
	Если НайденнаяНоменклатура = Неопределено Тогда
		
		// Товар не найден - показываем предупреждение
		Ждать ПредупреждениеАсинх("Товар с штрихкодом """ + ТекущиеДанные.Штрихкод + """ не найден!");
		ТекущиеДанные.Штрихкод = "";
		Возврат;
		
	КонецЕсли;
	
	// Заполняем номенклатуру
	ТекущиеДанные.Номенклатура = НайденнаяНоменклатура;
	
	// Получаем данные товара (остатки и цену)
	СтруктураДанных = ПолучитьДанныеНоменклатурыНаСервере(НайденнаяНоменклатура, Объект.Склад);
	
	ТекущиеДанные.УчетноеКоличество = СтруктураДанных.Остаток;
	ТекущиеДанные.Цена = СтруктураДанных.Цена;
	
	// По умолчанию ставим Факт = 0 (нужно пересчитать)
	ТекущиеДанные.ФактическоеКоличество = 0;
	ТекущиеДанные.Сумма = 0;
	
	РассчитатьОтклонение(ТекущиеДанные);
	РассчитатьСуммуНедостачиИзлишков(ТекущиеДанные);
	
КонецПроцедуры

// --- 3. АВТО-РАСЧЕТ ОТКЛОНЕНИЯ (При изменении количеств руками) ---

&НаКлиенте
Процедура ТоварыФактическоеКоличествоПриИзменении(Элемент)
	ТекСтрока = Элементы.Товары.ТекущиеДанные;
	Если ТекСтрока <> Неопределено Тогда
		// Пересчитываем сумму
		ТекСтрока.Сумма = ТекСтрока.ФактическоеКоличество * ТекСтрока.Цена;
		РассчитатьОтклонение(ТекСтрока);
		РассчитатьСуммуНедостачиИзлишков(ТекСтрока);
		ПересчитатьИтоги();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыУчетноеКоличествоПриИзменении(Элемент)
	ТекСтрока = Элементы.Товары.ТекущиеДанные;
	РассчитатьОтклонение(ТекСтрока);
	РассчитатьСуммуНедостачиИзлишков(ТекСтрока);
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьОтклонение(ТекСтрока)
	Если ТекСтрока <> Неопределено Тогда
		ТекСтрока.Отклонение = ТекСтрока.ФактическоеКоличество - ТекСтрока.УчетноеКоличество;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСуммуНедостачиИзлишков(ТекСтрока)
	Если ТекСтрока <> Неопределено Тогда
		ТекСтрока.СуммаНедостачиИзлишков = ТекСтрока.Отклонение * ТекСтрока.Цена;
	КонецЕсли;
КонецПроцедуры

// --- СЛУЖЕБНЫЕ ФУНКЦИИ ---

&НаСервереБезКонтекста
Функция ПолучитьДанныеНоменклатурыНаСервере(Номенклатура, Склад)
	
	Результат = Новый Структура("Остаток, Цена", 0, 0);
	
	Если Не ЗначениеЗаполнено(Номенклатура) ИЛИ Не ЗначениеЗаполнено(Склад) Тогда
		Возврат Результат;
	КонецЕсли;
	
	// Получаем остаток
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЕСТЬNULL(ОстаткиТоваровОстатки.КоличествоОстаток, 0) КАК Остаток
		|ИЗ
		|	РегистрНакопления.ОстаткиТоваров.Остатки(
		|			&Период,
		|			Склад = &Склад
		|				И Номенклатура = &Номенклатура) КАК ОстаткиТоваровОстатки";
	
	Запрос.УстановитьПараметр("Период", ТекущаяДата());
	Запрос.УстановитьПараметр("Склад", Склад);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Результат.Остаток = Выборка.Остаток;
	КонецЕсли;
	
	// Получаем закупочную цену из регистра ЦеныНоменклатуры с типом "Закупочная"
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|\tЦеныНоменклатуры.Цена КАК Цена
		|ИЗ
		|\tРегистрСведений.ЦеныНоменклатуры КАК ЦеныНоменклатуры
		|ГДЕ
		|\tЦеныНоменклатуры.Номенклатура = &Номенклатура
		|\tИ ЦеныНоменклатуры.ТипЦен = &ТипЦен";
	
	Запрос.УстановитьПараметр("ТипЦен", Справочники.ТипыЦен.Закупочная);
	
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	ВыборкаЦена = Запрос.Выполнить();
	
	Если Не ВыборкаЦена.Пустой() Тогда
		ВыборкаЦена = ВыборкаЦена.Выбрать();
		ВыборкаЦена.Следующий();
		Результат.Цена = ВыборкаЦена.Цена;
	Иначе
		Результат.Цена = 0;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

&НаСервереБезКонтекста
Функция НайтиНоменклатуруПоШтрихкоду(Штрихкод)
	
	// Поиск в регистре Штрихкоды
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Штрихкоды.Номенклатура КАК Номенклатура
	|ИЗ
	|	РегистрСведений.Штрихкоды КАК Штрихкоды
	|ГДЕ
	|	Штрихкоды.Штрихкод = &Штрихкод";
	
	Запрос.УстановитьПараметр("Штрихкод", Штрихкод);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Возврат Выборка.Номенклатура;
	
КонецФункции

// --- ПЕРЕСЧЕТ ИТОГОВОЙ СУММЫ ---

&НаКлиенте
Процедура ПересчитатьИтоги()
	
	ИтоговаяСумма = 0;
	
	Для Каждого Стр Из Объект.Товары Цикл
		ИтоговаяСумма = ИтоговаяСумма + Стр.Сумма;
	КонецЦикла;
	
КонецПроцедуры

// --- ПЕЧАТЬ РЕЗУЛЬТАТОВ ИНВЕНТАРИЗАЦИИ ---

&НаКлиенте
Процедура НапечататьРезультат(Команда)
	
	// Формируем табличный документ на сервере
	ТабличныйДокумент = СформироватьПечатнуюФормуНаСервере();
	
	// Показываем в окне печати
	ТабличныйДокумент.Показать();
	
КонецПроцедуры

&НаСервере
Функция СформироватьПечатнуюФормуНаСервере()
	
	ТабличныйДокумент = Новый ТабличныйДокумент;
	Макет = Документы.ИнвентаризацияТоваров.ПолучитьМакет("МакетРезультатИнвентаризации");
	
	// Получаем области макета
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьШапкаТаблицы = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ОбластьСтрока = Макет.ПолучитьОбласть("Строка");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	
	// Заполняем параметры заголовка
	ОбластьЗаголовок.Параметры.НомерДокумента = Объект.Number;
	ОбластьЗаголовок.Параметры.ДатаДокумента = Формат(Объект.Date, "ДФ='dd.MM.yyyy'");
	ОбластьЗаголовок.Параметры.Склад = Объект.Склад;
	
	// Выводим заголовок
	ТабличныйДокумент.Вывести(ОбластьЗаголовок);
	
	// Выводим шапку таблицы
	ТабличныйДокумент.Вывести(ОбластьШапкаТаблицы);
	
	// Переменные для подсчета итогов
	ИтогоУчетное = 0;
	ИтогоФактическое = 0;
	ИтогоОтклонение = 0;
	ИтогоСумма = 0;
	ИтогоСуммаНедостачиИзлишков = 0;
	НомерСтроки = 0;
	
	// Выводим строки товаров
	Для Каждого ТекСтрока Из Объект.Товары Цикл
		
		НомерСтроки = НомерСтроки + 1;
		
		ОбластьСтрока.Параметры.НомерСтроки = НомерСтроки;
		ОбластьСтрока.Параметры.Номенклатура = ТекСтрока.Номенклатура;
		ОбластьСтрока.Параметры.УчетноеКоличество = ТекСтрока.УчетноеКоличество;
		ОбластьСтрока.Параметры.ФактическоеКоличество = ТекСтрока.ФактическоеКоличество;
		ОбластьСтрока.Параметры.Отклонение = ТекСтрока.Отклонение;
		ОбластьСтрока.Параметры.Цена = ТекСтрока.Цена;
		ОбластьСтрока.Параметры.Сумма = ТекСтрока.Сумма;
		ОбластьСтрока.Параметры.СуммаНедостачиИзлишков = ТекСтрока.СуммаНедостачиИзлишков;
		
		ТабличныйДокумент.Вывести(ОбластьСтрока);
		
		// Накапливаем итоги
		ИтогоУчетное = ИтогоУчетное + ТекСтрока.УчетноеКоличество;
		ИтогоФактическое = ИтогоФактическое + ТекСтрока.ФактическоеКоличество;
		ИтогоОтклонение = ИтогоОтклонение + ТекСтрока.Отклонение;
		ИтогоСумма = ИтогоСумма + ТекСтрока.Сумма;
		ИтогоСуммаНедостачиИзлишков = ИтогоСуммаНедостачиИзлишков + ТекСтрока.СуммаНедостачиИзлишков;
		
	КонецЦикла;
	
	// Заполняем параметры подвала с итогами
	ОбластьПодвал.Параметры.ИтогоУчетное = ИтогоУчетное;
	ОбластьПодвал.Параметры.ИтогоФактическое = ИтогоФактическое;
	ОбластьПодвал.Параметры.ИтогоОтклонение = ИтогоОтклонение;
	ОбластьПодвал.Параметры.ИтогоСумма = ИтогоСумма;
	ОбластьПодвал.Параметры.ИтогоСуммаНедостачиИзлишков = ИтогоСуммаНедостачиИзлишков;
	
	// Выводим подвал
	ТабличныйДокумент.Вывести(ОбластьПодвал);
	
	Возврат ТабличныйДокумент;
	
КонецФункции