#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриОткрытии(Отказ)
	
	// Инициализация формы
	Если ЗначениеЗаполнено(Объект.Ссылка) И Объект.Проведен Тогда
		// Если документ уже проведен, форма только для просмотра
		Элементы.Товары.ТолькоПросмотр = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытииНаКлиенте(Отказ)
	
	// Дополнительная инициализация на клиенте при необходимости
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	// Контроль заполнения обязательных реквизитов
	Если Не ЗначениеЗаполнено(Объект.Склад) Тогда
		Отказ = Истина;
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не указан склад!";
		Сообщение.Сообщить();
		Возврат;
	КонецЕсли;
	
	// Контроль заполнения товаров
	Если Объект.Товары.Количество() = 0 Тогда
		Отказ = Истина;
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Не указаны товары для списания!";
		Сообщение.Сообщить();
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийТабличнойЧастиТовары

&НаКлиенте
Процедура ТоварыНоменклатураПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	
	Если ТекущиеДанные <> Неопределено И ЗначениеЗаполнено(ТекущиеДанные.Номенклатура) Тогда
		// При изменении номенклатуры сбросим количество для переввода
		ТекущиеДанные.Количество = 0;
		// Очищаем штрихкод
		ТекущиеДанные.Штрихкод = "";
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Асинх Процедура ТоварыШтрихкодПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Проверка на пустой штрихкод
	Если ПустаяСтрока(ТекущиеДанные.Штрихкод) Тогда
		Возврат;
	КонецЕсли;
	
	// Поиск номенклатуры по штрихкоду
	НайденнаяНоменклатура = НайтиНоменклатуруПоШтрихкоду(ТекущиеДанные.Штрихкод);
	
	Если НайденнаяНоменклатура = Неопределено Тогда
		
		// Товар не найден - показываем предупреждение
		Ждать ПредупреждениеАсинх("Товар с штрихкодом """ + ТекущиеДанные.Штрихкод + """ не найден!");
		ТекущиеДанные.Штрихкод = "";
		Возврат;
		
	КонецЕсли;
	
	// Заполняем номенклатуру
	ТекущиеДанные.Номенклатура = НайденнаяНоменклатура;
	
	// Сбрасываем количество для переввода
	ТекущиеДанные.Количество = 0;
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	
	// Получаем текущую строку таблицы
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Проверяем, что номенклатура заполнена
	Если Не ЗначениеЗаполнено(ТекущиеДанные.Номенклатура) Тогда
		Возврат;
	КонецЕсли;
	
	// Проверяем, что склад заполнен
	Если Не ЗначениеЗаполнено(Объект.Склад) Тогда
		ТекущиеДанные.Количество = 0;
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Сначала укажите склад!";
		Сообщение.Поле = "Объект.Склад";
		Сообщение.Сообщить();
		Возврат;
	КонецЕсли;
	
	// Контроль отрицательного количества
	Если ТекущиеДанные.Количество < 0 Тогда
		ТекущиеДанные.Количество = 0;
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Количество не может быть отрицательным!";
		Сообщение.Сообщить();
		Возврат;
	КонецЕсли;
	
	// Если количество = 0, не проверяем остаток
	Если ТекущиеДанные.Количество = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// Проверяем остаток на сервере, передавая скалярные значения
	РезультатПроверки = ПроверитьОстатокТовара(
		ТекущиеДанные.Номенклатура,
		Объект.Склад,
		Объект.Дата,
		ТекущиеДанные.Количество);
	
	// Если остаток недостаточный, обновляем количество
	Если РезультатПроверки.ОстатокНедостаточен Тогда
		ТекущиеДанные.Количество = РезультатПроверки.МаксимальноеКоличество;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервереБезКонтекста
Функция НайтиНоменклатуруПоШтрихкоду(Штрихкод)
	
	// Поиск в регистре Штрихкоды
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Штрихкоды.Номенклатура КАК Номенклатура
	|ИЗ
	|	РегистрСведений.Штрихкоды КАК Штрихкоды
	|ГДЕ
	|	Штрихкоды.Штрихкод = &Штрихкод";
	
	Запрос.УстановитьПараметр("Штрихкод", Штрихкод);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Возврат Выборка.Номенклатура;
	
КонецФункции

&НаСервере
Функция ПроверитьОстатокТовара(Номенклатура, Склад, Дата, Количество)
	
	// Получаем остаток товара на складе
	Остаток = ПолучитьОстатокТовара(Номенклатура, Склад, Дата);
	
	// Результат проверки
	Результат = Новый Структура("ОстатокНедостаточен, МаксимальноеКоличество, Остаток");
	Результат.ОстатокНедостаточен = Ложь;
	Результат.МаксимальноеКоличество = Количество;
	Результат.Остаток = Остаток;
	
	// Проверяем достаточность остатка
	Если Количество > Остаток Тогда
		
		Результат.ОстатокНедостаточен = Истина;
		Результат.МаксимальноеКоличество = Остаток;
		
		// Показываем предупреждение
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = СтрШаблон(
			"Недостаточно товара ""%1"" на складе ""%2"".""|
			|Попытка списать: %3 %4|
			|В наличии: %5 %4|
			|Количество сокращено до доступного остатка.",
			Номенклатура,
			Склад,
			Количество,
			ПолучитьЕдиницуИзмеренияНоменклатуры(Номенклатура),
			Остаток);
		Сообщение.Сообщить();
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьОстатокТовара(Номенклатура, Склад, Дата)
	
	// Если параметры не заполнены, возвращаем 0
	Если Не ЗначениеЗаполнено(Номенклатура) ИЛИ Не ЗначениеЗаполнено(Склад) Тогда
		Возврат 0;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЕСТЬNULL(ОстаткиТоваровОстатки.КоличествоОстаток, 0) КАК Остаток
		|ИЗ
		|	РегистрНакопления.ОстаткиТоваров.Остатки(
		|		&Дата,
		|		Номенклатура = &Номенклатура
		|			И Склад = &Склад) КАК ОстаткиТоваровОстатки";
	
	Запрос.УстановитьПараметр("Дата", Дата);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.УстановитьПараметр("Склад", Склад);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Остаток;
	Иначе
		Возврат 0;
	КонецЕсли;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьЕдиницуИзмеренияНоменклатуры(Номенклатура)
	
	Если Не ЗначениеЗаполнено(Номенклатура) Тогда
		Возврат "шт.";
	КонецЕсли;
	
	// Простое получение единицы измерения
	Возврат "шт.";
	
КонецФункции

#КонецОбласти
