Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	// 1. Инициализация записи регистров
	Движения.ОстаткиТоваров.Записывать = Истина;
	Движения.Взаиморасчеты.Записывать = Истина;
	Движения.ЦеныНоменклатуры.Записывать = Истина;
	
	// Получаем основной тип цен для переоценки
	ОсновнойТипЦен = НастройкиПоУмолчанию.ПолучитьОсновнойТипЦен();
	
	// 2. Движения по ТОВАРАМ и ЦЕНАМ
	Для Каждого ТекСтрокаТовары Из Товары Цикл
		
		// А) Остатки товаров (Приход)
		Движение = Движения.ОстаткиТоваров.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период = Дата;
		Движение.Склад = Склад;
		Движение.Номенклатура = ТекСтрокаТовары.Номенклатура;
		Движение.Количество = ТекСтрокаТовары.Количество;
		
		// Б) Фиксация закупочных цен в регистре ЦеныНоменклатуры
		// Записываем с типом цен "Закупочная"
		Движение = Движения.ЦеныНоменклатуры.Добавить();
		Движение.Период = Дата;
		Движение.Номенклатура = ТекСтрокаТовары.Номенклатура;
		Движение.ТипЦен = Справочники.ТипыЦен.Закупочная;
		Движение.Цена = ТекСтрокаТовары.Цена;
		
		// В) Автоматическая переоценка розничных цен
		// Если указана новая розничная цена, записываем её в регистр цен
		Если ТекСтрокаТовары.ЦенаРозничнаяНовая > 0 Тогда
			
			Движение = Движения.ЦеныНоменклатуры.Добавить();
			Движение.Период = Дата;
			Движение.Номенклатура = ТекСтрокаТовары.Номенклатура;
			Движение.ТипЦен = ОсновнойТипЦен;
			Движение.Цена = ТекСтрокаТовары.ЦенаРозничнаяНовая;
			
		КонецЕсли;
		
	КонецЦикла;
	
	// 3. Движения по ВЗАИМОРАСЧЕТАМ (Общая сумма)
	// Долг поставщику увеличивается (Расход по регистру Взаиморасчеты, т.к. это "Наш долг")
	Движение = Движения.Взаиморасчеты.Добавить();
	Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
	Движение.Период = Дата;
	Движение.Контрагент = Контрагент;
	Движение.Сумма = СуммаДокумента; 

КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	// Если создается новый документ (не копия, не ввод на основании другого документа)
	Если ЭтоНовый() И ТипЗнч(ДанныеЗаполнения) = Тип("Неопределено") Тогда
		
		// 1. Заполняем Склад из константы, если он еще не заполнен
		Если Склад.Пустая() Тогда
			Склад = НастройкиПоУмолчанию.ПолучитьОсновнойСклад();
		КонецЕсли;
		
		// 2. Заполняем Контрагента из константы
		Если Контрагент.Пустая() Тогда
			Контрагент = НастройкиПоУмолчанию.ПолучитьОсновногоПоставщика();
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	// 3. Автоматический пересчет суммы документа по табличной части
	СуммаДокумента = Товары.Итог("Сумма");
	
КонецПроцедуры