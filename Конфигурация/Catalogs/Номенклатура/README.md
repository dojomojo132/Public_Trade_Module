# Взаимодействие справочника Номенклатура со штрихкодами

## Описание реализации

Справочник **Номенклатура** теперь поддерживает управление штрихкодами через табличную часть с автоматической синхронизацией с регистром сведений **Штрихкоды**.

## Структура

### 1. Табличная часть "Штрихкоды"
- **Колонка:** `Штрихкод` (Строка, 200)
- **Назначение:** Отображение и редактирование штрихкодов товара

### 2. Форма элемента
**Путь:** `Конфигурация/Catalogs/Номенклатура/Forms/ФормаЭлемента/`

**Функциональность:**
- Отображение текущих штрихкодов товара (загружаются из регистра при открытии)
- Добавление новых штрихкодов
- Редактирование существующих штрихкодов
- Удаление штрихкодов

### 3. Модуль формы
**Путь:** `Конфигурация/Catalogs/Номенклатура/Forms/ФормаЭлемента/Ext/Form/Module.bsl`

**Основные процедуры:**

#### `ПриСозданииНаСервере()`
- Загружает штрихкоды из регистра сведений при открытии существующего элемента

#### `ПередЗаписьюНаСервере()`
- Проверяет уникальность штрихкодов (внутри ТЧ и в регистре)
- Блокирует запись при обнаружении дублей

#### `ПослеЗаписиНаСервере()`
- Синхронизирует штрихкоды с регистром сведений:
  1. Удаляет все старые записи для данной номенклатуры
  2. Добавляет новые записи из табличной части

#### `ЗагрузитьШтрихкодыИзРегистра()`
- Выполняет запрос к регистру сведений
- Заполняет табличную часть данными

#### `СинхронизироватьШтрихкодыСРегистром()`
- Выполняет атомарную операцию записи в регистр (в транзакции)
- Обеспечивает консистентность данных

#### `ПроверитьУникальностьШтрихкодов()`
- Проверяет дубликаты внутри табличной части
- Проверяет использование штрихкода другой номенклатурой
- Выводит информативные сообщения об ошибках

### 4. Модуль объекта
**Путь:** `Конфигурация/Catalogs/Номенклатура/Ext/ObjectModule.bsl`

**Дополнительная логика:**

#### `ПередЗаписью()`
- Проверяет уникальность штрихкодов внутри табличной части
- Дополнительная защита на уровне объекта

#### `ПроверитьУникальностьШтрихкодовВТЧ()`
- Контроль дублирования штрихкодов
- Блокирует запись при обнаружении дублей

## Логика работы

### При открытии формы элемента:
1. Если элемент существует (заполнена ссылка)
2. Выполняется запрос к регистру сведений `Штрихкоды`
3. Табличная часть заполняется данными из регистра

### При записи элемента:
1. **ПередЗаписьюНаСервере:**
   - Проверка уникальности штрихкодов внутри ТЧ
   - Проверка использования штрихкода другой номенклатурой
   - При ошибке - отказ от записи с выводом сообщения

2. **ПослеЗаписиНаСервере:**
   - Начало транзакции
   - Удаление всех записей регистра для данной номенклатуры
   - Добавление новых записей из табличной части
   - Фиксация транзакции

### Обработка ошибок:
- Все операции с регистром выполняются в транзакции
- При возникновении ошибки транзакция откатывается
- Пользователь получает информативное сообщение

## Проверки

### Уникальность штрихкодов:
✅ Проверка дублей внутри табличной части  
✅ Проверка использования штрихкода другой номенклатурой  
✅ Игнорирование пустых штрихкодов  

### Транзакционность:
✅ Атомарность операций с регистром  
✅ Откат при ошибке  
✅ Защита от частичной записи  

## Использование

1. Откройте элемент справочника **Номенклатура**
2. В табличной части **Штрихкоды** добавьте/измените/удалите штрихкоды
3. Нажмите **Записать**
4. Система автоматически синхронизирует данные с регистром сведений

## Связь с регистром сведений

**Регистр:** `РегистрСведений.Штрихкоды`

**Измерения:**
- `Штрихкод` (Строка, 200)
- `Номенклатура` (Справочник.Номенклатура)

**Назначение:** Централизованное хранение связей "штрихкод → товар" для быстрого поиска в документах и РМК.

## Обновление документации

Изменения отражены в технической спецификации:
- **Путь:** `Документация/Спецификации/ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ КОНФИГУРАЦИИ PTM (Public Trade Module).xml`
- **Раздел:** Справочник "Номенклатура"
- **Дата:** 2026-01-25
