#Область ПрограммныйИнтерфейс

// Выполняет импорт номенклатуры из Excel файла
//
// Параметры:
//  АдресХранилища - Строка - адрес временного хранилища с данными файла
//
// Возвращаемое значение:
//   Структура - результат импорта:
//     * Успешно - Булево - успешность операции
//     * СообщениеОбОшибке - Строка - текст ошибки, если есть
//     * КоличествоЗагружено - Число - количество загруженных элементов
//
Функция ВыполнитьИмпорт(АдресХранилища) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Успешно", Ложь);
	Результат.Вставить("СообщениеОбОшибке", "");
	Результат.Вставить("КоличествоЗагружено", 0);
	
	Попытка
		// Получаем данные из файла
		ДанныеФайла = ПолучитьДанныеИзExcel(АдресХранилища);
		Если ДанныеФайла = Неопределено Тогда
			Результат.СообщениеОбОшибке = "Не удалось прочитать данные из файла";
			Возврат Результат;
		КонецЕсли;
		
		// Этап 1: Создаем все элементы без родителей
		СозданныеЭлементы = СоздатьВсеЭлементы(ДанныеФайла);
		
		// Этап 2: Устанавливаем родителей
		УстановитьРодителей(ДанныеФайла, СозданныеЭлементы);
		
		Результат.Успешно = Истина;
		Результат.КоличествоЗагружено = СозданныеЭлементы.Количество();
		
	Исключение
		Результат.СообщениеОбОшибке = ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Заполняет табличную часть данными из Excel файла
//
// Параметры:
//  АдресХранилища - Строка - адрес временного хранилища с данными файла
//
// Возвращаемое значение:
//   ТаблицаЗначений - данные из файла
//
Функция ЗагрузитьДанныеИзФайла(АдресХранилища) Экспорт
	
	Попытка
		// Получаем данные из файла
		ДанныеФайла = ПолучитьДанныеИзExcel(АдресХранилища);
		Если ДанныеФайла = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		Возврат ДанныеФайла;
		
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Получает данные из Excel файла
//
// Параметры:
//  АдресХранилища - Строка - адрес временного хранилища
//
// Возвращаемое значение:
//   ТаблицаЗначений - данные из файла
//
Функция ПолучитьДанныеИзExcel(АдресХранилища)
	
	Попытка
		ДвоичныеДанные = ПолучитьИзВременногоХранилища(АдресХранилища);
		
		// Создаем COM объект Excel
		Excel = Новый COMОбъект("Excel.Application");
		Excel.Visible = Ложь;
		Excel.DisplayAlerts = Ложь;
		
		// Создаем временный файл
		ВременныйФайл = ПолучитьИмяВременногоФайла("xlsx");
		ДвоичныеДанные.Записать(ВременныйФайл);
		
		// Открываем книгу
		Книга = Excel.Workbooks.Open(ВременныйФайл);
		Лист = Книга.Worksheets(1);
		
		// Определяем диапазон данных
		ПоследняяСтрока = Лист.UsedRange.Rows.Count;
		
		// Создаем таблицу результатов
		ТаблицаДанных = Новый ТаблицаЗначений;
		ТаблицаДанных.Колонки.Добавить("ЭтоГруппа", Новый ОписаниеТипов("Булево"));
		ТаблицаДанных.Колонки.Добавить("Код", Новый ОписаниеТипов("Строка"));
		ТаблицаДанных.Колонки.Добавить("Наименование", Новый ОписаниеТипов("Строка"));
		ТаблицаДанных.Колонки.Добавить("НазваниеНаЭтикетке", Новый ОписаниеТипов("Строка"));
		ТаблицаДанных.Колонки.Добавить("ЕдиницаИзмерения", Новый ОписаниеТипов("Строка"));
		ТаблицаДанных.Колонки.Добавить("РодительКод", Новый ОписаниеТипов("Строка"));
		ТаблицаДанных.Колонки.Добавить("РодительНаименование", Новый ОписаниеТипов("Строка"));
		
		// Читаем данные со второй строки (первая - заголовки)
		Для НомерСтроки = 2 По ПоследняяСтрока Цикл
			
			НоваяСтрока = ТаблицаДанных.Добавить();
			
			// Колонка A - ЭтоГруппа
			ЗначениеЯчейки = Лист.Cells(НомерСтроки, 1).Value;
			НоваяСтрока.ЭтоГруппа = (ВРег(СокрЛП(ЗначениеЯчейки)) = "ДА" 
				ИЛИ ВРег(СокрЛП(ЗначениеЯчейки)) = "ИСТИНА"
				ИЛИ ВРег(СокрЛП(ЗначениеЯчейки)) = "TRUE"
				ИЛИ СокрЛП(ЗначениеЯчейки) = "1");
			
			// Колонка B - Код
			НоваяСтрока.Код = СокрЛП(Лист.Cells(НомерСтроки, 2).Value);
			
			// Колонка C - Наименование
			НоваяСтрока.Наименование = СокрЛП(Лист.Cells(НомерСтроки, 3).Value);
			
			// Колонка D - Название на этикетке
			НоваяСтрока.НазваниеНаЭтикетке = СокрЛП(Лист.Cells(НомерСтроки, 4).Value);
			
			// Колонка E - Единица измерения
			НоваяСтрока.ЕдиницаИзмерения = СокрЛП(Лист.Cells(НомерСтроки, 5).Value);
			
			// Колонка F - Родитель.Код
			НоваяСтрока.РодительКод = СокрЛП(Лист.Cells(НомерСтроки, 6).Value);
			
			// Колонка G - Родитель.Наименование
			НоваяСтрока.РодительНаименование = СокрЛП(Лист.Cells(НомерСтроки, 7).Value);
			
		КонецЦикла;
		
		// Закрываем книгу
		Книга.Close(Ложь);
		Excel.Quit();
		
		// Удаляем временный файл
		УдалитьФайлы(ВременныйФайл);
		
		Возврат ТаблицаДанных;
		
	Исключение
		Если Excel <> Неопределено Тогда
			Попытка
				Excel.Quit();
			Исключение
			КонецПопытки;
		КонецЕсли;
		
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

// Создает все элементы номенклатуры без установки родителей
//
// Параметры:
//  ДанныеФайла - ТаблицаЗначений - данные из Excel
//
// Возвращаемое значение:
//   Соответствие - Ключ: Код, Значение: Ссылка на элемент
//
Функция СоздатьВсеЭлементы(ДанныеФайла)
	
	СозданныеЭлементы = Новый Соответствие;
	
	НачатьТранзакцию();
	
	Попытка
		
		Для Каждого СтрокаДанных Из ДанныеФайла Цикл
			
			Если ПустаяСтрока(СтрокаДанных.Код) Тогда
				Продолжить;
			КонецЕсли;
			
			// Проверяем, не создан ли уже элемент
			Если СозданныеЭлементы[СтрокаДанных.Код] <> Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			ЭтоГруппа = СтрокаДанных.ЭтоГруппа;
			
			// Ищем или создаём элемент
			ЭлементОбъект = НайтиИлиСоздатьЭлемент(СтрокаДанных.Код, ЭтоГруппа);
			
			// Заполняем реквизиты
			ЭлементОбъект.Наименование = СтрокаДанных.Наименование;
			
			Если НЕ ЭтоГруппа Тогда
				// Для элементов заполняем дополнительные реквизиты
				ЭлементОбъект.НазваниеНаЭтикетке = СтрокаДанных.НазваниеНаЭтикетке;
				
				// Ищем единицу измерения по точному совпадению
				ЕдиницаИзмерения = НайтиЕдиницуИзмерения(СтрокаДанных.ЕдиницаИзмерения);
				Если ЗначениеЗаполнено(ЕдиницаИзмерения) Тогда
					ЭлементОбъект.ЕдиницаИзмерения = ЕдиницаИзмерения;
				КонецЕсли;
			КонецЕсли;
			
			ЭлементОбъект.Записать();
			
			СозданныеЭлементы.Вставить(СтрокаДанных.Код, ЭлементОбъект.Ссылка);
			
		КонецЦикла;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		ВызватьИсключение;
	КонецПопытки;
	
	Возврат СозданныеЭлементы;
	
КонецФункции

// Устанавливает родителей для созданных элементов
//
// Параметры:
//  ДанныеФайла - ТаблицаЗначений - данные из Excel
//  СозданныеЭлементы - Соответствие - созданные элементы (Код → Ссылка)
//
Процедура УстановитьРодителей(ДанныеФайла, СозданныеЭлементы)
	
	НачатьТранзакцию();
	
	Попытка
		
		Для Каждого СтрокаДанных Из ДанныеФайла Цикл
			
			Если ПустаяСтрока(СтрокаДанных.Код) Тогда
				Продолжить;
			КонецЕсли;
			
			// Пропускаем, если нет родителя
			Если ПустаяСтрока(СтрокаДанных.КодРодителя) Тогда
				Продолжить;
			КонецЕсли;
			
			// Находим ссылки на элемент и родителя
			СсылкаЭлемента = СозданныеЭлементы[СтрокаДанных.Код];
			СсылкаРодителя = СозданныеЭлементы[СтрокаДанных.КодРодителя];
			
			Если СсылкаЭлемента = Неопределено ИЛИ СсылкаРодителя = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			// Устанавливаем родителя
			ЭлементОбъект = СсылкаЭлемента.ПолучитьОбъект();
			ЭлементОбъект.Родитель = СсылкаРодителя;
			ЭлементОбъект.Записать();
			
		КонецЦикла;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

// Ищет единицу измерения в перечислении по точному совпадению
//
// Параметры:
//  ЗначениеИзФайла - Строка - значение единицы измерения из файла
//
// Возвращаемое значение:
//   ПеречислениеСсылка.ЕдиницыИзмерения - найденная единица или Неопределено
//
Функция НайтиЕдиницуИзмерения(ЗначениеИзФайла)
	
	ЗначениеИзФайла = ВРег(СокрЛП(ЗначениеИзФайла));
	
	Если ПустаяСтрока(ЗначениеИзФайла) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Прямое сопоставление
	Попытка
		Если ЗначениеИзФайла = "ШТ" Тогда
			Возврат Перечисления.ЕдиницыИзмерения.Штука;
		ИначеЕсли ЗначениеИзФайла = "КГ" Тогда
			Возврат Перечисления.ЕдиницыИзмерения.Килограмм;
		ИначеЕсли ЗначениеИзФайла = "Л" Тогда
			Возврат Перечисления.ЕдиницыИзмерения.Литр;
		ИначеЕсли ЗначениеИзФайла = "М" Тогда
			Возврат Перечисления.ЕдиницыИзмерения.Метр;
		КонецЕсли;
	Исключение
		// Ошибка при обращении к перечислению
	КонецПопытки;
	
	Возврат Неопределено;
	
КонецФункции

// Создает группы номенклатуры
//
// Параметры:
//  ДанныеФайла - ТаблицаЗначений - данные из Excel
//
// Возвращаемое значение:
//   Число - количество созданных групп
//
Функция СоздатьГруппы(ДанныеФайла)
	
	КоличествоГрупп = 0;
	СозданныеГруппы = Новый Соответствие; // Ключ: Код группы, Значение: Ссылка
	
	НачатьТранзакцию();
	
	Попытка
		// Сначала отбираем только группы
		Группы = ДанныеФайла.Скопировать(Новый Структура("ЭтоГруппа", Истина));
		
		// Сортируем, чтобы родительские группы создавались раньше
		Группы.Сортировать("РодительКод");
		
		Для Каждого СтрокаГруппы Из Группы Цикл
			
			Если ПустаяСтрока(СтрокаГруппы.Код) Тогда
				Продолжить;
			КонецЕсли;
			
			// Проверяем, не создана ли уже группа
			Если СозданныеГруппы[СтрокаГруппы.Код] <> Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			// Ищем существующую группу по коду
			ГруппаОбъект = НайтиИлиСоздатьЭлемент(СтрокаГруппы.Код, Истина);
			
			// Заполняем реквизиты
			ГруппаОбъект.Наименование = СтрокаГруппы.Наименование;
			ГруппаОбъект.ЭтоГруппа = Истина;
			
			// Устанавливаем родителя
			Если НЕ ПустаяСтрока(СтрокаГруппы.РодительКод) Тогда
				Родитель = СозданныеГруппы[СтрокаГруппы.РодительКод];
				Если Родитель <> Неопределено Тогда
					ГруппаОбъект.Родитель = Родитель;
				КонецЕсли;
			КонецЕсли;
			
			ГруппаОбъект.Записать();
			
			СозданныеГруппы.Вставить(СтрокаГруппы.Код, ГруппаОбъект.Ссылка);
			КоличествоГрупп = КоличествоГрупп + 1;
			
		КонецЦикла;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		ВызватьИсключение;
	КонецПопытки;
	
	Возврат КоличествоГрупп;
	
КонецФункции

// Создает элементы номенклатуры
//
// Параметры:
//  ДанныеФайла - ТаблицаЗначений - данные из Excel
//  СоответствиеЕдиниц - Соответствие - соответствие единиц измерения
//
// Возвращаемое значение:
//   Число - количество созданных элементов
//
Функция СоздатьНоменклатуру(ДанныеФайла, СоответствиеЕдиниц)
	
	КоличествоЭлементов = 0;
	
	НачатьТранзакцию();
	
	Попытка
		// Отбираем только элементы (не группы)
		Элементы = ДанныеФайла.Скопировать(Новый Структура("ЭтоГруппа", Ложь));
		
		Для Каждого СтрокаЭлемента Из Элементы Цикл
			
			Если ПустаяСтрока(СтрокаЭлемента.Код) Тогда
				Продолжить;
			КонецЕсли;
			
			// Ищем или создаем элемент
			ЭлементОбъект = НайтиИлиСоздатьЭлемент(СтрокаЭлемента.Код, Ложь);
			
			// Заполняем реквизиты
			ЭлементОбъект.Наименование = СтрокаЭлемента.Наименование;
			ЭлементОбъект.ЭтоГруппа = Ложь;
			
			// Единица измерения
			Если НЕ ПустаяСтрока(СтрокаЭлемента.ЕдиницаИзмерения) Тогда
				ЕдиницаВСистеме = СоответствиеЕдиниц[ВРег(СокрЛП(СтрокаЭлемента.ЕдиницаИзмерения))];
				Если ЕдиницаВСистеме <> Неопределено Тогда
					ЭлементОбъект.ЕдиницаИзмерения = ЕдиницаВСистеме;
				КонецЕсли;
			КонецЕсли;
			
			// Родитель (группа)
			Если НЕ ПустаяСтрока(СтрокаЭлемента.РодительКод) Тогда
				РодительСсылка = НайтиГруппуПоКоду(СтрокаЭлемента.РодительКод);
				Если РодительСсылка <> Неопределено Тогда
					ЭлементОбъект.Родитель = РодительСсылка;
				КонецЕсли;
			КонецЕсли;
			
			ЭлементОбъект.Записать();
			КоличествоЭлементов = КоличествоЭлементов + 1;
			
		КонецЦикла;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		ВызватьИсключение;
	КонецПопытки;
	
	Возврат КоличествоЭлементов;
	
КонецФункции

// Находит или создает элемент/группу номенклатуры по коду
//
// Параметры:
//  Код - Строка - код элемента
//  ЭтоГруппа - Булево - признак группы
//
// Возвращаемое значение:
//   СправочникОбъект.Номенклатура - найденный или новый объект
//
Функция НайтиИлиСоздатьЭлемент(Код, ЭтоГруппа)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Код = &Код
	|	И Номенклатура.ЭтоГруппа = &ЭтоГруппа";
	
	Запрос.УстановитьПараметр("Код", Код);
	Запрос.УстановитьПараметр("ЭтоГруппа", ЭтоГруппа);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		НовыйОбъект = Справочники.Номенклатура.СоздатьЭлемент();
		НовыйОбъект.Код = Код;
		НовыйОбъект.ЭтоГруппа = ЭтоГруппа;
		Возврат НовыйОбъект;
	Иначе
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка.ПолучитьОбъект();
	КонецЕсли;
	
КонецФункции

// Находит группу номенклатуры по коду
//
// Параметры:
//  Код - Строка - код группы
//
// Возвращаемое значение:
//   СправочникСсылка.Номенклатура - найденная группа или Неопределено
//
Функция НайтиГруппуПоКоду(Код)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Код = &Код
	|	И Номенклатура.ЭтоГруппа = ИСТИНА";
	
	Запрос.УстановитьПараметр("Код", Код);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	Иначе
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
КонецФункции

#КонецОбласти
