#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	УстановитьПериодПоУмолчанию();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Сформировать(Команда)
	
	Если НЕ ЗначениеЗаполнено(Контрагент) Тогда
		СообщениеОбОшибке = Новый СообщениеПользователю;
		СообщениеОбОшибке.Текст = "Укажите контрагента";
		СообщениеОбОшибке.Поле = "Контрагент";
		СообщениеОбОшибке.Сообщить();
		Возврат;
	КонецЕсли;
	
	СформироватьНаСервере();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьПериодПоУмолчанию()
	
	// Реквизиты формы - используются в СформироватьНаСервере
	ДатаНачала = НачалоМесяца(ТекущаяДатаСеанса()); // BSLLS:UnusedLocalVariable-off
	ДатаОкончания = ТекущаяДатаСеанса(); // BSLLS:UnusedLocalVariable-off
	
КонецПроцедуры

&НаСервере
Процедура СформироватьНаСервере()
	
	Результат.Очистить();
	
	// Получение данных пакетным запросом
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ЕСТЬNULL(Остатки.СуммаОстаток, 0) КАК НачальныйОстаток
		|ИЗ
		|	РегистрНакопления.Взаиморасчеты.Остатки(&ДатаНачала, Контрагент = &Контрагент) КАК Остатки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Движения.Период КАК Дата,
		|	Движения.Регистратор КАК Документ,
		|	ВЫБОР
		|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА Движения.Сумма
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Образование,
		|	ВЫБОР
		|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			ТОГДА Движения.Сумма
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Погашение
		|ИЗ
		|	РегистрНакопления.Взаиморасчеты КАК Движения
		|ГДЕ
		|	Движения.Период >= &ДатаНачала
		|	И Движения.Период <= &ДатаОкончания
		|	И Движения.Контрагент = &Контрагент
		|	И Движения.Активность = ИСТИНА
		|
		|УПОРЯДОЧИТЬ ПО
		|	Дата";
	
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(ДатаНачала));
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ДатаОкончания));
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	
	МассивРезультатов = Запрос.ВыполнитьПакет();
	
	// Начальный остаток
	НачальныйОстаток = 0;
	ВыборкаОстаток = МассивРезультатов[0].Выбрать();
	Если ВыборкаОстаток.Следующий() Тогда
		НачальныйОстаток = ВыборкаОстаток.НачальныйОстаток;
	КонецЕсли;
	
	ТекСтрока = 0;
	
	// === Заголовок ===
	ТекСтрока = ТекСтрока + 1;
	Область = Результат.Область(ТекСтрока, 1, ТекСтрока, 4);
	Область.Объединить();
	Область.Текст = "Отчёт по взаиморасчётам: " + Строка(Контрагент);
	Область.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Центр;
	
	ТекСтрока = ТекСтрока + 1;
	Область = Результат.Область(ТекСтрока, 1, ТекСтрока, 4);
	Область.Объединить();
	Область.Текст = "Период: " + Формат(ДатаНачала, "ДЛФ=D") + " - " + Формат(ДатаОкончания, "ДЛФ=D");
	Область.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Центр;
	
	// === Задолженность на начало периода ===
	ТекСтрока = ТекСтрока + 2;
	Область = Результат.Область(ТекСтрока, 1, ТекСтрока, 3);
	Область.Объединить();
	Область.Текст = "Задолженность на начало периода:";
	
	Область = Результат.Область(ТекСтрока, 4);
	Область.Текст = Формат(НачальныйОстаток, "ЧДЦ=2; ЧН=0,00");
	Область.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
	
	// === Шапка таблицы ===
	ТекСтрока = ТекСтрока + 2;
	
	ЗаголовкиКолонок = Новый Массив;
	ЗаголовкиКолонок.Добавить("Дата");
	ЗаголовкиКолонок.Добавить("Документ");
	ЗаголовкиКолонок.Добавить("Образование");
	ЗаголовкиКолонок.Добавить("Погашение");
	
	Для Индекс = 0 По ЗаголовкиКолонок.ВГраница() Цикл
		Область = Результат.Область(ТекСтрока, Индекс + 1);
		Область.Текст = ЗаголовкиКолонок[Индекс];
		Область.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Центр;
	КонецЦикла;
	
	// === Детализация по документам ===
	ВыборкаДвижений = МассивРезультатов[1].Выбрать();
	
	ИтогоОбразование = 0;
	ИтогоПогашение = 0;
	
	Пока ВыборкаДвижений.Следующий() Цикл
		
		ТекСтрока = ТекСтрока + 1;
		
		Результат.Область(ТекСтрока, 1).Текст = Формат(ВыборкаДвижений.Дата, "ДЛФ=D");
		Результат.Область(ТекСтрока, 2).Текст = Строка(ВыборкаДвижений.Документ);
		
		Если ВыборкаДвижений.Образование <> 0 Тогда
			Результат.Область(ТекСтрока, 3).Текст = Формат(ВыборкаДвижений.Образование, "ЧДЦ=2");
			Результат.Область(ТекСтрока, 3).ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
		КонецЕсли;
		
		Если ВыборкаДвижений.Погашение <> 0 Тогда
			Результат.Область(ТекСтрока, 4).Текст = Формат(ВыборкаДвижений.Погашение, "ЧДЦ=2");
			Результат.Область(ТекСтрока, 4).ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
		КонецЕсли;
		
		ИтогоОбразование = ИтогоОбразование + ВыборкаДвижений.Образование;
		ИтогоПогашение = ИтогоПогашение + ВыборкаДвижений.Погашение;
		
	КонецЦикла;
	
	// === Итого ===
	ТекСтрока = ТекСтрока + 1;
	Область = Результат.Область(ТекСтрока, 1, ТекСтрока, 2);
	Область.Объединить();
	Область.Текст = "Итого:";
	Область.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
	
	Область = Результат.Область(ТекСтрока, 3);
	Область.Текст = Формат(ИтогоОбразование, "ЧДЦ=2; ЧН=0,00");
	Область.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
	
	Область = Результат.Область(ТекСтрока, 4);
	Область.Текст = Формат(ИтогоПогашение, "ЧДЦ=2; ЧН=0,00");
	Область.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
	
	// === Задолженность на конец периода ===
	КонечныйОстаток = НачальныйОстаток + ИтогоОбразование - ИтогоПогашение;
	
	ТекСтрока = ТекСтрока + 2;
	Область = Результат.Область(ТекСтрока, 1, ТекСтрока, 3);
	Область.Объединить();
	Область.Текст = "Задолженность на конец периода:";
	
	Область = Результат.Область(ТекСтрока, 4);
	Область.Текст = Формат(КонечныйОстаток, "ЧДЦ=2; ЧН=0,00");
	Область.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
	
	// Ширина колонок
	Результат.Область(1, 1).ШиринаКолонки = 15;
	Результат.Область(1, 2).ШиринаКолонки = 40;
	Результат.Область(1, 3).ШиринаКолонки = 20;
	Результат.Область(1, 4).ШиринаКолонки = 20;
	
КонецПроцедуры

#КонецОбласти
