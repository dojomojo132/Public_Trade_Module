#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ДатаНачала = НачалоМесяца(ТекущаяДатаСеанса()); // BSLLS:UnusedLocalVariable-off
	ДатаОкончания = ТекущаяДатаСеанса(); // BSLLS:UnusedLocalVariable-off
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Сформировать(Команда)
	
	Попытка
		СформироватьОтчет();
	Исключение
		СообщениеОбОшибке = Новый СообщениеПользователю;
		СообщениеОбОшибке.Текст = "ОШИБКА ОТЧЁТА: " + ОписаниеОшибки();
		СообщениеОбОшибке.Сообщить();
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// {{{ Основная точка входа }}}

&НаСервере
Процедура СформироватьОтчет()
	
	Результат.Очистить();
	
	// ДИАГНОСТИЧЕСКИЙ ТЕСТ - простой вывод без шрифтов/цветов 
	Результат.Область(1, 1).Текст = "ТЕСТ: отчёт работает!";
	Результат.Область(2, 1).Текст = "Контрагент: " + Строка(Контрагент);
	Результат.Область(3, 1).Текст = "Период: " + Строка(ДатаНачала) + " - " + Строка(ДатаОкончания);
	Возврат;
	
	// --- Прежний код (временно закомментирован) ---
	Если ЗначениеЗаполнено(Контрагент) Тогда
		СформироватьДетальный();
	Иначе
		СформироватьСводный();
	КонецЕсли;
	
КонецПроцедуры

// {{{ Детальный отчёт по одному контрагенту }}}

&НаСервере
Процедура СформироватьДетальный()
	
	// Пакетный запрос: остатки на начало + движения за период
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ЕСТЬNULL(Остатки.СуммаОстаток, 0) КАК ОстатокРегистра
		|ИЗ
		|	РегистрНакопления.Взаиморасчеты.Остатки(&ДатаНачала, Контрагент = &Контрагент) КАК Остатки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Движения.Период КАК Дата,
		|	Движения.Регистратор КАК Документ,
		|	ВЫБОР
		|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|			ТОГДА Движения.Сумма
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Поставка,
		|	ВЫБОР
		|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|			ТОГДА Движения.Сумма
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Оплата
		|ИЗ
		|	РегистрНакопления.Взаиморасчеты КАК Движения
		|ГДЕ
		|	Движения.Период >= &ДатаНачала
		|	И Движения.Период <= &ДатаОкончания
		|	И Движения.Контрагент = &Контрагент
		|	И Движения.Активность = ИСТИНА
		|
		|УПОРЯДОЧИТЬ ПО
		|	Дата";
	
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(ДатаНачала));
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ДатаОкончания));
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	
	Пакет = Запрос.ВыполнитьПакет();
	
	// Остаток регистра: отрицательный = наш долг
	ОстатокРегистра = 0;
	Выборка = Пакет[0].Выбрать();
	Если Выборка.Следующий() Тогда
		ОстатокРегистра = Выборка.ОстатокРегистра;
	КонецЕсли;
	
	// Сальдо = -(остаток регистра). Положительное = наш долг, отрицательное = нам должны
	НачСальдо = -ОстатокРегистра;
	
	// Стили
	ШрифтЗаголовка = Новый Шрифт(, 14, Истина); // BSLLS:NewFont-off
	ШрифтПодзаголовка = Новый Шрифт(, 10); // BSLLS:NewFont-off
	ШрифтШапки = Новый Шрифт(, 10, Истина); // BSLLS:NewFont-off
	ШрифтДанных = Новый Шрифт(, 10); // BSLLS:NewFont-off
	ШрифтИтогов = Новый Шрифт(, 10, Истина); // BSLLS:NewFont-off
	ШрифтСальдо = Новый Шрифт(, 11, Истина); // BSLLS:NewFont-off
	ФонШапки = Новый Цвет(230, 230, 230); // BSLLS:NewColor-off
	ФонИтогов = Новый Цвет(245, 245, 245); // BSLLS:NewColor-off
	
	Стр = 0;
	
	// === Заголовок ===
	Стр = Стр + 1;
	ВывестиОбъединённуюСтроку(Стр, 1, 5, "Взаиморасчёты: " + Строка(Контрагент),
		ШрифтЗаголовка, ГоризонтальноеПоложение.Центр);
	
	Стр = Стр + 1;
	ВывестиОбъединённуюСтроку(Стр, 1, 5,
		"Период: " + Формат(ДатаНачала, "ДЛФ=D") + " - " + Формат(ДатаОкончания, "ДЛФ=D"),
		ШрифтПодзаголовка, ГоризонтальноеПоложение.Центр);
	
	// === Сальдо на начало ===
	Стр = Стр + 2;
	ВывестиСтрокуСальдо(Стр, "Задолженность на начало периода:", НачСальдо, ШрифтСальдо);
	
	// === Шапка таблицы ===
	Стр = Стр + 2;
	
	Заголовки = Новый Массив;
	Заголовки.Добавить("Дата");
	Заголовки.Добавить("Документ");
	Заголовки.Добавить("Поставка");
	Заголовки.Добавить("Оплата");
	Заголовки.Добавить("Сальдо");
	
	Для К = 0 По Заголовки.ВГраница() Цикл
		Яч = Результат.Область(Стр, К + 1);
		Яч.Текст = Заголовки[К];
		Яч.Шрифт = ШрифтШапки;
		Яч.ЦветФона = ФонШапки;
		Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Центр;
	КонецЦикла;
	
	// === Строки данных ===
	Выборка = Пакет[1].Выбрать();
	ИтогоПоставка = 0;
	ИтогоОплата = 0;
	ТекСальдо = НачСальдо;
	
	Пока Выборка.Следующий() Цикл
		
		Стр = Стр + 1;
		ТекСальдо = ТекСальдо + Выборка.Поставка - Выборка.Оплата;
		
		Яч = Результат.Область(Стр, 1);
		Яч.Текст = Формат(Выборка.Дата, "ДЛФ=D");
		Яч.Шрифт = ШрифтДанных;
		
		Яч = Результат.Область(Стр, 2);
		Яч.Текст = Строка(Выборка.Документ);
		Яч.Шрифт = ШрифтДанных;
		
		Если Выборка.Поставка <> 0 Тогда
			Яч = Результат.Область(Стр, 3);
			Яч.Текст = Формат(Выборка.Поставка, "ЧДЦ=2");
			Яч.Шрифт = ШрифтДанных;
			Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
		КонецЕсли;
		
		Если Выборка.Оплата <> 0 Тогда
			Яч = Результат.Область(Стр, 4);
			Яч.Текст = Формат(Выборка.Оплата, "ЧДЦ=2");
			Яч.Шрифт = ШрифтДанных;
			Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
		КонецЕсли;
		
		// Накопительное сальдо с цветовой индикацией
		Яч = Результат.Область(Стр, 5);
		Яч.Текст = Формат(ТекСальдо, "ЧДЦ=2");
		Яч.Шрифт = ШрифтДанных;
		Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
		ОкраситьПоЗнакуСальдо(Яч, ТекСальдо);
		
		ИтогоПоставка = ИтогоПоставка + Выборка.Поставка;
		ИтогоОплата = ИтогоОплата + Выборка.Оплата;
		
	КонецЦикла;
	
	// === Итого ===
	Стр = Стр + 1;
	
	Область = Результат.Область(Стр, 1, Стр, 2);
	Область.Объединить();
	Область.Текст = "Итого:";
	Область.Шрифт = ШрифтИтогов;
	Область.ЦветФона = ФонИтогов;
	Область.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
	
	Яч = Результат.Область(Стр, 3);
	Яч.Текст = Формат(ИтогоПоставка, "ЧДЦ=2");
	Яч.Шрифт = ШрифтИтогов;
	Яч.ЦветФона = ФонИтогов;
	Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
	
	Яч = Результат.Область(Стр, 4);
	Яч.Текст = Формат(ИтогоОплата, "ЧДЦ=2");
	Яч.Шрифт = ШрифтИтогов;
	Яч.ЦветФона = ФонИтогов;
	Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
	
	Яч = Результат.Область(Стр, 5);
	Яч.ЦветФона = ФонИтогов;
	
	// === Задолженность на конец периода ===
	КонСальдо = НачСальдо + ИтогоПоставка - ИтогоОплата;
	
	Стр = Стр + 2;
	ВывестиСтрокуСальдо(Стр, "Задолженность на конец периода:", КонСальдо, ШрифтСальдо);
	
	// === Расшифровка ===
	Стр = Стр + 1;
	ВывестиИнтерпретацию(Стр, КонСальдо);
	
	// Ширина колонок
	Результат.Область(1, 1).ШиринаКолонки = 14;
	Результат.Область(1, 2).ШиринаКолонки = 36;
	Результат.Область(1, 3).ШиринаКолонки = 16;
	Результат.Область(1, 4).ШиринаКолонки = 16;
	Результат.Область(1, 5).ШиринаКолонки = 18;
	
КонецПроцедуры

// {{{ Сводный отчёт по всем контрагентам }}}

&НаСервере
Процедура СформироватьСводный()
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ОстОб.Контрагент КАК Контрагент,
		|	ЕСТЬNULL(ОстОб.СуммаНачальныйОстаток, 0) КАК ОстатокНачало,
		|	ЕСТЬNULL(ОстОб.СуммаРасход, 0) КАК Поставка,
		|	ЕСТЬNULL(ОстОб.СуммаПриход, 0) КАК Оплата,
		|	ЕСТЬNULL(ОстОб.СуммаКонечныйОстаток, 0) КАК ОстатокКонец
		|ИЗ
		|	РегистрНакопления.Взаиморасчеты.ОстаткиИОбороты(&ДатаНачала, &ДатаОкончания, , ) КАК ОстОб
		|
		|УПОРЯДОЧИТЬ ПО
		|	Контрагент";
	
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(ДатаНачала));
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ДатаОкончания));
	
	РезЗапроса = Запрос.Выполнить();
	
	Если РезЗапроса.Пустой() Тогда
		ВывестиОбъединённуюСтроку(1, 1, 5, "Нет данных по взаиморасчётам за указанный период",
			Новый Шрифт(, 12), ГоризонтальноеПоложение.Центр); // BSLLS:NewFont-off
		Возврат;
	КонецЕсли;
	
	// Стили
	ШрифтЗаголовка = Новый Шрифт(, 14, Истина); // BSLLS:NewFont-off
	ШрифтПодзаголовка = Новый Шрифт(, 10); // BSLLS:NewFont-off
	ШрифтШапки = Новый Шрифт(, 10, Истина); // BSLLS:NewFont-off
	ШрифтДанных = Новый Шрифт(, 10); // BSLLS:NewFont-off
	ШрифтИтогов = Новый Шрифт(, 10, Истина); // BSLLS:NewFont-off
	ФонШапки = Новый Цвет(230, 230, 230); // BSLLS:NewColor-off
	ФонИтогов = Новый Цвет(245, 245, 245); // BSLLS:NewColor-off
	
	Стр = 0;
	
	// === Заголовок ===
	Стр = Стр + 1;
	ВывестиОбъединённуюСтроку(Стр, 1, 5, "Сводный отчёт по взаиморасчётам",
		ШрифтЗаголовка, ГоризонтальноеПоложение.Центр);
	
	Стр = Стр + 1;
	ВывестиОбъединённуюСтроку(Стр, 1, 5,
		"Период: " + Формат(ДатаНачала, "ДЛФ=D") + " - " + Формат(ДатаОкончания, "ДЛФ=D"),
		ШрифтПодзаголовка, ГоризонтальноеПоложение.Центр);
	
	// === Шапка таблицы ===
	Стр = Стр + 2;
	
	Заголовки = Новый Массив;
	Заголовки.Добавить("Контрагент");
	Заголовки.Добавить("Долг на начало");
	Заголовки.Добавить("Поставка");
	Заголовки.Добавить("Оплата");
	Заголовки.Добавить("Долг на конец");
	
	Для К = 0 По Заголовки.ВГраница() Цикл
		Яч = Результат.Область(Стр, К + 1);
		Яч.Текст = Заголовки[К];
		Яч.Шрифт = ШрифтШапки;
		Яч.ЦветФона = ФонШапки;
		Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Центр;
	КонецЦикла;
	
	// === Данные ===
	Выборка = РезЗапроса.Выбрать();
	ВсегоДолгНач = 0;
	ВсегоПоставка = 0;
	ВсегоОплата = 0;
	ВсегоДолгКон = 0;
	
	Пока Выборка.Следующий() Цикл
		
		Стр = Стр + 1;
		ДолгНач = -Выборка.ОстатокНачало;
		ДолгКон = -Выборка.ОстатокКонец;
		
		Яч = Результат.Область(Стр, 1);
		Яч.Текст = Строка(Выборка.Контрагент);
		Яч.Шрифт = ШрифтДанных;
		
		Яч = Результат.Область(Стр, 2);
		Яч.Текст = Формат(ДолгНач, "ЧДЦ=2");
		Яч.Шрифт = ШрифтДанных;
		Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
		ОкраситьПоЗнакуСальдо(Яч, ДолгНач);
		
		Яч = Результат.Область(Стр, 3);
		Яч.Текст = Формат(Выборка.Поставка, "ЧДЦ=2");
		Яч.Шрифт = ШрифтДанных;
		Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
		
		Яч = Результат.Область(Стр, 4);
		Яч.Текст = Формат(Выборка.Оплата, "ЧДЦ=2");
		Яч.Шрифт = ШрифтДанных;
		Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
		
		Яч = Результат.Область(Стр, 5);
		Яч.Текст = Формат(ДолгКон, "ЧДЦ=2");
		Яч.Шрифт = ШрифтДанных;
		Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
		ОкраситьПоЗнакуСальдо(Яч, ДолгКон);
		
		ВсегоДолгНач = ВсегоДолгНач + ДолгНач;
		ВсегоПоставка = ВсегоПоставка + Выборка.Поставка;
		ВсегоОплата = ВсегоОплата + Выборка.Оплата;
		ВсегоДолгКон = ВсегоДолгКон + ДолгКон;
		
	КонецЦикла;
	
	// === Итого ===
	Стр = Стр + 1;
	
	Яч = Результат.Область(Стр, 1);
	Яч.Текст = "ИТОГО:";
	Яч.Шрифт = ШрифтИтогов;
	Яч.ЦветФона = ФонИтогов;
	
	Яч = Результат.Область(Стр, 2);
	Яч.Текст = Формат(ВсегоДолгНач, "ЧДЦ=2");
	Яч.Шрифт = ШрифтИтогов;
	Яч.ЦветФона = ФонИтогов;
	Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
	
	Яч = Результат.Область(Стр, 3);
	Яч.Текст = Формат(ВсегоПоставка, "ЧДЦ=2");
	Яч.Шрифт = ШрифтИтогов;
	Яч.ЦветФона = ФонИтогов;
	Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
	
	Яч = Результат.Область(Стр, 4);
	Яч.Текст = Формат(ВсегоОплата, "ЧДЦ=2");
	Яч.Шрифт = ШрифтИтогов;
	Яч.ЦветФона = ФонИтогов;
	Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
	
	Яч = Результат.Область(Стр, 5);
	Яч.Текст = Формат(ВсегоДолгКон, "ЧДЦ=2");
	Яч.Шрифт = ШрифтИтогов;
	Яч.ЦветФона = ФонИтогов;
	Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
	
	// === Расшифровка ===
	Стр = Стр + 2;
	ВывестиИнтерпретацию(Стр, ВсегоДолгКон);
	
	// Ширина колонок
	Результат.Область(1, 1).ШиринаКолонки = 30;
	Результат.Область(1, 2).ШиринаКолонки = 17;
	Результат.Область(1, 3).ШиринаКолонки = 17;
	Результат.Область(1, 4).ШиринаКолонки = 17;
	Результат.Область(1, 5).ШиринаКолонки = 17;
	
КонецПроцедуры

// {{{ Вспомогательные процедуры }}}

&НаСервере
Процедура ВывестиОбъединённуюСтроку(НомерСтроки, НачКолонка, КонКолонка, Текст, Шрифт, Положение = Неопределено)
	
	Область = Результат.Область(НомерСтроки, НачКолонка, НомерСтроки, КонКолонка);
	Область.Объединить();
	Область.Текст = Текст;
	Область.Шрифт = Шрифт;
	
	Если Положение <> Неопределено Тогда
		Область.ГоризонтальноеПоложение = Положение;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ВывестиСтрокуСальдо(НомерСтроки, Заголовок, Сальдо, Шрифт)
	
	Область = Результат.Область(НомерСтроки, 1, НомерСтроки, 4);
	Область.Объединить();
	Область.Текст = Заголовок;
	Область.Шрифт = Шрифт;
	
	Яч = Результат.Область(НомерСтроки, 5);
	Яч.Текст = Формат(Сальдо, "ЧДЦ=2");
	Яч.Шрифт = Шрифт;
	Яч.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Право;
	ОкраситьПоЗнакуСальдо(Яч, Сальдо);
	
КонецПроцедуры

&НаСервере
Процедура ОкраситьПоЗнакуСальдо(Ячейка, Сальдо)
	
	Если Сальдо > 0 Тогда
		Ячейка.ЦветТекста = Новый Цвет(180, 0, 0); // BSLLS:NewColor-off
	ИначеЕсли Сальдо < 0 Тогда
		Ячейка.ЦветТекста = Новый Цвет(0, 130, 0); // BSLLS:NewColor-off
	Иначе
		Возврат; // нулевое сальдо - стандартный цвет
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ВывестиИнтерпретацию(НомерСтроки, Сальдо)
	
	ШрифтПояснения = Новый Шрифт(, 10, , Истина); // BSLLS:NewFont-off
	
	Область = Результат.Область(НомерСтроки, 1, НомерСтроки, 5);
	Область.Объединить();
	Область.Шрифт = ШрифтПояснения;
	
	Если Сальдо > 0 Тогда
		Область.Текст = "Наш долг контрагенту: " + Формат(Сальдо, "ЧДЦ=2") + " руб.";
		Область.ЦветТекста = Новый Цвет(180, 0, 0); // BSLLS:NewColor-off
	ИначеЕсли Сальдо < 0 Тогда
		Область.Текст = "Контрагент должен нам: " + Формат(-Сальдо, "ЧДЦ=2") + " руб.";
		Область.ЦветТекста = Новый Цвет(0, 130, 0); // BSLLS:NewColor-off
	Иначе
		Область.Текст = "Взаиморасчёты закрыты";
		Область.ЦветТекста = Новый Цвет(100, 100, 100); // BSLLS:NewColor-off
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
