// =============================================================================
// МОДУЛЬ ОБЪЕКТА: Справочник Номенклатура
// =============================================================================

Процедура ПередЗаписью(Отказ)
	
	// [Spec-First 1.1] Автозаполнение Артикула из Кода
	// Если артикул пустой, заполняем его из кода, убирая ведущие нули
	// ВАЖНО: Артикул доступен только для элементов, а не для групп!
	Если НЕ ЭтоГруппа И ПустаяСтрока(Артикул) И ЗначениеЗаполнено(Код) Тогда
		Артикул = УбратьВедущиеНули(Код);
	КонецЕсли;
	
	// Проверка уникальности штрихкодов внутри табличной части
	ПроверитьУникальностьШтрихкодовВТЧ(Отказ);
	
КонецПроцедуры

Процедура ПослеЗаписи(Отказ)
	
	// Синхронизация штрихкодов с регистром сведений происходит на форме
	// Здесь можно добавить дополнительную логику при необходимости
	
КонецПроцедуры

#Область СлужебныеПроцедурыИФункции

// Добавляет штрихкод к номенклатуре с проверкой уникальности
//
// Параметры:
//  Номенклатура - СправочникСсылка.Номенклатура - Элемент номенклатуры
//  Штрихкод - Строка - Значение штрихкода
//
// Возвращаемое значение:
//  Булево - Истина, если штрихкод успешно добавлен; Ложь - если пара уже существует
//
Функция ЗаполнитьШтрихкод(Номенклатура, Штрихкод) Экспорт
	
	// Проверка входных параметров
	Если Не ЗначениеЗаполнено(Номенклатура) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если ПустаяСтрока(СокрЛП(Штрихкод)) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	ШтрихкодНормализованный = ВРег(СокрЛП(Штрихкод));
	
	// Проверка существования пары номенклатура-штрихкод в регистре сведений
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Штрихкоды.Номенклатура КАК Номенклатура
	|ИЗ
	|	РегистрСведений.Штрихкоды КАК Штрихкоды
	|ГДЕ
	|	ВЕРХРЕГ(Штрихкоды.Штрихкод) = &Штрихкод
	|	И Штрихкоды.Номенклатура = &Номенклатура";
	
	Запрос.УстановитьПараметр("Штрихкод", ШтрихкодНормализованный);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	Результат = Запрос.Выполнить();
	
	// Если пара уже существует, возвращаем Ложь
	Если Не Результат.Пустой() Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Проверка, не привязан ли штрихкод к другой номенклатуре
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Штрихкоды.Номенклатура КАК Номенклатура
	|ИЗ
	|	РегистрСведений.Штрихкоды КАК Штрихкоды
	|ГДЕ
	|	ВЕРХРЕГ(Штрихкоды.Штрихкод) = &Штрихкод
	|	И Штрихкоды.Номенклатура <> &Номенклатура";
	
	Запрос.УстановитьПараметр("Штрихкод", ШтрихкодНормализованный);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	РезультатПроверки = Запрос.Выполнить();
	
	Если Не РезультатПроверки.Пустой() Тогда
		
		Выборка = РезультатПроверки.Выбрать();
		Выборка.Следующий();
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = СтрШаблон(
			"Штрихкод ""%1"" уже привязан к номенклатуре ""%2""!",
			Штрихкод,
			Выборка.Номенклатура);
		Сообщение.Сообщить();
		
		Возврат Ложь;
		
	КонецЕсли;
	
	// Добавление записи в регистр сведений
	НаборЗаписей = РегистрыСведений.Штрихкоды.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Штрихкод.Установить(ШтрихкодНормализованный);
	НаборЗаписей.Отбор.Номенклатура.Установить(Номенклатура);
	
	НоваяЗапись = НаборЗаписей.Добавить();
	НоваяЗапись.Штрихкод = ШтрихкодНормализованный;
	НоваяЗапись.Номенклатура = Номенклатура;
	
	Попытка
		НаборЗаписей.Записать();
		Возврат Истина;
	Исключение
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = СтрШаблон(
			"Ошибка при добавлении штрихкода ""%1"": %2",
			Штрихкод,
			ОписаниеОшибки());
		Сообщение.Сообщить();
		
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

Функция УбратьВедущиеНули(Строка)
	
	// Удаляет ведущие нули из строки
	// Пример: "000123" -> "123", "00ABC" -> "ABC"
	
	Если ПустаяСтрока(Строка) Тогда
		Возврат "";
	КонецЕсли;
	
	Результат = СокрЛП(Строка);
	
	// Убираем ведущие нули
	Пока СтрНачинаетсяС(Результат, "0") И СтрДлина(Результат) > 1 Цикл
		Результат = Сред(Результат, 2);
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Процедура ПроверитьУникальностьШтрихкодовВТЧ(Отказ)
	
	// Проверка на дублирование штрихкодов внутри табличной части
	СписокШтрихкодов = Новый Соответствие;
	
	Для Каждого СтрокаТЧ Из Штрихкоды Цикл
		
		// Пропускаем пустые штрихкоды
		Если ПустаяСтрока(СокрЛП(СтрокаТЧ.Штрихкод)) Тогда
			Продолжить;
		КонецЕсли;
		
		Штрихкод = ВРег(СокрЛП(СтрокаТЧ.Штрихкод));
		
		// Проверяем дубликаты внутри ТЧ
		Если СписокШтрихкодов[Штрихкод] <> Неопределено Тогда
			
			Отказ = Истина;
			
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = СтрШаблон(
				"Штрихкод ""%1"" дублируется в табличной части!",
				СокрЛП(СтрокаТЧ.Штрихкод));
			Сообщение.Сообщить();
			
			Возврат;
			
		КонецЕсли;
		
		СписокШтрихкодов.Вставить(Штрихкод, Истина);
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти
