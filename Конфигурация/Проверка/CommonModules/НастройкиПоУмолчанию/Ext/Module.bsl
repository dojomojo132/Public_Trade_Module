// ============================================================================
// ОБЩИЙ МОДУЛЬ: НастройкиПоУмолчанию (Серверный)
// Назначение: API для чтения/записи настроек в формате Key-Value (JSON)
// ============================================================================

#Область ПрограммныйИнтерфейс

// Возвращает значение настройки "Основной склад"
//
// Возвращаемое значение:
//   СправочникСсылка.Склады - Ссылка на основной склад
//
Функция ПолучитьОсновнойСклад() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ОсновнойСклад;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Основной поставщик"
//
// Возвращаемое значение:
//   СправочникСсылка.Контрагенты - Ссылка на основного поставщика
//
Функция ПолучитьОсновногоПоставщика() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ОсновнойПоставщик;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Основная касса"
//
// Возвращаемое значение:
//   СправочникСсылка.Кассы - Ссылка на основную кассу
//
Функция ПолучитьОсновнуюКассу() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ОсновнаяКасса;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Основной тип цен"
//
// Возвращаемое значение:
//   СправочникСсылка.ТипыЦен - Ссылка на основной тип цен
//
Функция ПолучитьОсновнойТипЦен() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ОсновнойТипЦен;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Порядок округления цен"
//
// Возвращаемое значение:
//   ПеречислениеСсылка.ПорядкиОкругленияЦен - Порядок округления
//
Функция ПолучитьПорядокОкругленияЦен() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ПорядокОкругленияЦен;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Контролировать остатки при списании"
//
// Возвращаемое значение:
//   Булево - Истина если контроль включен
//
Функция ПолучитьКонтрольОстатков() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.КонтролироватьОстаткиПриСписании;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Количество кнопок в колонке"
//
// Возвращаемое значение:
//   Число - Количество кнопок
//
Функция ПолучитьКоличествоКнопокВКолонке() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.КоличествоКнопокВКолонке;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Количество кнопок в ряду"
//
// Возвращаемое значение:
//   Число - Количество кнопок
//
Функция ПолучитьКоличествоКнопокВРяду() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.КоличествоКнопокВРяду;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Ширина кнопок"
//
// Возвращаемое значение:
//   Число - Ширина кнопок в пиксели
//
Функция ПолучитьШиринуКнопок() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ШиринаКнопок;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Высота кнопок"
//
// Возвращаемое значение:
//   Число - Высота кнопок в пиксели
//
Функция ПолучитьВысотуКнопок() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ВысотаКнопок;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Фискальный режим"
//
// Возвращаемое значение:
//   Булево - Истина если фискальный режим включен
//
Функция ПолучитьФискальныйРежим() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ФискальныйРежим;
	Значение = ПолучитьЗначениеНастройки(ИмяНастройки);
	
	// По умолчанию фискальный режим включен
	Если Значение = Неопределено Тогда
		Возврат Истина;
	КонецЕсли;
	
	Возврат Значение;
	
КонецФункции

// Возвращает значение настройки "Разделение фискальных чеков"
//
// Возвращаемое значение:
//   Булево - Истина если разделение фискальных чеков включено
//
Функция ПолучитьРазделениеФискальныхЧеков() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.РазделениеФискальныхЧеков;
	Значение = ПолучитьЗначениеНастройки(ИмяНастройки);
	
	// По умолчанию разделение выключено
	Если Значение = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Возврат Значение;
	
КонецФункции

// Возвращает значение настройки "Касса наличных"
//
// Возвращаемое значение:
//   СправочникСсылка.Кассы - Ссылка на кассу для наличных
//
Функция ПолучитьКассуНаличных() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.КассаНаличных;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Касса безналичных"
//
// Возвращаемое значение:
//   СправочникСсылка.Кассы - Ссылка на кассу для безналичных
//
Функция ПолучитьКассуБезналичных() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.КассаБезналичных;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает структуру со всеми настройками
//
// Возвращаемое значение:
//   Структура - Все настройки по умолчанию
//
Функция ПолучитьВсеНастройки() Экспорт
	
	Настройки = Новый Структура;
	Настройки.Вставить("ОсновнойСклад", ПолучитьОсновнойСклад());
	Настройки.Вставить("ОсновнойПоставщик", ПолучитьОсновногоПоставщика());
	Настройки.Вставить("ОсновнаяКасса", ПолучитьОсновнуюКассу());
	Настройки.Вставить("ОсновнойТипЦен", ПолучитьОсновнойТипЦен());
	Настройки.Вставить("ПорядокОкругленияЦен", ПолучитьПорядокОкругленияЦен());
	Настройки.Вставить("КонтролироватьОстаткиПриСписании", ПолучитьКонтрольОстатков());
	Настройки.Вставить("КоличествоКнопокВКолонке", ПолучитьКоличествоКнопокВКолонке());
	Настройки.Вставить("КоличествоКнопокВРяду", ПолучитьКоличествоКнопокВРяду());
	Настройки.Вставить("ШиринаКнопок", ПолучитьШиринуКнопок());
	Настройки.Вставить("ВысотаКнопок", ПолучитьВысотуКнопок());
	Настройки.Вставить("ФискальныйРежим", ПолучитьФискальныйРежим());
	Настройки.Вставить("РазделениеФискальныхЧеков", ПолучитьРазделениеФискальныхЧеков());
	Настройки.Вставить("КассаНаличных", ПолучитьКассуНаличных());
	Настройки.Вставить("КассаБезналичных", ПолучитьКассуБезналичных());
	
	Возврат Настройки;
	
КонецФункции

// Устанавливает значение настройки
//
// Параметры:
//   ИмяНастройки - Строка - Имя настройки
//   Значение - Произвольный - Значение настройки
//
Процедура УстановитьЗначениеНастройки(ИмяНастройки, Значение) Экспорт
	
	Менеджер = РегистрыСведений.НастройкиПоУмолчанию.СоздатьМенеджерЗаписи();
	Менеджер.ИмяНастройки = ИмяНастройки;
	
	// Сериализуем значение в строку используя внутреннее представление 1С
	Менеджер.Значение = ЗначениеВСтрокуВнутр(Значение);
	
	Менеджер.Записать();
	
КонецПроцедуры

// Инициализирует все настройки по умолчанию при первом запуске
// Проверяет существование записи и наличие значения
// Если запись отсутствует или значение пустое - устанавливает дефолт
//
Процедура ИнициализироватьНастройки() Экспорт
	
	// Получаем список всех настроек с дефолтными значениями
	ДефолтныеЗначения = ПолучитьДефолтныеЗначения();
	
	// Проверяем каждую настройку
	Для Каждого Настройка Из ДефолтныеЗначения Цикл
		
		ИмяНастройки = Настройка.Ключ;
		ДефолтноеЗначение = Настройка.Значение;
		
		// Проверяем существование и заполненность записи
		ТекущееЗначение = ПолучитьЗначениеНастройки(ИмяНастройки);
		
		// Если значение не определено или пустое - устанавливаем дефолт
		Если ТекущееЗначение = Неопределено Тогда
			УстановитьЗначениеНастройки(ИмяНастройки, ДефолтноеЗначение);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Возвращает массив с дефолтными значениями всех настроек
//
// Возвращаемое значение:
//   Массив из Структур - Каждый элемент содержит Ключ (ссылка на справочник) и Значение
//
Функция ПолучитьДефолтныеЗначения()
	
	Дефолты = Новый Массив;
	
	// Для ссылочных настроек берём первый элемент из справочника
	// Для примитивных - предустановленные константы
	
	Запрос = Новый Запрос;
	
	// Основной склад - первый из справочника
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка ИЗ Справочник.Склады";
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Элемент = Новый Структура("Ключ, Значение", 
			Справочники.НастройкиПоУмолчанию.ОсновнойСклад, 
			Выборка.Ссылка);
		Дефолты.Добавить(Элемент);
	КонецЕсли;
	
	// Основной поставщик
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка ИЗ Справочник.Контрагенты";
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Элемент = Новый Структура("Ключ, Значение", 
			Справочники.НастройкиПоУмолчанию.ОсновнойПоставщик, 
			Выборка.Ссылка);
		Дефолты.Добавить(Элемент);
	КонецЕсли;
	
	// Основная касса
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка ИЗ Справочник.Кассы";
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Элемент = Новый Структура("Ключ, Значение", 
			Справочники.НастройкиПоУмолчанию.ОсновнаяКасса, 
			Выборка.Ссылка);
		Дефолты.Добавить(Элемент);
	КонецЕсли;
	
	// Основной тип цен
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка ИЗ Справочник.ТипыЦен";
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Элемент = Новый Структура("Ключ, Значение", 
			Справочники.НастройкиПоУмолчанию.ОсновнойТипЦен, 
			Выборка.Ссылка);
		Дефолты.Добавить(Элемент);
	КонецЕсли;
	
	// Константные значения
	Элемент = Новый Структура("Ключ, Значение", 
		Справочники.НастройкиПоУмолчанию.ПорядокОкругленияЦен, 
		Перечисления.ПорядкиОкругленияЦен.ДоКопеек);
	Дефолты.Добавить(Элемент);
	
	Элемент = Новый Структура("Ключ, Значение", 
		Справочники.НастройкиПоУмолчанию.КонтролироватьОстаткиПриСписании, 
		Истина);
	Дефолты.Добавить(Элемент);
	
	Элемент = Новый Структура("Ключ, Значение", 
		Справочники.НастройкиПоУмолчанию.КоличествоКнопокВКолонке, 
		4);
	Дефолты.Добавить(Элемент);
	
	Элемент = Новый Структура("Ключ, Значение", 
		Справочники.НастройкиПоУмолчанию.КоличествоКнопокВРяду, 
		3);
	Дефолты.Добавить(Элемент);
	
	Элемент = Новый Структура("Ключ, Значение", 
		Справочники.НастройкиПоУмолчанию.ШиринаКнопок, 
		100);
	Дефолты.Добавить(Элемент);
	
	Элемент = Новый Структура("Ключ, Значение", 
		Справочники.НастройкиПоУмолчанию.ВысотаКнопок, 
		80);
	Дефолты.Добавить(Элемент);
	
	// Разделение фискальных чеков - по умолчанию выключено
	Элемент = Новый Структура("Ключ, Значение", 
		Справочники.НастройкиПоУмолчанию.РазделениеФискальныхЧеков, 
		Ложь);
	Дефолты.Добавить(Элемент);
	
	// Касса наличных - первая касса с видом "Наличная"
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка ИЗ Справочник.Кассы ГДЕ НЕ ПометкаУдаления И ВидКассы = ЗНАЧЕНИЕ(Перечисление.ВидыКасс.Наличная)";
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Элемент = Новый Структура("Ключ, Значение", 
			Справочники.НастройкиПоУмолчанию.КассаНаличных, 
			Выборка.Ссылка);
		Дефолты.Добавить(Элемент);
	КонецЕсли;
	
	// Касса безналичных - первая касса с видом "Банковский счет"
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка ИЗ Справочник.Кассы ГДЕ НЕ ПометкаУдаления И ВидКассы = ЗНАЧЕНИЕ(Перечисление.ВидыКасс.БанковскийСчет)";
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Элемент = Новый Структура("Ключ, Значение", 
			Справочники.НастройкиПоУмолчанию.КассаБезналичных, 
			Выборка.Ссылка);
		Дефолты.Добавить(Элемент);
	КонецЕсли;
	
	Возврат Дефолты;
	
КонецФункции

// Внутренняя функция для чтения значения из регистра
//
// Параметры:
//   ИмяНастройки - Строка - Имя настройки
//
// Возвращаемое значение:
//   Произвольный - Значение настройки или Неопределено
//
Функция ПолучитьЗначениеНастройки(ИмяНастройки)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	НастройкиПоУмолчанию.Значение КАК Значение
	|ИЗ
	|	РегистрСведений.НастройкиПоУмолчанию КАК НастройкиПоУмолчанию
	|ГДЕ
	|	НастройкиПоУмолчанию.ИмяНастройки = &ИмяНастройки";
	
	Запрос.УстановитьПараметр("ИмяНастройки", ИмяНастройки);
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	// Десериализуем из внутреннего представления 1С
	Если ПустаяСтрока(Выборка.Значение) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Попытка
		Возврат ЗначениеИзСтрокиВнутр(Выборка.Значение);
	Исключение
		// Если строка некорректна, возвращаем Неопределено
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

#КонецОбласти
