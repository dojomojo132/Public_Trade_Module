
#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Сформировать(Команда)
	
	СформироватьНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура Печать(Команда)
	
	Если Объект.Товары.Количество() = 0 Тогда
		ПоказатьПредупреждение(, "Таблица пуста. Сначала нажмите ""Сформировать"".");
		Возврат;
	КонецЕсли;
	
	АдресХранилища = ПодготовитьПечатнуюФормуНаСервере();
	ТабДок = ПолучитьИзВременногоХранилища(АдресХранилища);
	ТабДок.Показать("Информация номенклатуры");
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура СформироватьНаСервере()
	
	Объект.Товары.Очистить();
	
	Запрос = Новый Запрос;
	
	// Формируем динамические условия для виртуальных таблиц
	УсловиеОстатков = "";
	Если ЗначениеЗаполнено(Склад) Тогда
		УсловиеОстатков = ", Склад = &Склад";
		Запрос.УстановитьПараметр("Склад", Склад);
	КонецЕсли;
	
	УсловиеЦен = "";
	Если ЗначениеЗаполнено(ТипЦен) Тогда
		УсловиеЦен = ", ТипЦен = &ТипЦен";
		Запрос.УстановитьПараметр("ТипЦен", ТипЦен);
	КонецЕсли;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Остатки.Номенклатура КАК Номенклатура,
	|	СУММА(Остатки.КоличествоОстаток) КАК Остаток
	|ПОМЕСТИТЬ ВТ_Остатки
	|ИЗ
	|	РегистрНакопления.ОстаткиТоваров.Остатки(" + УсловиеОстатков + ") КАК Остатки
	|СГРУППИРОВАТЬ ПО
	|	Остатки.Номенклатура
	|;
	|ВЫБРАТЬ
	|	Цены.Номенклатура КАК Номенклатура,
	|	МАКСИМУМ(Цены.Цена) КАК Цена
	|ПОМЕСТИТЬ ВТ_Цены
	|ИЗ
	|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(" + УсловиеЦен + ") КАК Цены
	|СГРУППИРОВАТЬ ПО
	|	Цены.Номенклатура
	|;
	|ВЫБРАТЬ
	|	Товар.Ссылка КАК Номенклатура,
	|	Товар.Артикул КАК Артикул,
	|	Товар.Наименование КАК Наименование,
	|	Товар.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ЕСТЬNULL(Цены.Цена, 0) КАК Цена,
	|	ЕСТЬNULL(Остатки.Остаток, 0) КАК Остаток
	|ИЗ
	|	Справочник.Номенклатура КАК Товар
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Цены КАК Цены
	|		ПО Товар.Ссылка = Цены.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Остатки КАК Остатки
	|		ПО Товар.Ссылка = Остатки.Номенклатура
	|ГДЕ
	|	НЕ Товар.ЭтоГруппа
	|	И НЕ Товар.ПометкаУдаления
	|УПОРЯДОЧИТЬ ПО
	|	Товар.Наименование";
	
	// Получить все штрихкоды одним запросом (не в цикле!)
	СоответствиеШтрихкодов = ПолучитьВсеШтрихкоды();
	
	Результат = Запрос.ВыполнитьПакет();
	ВыборкаОсновная = Результат[2].Выбрать();
	
	Пока ВыборкаОсновная.Следующий() Цикл
		НоваяСтрока = Объект.Товары.Добавить();
		НоваяСтрока.Артикул = ВыборкаОсновная.Артикул;
		НоваяСтрока.Наименование = ВыборкаОсновная.Наименование;
		НоваяСтрока.ЕдиницаИзмерения = ВыборкаОсновная.ЕдиницаИзмерения;
		НоваяСтрока.Цена = ВыборкаОсновная.Цена;
		НоваяСтрока.Остаток = ВыборкаОсновная.Остаток;
		
		МассивШК = СоответствиеШтрихкодов[ВыборкаОсновная.Номенклатура];
		Если МассивШК <> Неопределено Тогда
			НоваяСтрока.ШтрихКод = СтрСоединить(МассивШК, "; ");
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьВсеШтрихкоды()
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Штрихкоды.Номенклатура КАК Номенклатура,
	|	Штрихкоды.Штрихкод КАК Штрихкод
	|ИЗ
	|	РегистрСведений.Штрихкоды КАК Штрихкоды
	|УПОРЯДОЧИТЬ ПО
	|	Штрихкоды.Номенклатура,
	|	Штрихкоды.Штрихкод";
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	СоответствиеШтрихкодов = Новый Соответствие;
	Пока Выборка.Следующий() Цикл
		Ключ = Выборка.Номенклатура;
		Если СоответствиеШтрихкодов[Ключ] = Неопределено Тогда
			СоответствиеШтрихкодов[Ключ] = Новый Массив;
		КонецЕсли;
		СоответствиеШтрихкодов[Ключ].Добавить(Выборка.Штрихкод);
	КонецЦикла;
	
	Возврат СоответствиеШтрихкодов;
	
КонецФункции

&НаСервере
Функция ПодготовитьПечатнуюФормуНаСервере()
	
	ТабДок = Новый ТабличныйДокумент;
	ТабДок.АвтоМасштаб = Истина;
	ТабДок.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	
	// === Заголовок ===
	ТабДок.Область(1, 1).Текст = "Информация номенклатуры";
	ТабДок.Область(1, 1).Шрифт = Новый Шрифт(, 14, Истина);
	
	// === Фильтры ===
	СтрокаФильтров = "Дата: " + Формат(ТекущаяДатаСеанса(), "ДЛФ=ДВ");
	Если ЗначениеЗаполнено(Склад) Тогда
		СтрокаФильтров = СтрокаФильтров + " | Склад: " + Строка(Склад);
	КонецЕсли;
	Если ЗначениеЗаполнено(ТипЦен) Тогда
		СтрокаФильтров = СтрокаФильтров + " | Тип цен: " + Строка(ТипЦен);
	КонецЕсли;
	ТабДок.Область(2, 1).Текст = СтрокаФильтров;
	ТабДок.Область(2, 1).Шрифт = Новый Шрифт(, 9);
	
	// === Ширина колонок ===
	ТабДок.Область(1, 1).ШиринаКолонки = 5;
	ТабДок.Область(1, 2).ШиринаКолонки = 12;
	ТабДок.Область(1, 3).ШиринаКолонки = 35;
	ТабДок.Область(1, 4).ШиринаКолонки = 8;
	ТабДок.Область(1, 5).ШиринаКолонки = 12;
	ТабДок.Область(1, 6).ШиринаКолонки = 12;
	ТабДок.Область(1, 7).ШиринаКолонки = 30;
	
	// === Шапка таблицы (строка 4) ===
	ШрифтШапки = Новый Шрифт(, 10, Истина);
	
	МассивЗаголовков = Новый Массив;
	МассивЗаголовков.Добавить("№");
	МассивЗаголовков.Добавить("Артикул");
	МассивЗаголовков.Добавить("Наименование");
	МассивЗаголовков.Добавить("Ед. изм.");
	МассивЗаголовков.Добавить("Цена");
	МассивЗаголовков.Добавить("Остаток");
	МассивЗаголовков.Добавить("Штрих-код");
	
	Для Индекс = 0 По МассивЗаголовков.ВГраница() Цикл
		Ячейка = ТабДок.Область(4, Индекс + 1);
		Ячейка.Текст = МассивЗаголовков[Индекс];
		Ячейка.Шрифт = ШрифтШапки;
		Ячейка.ГоризонтальноеПоложение = ГоризонтальноеПоложение.Центр;
		Ячейка.ЦветФона = Новый Цвет(220, 220, 220);
	КонецЦикла;
	
	// === Данные ===
	ШрифтДанных = Новый Шрифт(, 9);
	НомерСтроки = 0;
	
	Для Каждого СтрокаТовары Из Объект.Товары Цикл
		НомерСтроки = НомерСтроки + 1;
		ТекСтрока = 4 + НомерСтроки;
		
		ТабДок.Область(ТекСтрока, 1).Текст = Строка(НомерСтроки);
		ТабДок.Область(ТекСтрока, 2).Текст = СтрокаТовары.Артикул;
		ТабДок.Область(ТекСтрока, 3).Текст = СтрокаТовары.Наименование;
		ТабДок.Область(ТекСтрока, 4).Текст = Строка(СтрокаТовары.ЕдиницаИзмерения);
		ТабДок.Область(ТекСтрока, 5).Текст = Формат(СтрокаТовары.Цена, "ЧДЦ=2");
		ТабДок.Область(ТекСтрока, 6).Текст = Формат(СтрокаТовары.Остаток, "ЧДЦ=3");
		ТабДок.Область(ТекСтрока, 7).Текст = СтрокаТовары.ШтрихКод;
		
		Для Колонка = 1 По 7 Цикл
			ТабДок.Область(ТекСтрока, Колонка).Шрифт = ШрифтДанных;
		КонецЦикла;
	КонецЦикла;
	
	// === Итого ===
	Если НомерСтроки > 0 Тогда
		СтрокаИтого = 4 + НомерСтроки + 1;
		ТабДок.Область(СтрокаИтого, 1).Текст = "Итого позиций: " + Строка(НомерСтроки);
		ТабДок.Область(СтрокаИтого, 1).Шрифт = Новый Шрифт(, 10, Истина);
	КонецЕсли;
	
	АдресХранилища = ПоместитьВоВременноеХранилище(ТабДок, УникальныйИдентификатор);
	Возврат АдресХранилища;
	
КонецФункции

#КонецОбласти
