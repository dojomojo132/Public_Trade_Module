// ============================================================================
// ФОРМА ОБРАБОТКИ: Управление настройками
// Назначение: Удобный интерфейс для изменения настроек по умолчанию
// ============================================================================

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Загружаем текущие настройки из регистра
	ЗагрузитьНастройки();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Сохранить(Команда)
	
	СохранитьНастройкиНаСервере();
	Оповестить("ИзмененыНастройкиПоУмолчанию");
	ПоказатьПредупреждение(, "Настройки сохранены");
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗагрузитьНастройки()
	
	// Читаем настройки используя API
	ОсновнойСклад = НастройкиПоУмолчанию.ПолучитьОсновнойСклад();
	ОсновнойПоставщик = НастройкиПоУмолчанию.ПолучитьОсновногоПоставщика();
	ОсновнаяКасса = НастройкиПоУмолчанию.ПолучитьОсновнуюКассу();
	ОсновнойТипЦен = НастройкиПоУмолчанию.ПолучитьОсновнойТипЦен();
	ПорядокОкругленияЦен = НастройкиПоУмолчанию.ПолучитьПорядокОкругленияЦен();
	КонтролироватьОстаткиПриСписании = НастройкиПоУмолчанию.ПолучитьКонтрольОстатков();
	КоличествоКнопокВКолонке = НастройкиПоУмолчанию.ПолучитьКоличествоКнопокВКолонке();
	КоличествоКнопокВРяду = НастройкиПоУмолчанию.ПолучитьКоличествоКнопокВРяду();
	ШиринаКнопок = НастройкиПоУмолчанию.ПолучитьШиринуКнопок();
	ВысотаКнопок = НастройкиПоУмолчанию.ПолучитьВысотуКнопок();
	
	// Инициализируем недостающие настройки дефолтными значениями
	ЕстьПустыеНастройки = Ложь;
	ЕстьПустыеНастройки = ЕстьПустыеНастройки ИЛИ (ОсновнойСклад = Неопределено);
	ЕстьПустыеНастройки = ЕстьПустыеНастройки ИЛИ (ОсновнойПоставщик = Неопределено);
	ЕстьПустыеНастройки = ЕстьПустыеНастройки ИЛИ (ОсновнаяКасса = Неопределено);
	ЕстьПустыеНастройки = ЕстьПустыеНастройки ИЛИ (ОсновнойТипЦен = Неопределено);
	ЕстьПустыеНастройки = ЕстьПустыеНастройки ИЛИ (ПорядокОкругленияЦен = Неопределено);
	ЕстьПустыеНастройки = ЕстьПустыеНастройки ИЛИ (КонтролироватьОстаткиПриСписании = Неопределено);
	ЕстьПустыеНастройки = ЕстьПустыеНастройки ИЛИ (КоличествоКнопокВКолонке = Неопределено);
	ЕстьПустыеНастройки = ЕстьПустыеНастройки ИЛИ (КоличествоКнопокВРяду = Неопределено);
	ЕстьПустыеНастройки = ЕстьПустыеНастройки ИЛИ (ШиринаКнопок = Неопределено);
	ЕстьПустыеНастройки = ЕстьПустыеНастройки ИЛИ (ВысотаКнопок = Неопределено);
	
	Если ЕстьПустыеНастройки Тогда
		ИнициализироватьЗначенияПоУмолчанию();
		// Автоматически сохраняем дефолтные значения в БД
		СохранитьНастройкиНаСервере();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура СохранитьНастройкиНаСервере()
	
	// Сохраняем каждую настройку через API
	НастройкиПоУмолчанию.УстановитьЗначениеНастройки(Справочники.НастройкиПоУмолчанию.ОсновнойСклад, ОсновнойСклад);
	НастройкиПоУмолчанию.УстановитьЗначениеНастройки(Справочники.НастройкиПоУмолчанию.ОсновнойПоставщик, ОсновнойПоставщик);
	НастройкиПоУмолчанию.УстановитьЗначениеНастройки(Справочники.НастройкиПоУмолчанию.ОсновнаяКасса, ОсновнаяКасса);
	НастройкиПоУмолчанию.УстановитьЗначениеНастройки(Справочники.НастройкиПоУмолчанию.ОсновнойТипЦен, ОсновнойТипЦен);
	НастройкиПоУмолчанию.УстановитьЗначениеНастройки(Справочники.НастройкиПоУмолчанию.ПорядокОкругленияЦен, ПорядокОкругленияЦен);
	НастройкиПоУмолчанию.УстановитьЗначениеНастройки(Справочники.НастройкиПоУмолчанию.КонтролироватьОстаткиПриСписании, КонтролироватьОстаткиПриСписании);
	НастройкиПоУмолчанию.УстановитьЗначениеНастройки(Справочники.НастройкиПоУмолчанию.КоличествоКнопокВКолонке, КоличествоКнопокВКолонке);
	НастройкиПоУмолчанию.УстановитьЗначениеНастройки(Справочники.НастройкиПоУмолчанию.КоличествоКнопокВРяду, КоличествоКнопокВРяду);
	НастройкиПоУмолчанию.УстановитьЗначениеНастройки(Справочники.НастройкиПоУмолчанию.ШиринаКнопок, ШиринаКнопок);
	НастройкиПоУмолчанию.УстановитьЗначениеНастройки(Справочники.НастройкиПоУмолчанию.ВысотаКнопок, ВысотаКнопок);
	
КонецПроцедуры

&НаСервере
Процедура ИнициализироватьЗначенияПоУмолчанию()
	
	// Инициализируем только те настройки, которые не заполнены
	
	Запрос = Новый Запрос;
	
	// Основной склад - берём первый из справочника, если не задан
	Если ОсновнойСклад = Неопределено Тогда
		Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка ИЗ Справочник.Склады";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Выборка.Следующий();
			ОсновнойСклад = Выборка.Ссылка;
		КонецЕсли;
	КонецЕсли;
	
	// Основной поставщик
	Если ОсновнойПоставщик = Неопределено Тогда
		Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка ИЗ Справочник.Контрагенты";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Выборка.Следующий();
			ОсновнойПоставщик = Выборка.Ссылка;
		КонецЕсли;
	КонецЕсли;
	
	// Основная касса
	Если ОсновнаяКасса = Неопределено Тогда
		Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка ИЗ Справочник.Кассы";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Выборка.Следующий();
			ОсновнаяКасса = Выборка.Ссылка;
		КонецЕсли;
	КонецЕсли;
	
	// Основной тип цен
	Если ОсновнойТипЦен = Неопределено Тогда
		Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка ИЗ Справочник.ТипыЦен";
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Выборка.Следующий();
			ОсновнойТипЦен = Выборка.Ссылка;
		КонецЕсли;
	КонецЕсли;
	
	// Порядок округления - по умолчанию до копеек
	Если ПорядокОкругленияЦен = Неопределено Тогда
		ПорядокОкругленияЦен = Перечисления.ПорядкиОкругленияЦен.ДоКопеек;
	КонецЕсли;
	
	// Контроль остатков - по умолчанию включен
	Если КонтролироватьОстаткиПриСписании = Неопределено Тогда
		КонтролироватьОстаткиПриСписании = Истина;
	КонецЕсли;
	
	// Количество кнопок в колонке - по умолчанию 4
	Если КоличествоКнопокВКолонке = Неопределено Тогда
		КоличествоКнопокВКолонке = 4;
	КонецЕсли;
	
	// Количество кнопок в ряду - по умолчанию 3
	Если КоличествоКнопокВРяду = Неопределено Тогда
		КоличествоКнопокВРяду = 3;
	КонецЕсли;
	
	// Ширина кнопок - по умолчанию 100 пиксели
	Если ШиринаКнопок = Неопределено Тогда
		ШиринаКнопок = 100;
	КонецЕсли;
	
	// Высота кнопок - по умолчанию 80 пиксели
	Если ВысотаКнопок = Неопределено Тогда
		ВысотаКнопок = 80;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
