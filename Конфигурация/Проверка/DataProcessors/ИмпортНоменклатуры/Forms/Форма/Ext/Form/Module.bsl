#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Инициализация формы
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Асинх Процедура ВыбратьФайл(Команда)
	
	// Диалог выбора файла
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.Заголовок = "Выберите файл Excel";
	Диалог.МножественныйВыбор = Ложь;
	Диалог.Фильтр = "Файлы Excel (*.xlsx;*.xls)|*.xlsx;*.xls";
	
	Результат = Ждать Диалог.ВыбратьАсинх();
	
	Если Результат <> Неопределено И Результат.Количество() > 0 Тогда
		ПутьКФайлу = Результат[0];
		Объект.ПутьКФайлу = ПутьКФайлу;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Асинх Процедура ЗагрузитьДанные(Команда)
	
	Если ПустаяСтрока(Объект.ПутьКФайлу) Тогда
		ПоказатьОповещениеПользователя("Ошибка", , "Не указан файл для загрузки");
		Возврат;
	КонецЕсли;
	
	// Помещаем файл во временное хранилище
	АдресХранилища = "";
	
	Попытка
		РезультатПомещения = Ждать ПоместитьФайлНаСерверАсинх(, , , Объект.ПутьКФайлу, УникальныйИдентификатор);
		Если РезультатПомещения <> Неопределено Тогда
			АдресХранилища = РезультатПомещения.Адрес;
		КонецЕсли;
	Исключение
		ПоказатьОповещениеПользователя("Ошибка", , "Ошибка при загрузке файла: " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	Если ПустаяСтрока(АдресХранилища) Тогда
		ПоказатьОповещениеПользователя("Ошибка", , "Не удалось поместить файл в хранилище");
		Возврат;
	КонецЕсли;
	
	// Загружаем данные на сервере
	Успешно = ЗагрузитьДанныеНаСервере(АдресХранилища);
	
	Если Успешно Тогда
		ПоказатьОповещениеПользователя("Данные загружены", , "Данные из файла успешно загружены. Проверьте и выполните импорт.");
	Иначе
		ПоказатьОповещениеПользователя("Ошибка", , "Ошибка при загрузке данных из файла");
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Асинх Процедура ВыполнитьИмпорт(Команда)
	
	// Проверка заполнения
	Если ПустаяСтрока(Объект.ПутьКФайлу) Тогда
		ПоказатьОповещениеПользователя("Ошибка", , "Не указан файл для загрузки");
		Возврат;
	КонецЕсли;
	
	Если ДанныеИзФайла.Количество() = 0 Тогда
		ПоказатьОповещениеПользователя("Ошибка", , "Сначала загрузите данные из файла");
		Возврат;
	КонецЕсли;
	
	// Помещаем файл во временное хранилище
	АдресХранилища = "";
	
	Попытка
		РезультатПомещения = Ждать ПоместитьФайлНаСерверАсинх(, , , Объект.ПутьКФайлу, УникальныйИдентификатор);
		Если РезультатПомещения <> Неопределено Тогда
			АдресХранилища = РезультатПомещения.Адрес;
		КонецЕсли;
	Исключение
		ПоказатьОповещениеПользователя("Ошибка", , "Ошибка при загрузке файла: " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	Если ПустаяСтрока(АдресХранилища) Тогда
		ПоказатьОповещениеПользователя("Ошибка", , "Не удалось поместить файл в хранилище");
		Возврат;
	КонецЕсли;
	
	// Выполняем импорт на сервере
	Результат = ВыполнитьИмпортНаСервере(АдресХранилища);
	
	Если Результат.Успешно Тогда
		ТекстСообщения = СтрШаблон("Импорт успешно выполнен. Загружено элементов: %1", Результат.КоличествоЗагружено);
		ПоказатьОповещениеПользователя("Импорт", , ТекстСообщения);
	Иначе
		ТекстСообщения = "Ошибка при импорте: " + Результат.СообщениеОбОшибке;
		ПоказатьОповещениеПользователя("Ошибка", , ТекстСообщения);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Функция ЗагрузитьДанныеНаСервере(АдресХранилища)
	
	ОбъектОбработки = РеквизитФормыВЗначение("Объект");
	ТаблицаДанных = ОбъектОбработки.ЗагрузитьДанныеИзФайла(АдресХранилища);
	
	Если ТаблицаДанных <> Неопределено Тогда
		ДанныеИзФайла.Очистить();
		Для Каждого СтрокаТЧ Из ТаблицаДанных Цикл
			НоваяСтрока = ДанныеИзФайла.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТЧ);
		КонецЦикла;
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

&НаСервере
Функция ВыполнитьИмпортНаСервере(АдресХранилища)
	
	ОбъектОбработки = РеквизитФормыВЗначение("Объект");
	Результат = ОбъектОбработки.ВыполнитьИмпорт(АдресХранилища);
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти
