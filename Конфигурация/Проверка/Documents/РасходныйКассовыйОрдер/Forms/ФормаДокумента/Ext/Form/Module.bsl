
#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ВыбратьЗадолженность(Команда)
	
	// Получаем список задолженностей с сервера
	СписокЗадолженностей = ПолучитьСписокЗадолженностей();
	
	Если СписокЗадолженностей.Количество() = 0 Тогда
		ПоказатьПредупреждение(, "Нет неоплаченных задолженностей перед контрагентами.");
		Возврат;
	КонецЕсли;
	
	// Формируем список значений для выбора
	СписокВыбора = Новый СписокЗначений;
	Для Каждого Строка Из СписокЗадолженностей Цикл
		ЧастьНомера = ?(ЗначениеЗаполнено(Строка.ВходящийНомер), " №" + Строка.ВходящийНомер, "");
		
		Если Строка.СуммаОплат > 0 Тогда
			ЧастьОплаты = " (оплачено: " + Формат(Строка.СуммаОплат, "ЧДЦ=2") + " из " + Формат(Строка.СуммаПрихода, "ЧДЦ=2") + ")";
		Иначе
			ЧастьОплаты = "";
		КонецЕсли;
		
		Представление = Формат(Строка.Дата, "ДФ=dd.MM.yyyy") + " | " + Строка.Контрагент + ЧастьНомера
			+ " | " + Формат(Строка.Сумма, "ЧДЦ=2") + " грн." + ЧастьОплаты;
		СписокВыбора.Добавить(Строка, Представление);
	КонецЦикла;
	
	// Показываем асинхронный выбор
	ОбработкаВыбора = Новый ОписаниеОповещения("ВыбратьЗадолженностьЗавершение", ЭтотОбъект);
	СписокВыбора.ПоказатьВыборЭлемента(ОбработкаВыбора, "Выберите задолженность для погашения");
	
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьЗадолженностьЗавершение(ВыбранныйЭлемент, ДополнительныеПараметры) Экспорт
	
	Если ВыбранныйЭлемент = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ДанныеЗадолженности = ВыбранныйЭлемент.Значение;
	
	Объект.Контрагент = ДанныеЗадолженности.Контрагент;
	Объект.СуммаДокумента = ДанныеЗадолженности.Сумма;
	Объект.ДокументОснование = ДанныеЗадолженности.Документ;
	
	Модифицированность = Истина;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервереБезКонтекста
Функция ПолучитьСписокЗадолженностей()
	
	// Запрос: неоплаченные приходные накладные
	// Остаток долга = СуммаДокумента ПриходТовара - оплаченное через РКО
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПриходТовара.Ссылка КАК Документ,
	|	ПриходТовара.Дата КАК ДатаДокумента,
	|	ПриходТовара.ВходящийНомер КАК ВходящийНомер,
	|	ПриходТовара.Контрагент КАК Контрагент,
	|	ПриходТовара.СуммаДокумента КАК СуммаПрихода,
	|	ЕСТЬNULL(Оплаты.СуммаОплат, 0) КАК СуммаОплат,
	|	ПриходТовара.СуммаДокумента - ЕСТЬNULL(Оплаты.СуммаОплат, 0) КАК ОстатокДолга
	|ИЗ
	|	Документ.ПриходТовара КАК ПриходТовара
	|		ЛЕВОЕ СОЕДИНЕНИЕ (
	|			ВЫБРАТЬ
	|				РКО.ДокументОснование КАК ДокументОснование,
	|				СУММА(РКО.СуммаДокумента) КАК СуммаОплат
	|			ИЗ
	|				Документ.РасходныйКассовыйОрдер КАК РКО
	|			ГДЕ
	|				РКО.Проведен = ИСТИНА
	|				И РКО.ДокументОснование <> ЗНАЧЕНИЕ(Документ.ПриходТовара.ПустаяСсылка)
	|			СГРУППИРОВАТЬ ПО
	|				РКО.ДокументОснование
	|		) КАК Оплаты
	|		ПО ПриходТовара.Ссылка = Оплаты.ДокументОснование
	|ГДЕ
	|	ПриходТовара.Проведен = ИСТИНА
	|	И ПриходТовара.СуммаДокумента - ЕСТЬNULL(Оплаты.СуммаОплат, 0) > 0
	|УПОРЯДОЧИТЬ ПО
	|	ПриходТовара.Дата";
	
	Результат = Запрос.Выполнить().Выгрузить();
	
	МассивЗадолженностей = Новый Массив;
	Для Каждого Строка Из Результат Цикл
		ДанныеСтроки = Новый Структура("Контрагент, Сумма, Документ, Дата, ВходящийНомер, СуммаПрихода, СуммаОплат");
		ДанныеСтроки.Контрагент = Строка.Контрагент;
		ДанныеСтроки.Сумма = Строка.ОстатокДолга;
		ДанныеСтроки.Документ = Строка.Документ;
		ДанныеСтроки.Дата = Строка.ДатаДокумента;
		ДанныеСтроки.ВходящийНомер = Строка.ВходящийНомер;
		ДанныеСтроки.СуммаПрихода = Строка.СуммаПрихода;
		ДанныеСтроки.СуммаОплат = Строка.СуммаОплат;
		МассивЗадолженностей.Добавить(ДанныеСтроки);
	КонецЦикла;
	
	Возврат МассивЗадолженностей;
	
КонецФункции

#КонецОбласти

