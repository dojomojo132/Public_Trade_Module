&НаКлиенте
Процедура ТоварыНоменклатураПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// 1. Получаем данные товара с сервера (Наценка)
	ДанныеТовара = ПолучитьДанныеНоменклатуры(ТекущиеДанные.Номенклатура);
	
	// 2. Рассчитываем цену, если есть цена закупки
	Если ТекущиеДанные.Цена > 0 Тогда
		РассчитатьРозничнуюЦену(ТекущиеДанные, ДанныеТовара.ПроцентНаценки);
	КонецЕсли;
	
	// 3. Заполняем текущую розничную для сравнения
	ТекущиеДанные.ЦенаРозничнаяТекущая = ДанныеТовара.ЦенаТекущая;
	
КонецПроцедуры

&НаКлиенте
Асинх Процедура ТоварыШтрихкодПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Проверка на пустой штрихкод
	Если ПустаяСтрока(ТекущиеДанные.Штрихкод) Тогда
		Возврат;
	КонецЕсли;
	
	// Поиск номенклатуры по штрихкоду
	НайденнаяНоменклатура = НайтиНоменклатуруПоШтрихкоду(ТекущиеДанные.Штрихкод);
	
	Если НайденнаяНоменклатура = Неопределено Тогда
		
		// Товар не найден - показываем предупреждение
		Ждать ПредупреждениеАсинх("Товар с штрихкодом """ + ТекущиеДанные.Штрихкод + """ не найден!");
		ТекущиеДанные.Штрихкод = "";
		Возврат;
		
	КонецЕсли;
	
	// Заполняем номенклатуру
	ТекущиеДанные.Номенклатура = НайденнаяНоменклатура;
	
	// Получаем данные товара
	ДанныеТовара = ПолучитьДанныеНоменклатуры(НайденнаяНоменклатура);
	
	// Рассчитываем розничную цену, если есть закупочная
	Если ТекущиеДанные.Цена > 0 Тогда
		РассчитатьРозничнуюЦену(ТекущиеДанные, ДанныеТовара.ПроцентНаценки);
	КонецЕсли;
	
	// Заполняем текущую розничную для сравнения
	ТекущиеДанные.ЦенаРозничнаяТекущая = ДанныеТовара.ЦенаТекущая;
	
	// Устанавливаем фокус на поле "Количество"
	//Элементы.Товары.ТекущийЭлемент = Элементы.ТоварыКоличество;	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Пересчитываем сумму строки (стандартная логика)
	ТекущиеДанные.Сумма = ТекущиеДанные.Цена * ТекущиеДанные.Количество;
	
	// 1. Получаем % наценки (чтобы не дергать сервер лишний раз, можно кэшировать, но пока так)
	ДанныеТовара = ПолучитьДанныеНоменклатуры(ТекущиеДанные.Номенклатура);
	
	// 2. Рассчитываем новую розницу
	РассчитатьРозничнуюЦену(ТекущиеДанные, ДанныеТовара.ПроцентНаценки);
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьРозничнуюЦену(СтрокаТЧ, ПроцентНаценки)
	
	Если ПроцентНаценки = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// Формула: Закупка * (1 + % / 100)
	РасчетнаяЦена = СтрокаТЧ.Цена * (1 + ПроцентНаценки / 100);
	
	// Округление (получаем метод округления с сервера один раз при открытии или каждый раз)
	// Для оптимизации вызовем серверную функцию без контекста
	Порядок = ПолучитьПорядокОкругления();
	
	СтрокаТЧ.ЦенаРозничнаяНовая = ОкруглитьЦену(РасчетнаяЦена, Порядок);
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция НайтиНоменклатуруПоШтрихкоду(Штрихкод)
	
	// Поиск в регистре Штрихкоды
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Штрихкоды.Номенклатура КАК Номенклатура
	|ИЗ
	|	РегистрСведений.Штрихкоды КАК Штрихкоды
	|ГДЕ
	|	Штрихкоды.Штрихкод = &Штрихкод";
	
	Запрос.УстановитьПараметр("Штрихкод", Штрихкод);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Возврат Выборка.Номенклатура;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьДанныеНоменклатуры(НоменклатураСсылка)
	
	Результ = Новый Структура("ПроцентНаценки, ЦенаТекущая");
	Результ.ПроцентНаценки = 0;
	Результ.ЦенаТекущая = 0;
	
	Если НоменклатураСсылка.Пустая() Тогда
		Возврат Результ;
	КонецЕсли;
	
	// Читаем наценку из справочника
	Результ.ПроцентНаценки = НоменклатураСсылка.ПроцентНаценки;
	
	// Читаем текущую цену из регистра сведений
	Отбор = Новый Структура("Номенклатура", НоменклатураСсылка);
	Цены = РегистрыСведений.ЦеныНоменклатуры.ПолучитьПоследнее(ТекущаяДата(), Отбор);
	Результ.ЦенаТекущая = Цены.Цена;
	
	Возврат Результ;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьПорядокОкругления()
	// Читаем константу
	Возврат НастройкиПоУмолчанию.ПолучитьПорядокОкругленияЦен();
КонецФункции

&НаКлиенте
Функция ОкруглитьЦену(Цена, Порядок)
	
	Если Порядок = ПредопределенноеЗначение("Перечисление.ПорядкиОкругленияЦен.Окр001") Тогда
		Возврат Окр(Цена, 2);
	ИначеЕсли Порядок = ПредопределенноеЗначение("Перечисление.ПорядкиОкругленияЦен.Окр010") Тогда
		Возврат Окр(Цена / 0.1, 0, РежимОкругления.Окр15как20) * 0.1;
	ИначеЕсли Порядок = ПредопределенноеЗначение("Перечисление.ПорядкиОкругленияЦен.Окр050") Тогда
		Возврат Окр(Цена / 0.5, 0, РежимОкругления.Окр15как20) * 0.5;
	ИначеЕсли Порядок = ПредопределенноеЗначение("Перечисление.ПорядкиОкругленияЦен.Окр100") Тогда
		Возврат Окр(Цена, 0, РежимОкругления.Окр15как20);
	ИначеЕсли Порядок = ПредопределенноеЗначение("Перечисление.ПорядкиОкругленияЦен.ОкрВБольшую") Тогда
		Возврат Цел(Цена) + ?(Цена = Цел(Цена), 0, 1);
	КонецЕсли;
	
	Возврат Цена;
	
КонецФункции


