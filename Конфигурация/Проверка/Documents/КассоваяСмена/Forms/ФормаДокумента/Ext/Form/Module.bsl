
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Если это новый документ, устанавливаем статус "Открыта" по умолчанию
	Если Объект.Ссылка.Пустая() Тогда
		Объект.Статус = Перечисления.СтатусыКассовойСмены.Открыта;
		Объект.ДатаНачала = ТекущаяДатаСеанса();
	КонецЕсли;
	
	УправлениеЭлементамиФормы();
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	УправлениеЭлементамиФормы();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКоманд

&НаКлиенте
Процедура ЗакрытьСменуКоманда(Команда)
	
	Если Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусыКассовойСмены.Закрыта") Тогда
		ПоказатьПредупреждение(, "Смена уже закрыта!");
		Возврат;
	КонецЕсли;
	
	Если Модифицированность Тогда
		ТекстВопроса = "Перед закрытием смены необходимо записать документ. Записать?";
		Оповещение = Новый ОписаниеОповещения("ПослеОтветаНаВопросЗаписи", ЭтотОбъект);
		ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
		Возврат;
	КонецЕсли;
	
	ТекстВопроса = "Закрыть смену? Это действие нельзя отменить.";
	Оповещение = Новый ОписаниеОповещения("ПослеОтветаНаВопросЗакрытия", ЭтотОбъект);
	ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеОтветаНаВопросЗаписи(Результат, ДопПараметры) Экспорт
	
	Если Результат = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	Записать();
	
	// После записи задаем вопрос о закрытии
	ТекстВопроса = "Закрыть смену? Это действие нельзя отменить.";
	Оповещение = Новый ОписаниеОповещения("ПослеОтветаНаВопросЗакрытия", ЭтотОбъект);
	ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеОтветаНаВопросЗакрытия(Результат, ДопПараметры) Экспорт
	
	Если Результат = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	ЗакрытьСменуНаСервере();
	УправлениеЭлементамиФормы();
	
	ПоказатьОповещениеПользователя("Смена закрыта", , "Кассовая смена успешно закрыта");
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗакрытьСменуНаСервере()
	
	ДокументОбъект = РеквизитФормыВЗначение("Объект");
	
	Попытка
		ДокументОбъект.ЗакрытьСмену();
		ЗначениеВРеквизитФормы(ДокументОбъект, "Объект");
		Модифицированность = Ложь;
	Исключение
		ВызватьИсключение СтрШаблон("Ошибка при закрытии смены: %1", ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

&НаСервере
Процедура УправлениеЭлементамиФормы()
	
	СменаЗакрыта = (Объект.Статус = Перечисления.СтатусыКассовойСмены.Закрыта);
	
	// Если смена закрыта, блокируем редактирование
	Элементы.ДатаНачала.ТолькоПросмотр = СменаЗакрыта;
	Элементы.ЧекиККМ.ТолькоПросмотр = СменаЗакрыта;
	Элементы.ФискальныеЧеки.ТолькоПросмотр = СменаЗакрыта;
	
	// Кнопка "Закрыть смену" доступна только для открытых смен
	Элементы.ФормаЗакрытьСмену.Доступность = НЕ СменаЗакрыта;
	
КонецПроцедуры

#КонецОбласти
