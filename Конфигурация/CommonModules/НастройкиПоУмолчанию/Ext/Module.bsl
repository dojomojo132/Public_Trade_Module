// ============================================================================
// ОБЩИЙ МОДУЛЬ: НастройкиПоУмолчанию (Серверный)
// Назначение: API для чтения/записи настроек в формате Key-Value (JSON)
// ============================================================================

#Область ПрограммныйИнтерфейс

// Возвращает значение настройки "Основной склад"
//
// Возвращаемое значение:
//   СправочникСсылка.Склады - Ссылка на основной склад
//
Функция ПолучитьОсновнойСклад() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ОсновнойСклад;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Основной поставщик"
//
// Возвращаемое значение:
//   СправочникСсылка.Контрагенты - Ссылка на основного поставщика
//
Функция ПолучитьОсновногоПоставщика() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ОсновнойПоставщик;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Основная касса"
//
// Возвращаемое значение:
//   СправочникСсылка.Кассы - Ссылка на основную кассу
//
Функция ПолучитьОсновнуюКассу() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ОсновнаяКасса;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Основной тип цен"
//
// Возвращаемое значение:
//   СправочникСсылка.ТипыЦен - Ссылка на основной тип цен
//
Функция ПолучитьОсновнойТипЦен() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ОсновнойТипЦен;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Порядок округления цен"
//
// Возвращаемое значение:
//   ПеречислениеСсылка.ПорядкиОкругленияЦен - Порядок округления
//
Функция ПолучитьПорядокОкругленияЦен() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ПорядокОкругленияЦен;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Контролировать остатки при списании"
//
// Возвращаемое значение:
//   Булево - Истина если контроль включен
//
Функция ПолучитьКонтрольОстатков() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.КонтролироватьОстаткиПриСписании;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Количество кнопок в колонке"
//
// Возвращаемое значение:
//   Число - Количество кнопок
//
Функция ПолучитьКоличествоКнопокВКолонке() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.КоличествоКнопокВКолонке;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Количество кнопок в ряду"
//
// Возвращаемое значение:
//   Число - Количество кнопок
//
Функция ПолучитьКоличествоКнопокВРяду() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.КоличествоКнопокВРяду;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Ширина кнопок"
//
// Возвращаемое значение:
//   Число - Ширина кнопок в пиксели
//
Функция ПолучитьШиринуКнопок() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ШиринаКнопок;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает значение настройки "Высота кнопок"
//
// Возвращаемое значение:
//   Число - Высота кнопок в пиксели
//
Функция ПолучитьВысотуКнопок() Экспорт
	
	ИмяНастройки = Справочники.НастройкиПоУмолчанию.ВысотаКнопок;
	Возврат ПолучитьЗначениеНастройки(ИмяНастройки);
	
КонецФункции

// Возвращает структуру со всеми настройками
//
// Возвращаемое значение:
//   Структура - Все настройки по умолчанию
//
Функция ПолучитьВсеНастройки() Экспорт
	
	Настройки = Новый Структура;
	Настройки.Вставить("ОсновнойСклад", ПолучитьОсновнойСклад());
	Настройки.Вставить("ОсновнойПоставщик", ПолучитьОсновногоПоставщика());
	Настройки.Вставить("ОсновнаяКасса", ПолучитьОсновнуюКассу());
	Настройки.Вставить("ОсновнойТипЦен", ПолучитьОсновнойТипЦен());
	Настройки.Вставить("ПорядокОкругленияЦен", ПолучитьПорядокОкругленияЦен());
	Настройки.Вставить("КонтролироватьОстаткиПриСписании", ПолучитьКонтрольОстатков());
	Настройки.Вставить("КоличествоКнопокВКолонке", ПолучитьКоличествоКнопокВКолонке());
	Настройки.Вставить("КоличествоКнопокВРяду", ПолучитьКоличествоКнопокВРяду());
	Настройки.Вставить("ШиринаКнопок", ПолучитьШиринуКнопок());
	Настройки.Вставить("ВысотаКнопок", ПолучитьВысотуКнопок());
	
	Возврат Настройки;
	
КонецФункции

// Устанавливает значение настройки
//
// Параметры:
//   ИмяНастройки - Строка - Имя настройки
//   Значение - Произвольный - Значение настройки
//
Процедура УстановитьЗначениеНастройки(ИмяНастройки, Значение) Экспорт
	
	Менеджер = РегистрыСведений.НастройкиПоУмолчанию.СоздатьМенеджерЗаписи();
	Менеджер.ИмяНастройки = ИмяНастройки;
	
	// Сериализуем значение в строку используя внутреннее представление
	Менеджер.Значение = Значение;
	
	Менеджер.Записать();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Внутренняя функция для чтения значения из регистра
//
// Параметры:
//   ИмяНастройки - Строка - Имя настройки
//
// Возвращаемое значение:
//   Произвольный - Значение настройки или Неопределено
//
Функция ПолучитьЗначениеНастройки(ИмяНастройки)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	НастройкиПоУмолчанию.Значение КАК Значение
	|ИЗ
	|	РегистрСведений.НастройкиПоУмолчанию КАК НастройкиПоУмолчанию
	|ГДЕ
	|	НастройкиПоУмолчанию.ИмяНастройки = &ИмяНастройки";
	
	Запрос.УстановитьПараметр("ИмяНастройки", ИмяНастройки);
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	// Десериализуем из внутреннего представления
	Если ПустаяСтрока(Выборка.Значение) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Попытка
		Возврат Выборка.Значение;
	Исключение
		// Если строка некорректна, возвращаем Неопределено
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

#КонецОбласти
