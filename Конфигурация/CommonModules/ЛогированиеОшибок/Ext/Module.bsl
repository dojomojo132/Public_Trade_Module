////////////////////////////////////////////////////////////////////////////////
// Общий модуль ЛогированиеОшибок (Серверный, ВызовСервера)
// Централизованное логирование ошибок в Журнал регистрации (ЖР).
//
// НАЗНАЧЕНИЕ:
//   Решает проблему потерянных ошибок - когда исключения обрабатываются
//   через Попытка/Исключение + Сообщить(), но НЕ попадают в ЖР и ТЖ.
//   Этот модуль гарантирует запись КАЖДОЙ ошибки в ЖР для последующего
//   анализа через monitor-errors.ps1.
//
// ИСПОЛЬЗОВАНИЕ:
//   Попытка
//       // код
//   Исключение
//       ЛогированиеОшибок.ЗаписатьОшибку(ОписаниеОшибки(), "ИмяМодуля.ИмяМетода");
//   КонецПопытки;
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Записывает ошибку в Журнал регистрации и выводит сообщение пользователю.
// Основной метод - использовать ВМЕСТО Сообщить(ОписаниеОшибки()).
//
// Параметры:
//   ТекстОшибки          - Строка - текст ошибки (обычно ОписаниеОшибки())
//   ИмяМодуля            - Строка - откуда вызвано
//   ПоказатьПользователю - Булево - показывать ли сообщение пользователю
//   Комментарий          - Строка - дополнительный контекст
//
Процедура ЗаписатьОшибку(ТекстОшибки, ИмяМодуля = "", ПоказатьПользователю = Истина, Комментарий = "") Экспорт
	
	ПолныйТекст = СформироватьТекстОшибки(ТекстОшибки, ИмяМодуля, Комментарий);
	
	// Запись в Журнал регистрации
	ЗаписьЖурналаРегистрации(
		"PTM.Ошибка",
		УровеньЖурналаРегистрации.Ошибка,
		,
		,
		ПолныйТекст);
	
	// Показать пользователю (как было раньше через Сообщить)
	Если ПоказатьПользователю Тогда
		Сообщить(ТекстОшибки);
	КонецЕсли;
	
КонецПроцедуры

// Записывает ошибку с привязкой к конкретному объекту метаданных.
// Используется в модулях объектов (документы, справочники).
//
// Параметры:
//   ТекстОшибки      - Строка - текст ошибки
//   ОбъектМетаданных - ОбъектМетаданных - метаданные объекта
//   ДанныеОбъекта    - Произвольный - ссылка на объект
//   ИмяМодуля        - Строка - имя метода/контекста
//
Процедура ЗаписатьОшибкуОбъекта(ТекстОшибки, ОбъектМетаданных, ДанныеОбъекта = Неопределено, ИмяМодуля = "") Экспорт
	
	ПолныйТекст = СформироватьТекстОшибки(ТекстОшибки, ИмяМодуля, "");
	
	ЗаписьЖурналаРегистрации(
		"PTM.Ошибка",
		УровеньЖурналаРегистрации.Ошибка,
		ОбъектМетаданных,
		ДанныеОбъекта,
		ПолныйТекст);
	
	Сообщить(ТекстОшибки);
	
КонецПроцедуры

// Записывает предупреждение в Журнал регистрации.
// Используется для нефатальных проблем, которые нужно отслеживать.
//
// Параметры:
//   ТекстПредупреждения - Строка - текст предупреждения
//   ИмяМодуля           - Строка - откуда вызвано
//
Процедура ЗаписатьПредупреждение(ТекстПредупреждения, ИмяМодуля = "") Экспорт
	
	ПолныйТекст = СформироватьТекстОшибки(ТекстПредупреждения, ИмяМодуля, "");
	
	ЗаписьЖурналаРегистрации(
		"PTM.Предупреждение",
		УровеньЖурналаРегистрации.Предупреждение,
		,
		,
		ПолныйТекст);
	
КонецПроцедуры

// Записывает информационное сообщение в Журнал регистрации.
// Используется для трассировки важных операций при отладке.
//
// Параметры:
//   ТекстСообщения - Строка - информационный текст
//   ИмяМодуля      - Строка - откуда вызвано
//
Процедура ЗаписатьИнформацию(ТекстСообщения, ИмяМодуля = "") Экспорт
	
	ПолныйТекст = СформироватьТекстОшибки(ТекстСообщения, ИмяМодуля, "");
	
	ЗаписьЖурналаРегистрации(
		"PTM.Информация",
		УровеньЖурналаРегистрации.Информация,
		,
		,
		ПолныйТекст);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Формирует полный текст ошибки с контекстом.
//
// Параметры:
//   ТекстОшибки - Строка - исходный текст ошибки
//   ИмяМодуля   - Строка - имя модуля-источника
//   Комментарий - Строка - дополнительный контекст
//
// Возвращаемое значение:
//   Строка - форматированный текст ошибки
//
Функция СформироватьТекстОшибки(ТекстОшибки, ИмяМодуля, Комментарий)
	
	Части = Новый Массив;
	
	Если ЗначениеЗаполнено(ИмяМодуля) Тогда
		Части.Добавить("[" + ИмяМодуля + "]");
	КонецЕсли;
	
	Части.Добавить(ТекстОшибки);
	
	Если ЗначениеЗаполнено(Комментарий) Тогда
		Части.Добавить("Контекст: " + Комментарий);
	КонецЕсли;
	
	Возврат СтрСоединить(Части, " | ");
	
КонецФункции

#КонецОбласти
