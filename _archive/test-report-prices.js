/**
 * Тестовый отчет: Получение текущих цен товаров
 * Демонстрация работы PowerShell обёрток для 1С
 */

const COM1CWrapper = require('./mcp-config/1c-com-wrapper');
const path = require('path');

class ОтчетЦеныТоваров {
  constructor() {
    this.com = new COM1CWrapper();
    this.подключен = false;
  }

  /**
   * Подключиться к базе
   */
  подключиться(infobase, user, password = '') {
    console.log('📡 Подключение к базе данных...');
    
    const success = this.com.init({
      infobase,
      user,
      password
    });

    if (success) {
      this.подключен = true;
      console.log('✅ Подключение установлено\n');
      return true;
    } else {
      console.error('❌ Ошибка подключения\n');
      return false;
    }
  }

  /**
   * Получить текущие цены всех товаров
   */
  получитьЦеныТоваров() {
    if (!this.подключен) {
      console.error('❌ Нет подключения к базе');
      return null;
    }

    console.log('📊 Выполнение запроса: Цены номенклатуры\n');

    const запрос = `
      // Получаем актуальные цены товаров
      Запрос = Новый Запрос;
      Запрос.Текст = "
        |ВЫБРАТЬ
        |    РегистрСведений.ЦеныНоменклатуры.Номенклатура КАК Номенклатура,
        |    РегистрСведений.ЦеныНоменклатуры.Номенклатура.Наименование КАК Наименование,
        |    РегистрСведений.ЦеныНоменклатуры.ТипЦен КАК ТипЦен,
        |    РегистрСведений.ЦеныНоменклатуры.ТипЦен.Наименование КАК ТипЦенНаименование,
        |    РегистрСведений.ЦеныНоменклатуры.Цена КАК Цена,
        |    РегистрСведений.ЦеныНоменклатуры.Период КАК Период
        |ИЗ
        |    РегистрСведений.ЦеныНоменклатуры КАК ЦеныНоменклатуры
        |ГДЕ
        |    НЕ ЦеныНоменклатуры.Номенклатура.ПометкаУдаления
        |
        |УПОРЯДОЧИТЬ ПО
        |    Наименование,
        |    ТипЦенНаименование
        |";
      
      Результат = Запрос.Выполнить();
      Выборка = Результат.Выбрать();
      
      // Формируем строку результата
      ТекстРезультата = "";
      Счетчик = 0;
      
      Пока Выборка.Следующий() Цикл
        Счетчик = Счетчик + 1;
        СтрокаРезультата = Строка(Счетчик) + "|" 
          + Выборка.Наименование + "|"
          + Выборка.ТипЦенНаименование + "|"
          + Формат(Выборка.Цена, "ЧЦ=15; ЧДЦ=2") + "|"
          + Формат(Выборка.Период, "ДФ='dd.MM.yyyy HH:mm'");
        ТекстРезультата = ТекстРезультата + СтрокаРезультата + Символы.ПС;
      КонецЦикла;
      
      // Возвращаем результат
      Строка(Счетчик) + "###" + ТекстРезультата
    `;

    const результат = this.com.eval(запрос);

    if (результат.success) {
      return this.разобратьРезультат(результат.value);
    } else {
      console.error('❌ Ошибка выполнения запроса:', результат.error);
      return null;
    }
  }

  /**
   * Разобрать результат запроса
   */
  разобратьРезультат(текст) {
    if (!текст || typeof текст !== 'string') {
      return { количество: 0, строки: [] };
    }

    const части = текст.split('###');
    const количество = parseInt(части[0]) || 0;
    const строкиТекст = части[1] || '';
    
    const строки = строкиТекст
      .split('\n')
      .filter(s => s.trim())
      .map(строка => {
        const поля = строка.split('|');
        return {
          номер: parseInt(поля[0]) || 0,
          наименование: (поля[1] || '').trim(),
          типЦен: (поля[2] || '').trim(),
          цена: parseFloat(поля[3]) || 0,
          период: (поля[4] || '').trim()
        };
      });

    return { количество, строки };
  }

  /**
   * Вывести отчет в консоль
   */
  вывестиОтчет(данные) {
    if (!данные || данные.количество === 0) {
      console.log('📋 Нет данных для отображения\n');
      return;
    }

    console.log('╔════════════════════════════════════════════════════════════════════════════╗');
    console.log('║                        ОТЧЕТ: ЦЕНЫ НОМЕНКЛАТУРЫ                           ║');
    console.log('╚════════════════════════════════════════════════════════════════════════════╝\n');

    console.log(`Всего записей: ${данные.количество}\n`);

    console.log('┌────┬──────────────────────────────────┬──────────────────┬────────────┬──────────────────┐');
    console.log('│ № │ Наименование                     │ Тип цен          │ Цена       │ Дата установки   │');
    console.log('├────┼──────────────────────────────────┼──────────────────┼────────────┼──────────────────┤');

    данные.строки.forEach(строка => {
      const номер = String(строка.номер).padStart(3);
      const наименование = строка.наименование.padEnd(32).substring(0, 32);
      const типЦен = строка.типЦен.padEnd(16).substring(0, 16);
      const цена = String(строка.цена.toFixed(2)).padStart(10);
      const период = строка.период.padEnd(16);

      console.log(`│ ${номер} │ ${наименование} │ ${типЦен} │ ${цена} │ ${период} │`);
    });

    console.log('└────┴──────────────────────────────────┴──────────────────┴────────────┴──────────────────┘\n');
  }

  /**
   * Получить статистику по ценам
   */
  получитьСтатистику(данные) {
    if (!данные || данные.количество === 0) {
      return null;
    }

    const цены = данные.строки.map(s => s.цена);
    const минимальная = Math.min(...цены);
    const максимальная = Math.max(...цены);
    const средняя = цены.reduce((a, b) => a + b, 0) / цены.length;

    const типыЦен = {};
    данные.строки.forEach(строка => {
      if (!типыЦен[строка.типЦен]) {
        типыЦен[строка.типЦен] = 0;
      }
      типыЦен[строка.типЦен]++;
    });

    return {
      минимальная,
      максимальная,
      средняя,
      типыЦен
    };
  }

  /**
   * Вывести статистику
   */
  вывестиСтатистику(статистика) {
    if (!статистика) {
      return;
    }

    console.log('╔════════════════════════════════════════════════════════════════════════════╗');
    console.log('║                              СТАТИСТИКА                                    ║');
    console.log('╚════════════════════════════════════════════════════════════════════════════╝\n');

    console.log(`💰 Минимальная цена: ${статистика.минимальная.toFixed(2)} руб.`);
    console.log(`💰 Максимальная цена: ${статистика.максимальная.toFixed(2)} руб.`);
    console.log(`💰 Средняя цена: ${статистика.средняя.toFixed(2)} руб.\n`);

    console.log('📊 Распределение по типам цен:');
    Object.entries(статистика.типыЦен).forEach(([тип, количество]) => {
      console.log(`   • ${тип}: ${количество} шт.`);
    });
    console.log();
  }

  /**
   * Проверить наличие данных
   */
  проверитьДанные() {
    console.log('🔍 Проверка наличия данных в регистре ЦеныНоменклатуры...\n');

    const проверка = this.com.eval(`
      Запрос = Новый Запрос;
      Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 1 ИЗ РегистрСведений.ЦеныНоменклатуры";
      Результат = Запрос.Выполнить();
      ?(Результат.Пустой(), "ПУСТО", "ЕСТЬ_ДАННЫЕ")
    `);

    if (проверка.success) {
      if (проверка.value.includes('ПУСТО')) {
        console.log('⚠️  Регистр ЦеныНоменклатуры пустой');
        console.log('💡 Нужно заполнить тестовые данные\n');
        return false;
      } else {
        console.log('✅ Данные в регистре найдены\n');
        return true;
      }
    } else {
      console.error('❌ Ошибка проверки:', проверка.error);
      return false;
    }
  }

  /**
   * Отключиться от базы
   */
  отключиться() {
    this.com.cleanup();
    this.подключен = false;
    console.log('✅ Отключение от базы завершено\n');
  }

  /**
   * Запустить полный отчет
   */
  запустить(config) {
    console.log('\n╔════════════════════════════════════════════════════════════════════════════╗');
    console.log('║           ТЕСТИРОВАНИЕ: Отчет по ценам номенклатуры                       ║');
    console.log('╚════════════════════════════════════════════════════════════════════════════╝\n');

    const started = Date.now();

    try {
      // 1. Подключение
      if (!this.подключиться(config.infobase, config.user, config.password)) {
        return false;
      }

      // 2. Проверка данных
      const естьДанные = this.проверитьДанные();
      
      if (!естьДанные) {
        console.log('⚠️  Для демонстрации создам тестовые данные...\n');
        this.создатьТестовыеДанные();
      }

      // 3. Получение данных
      const данные = this.получитьЦеныТоваров();

      if (!данные) {
        console.error('❌ Не удалось получить данные');
        return false;
      }

      // 4. Вывод отчета
      this.вывестиОтчет(данные);

      // 5. Статистика
      const статистика = this.получитьСтатистику(данные);
      this.вывестиСтатистику(статистика);

      // 6. Время выполнения
      const elapsed = Date.now() - started;
      console.log(`⏱️  Время выполнения: ${elapsed} мс\n`);

      return true;

    } catch (error) {
      console.error('❌ Критическая ошибка:', error.message);
      return false;
    } finally {
      this.отключиться();
    }
  }

  /**
   * Создать тестовые данные (если база пустая)
   */
  создатьТестовыеДанные() {
    console.log('📝 Создание тестовых данных...\n');

    const создание = this.com.eval(`
      // Получаем тип цен по умолчанию
      ТипЦен = Справочники.ТипыЦен.НайтиПоНаименованию("Розничная");
      Если ТипЦен.Пустая() Тогда
        ТипЦен = Справочники.ТипыЦен.СоздатьЭлемент();
        ТипЦен.Наименование = "Розничная";
        ТипЦен.Записать();
      КонецЕсли;
      
      // Получаем товары
      Запрос = Новый Запрос;
      Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 5 Ссылка ИЗ Справочник.Номенклатура";
      Результат = Запрос.Выполнить();
      Выборка = Результат.Выбрать();
      
      Счетчик = 0;
      Пока Выборка.Следующий() Цикл
        // Устанавливаем цену
        Набор = РегистрыСведений.ЦеныНоменклатуры.СоздатьНаборЗаписей();
        Набор.Отбор.Номенклатура.Установить(Выборка.Ссылка);
        Набор.Отбор.ТипЦен.Установить(ТипЦен);
        
        Запись = Набор.Добавить();
        Запись.Номенклатура = Выборка.Ссылка;
        Запись.ТипЦен = ТипЦен;
        Запись.Цена = 100 + Случайное() * 900; // Цена от 100 до 1000
        Запись.Период = ТекущаяДата();
        
        Набор.Записать();
        Счетчик = Счетчик + 1;
      КонецЦикла;
      
      "СОЗДАНО:" + Строка(Счетчик)
    `);

    if (создание.success) {
      console.log(`✅ ${создание.value}\n`);
    } else {
      console.error('❌ Ошибка создания данных:', создание.error);
    }
  }
}

// ============================================================================
// ЗАПУСК ТЕСТА
// ============================================================================

if (require.main === module) {
  const отчет = new ОтчетЦеныТоваров();

  // Конфигурация подключения
  const config = {
    infobase: 'D:\\1C_Bases\\PTM_Test',
    user: 'TestRunner',
    password: ''
  };

  // Запустить отчет
  const успех = отчет.запустить(config);

  process.exit(успех ? 0 : 1);
}

module.exports = ОтчетЦеныТоваров;
