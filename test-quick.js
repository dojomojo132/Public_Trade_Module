/**
 * Быстрый тест: Проверка работы COM обёрток
 * Простой пример получения данных из 1С
 */

const COM1CWrapper = require('./mcp-config/1c-com-wrapper');

console.log('╔════════════════════════════════════════════════════════════════╗');
console.log('║    БЫСТРЫЙ ТЕСТ: Получение цен товаров через COM             ║');
console.log('╚════════════════════════════════════════════════════════════════╝\n');

// Создать обёртку
const com = new COM1CWrapper();

// Подключиться к базе
console.log('1️⃣  Подключение к базе...');
const подключено = com.init({
  infobase: 'D:\\Confiq\\Public Trade Module',
  user: 'Админ', 
  password: ''  
});

if (!подключено) {
  console.error('❌ Не удалось подключиться к базе');
  process.exit(1);
}

console.log('✅ Подключено\n');

// Проверить текущую дату
console.log('2️⃣  Проверка связи с сервером...');
const дата = com.getCurrentDate();
if (дата.success) {
  console.log(`✅ Дата на сервере: ${дата.value}\n`);
} else {
  console.error('❌ Ошибка:', дата.error);
}

// Получить количество товаров
console.log('3️⃣  Получение количества товаров...');
const количествоТоваров = com.eval(`
  Запрос = Новый Запрос;
  Запрос.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК Количество ИЗ Справочник.Номенклатура";
  Результат = Запрос.Выполнить().Выбрать();
  Результат.Следующий();
  Результат.Количество
`);

if (количествоТоваров.success) {
  console.log(`✅ Найдено товаров: ${количествоТоваров.value}\n`);
} else {
  console.error('❌ Ошибка:', количествоТоваров.error);
}

// Получить несколько товаров с ценами
console.log('4️⃣  Получение топ-5 товаров с ценами...');
const товарыСЦенами = com.eval(`
  Запрос = Новый Запрос;
  Запрос.Текст = "
    |ВЫБРАТЬ ПЕРВЫЕ 5
    |    Номенклатура.Наименование КАК Наименование,
    |    ЕСТЬNULL(ЦеныНоменклатуры.Цена, 0) КАК Цена
    |ИЗ
    |    Справочник.Номенклатура КАК Номенклатура
    |        ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних() КАК ЦеныНоменклатуры
    |        ПО Номенклатура.Ссылка = ЦеныНоменклатуры.Номенклатура
    |ГДЕ
    |    НЕ Номенклатура.ПометкаУдаления
    |
    |УПОРЯДОЧИТЬ ПО
    |    Наименование
    |";
  
  Результат = Запрос.Выполнить();
  Выборка = Результат.Выбрать();
  
  Текст = "";
  Пока Выборка.Следующий() Цикл
    Текст = Текст + Выборка.Наименование + " | " + Формат(Выборка.Цена, "ЧЦ=10; ЧДЦ=2") + Символы.ПС;
  КонецЦикла;
  
  Текст
`);

if (товарыСЦенами.success) {
  console.log('✅ Товары с ценами:\n');
  console.log('┌─────────────────────────────────────────┬──────────────┐');
  console.log('│ Наименование                            │ Цена         │');
  console.log('├─────────────────────────────────────────┼──────────────┤');
  
  const строки = товарыСЦенами.value.split('\n').filter(s => s.trim());
  
  if (строки.length === 0) {
    console.log('│ (нет товаров)                           │              │');
  } else {
    строки.forEach(строка => {
      const части = строка.split('|').map(s => s.trim());
      const название = (части[0] || '').padEnd(39).substring(0, 39);
      const цена = (части[1] || '0').padStart(12);
      console.log(`│ ${название} │ ${цена} │`);
    });
  }
  
  console.log('└─────────────────────────────────────────┴──────────────┘\n');
} else {
  console.error('❌ Ошибка:', товарыСЦенами.error);
}

// Получить константу
console.log('5️⃣  Проверка констант конфигурации...');
const основнойСклад = com.getConstant('ОсновнойСклад');
if (основнойСклад.success) {
  console.log(`✅ Основной склад: ${основнойСклад.value || '(не задан)'}\n`);
} else {
  console.error('❌ Ошибка:', основнойСклад.error);
}

// Системная информация
console.log('6️⃣  Системная информация...');
const инфо = com.getSystemInfo();
if (инфо.success) {
  console.log(`✅ ${инфо.value}\n`);
} else {
  console.error('❌ Ошибка:', инфо.error);
}

// Очистка
com.cleanup();

console.log('╔════════════════════════════════════════════════════════════════╗');
console.log('║                    ✅ ТЕСТ ЗАВЕРШЕН                           ║');
console.log('╚════════════════════════════════════════════════════════════════╝\n');

console.log('💡 Для полного отчета запустите:');
console.log('   node test-report-prices.js\n');
