# Контроль по остатку для документа "Списание товара"

## Описание
Реализован многоуровневый контроль по остаткам товаров при списании:

### 1. **Клиентский контроль (реал-тайм при редактировании)**
- Срабатывает при изменении поля `Количество` в табличной части `Товары`
- Проверяет остаток товара на складе на дату документа
- Если введено количество больше остатка:
  - Показывает предупреждение с указанием:
    - Товар, который пытались списать
    - Попытанное количество
    - Доступное количество на складе
    - Дефицит
  - Автоматически сокращает введенное количество до доступного остатка
- Не позволяет вводить отрицательные значения
- Требует заполнения склада перед вводом количества

### 2. **Серверный контроль при записи документа**
- Проверяет наличие обязательных реквизитов:
  - Склад должен быть указан
  - Таблица товаров не должна быть пустой
- Показывает ошибку и отказывает в сохранении при отсутствии

### 3. **Контроль при проведении (уже реализован)**
- Если включена константа `КонтролироватьОстаткиПриСписании` = Истина
- Выполняется процедура `ВыполнитьКонтрольОстатков(Отказ)`
- Проверяет остатки для ВСЕХ товаров в документе
- Отказывает проведение, если остаток недостаточен

## Файлы реализации

### Форма документа
- **Location**: `Конфигурация/Documents/СписаниеТовара/Forms/ФормаДокумента/`
- **Files**:
  - `Form.xml` - Описание формы
  - `Ext/Form.xml` - Расширение формы
  - `Ext/Form/Module.bsl` - Модуль формы с обработчиками событий

### Модуль объекта (уже существовал)
- **Location**: `Конфигурация/Documents/СписаниеТовара/Ext/ObjectModule.bsl`
- **Функции**:
  - `ОбработкаПроведения(Отказ, РежимПроведения)` - Формирование движений и контроль
  - `ВыполнитьКонтрольОстатков(Отказ)` - Проверка остатков при проведении

## Обработчики событий формы

### `ПриОткрытии(Отказ)`
- Инициализирует форму
- При открытии проведенного документа делает табличную часть доступной только для просмотра

### `ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)`
- Проверяет заполнение обязательных реквизитов
- Отказывает сохранение при ошибках заполнения

### `ТоварыКоличествоПриИзменении(Элемент)` - КРИТИЧЕСКОЕ
- Срабатывает при каждом изменении количества
- Вызывает `ПроверитьОстатокТовара(ТекущаяСтрока)` на сервере
- Показывает предупреждение и сокращает количество при превышении

### `ТоварыНоменклатураПриИзменении(Элемент)`
- При смене номенклатуры сбрасывает количество для переввода

## Серверные функции

### `ПроверитьОстатокТовара(ТекущаяСтрока)`
- Получает остаток из регистра накопления `ОстаткиТоваров`
- Сравнивает с введенным количеством
- При превышении:
  - Сокращает количество до остатка
  - Показывает подробное предупреждение

### `ПолучитьОстатокТовара(Номенклатура, Склад, Дата)`
- Вспомогательная функция для получения остатка
- Используется также в модуле объекта
- Работает через Остатки регистра накопления

### `ПолучитьЕдиницуИзмеренияНоменклатуры(Номенклатура)`
- Возвращает единицу измерения для отображения в сообщениях
- Пока возвращает "шт." (может расширяться)

## Константы и регистры

### Используемые:
- **Константа**: `КонтролироватьОстаткиПриСписании` - управляет жестким контролем
- **Регистр накопления**: `ОстаткиТоваров` - источник данных по остаткам
- **Справочники**: `Склады`, `Номенклатура`

## Обновления спецификации

В файл `ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ КОНФИГУРАЦИИ PTM (Public Trade Module).xml` добавлены:
- Описание клиентского контроля
- Блок Interface с описанием поведения формы
- История изменения с датой 2026-01-25

## Тестирование

Для проверки функциональности:
1. Открыть документ "Списание товара"
2. Выбрать склад и товар
3. Попытаться ввести количество больше остатка
4. Система должна показать предупреждение и сократить количество
5. При сохранении проверяется наличие всех обязательных полей
6. При проведении (если включена константа) выполняется дополнительный контроль

## Примечание

- Контроль работает асинхронно на клиенте и сервере
- При появлении ошибки система не блокирует работу, а сокращает до максимально возможного значения
- История изменений документируется в спецификации
