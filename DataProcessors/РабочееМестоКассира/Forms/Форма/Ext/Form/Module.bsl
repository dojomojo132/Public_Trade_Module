// =================================================================================
// МОДУЛЬ ФОРМЫ: РАБОЧЕЕ МЕСТО КАССИРА (РМК)
// Адаптация: Public_Trade_Module
// =================================================================================

#Область Переменные
&НаКлиенте
Перем ИмяКнопкиПоследнегоНажатия;
#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// 1. Инициализация параметров
	НомерСтраницыПараметр = 1;
	ИнициализацияНастроекПанели();
	
	// 2. Построение интерфейса (Сетки кнопок)
	СоздатьГруппыРядов();
	
	// 3. Отображение товаров (Корневая группа или сохраненная)
	ОбработчикУправлениеПанелиТоваров("ПриОткрытии");
	
	// 4. Управление видимостью панелей
	РежимОтображенияПанели();
	
	// 5. Фокус на поле сканирования
	АктивироватьПоиск();
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)
	// Очищаем динамически созданные элементы
	УдалитьГруппыРядов();
КонецПроцедуры

#КонецОбласти

#Область ДействияСТаблицейТоваров

// --- Пересчет при изменении данных в таблице ---

&НаКлиенте
Процедура ТЧПриИзменении(Элемент)
	РассчитатьИтоги();
КонецПроцедуры

&НаКлиенте
Процедура ТЧКоличествоПриИзменении(Элемент)
	ТекСтрока = Элементы.ТЧ.ТекущиеДанные;
	Если ТекСтрока <> Неопределено Тогда
		ТекСтрока.Сумма = ТекСтрока.Цена * ТекСтрока.Количество;
		РассчитатьИтоги();
	КонецЕсли;
	АктивироватьПоиск(); // Возвращаем фокус на сканер
КонецПроцедуры

&НаКлиенте
Процедура ТЧЦенаПриИзменении(Элемент)
	ТекСтрока = Элементы.ТЧ.ТекущиеДанные;
	Если ТекСтрока <> Неопределено Тогда
		ТекСтрока.Сумма = ТекСтрока.Цена * ТекСтрока.Количество;
		РассчитатьИтоги();
	КонецЕсли;
	АктивироватьПоиск();
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьИтоги()
	// Если используется стандартный путь к данным "Объект.ТЧ.ИтогСумма", 
	// платформа сама обновит подвал. Если нет - можно раскомментировать:
	// Объект.СуммаДокумента = Объект.ТЧ.Итог("Сумма");
КонецПроцедуры

&НаКлиенте
Процедура Удалить(Команда)
	
	Если Объект.ТЧ.Количество() = 0 Тогда Возврат; КонецЕсли;
	
	Режим = РежимДиалогаВопрос.ДаНет;
	 Оповещение = Новый ОписаниеОповещения("УдалитьЗавершение", ЭтотОбъект);
	ПоказатьВопрос(Оповещение, "Очистить чек полностью?", Режим, 0);
	
КонецПроцедуры

&НаКлиенте
Процедура УдалитьЗавершение(Результат, Параметры) Экспорт
	Если Результат = КодВозвратаДиалога.Да Тогда
		Объект.ТЧ.Очистить();
		РассчитатьИтоги();
	КонецЕсли;
	АктивироватьПоиск();
КонецПроцедуры

#КонецОбласти

#Область СканированиеИПоиск

&НаКлиенте
Процедура АктивироватьПоиск(Команда = Неопределено)
	// Переводим фокус на поле ввода штрихкода (для сканера)
	Если Элементы.Найти("ПолеПоискаТовара") <> Неопределено Тогда
		ТекущийЭлемент = Элементы.ПолеПоискаТовара;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПолеПоискаТовараПриИзменении(Элемент)
	ОбработкаШтрихкода(Объект.ПолеПоискаТовара);
	Объект.ПолеПоискаТовара = ""; // Очищаем поле для следующего сканирования
	АктивироватьПоиск();
КонецПроцедуры

// Обработка дублирующего поля (иногда нужно для сканеров в разрыв клавиатуры)
&НаКлиенте
Процедура ПолеПоискаТовара2ПриИзменении(Элемент)
	ОбработкаШтрихкода(Объект.ПолеПоискаТовара2);
	Объект.ПолеПоискаТовара2 = "";
	АктивироватьПоиск();
КонецПроцедуры

&НаКлиенте
Процедура Поиск(Команда)
	// Ручной ввод штрихкода кнопкой
	ПоказатьВводЧисла(Новый ОписаниеОповещения("ВводШтрихкодаЗавершение", ЭтотОбъект), 0, "Введите штрихкод/код:", 13, 0);
КонецПроцедуры

&НаКлиенте
Процедура ВводШтрихкодаЗавершение(Значение, ДопПараметры) Экспорт
	Если Значение <> Неопределено Тогда
		ОбработкаШтрихкода(Строка(Значение));
	КонецЕсли;
	АктивироватьПоиск();
КонецПроцедуры

// --- ЛОГИКА ПОИСКА (Адаптировано под Public_Trade_Module) ---

&НаСервере
Процедура ОбработкаШтрихкода(Штрихкод)
	
	Если ПустаяСтрока(Штрихкод) Тогда Возврат; КонецЕсли;
	
	// 1. Ищем номенклатуру (Серверный вызов)
	НайденаяНоменклатура = НайтиНоменклатуруНаСервере(Штрихкод);
	
	Если НайденаяНоменклатура.Пустая() Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Товар со штрихкодом " + Штрихкод + " не найден!";
		Сообщение.Сообщить();
		Возврат;
	КонецЕсли;
	
	// 2. Добавляем в таблицу
	ДобавитьТоварВЧек(НайденаяНоменклатура);
	
КонецПроцедуры

&НаСервере
Функция НайтиНоменклатуруНаСервере(Штрихкод)
	
	// А. Поиск в регистре штрихкодов
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Штрихкоды.Номенклатура КАК Номенклатура
		|ИЗ
		|	РегистрСведений.Штрихкоды КАК Штрихкоды
		|ГДЕ
		|	Штрихкоды.Штрихкод = &Штрихкод";
	
	Запрос.УстановитьПараметр("Штрихкод", Штрихкод);
	Результат = Запрос.Выполнить();
	
	Если Не Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Номенклатура;
	КонецЕсли;
	
	// Б. Если не нашли, пробуем искать по Коду или Артикулу справочника
	// (Для коротких номеров)
	Если СтрДлина(Штрихкод) < 15 Тогда 
		ТоварПоКоду = Справочники.Номенклатура.НайтиПоКоду(Штрихкод);
		Если Не ТоварПоКоду.Пустая() Тогда
			Возврат ТоварПоКоду;
		КонецЕсли;
		
		// Можно добавить поиск по Артикулу, если нужно
		// ЗапросАртикул = ...
	КонецЕсли;
	
	Возврат Справочники.Номенклатура.ПустаяСсылка();
	
КонецФункции

&НаСервере
Процедура ДобавитьТоварВЧек(Номенклатура)
	
	// Проверяем, есть ли уже этот товар в чеке
	ПараметрыОтбора = Новый Структура("Номенклатура", Номенклатура);
	НайденныеСтроки = Объект.ТЧ.НайтиСтроки(ПараметрыОтбора);
	
	Если НайденныеСтроки.Количество() > 0 Тогда
		// Если есть - увеличиваем количество
		СтрокаТЧ = НайденныеСтроки[0];
		СтрокаТЧ.Количество = СтрокаТЧ.Количество + 1;
	Иначе
		// Если нет - добавляем новую строку
		СтрокаТЧ = Объект.ТЧ.Добавить();
		СтрокаТЧ.Номенклатура = Номенклатура;
		СтрокаТЧ.Количество = 1;
		
		// Подтягиваем цену из регистра
		СтрокаТЧ.Цена = ПолучитьЦенуНоменклатуры(Номенклатура);
	КонецЕсли;
	
	// Пересчитываем сумму
	СтрокаТЧ.Сумма = СтрокаТЧ.Цена * СтрокаТЧ.Количество;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьЦенуНоменклатуры(Номенклатура)
	
	// Получаем цену на текущую дату (Срез последних)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) КАК Цена
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&Период, Номенклатура = &Номенклатура) КАК ЦеныНоменклатурыСрезПоследних";
		
	Запрос.УстановитьПараметр("Период", ТекущаяДата());
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Цена;
	КонецЕсли;
	
	Возврат 0;
	
КонецФункции

#КонецОбласти

#Область ПанельБыстрыхТоваров
&НаСервере
Процедура ИнициализацияНастроекПанели()
	// Параметры сетки: 4 товара в ширину, 6 в высоту
	КоличествоВРяду = 4;
	КоличествоРядов = 6;
КонецПроцедуры

&НаКлиенте
Процедура РежимОтображенияПанели(Элемент = Неопределено)
	// Управление видимостью панели (если есть галочка)
	Если Элементы.Найти("ГруппаВыборТовара") <> Неопределено Тогда
		Элементы.ГруппаВыборТовара.Видимость = ПоказатьПанельТоваров; 
	КонецЕсли;
	АктивироватьПоиск();
КонецПроцедуры

&НаСервере
Процедура СоздатьГруппыРядов()
	
	// Создаем горизонтальные группы (ряды) для кнопок
	Для ИндексРяда = 0 По КоличествоРядов - 1 Цикл
		ИмяГруппы = "ГруппаРяд" + Строка(ИндексРяда + 1);
		// Проверяем, может уже есть
		Если Элементы.Найти(ИмяГруппы) = Неопределено Тогда
			ГруппаРяда = Элементы.Добавить(ИмяГруппы, Тип("ГруппаФормы"), Элементы.ГруппаВыборТовара);
			ГруппаРяда.Вид = ВидГруппыФормы.ОбычнаяГруппа;
			ГруппаРяда.Группировка = ГруппировкаПодчиненныхЭлементовФормы.ГоризонтальнаяВсегда;
			ГруппаРяда.Ширина = 70;
			ГруппаРяда.Высота = 3;
			
			// ВОТ ЗДЕСЬ ИСПРАВЛЕНИЕ:
			ГруппаРяда.Отображение = ОтображениеОбычнойГруппы.Нет; 
			// ГруппаРяда.ПоказыватьЗаголовок = Ложь; // <--- ЭТУ СТРОКУ НУЖНО УДАЛИТЬ ИЛИ ЗАКОММЕНТИРОВАТЬ
			
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры
&НаСервере
Процедура УдалитьГруппыРядов()
	
	// Очистка интерфейса при закрытии или обновлении
	МассивУдаления = Новый Массив;
	Для Каждого Элемент Из Элементы Цикл
		// Удаляем только наши динамические кнопки и группы
		Если СтрНачинаетсяС(Элемент.Имя, "КнопкаКод") ИЛИ СтрНачинаетсяС(Элемент.Имя, "ГруппаРяд") 
			ИЛИ СтрНачинаетсяС(Элемент.Имя, "Бтн_") Тогда
			МассивУдаления.Добавить(Элемент);
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого Эл Из МассивУдаления Цикл
		// Если удаляем кнопку, надо удалить и связанную с ней команду
		Если ТипЗнч(Эл) = Тип("КнопкаФормы") Тогда
			Попытка
				Команды.Удалить(Команды[Эл.ИмяКоманды]);
			Исключение
			КонецПопытки;
		КонецЕсли;
		Элементы.Удалить(Эл);
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработчикУправлениеПанелиТоваров(Действие)
	
	Перерисовать = Ложь;
	
	// Логика переключения страниц
	Если Действие = "ПриОткрытии" ИЛИ Действие = "Группа" Тогда
		НомерСтраницыПараметр = 1;
		Перерисовать = Истина;
	ИначеЕсли Действие = "CледущаяСтраница" Тогда
		НомерСтраницыПараметр = НомерСтраницыПараметр + 1;
		Перерисовать = Истина;
	ИначеЕсли Действие = "ПредыдущаяСтраница" Тогда
		Если НомерСтраницыПараметр > 1 Тогда
			НомерСтраницыПараметр = НомерСтраницыПараметр - 1;
			Перерисовать = Истина;
		КонецЕсли;
	ИначеЕсли Действие = "Назад" Тогда
		// Возврат в родительскую группу
		Если ЗначениеЗаполнено(ТекущаяГруппа) Тогда
			ТекущаяГруппа = ПолучитьРодителя(ТекущаяГруппа);
			НомерСтраницыПараметр = 1;
			Перерисовать = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если Перерисовать Тогда
		ОбновитьОтображениеНоменклатурыНаСервере();
	КонецЕсли;
	
	// Обновляем счетчик страниц на форме
	НомерСтраницы = НомерСтраницыПараметр; 
	
КонецПроцедуры

&НаСервере
Функция ПолучитьРодителя(Ссылка)
	Возврат Ссылка.Родитель;
КонецФункции

&НаСервере
Процедура ОбновитьОтображениеНоменклатурыНаСервере()
	
	// 1. Очищаем старые кнопки (сохраняя структуру групп)
	Для ИндексРяда = 0 По КоличествоРядов - 1 Цикл
		ИмяГруппы = "ГруппаРяд" + Строка(ИндексРяда + 1);
		Группа = Элементы.Найти(ИмяГруппы);
		Если Группа <> Неопределено Тогда
			МассивКнопок = Новый Массив;
			Для Каждого Подчиненный Из Группа.ПодчиненныеЭлементы Цикл
				МассивКнопок.Добавить(Подчиненный);
			КонецЦикла;
			Для Каждого Кн Из МассивКнопок Цикл
				// Удаляем команду, если она есть
				Если Команды.Найти(Кн.ИмяКоманды) <> Неопределено Тогда
					Команды.Удалить(Команды[Кн.ИмяКоманды]);
				КонецЕсли;
				Элементы.Удалить(Кн);
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	// 2. Получаем данные (товары текущей группы и страницы)
	КоличествоНаСтраницу = КоличествоВРяду * КоличествоРядов;
	МассивТоваров = ПолучитьТоварыДляПанели(ТекущаяГруппа, НомерСтраницыПараметр, КоличествоНаСтраницу);
	
	// 3. Создаем новые кнопки
	Счетчик = 0;
	Для Каждого СтруктураТовара Из МассивТоваров Цикл
		
		Счетчик = Счетчик + 1;
		
		// Вычисляем, в какой ряд положить кнопку
		ИндексРяда = Цел((Счетчик - 1) / КоличествоВРяду);
		ИмяГруппы = "ГруппаРяд" + Строка(ИндексРяда + 1);
		ГруппаРодитель = Элементы.Найти(ИмяГруппы);
		
		Если ГруппаРодитель <> Неопределено Тогда
			
			// --- ИСПРАВЛЕНИЕ: ОЧИСТКА ИМЕНИ ОТ ЗАПРЕЩЕННЫХ СИМВОЛОВ ---
			
			// А. Чистим Код товара (убираем пробелы, дефисы, точки)
			ЧистыйКод = СтруктураТовара.Код;
			ЧистыйКод = СтрЗаменить(ЧистыйКод, " ", "");
			ЧистыйКод = СтрЗаменить(ЧистыйКод, "-", "_");
			ЧистыйКод = СтрЗаменить(ЧистыйКод, ".", "_");
			ЧистыйКод = СтрЗаменить(ЧистыйКод, "/", "_");
			
			// Б. Генерируем UUID и ОБЯЗАТЕЛЬНО убираем дефисы
			УИД = Строка(Новый УникальныйИдентификатор);
			УИД = СтрЗаменить(УИД, "-", ""); // <--- КРИТИЧНО ВАЖНО
			
			// Формируем валидное имя команды
			Префикс = ?(СтруктураТовара.ЭтоГруппа, "GRP", "ITM");
			ИмяКоманды = "CMD_" + Префикс + "_" + ЧистыйКод + "_" + УИД; 
			
			// Имя кнопки тоже должно быть валидным
			ИмяКнопки  = "Бтн_" + ИмяКоманды;
			
			// Создаем Команду
			Команда = Команды.Добавить(ИмяКоманды);
			Команда.Заголовок = СтруктураТовара.Наименование;
			Команда.Действие  = "НажатиеКнопкиТовара"; 
			
			// Создаем Кнопку
			Кнопка = Элементы.Добавить(ИмяКнопки, Тип("КнопкаФормы"), ГруппаРодитель);
			Кнопка.ИмяКоманды = ИмяКоманды;
			Кнопка.Вид = ВидКнопкиФормы.ОбычнаяКнопка;
			Кнопка.Высота = 3;
			Кнопка.Ширина = 18; 
			
			// Визуальное выделение групп (желтый цвет)
			Если СтруктураТовара.ЭтоГруппа Тогда
				Кнопка.ЦветФона = WebЦвета.СветлоЖелтый;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьТоварыДляПанели(Родитель, Страница, РазмерСтраницы)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Код КАК Код,
		|	Номенклатура.Наименование КАК Наименование,
		|	Номенклатура.ЭтоГруппа КАК ЭтоГруппа
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Родитель = &Родитель
		|	И НЕ Номенклатура.ПометкаУдаления
		|
		|УПОРЯДОЧИТЬ ПО
		|	ЭтоГруппа УБЫВ,
		|	Наименование";
	
	// Если Родитель не заполнен (корень), передаем ПустуюСсылку
	Запрос.УстановитьПараметр("Родитель", ?(ЗначениеЗаполнено(Родитель), Родитель, Справочники.Номенклатура.ПустаяСсылка()));
	
	Результат = Запрос.Выполнить();
	
	// Ручная пагинация (пропускаем ненужные записи)
	МассивРезультат = Новый Массив;
	
	Начало = (Страница - 1) * РазмерСтраницы;
	Конец = Начало + РазмерСтраницы;
	
	Счетчик = 0;
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		// Если попали в диапазон страницы - добавляем
		If Счетчик >= Начало И Счетчик < Конец Тогда
			МассивРезультат.Добавить(Новый Структура("Код, Наименование, ЭтоГруппа", Выборка.Код, Выборка.Наименование, Выборка.ЭтоГруппа));
		EndIf;
		
		Счетчик = Счетчик + 1;
		// Если страница заполнена - выходим
		Если Счетчик >= Конец Тогда Прервать; КонецЕсли;
	КонецЦикла;
	
	Возврат МассивРезультат;
	
КонецФункции

&НаКлиенте
Процедура НажатиеКнопкиТовара(Команда)
	
	// Разбираем имя команды: CMD_GRP_00001_UUID
	МассивЧастей = СтрРазделить(Команда.Имя, "_");
	
	// Защита от сбоев
	If МассивЧастей.Количество() < 3 Then Return; EndIf;
	
	ТипОбъекта = МассивЧастей[1]; // GRP (Группа) или ITM (Товар)
	КодОбъекта = МассивЧастей[2]; // Код номенклатуры
	
	Если ТипОбъекта = "GRP" Тогда
		// Если нажали на группу -> проваливаемся внутрь
		ПерейтиВГруппу(КодОбъекта);
	Иначе
		// Если нажали на товар -> ищем его и добавляем в чек
		ОбработкаШтрихкода(КодОбъекта); 
	КонецЕсли;
	
	АктивироватьПоиск();
	
КонецПроцедуры

&НаСервере
Процедура ПерейтиВГруппу(КодГруппы)
	НайденаяГруппа = Справочники.Номенклатура.НайтиПоКоду(КодГруппы);
	Если Не НайденаяГруппа.Пустая() Тогда
		ТекущаяГруппа = НайденаяГруппа;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура Назад(Команда)
	ОбработчикУправлениеПанелиТоваров("Назад");
	АктивироватьПоиск();
КонецПроцедуры

&НаКлиенте
Процедура CледущаяСтраница(Команда)
	ОбработчикУправлениеПанелиТоваров("CледущаяСтраница");
	АктивироватьПоиск();
КонецПроцедуры

&НаКлиенте
Процедура ПредыдущаяСтраница(Команда)
	ОбработчикУправлениеПанелиТоваров("ПредыдущаяСтраница");
	АктивироватьПоиск();
КонецПроцедуры

#КонецОбласти

#Область ОформлениеПродажи
&НаКлиенте
Процедура Рассчитать(Команда)
	
	// 1. Проверки
	Если Объект.ТЧ.Количество() = 0 Тогда
		ПоказатьПредупреждение(, "Чек пуст!");
		Возврат;
	КонецЕсли;
	
	// 2. Подтверждение
	Оповещение = Новый ОписаниеОповещения("РассчитатьЗавершение", ЭтотОбъект);
	ПоказатьВопрос(Оповещение, "Закрыть чек и провести продажу?", РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьЗавершение(Результат, Параметры) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		// Вызываем сервер для создания документа
		Если ОформитьЧекНаСервере() Тогда
			ПоказатьПредупреждение(, "Чек успешно пробит!");
			// Очищаем форму для нового клиента
			Объект.ТЧ.Очистить();
			РассчитатьИтоги();
		Иначе
			// Ошибку уже вывел сервер
		КонецЕсли;
	КонецЕсли;
	
	АктивироватьПоиск();
	
КонецПроцедуры

&НаСервере
Функция ОформитьЧекНаСервере()
	
	Попытка
		// 1. Создаем документ ЧекККМ (адаптировано под ваши метаданные)
		НовыйЧек = Документы.ЧекККМ.СоздатьДокумент();
		НовыйЧек.Дата = ТекущаяДата();
		
		// --- ЗАПОЛНЕНИЕ ШАПКИ ---
		// Берем склад из константы (если есть) или ищем по умолчанию
		СкладКонст = Константы.ОсновнойСклад.Получить();
		Если ЗначениеЗаполнено(СкладКонст) Тогда
			НовыйЧек.Склад = СкладКонст;
		Иначе
			// Пытаемся найти хоть какой-то склад, чтобы документ провелся
			ВыборкаСкладов = Справочники.Склады.Выбрать();
			Если ВыборкаСкладов.Следующий() Тогда
				НовыйЧек.Склад = ВыборкаСкладов.Ссылка;
			КонецЕсли;
		КонецЕсли;

		// Заполняем кассу (первая попавшаяся для теста)
		ВыборкаКасс = Справочники.Кассы.Выбрать();
		Если ВыборкаКасс.Следующий() Тогда
			НовыйЧек.Касса = ВыборкаКасс.Ссылка;
		КонецЕсли;
		
		НовыйЧек.Статус = Перечисления.СтатусыЧекаККМ.Пробит;
		
		// --- ЗАПОЛНЕНИЕ ТОВАРОВ ---
		СуммаДок = 0;
		Для Каждого СтрТЧ Из Объект.ТЧ Цикл
			НоваяСтр = НовыйЧек.Товары.Добавить();
			НоваяСтр.Номенклатура = СтрТЧ.Номенклатура;
			НоваяСтр.Количество = СтрТЧ.Количество;
			НоваяСтр.Цена = СтрТЧ.Цена;
			НоваяСтр.Сумма = СтрТЧ.Сумма;
			
			// Налоговая группа из карточки товара
			НоваяСтр.НалоговаяГруппа = СтрТЧ.Номенклатура.НалоговаяГруппа;
			
			СуммаДок = СуммаДок + СтрТЧ.Сумма;
		КонецЦикла;
		
		НовыйЧек.СуммаДокумента = СуммаДок;
		
		// --- ОПЛАТА (Автоматически наличные) ---
		Оплата = НовыйЧек.Оплата.Добавить();
		Оплата.ВидОплаты = Перечисления.ВидыОплаты.Наличные;
		Оплата.Сумма = СуммаДок;
		
		// 2. Проводим документ
		НовыйЧек.Записать(РежимЗаписиДокумента.Проведение);
		Возврат Истина;
		
	Исключение
		Сообщить("Ошибка проведения: " + ОписаниеОшибки());
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

&НаКлиенте
Процедура ЗавершитьРаботу(Команда)
	Закрыть();
КонецПроцедуры

#КонецОбласти

// --- Заглушки для нереализованных команд (чтобы не было ошибок при нажатии) ---
&НаКлиенте
Процедура Заполнить(Команда)
КонецПроцедуры

&НаКлиенте
Процедура УстановитьЦены(Команда)
КонецПроцедуры

&НаКлиенте
Процедура Начать(Команда)
КонецПроцедуры

&НаКлиенте
Процедура АктивизироватьПоиск(Команда) 
	АктивироватьПоиск();
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьГруппы(Команда)
КонецПроцедуры

&НаКлиенте
Процедура ТестПоказПанели(Команда)
КонецПроцедуры

&НаКлиенте
Процедура СодержимоеГруппы(Команда)
КонецПроцедуры

&НаКлиенте
Процедура ОтчетПоДню(Команда)
	Сообщить("Функционал отчетов в разработке");
КонецПроцедуры