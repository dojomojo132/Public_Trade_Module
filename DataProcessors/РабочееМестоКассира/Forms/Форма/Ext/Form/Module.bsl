// =================================================================================
// МОДУЛЬ ФОРМЫ: РАБОЧЕЕ МЕСТО КАССИРА (РМК)
// Адаптация: Public_Trade_Module (Ukraine Edition)
// =================================================================================

&НаКлиенте
Перем ИмяКнопкиПоследнегоНажатия;

&НаКлиенте
Перем ТоварДляАкциза; // Для акцизных товаров с панели

&НаКлиенте
Перем ПоследнееАктивноеПоле; // Для пинг-понг активации полей сканера ("Поле1" или "Поле2")

#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
// 1. Инициализация и Проверка смены (Изменено)
	Если Не ПроверитьИПодключитьСмену() Тогда
		// Не блокируем открытие, а планируем вопрос пользователю
		ПодключитьОбработчикОжидания("ПредложитьОткрытьСмену", 0.1, Истина);
	КонецЕсли;
	
	
	// 2. Стандартная инициализация
	НомерСтраницыПараметр = 1;
	ИнициализацияНастроекПанели();
	СоздатьГруппыРядов();
	ОбработчикУправлениеПанелиТоваров("ПриОткрытии");
	РежимОтображенияПанели();
	
	// Инициализация псевдо драйвера сканера
	ПоследнееАктивноеПоле = "Поле1";
	АктивироватьПоиск();	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)
	// Очистка не требуется, платформа удалит элементы автоматически.
	// Строку УдалитьГруппыРядов(); удаляем.
КонецПроцедуры
&НаКлиенте
Процедура ПредложитьОткрытьСмену()
	Оповещение = Новый ОписаниеОповещения("ОбработкаОтветаНаОткрытиеСмены", ЭтотОбъект);
	ПоказатьВопрос(Оповещение, "Кассовая смена не открыта. Открыть новую смену?", РежимДиалогаВопрос.ДаНет);
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОтветаНаОткрытиеСмены(Результат, Параметры) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		Если СоздатьИПодключитьСменуНаСервере() Тогда
			ПоказатьПредупреждение(, "Смена успешно открыта!");
			АктивироватьПоиск();
		Иначе
			// Ошибка при создании - закрываемся
			Закрыть();
		КонецЕсли;
	Иначе
		// Пользователь отказался - закрываем РМК
		Закрыть();
	КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область ЛогикаКассовойСмены

&НаСервере
Функция ПроверитьИПодключитьСмену()
	
	// Ищем открытую смену
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	КассоваяСмена.Ссылка КАК Смена,
		|	КассоваяСмена.Касса КАК Касса
		|ИЗ
		|	Документ.КассоваяСмена КАК КассоваяСмена
		|ГДЕ
		// ИСПРАВЛЕНО: Ссылка на правильное перечисление СтатусыКассовойСмены
		|	КассоваяСмена.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыКассовойСмены.Открыта)
		|	И НЕ КассоваяСмена.ПометкаУдаления";
		
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Объект.КассоваяСмена = Выборка.Смена;
	Объект.Касса = Выборка.Касса;
	
	Возврат Истина;
	
КонецФункции

&НаСервере
Функция СоздатьИПодключитьСменуНаСервере()
	
	// 1. Определяем кассу для новой смены
	// В реальном проекте: брали бы из настроек пользователя.
	// Здесь берем первую попавшуюся или основную.
	КассаДляСмены = Справочники.Кассы.ПустаяСсылка();
	
	Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка КАК Ссылка ИЗ Справочник.Кассы ГДЕ НЕ ПометкаУдаления");
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		КассаДляСмены = Выборка.Ссылка;
	КонецЕсли;
	
	Если КассаДляСмены.Пустая() Тогда
		Сообщить("Ошибка: В системе нет ни одной кассы!");
		Возврат Ложь;
	КонецЕсли;
	
	// 2. Создаем документ
	Попытка
		НоваяСмена = Документы.КассоваяСмена.СоздатьДокумент();
		НоваяСмена.Дата = ТекущаяДата();
		НоваяСмена.ДатаНачала = ТекущаяДата();
		НоваяСмена.Касса = КассаДляСмены; // Используем правильное имя реквизита
		НоваяСмена.Статус = Перечисления.СтатусыКассовойСмены.Открыта;
		
		НоваяСмена.Записать(РежимЗаписиДокумента.Проведение);
		
		// 3. Подключаем к контексту формы
		Объект.КассоваяСмена = НоваяСмена.Ссылка;
		Объект.Касса = КассаДляСмены;
		
		Возврат Истина;
		
	Исключение
		Сообщить("Не удалось открыть смену: " + ОписаниеОшибки());
		Возврат Ложь;
	КонецПопытки;

КонецФункции
#КонецОбласти

#Область СканированиеИПоиск

&НаКлиенте
Процедура АктивироватьПоиск(Команда = Неопределено)
	// Псевдо драйвер сканера: пинг-понг активация полей
	// Чередуем поля, чтобы избежать невозможности активации из собственного обработчика
	
	Если ПоследнееАктивноеПоле = "Поле1" Тогда
		// Предыдущим было Поле1 -> активируем Поле2
		Если Элементы.Найти("ПолеПоискаТовара2") <> Неопределено Тогда
			ТекущийЭлемент = Элементы.ПолеПоискаТовара2;
			ПоследнееАктивноеПоле = "Поле2";
		КонецЕсли;
	Иначе
		// Предыдущим было Поле2 -> активируем Поле1
		Если Элементы.Найти("ПолеПоискаТовара") <> Неопределено Тогда
			ТекущийЭлемент = Элементы.ПолеПоискаТовара;
			ПоследнееАктивноеПоле = "Поле1";
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПолеПоискаТовараПриИзменении(Элемент)
	ПоследнееАктивноеПоле = "Поле1"; // Фиксируем источник
	ОбработкаШтрихкода(Объект.ПолеПоискаТовара);
	Объект.ПолеПоискаТовара = ""; 
	АктивироватьПоиск();
КонецПроцедуры

&НаКлиенте
Процедура ПолеПоискаТовара2ПриИзменении(Элемент)
	ОбработкаШтрихкода(Объект.ПолеПоискаТовара2);
	Объект.ПолеПоискаТовара2 = "";           
	ПоследнееАктивноеПоле = "Поле2"; // Фиксируем источник
	АктивироватьПоиск();
КонецПроцедуры

// --- ГЛОБАЛЬНЫЙ ПОИСК + АКЦИЗ ---

&НаКлиенте
Процедура ОбработкаШтрихкода(Штрихкод)
	Если ПустаяСтрока(Штрихкод) Тогда Возврат; КонецЕсли;
	
	// 1. Вызываем глобальный поиск (через Client wrapper)
	Оповещение = Новый ОписаниеОповещения("ОбработкаПоискаЗавершение", ЭтотОбъект);
	ОбщегоНазначенияКлиент.НайтиИОбработатьТовар(Штрихкод, Оповещение);
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаПоискаЗавершение(Результат, ДопПараметры) Экспорт
	
	Если ЗначениеЗаполнено(Результат) Тогда
		
		// 2. Проверяем, нужен ли акциз
		ПараметрыТовара = ПолучитьПараметрыТовараНаСервере(Результат);
		
		Если ПараметрыТовара.ТребуетАкцизнуюМарку Тогда
			// Запрашиваем ввод марки
			ОповещениеМарки = Новый ОписаниеОповещения("ВводМаркиЗавершение", ЭтотОбъект, Результат);
			ПоказатьВводСтроки(ОповещениеМарки, "", "Введите акцизную марку (Украина):", 0, Ложь);
		Иначе
			// Обычный товар
			ДобавитьТоварВЧек(Результат, "");
		КонецЕсли;
		
	КонецЕсли;
	
	АктивироватьПоиск();
	
КонецПроцедуры

&НаКлиенте
Процедура ВводМаркиЗавершение(Марка, Номенклатура) Экспорт
	
	Если Марка = Неопределено ИЛИ ПустаяСтрока(Марка) Тогда
		ПоказатьПредупреждение(, "Отмена: Акцизная марка обязательна!");
		Возврат;
	КонецЕсли;
	
	// Здесь можно добавить Regex проверку формата марки (буквы/цифры)
	ДобавитьТоварВЧек(Номенклатура, Марка);
	АктивироватьПоиск();
	
КонецПроцедуры

&НаСервере
Функция ПолучитьПараметрыТовараНаСервере(Знач Номенклатура)
	Возврат Новый Структура("ТребуетАкцизнуюМарку", Номенклатура.ТребуетАкцизнуюМарку);
КонецФункции

&НаСервере
Процедура ДобавитьТоварВЧек(Знач Номенклатура, Знач АкцизнаяМарка)
	
	// Проверяем наличие строки
	ПараметрыОтбора = Новый Структура("Номенклатура", Номенклатура);
	
	// Если есть марка - ищем строку именно с этой маркой (уникальность)
	Если ЗначениеЗаполнено(АкцизнаяМарка) Тогда
		ПараметрыОтбора.Вставить("АкцизнаяМарка", АкцизнаяМарка);
	КонецЕсли;
	
	НайденныеСтроки = Объект.ТЧ.НайтиСтроки(ПараметрыОтбора);
	
	Если НайденныеСтроки.Количество() > 0 Тогда
		// Увеличиваем количество (для акциза это редкость, но допустим)
		СтрокаТЧ = НайденныеСтроки[0];
		СтрокаТЧ.Количество = СтрокаТЧ.Количество + 1;
	Иначе
		// Новая строка
		СтрокаТЧ = Объект.ТЧ.Добавить();
		СтрокаТЧ.Номенклатура = Номенклатура;
		СтрокаТЧ.Количество = 1;
		СтрокаТЧ.Цена = ПолучитьЦенуНоменклатуры(Номенклатура);
		СтрокаТЧ.АкцизнаяМарка = АкцизнаяМарка; 
	КонецЕсли;
	
	СтрокаТЧ.Сумма = СтрокаТЧ.Цена * СтрокаТЧ.Количество;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьЦенуНоменклатуры(Номенклатура)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ЕСТЬNULL(Ц.Цена, 0) КАК Цена 
		|ИЗ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&Д, Номенклатура=&Н) КАК Ц";
	Запрос.УстановитьПараметр("Д", ТекущаяДата());
	Запрос.УстановитьПараметр("Н", Номенклатура);
	Выб = Запрос.Выполнить().Выбрать();
	Если Выб.Следующий() Тогда Возврат Выб.Цена; КонецЕсли;
	Возврат 0;
КонецФункции

#КонецОбласти

#Область ДействияСТаблицейТоваров

&НаКлиенте
Процедура ТЧПриИзменении(Элемент)
	РассчитатьИтоги();   
	АктивироватьПоиск();
КонецПроцедуры

&НаКлиенте
Процедура ТЧКоличествоПриИзменении(Элемент)
	ТекСтрока = Элементы.ТЧ.ТекущиеДанные;
	Если ТекСтрока <> Неопределено Тогда
		ТекСтрока.Сумма = ТекСтрока.Цена * ТекСтрока.Количество;
		РассчитатьИтоги();
	КонецЕсли;
	АктивироватьПоиск();
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьИтоги()
	// Если нужно обновлять подвалы или общую сумму формы
КонецПроцедуры

&НаКлиенте
Процедура Удалить(Команда)
	Если Объект.ТЧ.Количество() = 0 Тогда Возврат; КонецЕсли;
	Оповещение = Новый ОписаниеОповещения("УдалитьЗавершение", ЭтотОбъект);
	ПоказатьВопрос(Оповещение, "Очистить чек полностью?", РежимДиалогаВопрос.ДаНет);
КонецПроцедуры

&НаКлиенте
Процедура УдалитьЗавершение(Результат, Параметры) Экспорт
	Если Результат = КодВозвратаДиалога.Да Тогда
		Объект.ТЧ.Очистить();
		РассчитатьИтоги();
	КонецЕсли;
	АктивироватьПоиск();
КонецПроцедуры

#КонецОбласти

#Область ОформлениеПродажи

&НаКлиенте
Процедура Рассчитать(Команда)
	
	Если Объект.ТЧ.Количество() = 0 Тогда
		ПоказатьПредупреждение(, "Чек пуст!");
		Возврат;
	КонецЕсли;
	
	// Выбор вида оплаты (Нал/Карта)
	СписокОплат = Новый СписокЗначений;
	СписокОплат.Добавить(PredefinedValue("Перечисление.ВидыОплаты.Наличные"), "Наличные");
	СписокОплат.Добавить(PredefinedValue("Перечисление.ВидыОплаты.Безналичные"), "Банковская карта");
	
	Оп = Новый ОписаниеОповещения("ВыборОплатыЗавершение", ЭтотОбъект);
	СписокОплат.ПоказатьВыборЭлемента(Оп, "Выберите способ оплаты:");
	
КонецПроцедуры

&НаКлиенте
Процедура ВыборОплатыЗавершение(ВыбранныйЭлемент, Параметры) Экспорт
	
	Если ВыбранныйЭлемент = Неопределено Тогда Возврат; КонецЕсли;
	
	ВидОплаты = ВыбранныйЭлемент.Значение;
	
	// Вызов сервера для проведения
	Если ОформитьЧекНаСервере(ВидОплаты) Тогда
		ПоказатьПредупреждение(, "Чек успешно пробит!");
		Объект.ТЧ.Очистить();
		РассчитатьИтоги();
	КонецЕсли;
	
	АктивироватьПоиск();
	
КонецПроцедуры

&НаСервере
Функция ОформитьЧекНаСервере(Знач ВидОплаты)
	
	Попытка
		НовыйЧек = Документы.ЧекККМ.СоздатьДокумент();
		НовыйЧек.Дата = ТекущаяДата();
		
		// Заполняем шапку из контекста формы
		НовыйЧек.Склад = Константы.ОсновнойСклад.Получить(); 
		НовыйЧек.Касса = Объект.Касса; 
		НовыйЧек.КассоваяСмена = Объект.КассоваяСмена;
		НовыйЧек.Статус = Перечисления.СтатусыЧекаККМ.Пробит;
		
		СуммаДок = 0;
		Для Каждого СтрТЧ Из Объект.ТЧ Цикл
			НоваяСтр = НовыйЧек.Товары.Добавить();
			
			// Заполняем стандартные реквизиты
			НоваяСтр.Номенклатура = СтрТЧ.Номенклатура;
			НоваяСтр.Количество = СтрТЧ.Количество;
			НоваяСтр.Цена = СтрТЧ.Цена;
			НоваяСтр.Сумма = СтрТЧ.Сумма;
			
			// Важные поля: Налоговая группа и Марка
			НоваяСтр.НалоговаяГруппа = СтрТЧ.Номенклатура.НалоговаяГруппа;
			НоваяСтр.АкцизнаяМарка = СтрТЧ.АкцизнаяМарка;
			
			СуммаДок = СуммаДок + СтрТЧ.Сумма;
		КонецЦикла;
		
		НовыйЧек.СуммаДокумента = СуммаДок;
		
		// Заполняем оплату
		Оплата = НовыйЧек.Оплата.Добавить();
		Оплата.ВидОплаты = ВидОплаты;
		Оплата.Сумма = СуммаДок;
		
		НовыйЧек.Записать(РежимЗаписиДокумента.Проведение);
		Возврат Истина;
		
	Исключение
		Сообщить("Ошибка проведения: " + ОписаниеОшибки());
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

&НаКлиенте
Процедура ЗавершитьРаботу(Команда)
	Закрыть();
КонецПроцедуры

#КонецОбласти

#Область ПанельБыстрыхТоваров
// (Оставляем старый код для панели без изменений)

&НаСервере
Процедура ИнициализацияНастроекПанели()
	// Значения сохраняются как переменные формы и доступны везде
	КоличествоВРяду = 4;
	КоличествоРядов = 6;
	НомерСтраницыПараметр = 1;
КонецПроцедуры

&НаКлиенте
Процедура РежимОтображенияПанели(Элемент = Неопределено)
	Если Элементы.Найти("ГруппаВыборТовара") <> Неопределено Тогда
		// Здесь можно привязать к галочке "ПоказатьПанель"
		Элементы.ГруппаВыборТовара.Видимость = Истина; 
	КонецЕсли;
	АктивироватьПоиск();
КонецПроцедуры

&НаСервере
Процедура СоздатьГруппыРядов()
	Для ИндексРяда = 0 По КоличествоРядов - 1 Цикл
		ИмяГруппы = "ГруппаРяд" + Строка(ИндексРяда + 1);
		Если Элементы.Найти(ИмяГруппы) = Неопределено Тогда
			ГруппаРяда = Элементы.Добавить(ИмяГруппы, Тип("ГруппаФормы"), Элементы.ГруппаВыборТовара);
			ГруппаРяда.Вид = ВидГруппыФормы.ОбычнаяГруппа;
			ГруппаРяда.Группировка = ГруппировкаПодчиненныхЭлементовФормы.ГоризонтальнаяВсегда;
			ГруппаРяда.Отображение = ОтображениеОбычнойГруппы.Нет;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

&НаСервере
Процедура УдалитьГруппыРядов()
	
	// 1. Собираем элементы для удаления с сохранением имени команды
	МассивУдаления = Новый Массив;
	Для Каждого Элемент Из Элементы Цикл
		// Удаляем динамические кнопки и пустые декорации
		Если СтрНачинаетсяС(Элемент.Имя, "Бтн_CMD_") ИЛИ СтрНачинаетсяС(Элемент.Имя, "Пустая_") Тогда
			// Безопасно получаем имя команды
			Попытка
				ИмяКомандыЭлемента = Элемент.ИмяКоманды;
			Исключение
				ИмяКомандыЭлемента = "";
			КонецПопытки;
			
			// Сохраняем элемент И имя его команды в структуре
			ИнфоЭлемента = Новый Структура("Элемент, ИмяКоманды", Элемент, ИмяКомандыЭлемента);
			МассивУдаления.Добавить(ИнфоЭлемента);
		КонецЕсли;
	КонецЦикла;
	
	// 2. Удаляем
	Для Каждого ИнфоЭл Из МассивУдаления Цикл
		
		// ВАЖНО: Сначала удаляем Элемент формы (Кнопку/Декорацию)
		Попытка
			Элементы.Удалить(ИнфоЭл.Элемент);
		Исключение
			// Игнорируем ошибки - элемент уже удален или недоступен
			Продолжить;
		КонецПопытки;
		
		// ВАЖНО: Только потом удаляем связанную Команду (если есть)
		Если ЗначениеЗаполнено(ИнфоЭл.ИмяКоманды) Тогда
			Попытка
				Команды.Удалить(Команды[ИнфоЭл.ИмяКоманды]); 
			Исключение
				// Игнорируем ошибки - команда уже удалена
				Продолжить;
			КонецПопытки;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры
&НаКлиенте
Процедура ОбработчикУправлениеПанелиТоваров(Действие)
	// Вызываем серверную функцию для обработки навигации
	Результат = ОбработатьНавигациюНаСервере(Действие);
	
	// Обновляем отображение если требуется
	Если Результат.Перерисовать Тогда 
		ОбновитьОтображениеНоменклатурыНаСервере(); 
		НомерСтраницы = НомерСтраницыПараметр; // Обновляем отображение номера страницы
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция ОбработатьНавигациюНаСервере(Действие)
	Перерисовать = Ложь;
	
	Если Действие = "ПриОткрытии" ИЛИ Действие = "Группа" Тогда
		// Инициализация или переход в группу - сброс на первую страницу
		НомерСтраницыПараметр = 1; 
		Перерисовать = Истина;
		
	ИначеЕсли Действие = "СледующаяСтраница" Тогда
		// Проверка: нельзя листать вперед на страницу без товаров
		КоличествоНаСтраницу = КоличествоВРяду * КоличествоРядов;
		ВсегоТоваров = ПолучитьКоличествоТоваровВГруппе(ТекущаяГруппа);
		МаксСтраница = Цел((ВсегоТоваров - 1) / КоличествоНаСтраницу) + 1;
		
		Если НомерСтраницыПараметр < МаксСтраница Тогда
			НомерСтраницыПараметр = НомерСтраницыПараметр + 1; 
			Перерисовать = Истина;
		КонецЕсли;
		
	ИначеЕсли Действие = "ПредыдущаяСтраница" Тогда
		// Проверка: нельзя листать назад на 0 страницу
		Если НомерСтраницыПараметр > 1 Тогда 
			НомерСтраницыПараметр = НомерСтраницыПараметр - 1; 
			Перерисовать = Истина; 
		КонецЕсли;
		
	ИначеЕсли Действие = "Назад" Тогда
		// Возврат к родительской группе
		Если ЗначениеЗаполнено(ТекущаяГруппа) Тогда
			ТекущаяГруппа = ТекущаяГруппа.Родитель; 
			НомерСтраницыПараметр = 1; 
			Перерисовать = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Новый Структура("Перерисовать", Перерисовать);
КонецФункции

&НаСервере
Процедура ОбновитьОтображениеНоменклатурыНаСервере()
	УдалитьГруппыРядов(); // Упрощенная очистка
	
	КоличествоНаСтраницу = КоличествоВРяду * КоличествоРядов;
	МассивТоваров = ПолучитьТоварыДляПанели(ТекущаяГруппа, НомерСтраницыПараметр, КоличествоНаСтраницу);
	
	Счетчик = 0;
	Для Каждого СтруктураТовара Из МассивТоваров Цикл
		Счетчик = Счетчик + 1;
		ИндексРяда = Цел((Счетчик - 1) / КоличествоВРяду);
		ИмяГруппы = "ГруппаРяд" + Строка(ИндексРяда + 1);
		ГруппаРодитель = Элементы.Найти(ИмяГруппы);
		
		Если ГруппаРодитель <> Неопределено Тогда
			ЧистыйКод = СтрЗаменить(СтруктураТовара.Код, " ", "");
			ЧистыйКод = СтрЗаменить(ЧистыйКод, "-", "_");
			УИД = СтрЗаменить(Строка(Новый УникальныйИдентификатор), "-", "");
			
			Префикс = ?(СтруктураТовара.ЭтоГруппа, "GRP", "ITM");
			ИмяКоманды = "CMD_" + Префикс + "_" + ЧистыйКод + "_" + УИД;
			ИмяКнопки  = "Бтн_" + ИмяКоманды;
			
			Команда = Команды.Добавить(ИмяКоманды);
			Команда.Заголовок = СтруктураТовара.Наименование;
			Команда.Действие  = "НажатиеКнопкиТовара"; 
			
			Кнопка = Элементы.Добавить(ИмяКнопки, Тип("КнопкаФормы"), ГруппаРодитель);
			Кнопка.ИмяКоманды = ИмяКоманды;
			Кнопка.Вид = ВидКнопкиФормы.ОбычнаяКнопка;
			Кнопка.Высота = 3; Кнопка.Ширина = 18;
			
			Если СтруктураТовара.ЭтоГруппа Тогда Кнопка.ЦветФона = WebЦвета.СветлоЖелтый; КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	// Заполняем пустые ячейки для стабильности размера панели
	Пока Счетчик < КоличествоНаСтраницу Цикл
		Счетчик = Счетчик + 1;
		ИндексРяда = Цел((Счетчик - 1) / КоличествоВРяду);
		ИмяГруппы = "ГруппаРяд" + Строка(ИндексРяда + 1);
		ГруппаРодитель = Элементы.Найти(ИмяГруппы);
		
		Если ГруппаРодитель <> Неопределено Тогда
			// Добавляем пустую декорацию для заполнения ячейки
			ИмяДекорации = "Пустая_" + Строка(Счетчик) + "_" + СтрЗаменить(Строка(Новый УникальныйИдентификатор), "-", "");
			Декорация = Элементы.Добавить(ИмяДекорации, Тип("ДекорацияФормы"), ГруппаРодитель);
			Декорация.Вид = ВидДекорацииФормы.Надпись;
			Декорация.Высота = 3; 
			Декорация.Ширина = 18;
			Декорация.Заголовок = "";
			Декорация.Видимость = Ложь; // Невидимая, но занимает место
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

&НаСервере
Функция ПолучитьТоварыДляПанели(Родитель, Страница, РазмерСтраницы)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ 
		|   Номенклатура.Ссылка КАК Ссылка, 
		|   Номенклатура.Код КАК Код, 
		|   Номенклатура.Наименование КАК Наименование, 
		|   Номенклатура.ЭтоГруппа КАК ЭтоГруппа
		|ИЗ Справочник.Номенклатура КАК Номенклатура
		|ГДЕ Номенклатура.Родитель = &Родитель И НЕ Номенклатура.ПометкаУдаления
		|УПОРЯДОЧИТЬ ПО ЭтоГруппа УБЫВ, Наименование";
	Запрос.УстановитьПараметр("Родитель", ?(ЗначениеЗаполнено(Родитель), Родитель, Справочники.Номенклатура.ПустаяСсылка()));
	
	Результат = Запрос.Выполнить();
	МассивРезультат = Новый Массив;
	Начало = (Страница - 1) * РазмерСтраницы; 
	Конец = Начало + РазмерСтраницы;
	
	// Сохраняем общее количество для проверки возможности перелистывания
	ВсегоТоваровВГруппе = Результат.Выгрузить().Количество();
	
	Счетчик = 0; 
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		Если Счетчик >= Начало И Счетчик < Конец Тогда
			МассивРезультат.Добавить(Новый Структура("Ссылка, Код, Наименование, ЭтоГруппа", 
				Выборка.Ссылка, Выборка.Код, Выборка.Наименование, Выборка.ЭтоГруппа));
		КонецЕсли;
		Счетчик = Счетчик + 1;
		Если Счетчик >= Конец Тогда Прервать; КонецЕсли;
	КонецЦикла;
	Возврат МассивРезультат;
КонецФункции

&НаСервере
Функция ПолучитьКоличествоТоваровВГруппе(Родитель)
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК Количество
		|ИЗ Справочник.Номенклатура КАК Номенклатура
		|ГДЕ Номенклатура.Родитель = &Родитель И НЕ Номенклатура.ПометкаУдаления";
	Запрос.УстановитьПараметр("Родитель", ?(ЗначениеЗаполнено(Родитель), Родитель, Справочники.Номенклатура.ПустаяСсылка()));
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Количество;
	КонецЕсли;
	Возврат 0;
КонецФункции

&НаКлиенте
Процедура НажатиеКнопкиТовара(Команда)
	// Формат имени команды: CMD_<ТИП>_<КОД>_<УИД>
	МассивЧастей = СтрРазделить(Команда.Имя, "_");
	Если МассивЧастей.Количество() < 3 Тогда 
		Возврат; 
	КонецЕсли;
	
	ТипОбъекта = МассивЧастей[1]; // GRP или ITM
	КодОбъекта = МассивЧастей[2];
	
	Если ТипОбъекта = "GRP" Тогда
		// Переход в группу: очищаем панель, отображаем содержимое группы
		ПерейтиВГруппуНаСервере(КодОбъекта);
		ОбработчикУправлениеПанелиТоваров("Группа");
	Иначе
		// Добавление товара в ТЧ
		ДобавитьТоварИзПанели(КодОбъекта);
	КонецЕсли;
	АктивироватьПоиск();
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьТоварИзПанели(КодТовара)
	// Получаем информацию о товаре
	ИнфоТовара = ПолучитьИнфоТовараПоКоду(КодТовара);
	
	Если Не ИнфоТовара.Найден Тогда
		Возврат;
	КонецЕсли;
	
	Если ИнфоТовара.ТребуетАкцизнуюМарку Тогда
		// Сохраняем ссылку и запрашиваем марку асинхронно
		ТоварДляАкциза = ИнфоТовара.Ссылка;
		ОповещениеМарки = Новый ОписаниеОповещения("ВводМаркиПанелиЗавершение", ЭтотОбъект);
		ПоказатьВводСтроки(ОповещениеМарки, "", "Введите акцизную марку:", 0, Ложь);
	Иначе
		// Обычный товар - добавляем сразу
		ДобавитьТоварВЧекПоСсылке(ИнфоТовара.Ссылка, "");
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ВводМаркиПанелиЗавершение(Марка, ДопПараметры) Экспорт
	Если Марка = Неопределено ИЛИ ПустаяСтрока(Марка) Тогда
		ПоказатьПредупреждение(, "Отмена: Акцизная марка обязательна!");
		ТоварДляАкциза = Неопределено;
		Возврат;
	КонецЕсли;
	
	ДобавитьТоварВЧекПоСсылке(ТоварДляАкциза, Марка);
	ТоварДляАкциза = Неопределено;
	АктивироватьПоиск();
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьИнфоТовараПоКоду(Знач КодТовара)
	Результат = Новый Структура("Найден, Ссылка, ТребуетАкцизнуюМарку", Ложь, Неопределено, Ложь);
	
	НайденныйТовар = Справочники.Номенклатура.НайтиПоКоду(КодТовара);
	Если НайденныйТовар.Пустая() ИЛИ НайденныйТовар.ЭтоГруппа Тогда
		Возврат Результат;
	КонецЕсли;
	
	Результат.Найден = Истина;
	Результат.Ссылка = НайденныйТовар;
	Результат.ТребуетАкцизнуюМарку = НайденныйТовар.ТребуетАкцизнуюМарку;
	
	Возврат Результат;
КонецФункции

&НаСервере
Процедура ДобавитьТоварВЧекПоСсылке(Знач Номенклатура, Знач АкцизнаяМарка)
	ДобавитьТоварВЧек(Номенклатура, АкцизнаяМарка);
КонецПроцедуры

&НаСервере
Процедура ПерейтиВГруппуНаСервере(Знач КодГруппы)
	НайденнаяГруппа = Справочники.Номенклатура.НайтиПоКоду(КодГруппы);
	Если Не НайденнаяГруппа.Пустая() И НайденнаяГруппа.ЭтоГруппа Тогда 
		ТекущаяГруппа = НайденнаяГруппа; 
		НомерСтраницыПараметр = 1;
	КонецЕсли;
КонецПроцедуры

// Команды навигации по панели товаров
//
// Параметры:
//  Команда - КомандаФормы
//
&НаКлиенте
Процедура Назад(Команда)
	ОбработчикУправлениеПанелиТоваров("Назад"); 
	АктивироватьПоиск(); 
КонецПроцедуры

// Параметры:
//  Команда - КомандаФормы
//
&НаКлиенте
Процедура СледующаяСтраница(Команда) 
	ОбработчикУправлениеПанелиТоваров("СледующаяСтраница"); 
	АктивироватьПоиск(); 
КонецПроцедуры

// Параметры:
//  Команда - КомандаФормы
//
&НаКлиенте
Процедура ПредыдущаяСтраница(Команда) 
	ОбработчикУправлениеПанелиТоваров("ПредыдущаяСтраница"); 
	АктивироватьПоиск(); 
КонецПроцедуры

#КонецОбласти