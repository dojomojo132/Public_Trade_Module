
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	МинимальнаяЦена = 10;
	МаксимальнаяЦена = 1000;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ТипыЦен.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ТипыЦен КАК ТипыЦен
	|ГДЕ
	|	НЕ ТипыЦен.ПометкаУдаления
	|
	|УПОРЯДОЧИТЬ ПО
	|	ТипыЦен.Код";
	
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		ТипЦен = Выборка.Ссылка;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Асинх Процедура СоздатьПереоценкуКоманда(Команда)
	
	//Если НЕ ЗначениеЗаполнено(Объект.ТипЦен) Тогда
	//	Ждать ПредупреждениеАсинх("Необходимо выбрать тип цен");
	//	Возврат;
	//КонецЕсли;
	//
	Если Объект.МинимальнаяЦена <= 0 Или Объект.МаксимальнаяЦена <= 0 Тогда
		Ждать ПредупреждениеАсинх("Цены должны быть больше нуля");
		Возврат;
	КонецЕсли;
	
	Если Объект.МинимальнаяЦена > Объект.МаксимальнаяЦена Тогда
		Ждать ПредупреждениеАсинх("Минимальная цена не может быть больше максимальной");
		Возврат;
	КонецЕсли;
	
	Ссылка = Ждать СоздатьДокументПереоценкиНаСервере(0, Объект.МинимальнаяЦена, Объект.МаксимальнаяЦена);
	
	Если ЗначениеЗаполнено(Ссылка) Тогда
		Ждать ОткрытьЗначениеАсинх(Ссылка);
		Ждать ПредупреждениеАсинх("Документ переоценки создан и проведен");
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция СоздатьДокументПереоценкиНаСервере(ТипЦен, МинимальнаяЦена, МаксимальнаяЦена)
	
	// Запрос для получения всех номенклатур
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Номенклатура
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	НЕ Номенклатура.ПометкаУдаления
	|	И НЕ Номенклатура.ЭтоГруппа";
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Создаем документ Переоценка
	ДокументПереоценка = Документы.Переоценка.СоздатьДокумент();
	ДокументПереоценка.Дата = ТекущаяДата();
	//ДокументПереоценка.ТипЦен = ТипЦен;
	
	// Заполняем табличную часть Товары
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		НоваяСтрока = ДокументПереоценка.Товары.Добавить();
		НоваяСтрока.Номенклатура = Выборка.Номенклатура;
		
		// Генерируем случайную цену в диапазоне
		Диапазон = МаксимальнаяЦена - МинимальнаяЦена;
		Генератор = Новый ГенераторСлучайныхЧисел();
		СлучайноеЧисло = МинимальнаяЦена + (Диапазон * Генератор.СлучайноеЧисло(МинимальнаяЦена, МаксимальнаяЦена));
		НоваяСтрока.Цена = Окр(СлучайноеЧисло, 2);
		
	КонецЦикла;
	
	// Записываем и проводим документ
	Попытка
		ДокументПереоценка.Записать(РежимЗаписиДокумента.Проведение);
		Возврат ДокументПереоценка.Ссылка;
	Исключение
		Сообщить("Ошибка при проведении документа: " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции
