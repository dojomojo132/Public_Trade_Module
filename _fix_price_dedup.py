# -*- coding: utf-8 -*-
import pathlib

paths = [
    pathlib.Path(r"D:\Git\Public_Trade_Module\Конфигурация\DataProcessors\ИмпортНоменклатуры\Ext\ObjectModule.bsl"),
    pathlib.Path(r"D:\Git\Public_Trade_Module\Конфигурация\Проверка\DataProcessors\ИмпортНоменклатуры\Ext\ObjectModule.bsl"),
]

# Replace the ИмпортироватьЦены function to deduplicate
old = '''Функция ИмпортироватьЦены(ТабДок)
	
	// Колонки: Номенклатура.Код, Номенклатура.Наименование, Цена
	Счетчик = 0;
	
	ТипЦен = НастройкиПоУмолчанию.ПолучитьОсновнойТипЦен();
	
	ДокументПереоценка = Документы.Переоценка.СоздатьДокумент();
	ДокументПереоценка.Дата = ТекущаяДатаСеанса();
	ДокументПереоценка.ТипЦен = ТипЦен;
	
	Для НомерСтроки = 2 По ТабДок.ВысотаТаблицы Цикл
		КодНоменклатуры = СокрЛП(ТабДок.Область(НомерСтроки, 1).Текст);
		ЦенаТекст = СокрЛП(ТабДок.Область(НомерСтроки, 3).Текст);
		
		Если ПустаяСтрока(КодНоменклатуры) ИЛИ ПустаяСтрока(ЦенаТекст) Тогда
			Продолжить;
		КонецЕсли;
		
		Номенклатура = Справочники.Номенклатура.НайтиПоКоду(КодНоменклатуры);
		Если Номенклатура.Пустая() Тогда
			Продолжить;
		КонецЕсли;
		
		Цена = Число(СтрЗаменить(ЦенаТекст, " ", ""));
		Если Цена <= 0 Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаТовара = ДокументПереоценка.Товары.Добавить();
		СтрокаТовара.Номенклатура = Номенклатура;
		СтрокаТовара.Цена = Цена;
		
		Счетчик = Счетчик + 1;
	КонецЦикла;
	
	Если Счетчик > 0 Тогда
		ДокументПереоценка.Записать(РежимЗаписиДокумента.Проведение);
	КонецЕсли;
	
	Возврат Счетчик;
	
КонецФункции'''

new = '''Функция ИмпортироватьЦены(ТабДок)
	
	// Колонки: Номенклатура.Код, Номенклатура.Наименование, Цена
	Счетчик = 0;
	
	ТипЦен = НастройкиПоУмолчанию.ПолучитьОсновнойТипЦен();
	
	ДокументПереоценка = Документы.Переоценка.СоздатьДокумент();
	ДокументПереоценка.Дата = ТекущаяДатаСеанса();
	ДокументПереоценка.ТипЦен = ТипЦен;
	
	// Соответствие для дедупликации (одна номенклатура = одна строка, последняя цена побеждает)
	УжеДобавлены = Новый Соответствие; // Номенклатура -> НомерСтрокиТЧ
	
	Для НомерСтроки = 2 По ТабДок.ВысотаТаблицы Цикл
		КодНоменклатуры = СокрЛП(ТабДок.Область(НомерСтроки, 1).Текст);
		ЦенаТекст = СокрЛП(ТабДок.Область(НомерСтроки, 3).Текст);
		
		Если ПустаяСтрока(КодНоменклатуры) ИЛИ ПустаяСтрока(ЦенаТекст) Тогда
			Продолжить;
		КонецЕсли;
		
		Номенклатура = Справочники.Номенклатура.НайтиПоКоду(КодНоменклатуры);
		Если Номенклатура.Пустая() Тогда
			Продолжить;
		КонецЕсли;
		
		Цена = Число(СтрЗаменить(ЦенаТекст, " ", ""));
		Если Цена <= 0 Тогда
			Продолжить;
		КонецЕсли;
		
		// Проверяем дубликат номенклатуры — обновляем цену если уже есть
		СуществующийИндекс = УжеДобавлены[Номенклатура];
		Если СуществующийИндекс <> Неопределено Тогда
			ДокументПереоценка.Товары[СуществующийИндекс].Цена = Цена;
		Иначе
			СтрокаТовара = ДокументПереоценка.Товары.Добавить();
			СтрокаТовара.Номенклатура = Номенклатура;
			СтрокаТовара.Цена = Цена;
			УжеДобавлены.Вставить(Номенклатура, ДокументПереоценка.Товары.Количество() - 1);
			Счетчик = Счетчик + 1;
		КонецЕсли;
	КонецЦикла;
	
	Если Счетчик > 0 Тогда
		ДокументПереоценка.Записать(РежимЗаписиДокумента.Проведение);
	КонецЕсли;
	
	Возврат Счетчик;
	
КонецФункции'''

for p in paths:
    content = p.read_text(encoding='utf-8-sig')
    if old in content:
        content = content.replace(old, new)
        p.write_text(content, encoding='utf-8-sig')
        print(f"  OK: {p}")
    else:
        print(f"  SKIP: {p} (not found)")

print("\nDone!")
